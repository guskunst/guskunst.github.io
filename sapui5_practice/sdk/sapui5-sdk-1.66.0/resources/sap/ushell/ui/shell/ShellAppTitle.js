// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['jquery.sap.global','sap/m/Button','sap/ui/core/IconPool','sap/ushell/Config','sap/ui/Device','sap/ushell/library','./ShellNavigationMenu','sap/ushell/services/AllMyApps'],function(q,B,I,C,D){"use strict";var s={SHELL_NAV_MENU_ONLY:0,ALL_MY_APPS_ONLY:1,SHELL_NAV_MENU:2,ALL_MY_APPS:3},S;S=B.extend("sap.ushell.ui.shell.ShellAppTitle",{metadata:{properties:{text:{type:"string",group:"Misc",defaultValue:null},tooltip:{type:"string",group:"Misc",defaultValue:null}},associations:{navigationMenu:{type:"sap.ushell.ui.shell.ShellNavigationMenu"},allMyApps:{type:"sap.ui.core.mvc.ViewType.JS"}},events:{press:{},textChanged:{}}},renderer:{render:function(r,c){var n=c.getNavigationMenu(),t=c.getText(),v=false,N,m=c.getModel();if(n){N=sap.ui.getCore().byId(n);}v=c._getControlVisibilityAndState(N,c);c.bIconVisible=v;r.write('<div ');r.writeControlData(c);r.addClass("sapUshellAppTitle");if(v||D.system.phone){r.addClass("sapUshellAppTitleClickable");r.write("tabindex='0' ");r.writeAttribute("role","heading");r.writeAttribute("aria-level","1");}if(v){r.writeAttribute("aria-haspopup","true");r.writeAttribute("aria-expanded","false");if(m&&m.getProperty("/ShellAppTitleState")===s.ALL_MY_APPS_ONLY){r.writeAttributeEscaped("aria-label",sap.ushell.resources.i18n.getText("ShowAllMyApps_AriaLabel",[t]));}else{r.writeAttributeEscaped("aria-label",sap.ushell.resources.i18n.getText("ShellNavigationMenu_AriaLabel",[t]));}}r.writeClasses();r.write(">");r.write('<h1 class="sapUshellHeadTitle">');if(t){r.writeEscaped(t);}r.write("</h1>");if(v){r.write("<div ");r.addClass("sapUshellShellHeadAction");r.writeClasses();r.write("><span class='sapUshellShellHeadActionImg'>");r.renderControl(c.oIcon);r.write("</span>");r.write("</div>");}r.write("</div>");}}});S.prototype.init=function(){if(B.prototype.init){B.prototype.init.apply(this,arguments);}this.oIcon=I.createControlByURI(I.getIconURI("megamenu"));this.oIcon.addStyleClass("sapUshellAppTitleMenuIcon");if(D.system.desktop){this.addEventDelegate({onkeydown:function(e){if(e.altKey&&e.keyCode===40){e.preventDefault();this.onclick();}}.bind(this)});}this._bTextChanged=false;};S.prototype.onclick=function(e){var t=this;this.oNavMenu=sap.ui.getCore().byId(t.getNavigationMenu());this.oAllMyApps=sap.ui.getCore().byId(t.getAllMyApps());if(!this.bIconVisible){if(D.system.phone){window.hasher.setHash(C.last("/core/shellHeader/rootIntent"));}return;}if(this.getModel().getProperty("/ShellAppTitleState")===s.ALL_MY_APPS_ONLY){q.sap.measure.start("FLP:ShellAppTitle.onClick","Click ShellAppTitle in HOME state, Launching AllMyApps","FLP");if(!this.oAllMyApps){return;}if(!this._getAllMyAppsPopover()){this.oAllMyAppsPopover=this._createAllMyAppsPopover();}if(this.oAllMyAppsPopover.isOpen()){this.oAllMyAppsPopover.close();}else{this.oAllMyAppsPopover.openBy(this);}}else{this.bAppTitleClick=false;if(!this._getNavMenuPopover()){this.oNavMenuPopover=this._createNavMenuPopover(this.getModel());}this.getModel().setProperty("/ShellAppTitleState",s.SHELL_NAV_MENU);if(!D.system.desktop){if(this._getNavMenuPopover().isOpen()){this._getNavMenuPopover().close();}else{this._getNavMenuPopover().openBy(this);this.firePress();}}else if(!this.bAppTitleClick){this._getNavMenuPopover().openBy(this);this.firePress();}else{this.bAppTitleClick=false;}}this._handlePopoverStateChange();};S.prototype.onsapskipback=function(e){e.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;};S.prototype._getControlVisibilityAndState=function(n,c){q.sap.measure.start("FLP:ShellAppTitle.getControlVisibilityAndState","Check AllMyApps and NavShellMenu visibility","FLP");var v=false,m=c.getModel(),a=C.last("/core/shell/model/currentState/stateName"),A=sap.ushell.Container.getService("AllMyApps").isEnabled(),N=this._isNavMenuEnabled(n);if(!m){return false;}if(a==="app"||a==="home"){v=A||N;if(A&&N){m.setProperty("/ShellAppTitleState",s.SHELL_NAV_MENU);}else if(!A&&N){m.setProperty("/ShellAppTitleState",s.SHELL_NAV_MENU_ONLY);}else if(A&&!N){m.setProperty("/ShellAppTitleState",s.ALL_MY_APPS_ONLY);}}else{v=N;m.setProperty("/ShellAppTitleState",s.SHELL_NAV_MENU_ONLY);}q.sap.measure.end("FLP:ShellAppTitle.getControlVisibilityAndState");return v;};S.prototype._getAllMyAppsPopover=function(){return this.oAllMyAppsPopover;};S.prototype._getNavMenuPopover=function(){return this.oNavMenuPopover;};S.prototype._createAllMyAppsPopover=function(){var a=new sap.m.ResponsivePopover({id:"sapUshellAllMyAppsPopover",placement:sap.m.PlacementType.Bottom,title:"",showArrow:true,customHeader:this._getPopoverHeader(this.getModel()),showHeader:{path:'/ShellAppTitleState',formatter:function(c){return c!==s.SHELL_NAV_MENU;}},content:[this.oAllMyApps]});a.setModel(this.getModel());a.addStyleClass('sapUshellAppTitleAllMyAppsPopover');a.attachAfterOpen(function(){this.oAllMyApps._afterOpen();if(this.oToggleListButton.getVisible()){this.oToggleListButton.firePress();this.oToggleListButton.setPressed(true);}}.bind(this));return a;};S.prototype._createNavMenuPopover=function(){var n=new sap.m.Popover({id:"sapUshellAppTitlePopover",placement:sap.m.PlacementType.Bottom,title:"",showArrow:true,showHeader:{path:'/ShellAppTitleState',formatter:function(c){return c!==s.SHELL_NAV_MENU;}},contentWidth:"20rem",content:sap.ui.getCore().byId(this.getNavigationMenu())}),N=this.getModel().bindProperty('/ShellAppTitleState'),p;if(sap.ushell.Container.getService("AllMyApps").isEnabled()){p=this._getPopoverFooterContent(this.getModel());n.setFooter(p);}n.addStyleClass('sapUshellAppTitleNavigationMenuPopover');n.setModel(this.getModel());C.emit('/core/shell/model/allMyAppsMasterLevel',0);N.attachChange(this._handlePopoverStateChange.bind(this));n.attachBeforeOpen(function(){if(p){var a=C.last('/core/shell/model/currentState/stateName'),b=(a==="home"||a==="app"),o=this.getModel().getProperty("/ShellAppTitleState"),v=(o===s.SHELL_NAV_MENU)&&b;p.setVisible(v);}this.oNavMenu._beforeOpen();}.bind(this));n.attachAfterOpen(function(){this.oNavMenu.$().on("touchmove.scrollFix",function(e){e.stopPropagation();});this.oNavMenu._afterOpen();this._adjustAccProperties(true);}.bind(this));n.attachBeforeClose(function(e){if(document.activeElement.id===this.getId()){this.bAppTitleClick=true;}e.preventDefault();e.cancelBubble();}.bind(this));n.attachAfterClose(function(e){this._adjustAccProperties(false);}.bind(this));return n;};S.prototype._getPopoverHeader=function(m){if(!this.oPopoverHeader){this.oBackButton=this._createPopoverBackButton();this.oBackButton.addStyleClass("sapUshellCatalogNewGroupBackButton");this.oToggleListButton=this._createPopoverToggleButton();this.oToggleListButton.addStyleClass("sapUshellAllMyAppsToggleListButton");var a=new sap.m.Label({text:sap.ushell.resources.i18n.getText("allMyApps_headerTitle")});this.addCustomData(a,"role","heading");this.addCustomData(a,"aria-level","2");this.oPopoverHeader=new sap.m.Bar("sapUshellShellAppPopoverHeader",{contentLeft:[this.oBackButton,this.oToggleListButton],contentMiddle:[a]});}return this.oPopoverHeader;};S.prototype._createPopoverBackButton=function(){var b=new B("sapUshellAppTitleBackButton",{icon:I.getIconURI("nav-back"),press:[this._popoverBackButtonPressHandler,this],tooltip:sap.ushell.resources.i18n.getText("backBtn_tooltip"),visible:this.getAllMyAppsController().getBackButtonVisible()});return b;};S.prototype._popoverBackButtonPressHandler=function(){var a=this.getAllMyAppsController(),A=a.getCurrentState(),o=a.getStateEnum(),m=this.getModel();if((A===o.FIRST_LEVEL)||(A===o.FIRST_LEVEL_SPREAD)){if(m.getProperty("/ShellAppTitleState")!==s.ALL_MY_APPS_ONLY){m.setProperty("/ShellAppTitleState",s.SHELL_NAV_MENU);this._getAllMyAppsPopover().close();this._getNavMenuPopover().openBy(this);}}else if(A===o.SECOND_LEVEL){a.switchToInitialState();}else{a.handleSwitchToMasterAreaOnPhone();}a.updateHeaderButtonsState();};S.prototype._createPopoverToggleButton=function(m){var t,c=this.oAllMyApps.getController();t=new sap.m.ToggleButton("sapUshellAllMyAppsToggleListButton",{icon:I.getIconURI("sap-icon://menu2"),press:function(e){c.switchToInitialState();this.setTooltip(e.getParameter("pressed")?sap.ushell.resources.i18n.getText("ToggleButtonHide"):sap.ushell.resources.i18n.getText("ToggleButtonShow"));},tooltip:sap.ushell.resources.i18n.getText("ToggleButtonShow"),visible:c.getToggleListButtonVisible()});D.media.attachHandler(function(){t.setVisible(c.getToggleListButtonVisible());},this,D.media.RANGESETS.SAP_STANDARD);return t;};S.prototype._getPopoverFooterContent=function(m){var t=this,a;if(!this.oPopoverFooterContent){a=new B('allMyAppsButton',{text:sap.ushell.resources.i18n.getText("allMyApps_launchingButtonTitle"),press:function(){m.setProperty("/ShellAppTitleState",s.ALL_MY_APPS);q.sap.measure.start("FLP:ShellNavMenu.footerClick","Click the footer of ShellNavMenu, Launching AllMyApps","FLP");if(!t._getAllMyAppsPopover()){t.oAllMyAppsPopover=t._createAllMyAppsPopover();}t.oNavMenuPopover.close();t.oAllMyAppsPopover.openBy(t);t.oBackButton.focus();},visible:{path:'/ShellAppTitleState',formatter:function(c){return c===s.SHELL_NAV_MENU;}}});this.oPopoverFooterContent=new sap.m.Bar('shellpopoverFooter',{contentMiddle:[a]});this.addCustomData(a,"role","button");this.addCustomData(a,"aria-label",sap.ushell.resources.i18n.getText("allMyApps_launchingButtonTitle"));}return this.oPopoverFooterContent;};S.prototype._isNavMenuEnabled=function(n){return n?n.getItems()&&n.getItems().length>0:false;};S.prototype._handlePopoverStateChange=function(d){var m=this.getModel(),c=m.getProperty('/ShellAppTitleState');};S.prototype.setText=function(t){this.setProperty("text",t,false);this._bTextChanged=true;};S.prototype.onAfterRendering=function(){if(this._bTextChanged){this.fireTextChanged();if(this.getProperty("text")!=="Home"&&this.getProperty("text")!==""&&this.getProperty("text")!==undefined){q.sap.measure.end("FLP:OpenApplicationonClick");}}this._bTextChanged=false;var o=sap.ui.getCore().byId("shell-header");if(o){o._setMaxWidthForTitle();}};S.prototype._adjustAccProperties=function(i){q(this.getDomRef()).attr("aria-expanded",!!i);};S.prototype.addCustomData=function(i,k,v){i.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:k,value:v,writeToDom:true}));};S.prototype.close=function(){if(this.oNavMenuPopover&&this.oNavMenuPopover.isOpen()){this.oNavMenuPopover.close();}};S.prototype.setTooltip=function(t){this.oIcon.setTooltip(t);};S.prototype.getAllMyAppsController=function(){return this.oAllMyApps.getController();};S.prototype.getStateEnum=function(){return s;};S.prototype.onsapspace=S.prototype.onclick;S.prototype.onsapenter=S.prototype.onclick;S.prototype.exit=function(){var n=sap.ui.getCore().byId(this.getNavigationMenu()),a=sap.ui.getCore().byId(this.getAllMyApps());if(n){n.destroy();}if(a){a.destroy();}if(this.oAllMyAppsPopover){this.oAllMyAppsPopover.destroy();}if(this.oNavMenuPopover){this.oNavMenuPopover.destroy();}};return S;},true);
