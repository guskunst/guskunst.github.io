// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/Device","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/ui/launchpad/ShortcutsHelpContainer"],function(D,C,E,r,S){"use strict";var A=function(){};A.prototype={bFocusOnShell:true,bFocusPassedToExternalHandlerFirstTime:true,isFocusHandledByAnotherHandler:false,fnExternalKeysHandler:null,sLastExternalKeysHandlerUrl:null,fnExternalShortcuts:null,isleftAltPressed:false,bForwardNavigation:true,aShortcutsDescriptions:[],appOpenedHandler:function(){var c=hasher.getHash();if(c!==this.sLastExternalKeysHandlerUrl){this.fnExternalKeysHandler=null;}this.sLastExternalKeysHandlerUrl=c;},_focusItemInOverflowPopover:function(i){var o=sap.ui.getCore().byId("headEndItemsOverflow");if(o&&o.isOpen()){if(o.getContent().length){this._focusIteminPopover(i,o.getContent()[0].getItems());}}else{var O=window.document.getElementById("endItemsOverflowBtn");if(O){O.click();var t=this;window.setTimeout(function(){t._focusItemInOverflowPopover(i);},200);}}},_focusItemInUserMenu:function(i){var u=sap.ui.getCore().byId("sapUshellMeAreaPopover");if(u&&u.isOpen()){if(u.getContent().length){this._focusIteminPopover(i,u.getContent()[0].getItems());}}else{var t=this;E.emit("showMeArea",Date.now());window.setTimeout(function(){t._focusItemInUserMenu(i);},200);}},_focusIteminPopover:function(I,b){for(var i=0;i<b.length;i++){var c=b[i].getId().split("-");if(c[c.length-1]===I){b[i].getDomRef().focus();return;}}},_handleAccessOverviewKey:function(){var s=this.oModel.getProperty("/searchAvailable"),p=this.oModel.getProperty("/personalization");if(D.browser.msie){document.addEventListener("help",this._cancelHelpEvent);}var b=[];b=b.concat(this.aShortcutsDescriptions);if(window.document.getElementById("shell-header")){if(p){b.push({text:"Alt+A",description:r.i18n.getText("hotkeyFocusOnAppFinderButton")});}if(s){b.push({text:"Alt+F",description:r.i18n.getText("hotkeyFocusOnSearchButton")});}b.push({text:"Alt+H",description:r.i18n.getText("hotkeyHomePage")});b.push({text:"Alt+M",description:r.i18n.getText("hotkeyFocusOnMeArea")});b.push({text:"Alt+N",description:r.i18n.getText("hotkeyFocusOnNotifications")});b.push({text:"Alt+S",description:r.i18n.getText("hotkeyFocusOnSettingsButton")});b.push({text:"Ctrl+Comma",description:r.i18n.getText("hotkeyOpenSettings")});if(p){b.push({text:"Ctrl+Enter",description:r.i18n.getText("hotkeySaveEditing")});}if(s){var t;if(D.os.macintosh){t="Cmd+Shift+F";}else{t="Ctrl+Shift+F";}b.push({text:t,description:r.i18n.getText("hotkeyFocusOnSearchField")});}}var o=new S();b.forEach(function(v){o.addContent(new sap.m.Label({text:v.description}));o.addContent(new sap.m.Text({text:v.text}));});var d=new sap.m.Dialog({id:"hotKeysGlossary",title:r.i18n.getText("hotKeysGlossary"),contentWidth:"29.6rem",content:o,afterClose:function(){d.destroy();}});d.setBeginButton(new sap.m.Button({text:r.i18n.getText("okBtn"),press:function(){d.close();}}));d.open();},_blockBrowserDefault:function(e){if(D.browser.name==="ie"){var s=window.document.getElementById("shell-header");if(s){s.setAttribute("accesskey",e.key);window.setTimeout(function(){s=window.document.getElementById("shell-header");if(s){s.removeAttribute("accesskey");}},0);}}e.preventDefault();},_handleAltShortcutKeys:function(e){var s=sap.ui.getCore().byId("shell-header"),c=sap.ushell.Container.getRenderer("fiori2").getShellConfig(),u=sap.ui.getCore().byId("sapUshellMeAreaPopover"),n=sap.ui.getCore().byId("shellNotificationsPopover");if(s){if(e.keyCode===65){this._blockBrowserDefault(e);var o=window.document.getElementById("openCatalogBtn");if(o){o.focus();return;}if(c.moveAppFinderActionToShellHeader){this._focusItemInOverflowPopover("openCatalogBtn");return;}this._focusItemInUserMenu("openCatalogBtn");}else if(e.keyCode===70){this._blockBrowserDefault(e);var b=window.document.getElementById("sf");if(b){b.focus();}}else if(e.keyCode===72){this._blockBrowserDefault(e);window.hasher.setHash(s.getHomeUri());if(u&&u.isOpen()){E.emit("showMeArea",false);}if(n&&n.isOpen()){E.emit("showNotifications",false);}var d=window.document.getElementById("shellAppTitle");if(d){d.focus();}}else if(e.keyCode===77){this._blockBrowserDefault(e);if(!(u&&u.isOpen())){E.emit("showMeArea",Date.now());}}else if(e.keyCode===78){this._blockBrowserDefault(e);if(!(n&&n.isOpen())){E.emit("showNotifications",Date.now());}}else if(e.keyCode===83){this._blockBrowserDefault(e);var f=window.document.getElementById("userSettingsBtn");if(f){f.focus();return;}if(c.moveUserSettingsActionToShellHeader){this._focusItemInOverflowPopover("userSettingsBtn");return;}this._focusItemInUserMenu("userSettingsBtn");}}},_handleCtrlShortcutKeys:function(e){if(e.shiftKey){if(e.keyCode===70){var s=window.document.getElementById("sf");if(s){s.click();}}}else if(e.keyCode===188){var o=sap.ui.getCore().byId("userSettingsBtn");if(o){o.firePress();}}else if(e.keyCode===112){this._handleAccessOverviewKey();}else if(e.keyCode===83){var b=window.document.getElementById("appFinderSearch-I");if(b){b.focus();}e.preventDefault();}else if(e.keyCode===13){var d=sap.ui.getCore().byId("sapUshellDashboardFooterDoneBtn");if(d){d.firePress();}}},handleShortcuts:function(e){if(D.os.macintosh&&e.metaKey&&e.shiftKey&&e.keyCode===70){var s=window.document.getElementById("sf");if(s){s.focus();}e.preventDefault();}else if(e.altKey){this._handleAltShortcutKeys(e);}else if(e.ctrlKey){this._handleCtrlShortcutKeys(e);}},registerAppKeysHandler:function(h){this.fnExternalKeysHandler=h;this.sLastExternalKeysHandlerUrl=hasher.getHash();},resetAppKeysHandler:function(){this.fnExternalKeysHandler=null;},getAppKeysHandler:function(){return this.fnExternalKeysHandler;},registerAppShortcuts:function(h,s){this.fnExternalShortcuts=h;this.aShortcutsDescriptions=s;},_handleFocusBackToMe:function(e,i){this.bFocusOnShell=true;var f;if(i){f=window.document.getElementById(i);}else{this.fromOutside=true;if(e){e.preventDefault();this.bForwardNavigation=!e.shiftKey||e.key==="F6";}f=window.document.getElementById("sapUshellHeaderAccessibilityHelper");}if(f){f.focus();}this.bFocusPassedToExternalHandlerFirstTime=true;},setIsFocusHandledByAnotherHandler:function(h){this.isFocusHandledByAnotherHandler=h;},sendFocusBackToShell:function(p){var e,i;if(typeof p==="string"){i=p;}else if(typeof p==="object"){e=p;}this._handleFocusBackToMe(e,i);},_handleEventUsingExteranlKeysHandler:function(e){if(!this.bFocusOnShell&&!this.isFocusHandledByAnotherHandler){if(this.fnExternalKeysHandler&&jQuery.isFunction(this.fnExternalKeysHandler)){this.fnExternalKeysHandler(e,this.bFocusPassedToExternalHandlerFirstTime);this.bFocusPassedToExternalHandlerFirstTime=false;}}this.setIsFocusHandledByAnotherHandler(false);},_cancelHelpEvent:function(e){e.preventDefault();document.removeEventListener("help",this._cancelHelpEvent);},init:function(m){this.oModel=m;document.addEventListener("keydown",function(e){if(e.keyCode===16){return;}if(e.shiftKey){this.bForwardNavigation=false;}else{this.bForwardNavigation=true;}if(e.key==="Tab"||e.key==="F6"){setTimeout(function(){this._handleEventUsingExteranlKeysHandler(e);}.bind(this),0);}else{this._handleEventUsingExteranlKeysHandler(e);}if(e.keyCode===18){if(e.location===window.KeyboardEvent.DOM_KEY_LOCATION_LEFT){this.isleftAltPressed=true;}else{this.isleftAltPressed=false;}}if(this.isleftAltPressed||!e.altKey){this.handleShortcuts(e);if(this.fnExternalShortcuts){this.fnExternalShortcuts(e);}}}.bind(this),true);this._cancelHelpEvent=this._cancelHelpEvent.bind(this);}};var a=new A();E.on("AppRendered").do(A.prototype.appOpenedHandler.bind(a));return a;},true);
