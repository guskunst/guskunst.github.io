// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/System","sap/ushell/Ui5ServiceFactory","sap/ushell/Ui5NativeServiceFactory","sap/ui/base/EventProvider","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/core/service/ServiceFactory","sap/ui/core/Control","jquery.sap.global","jquery.sap.mobile"],function(u,S,U,a,E,b,c,C,q){"use strict";var d="sap.ushell.services.Container",f="sap.ushell.Container.dirtyState.",o,p,F;function g(){close();}function r(){document.location="about:blank";}function h(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function j(s){return(o.services&&o.services[s])||{};}function k(n,s,P,A){var e=j(n).adapter||{},i=e.module||h(s.getPlatform())+"."+n+"Adapter";function t(){return new(q.sap.getObject(i))(s,P,{config:e.config||{}});}if(A){return new Promise(function(v,w){var M=i.replace(/\./g,"/");sap.ui.require([M],function(){try{v(t());}catch(x){w(x);}});});}q.sap.require(i);return t();}function l(A){var n=new E(),s=false,R=[],t={},v="sap.ushell.Container."+A.getSystem().getPlatform()+".remoteSystem.",w={},G,x,L=u.getLocalStorage(),y=new u.Map(),z="sap.ushell.Container."+A.getSystem().getPlatform()+".sessionTermination",B=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon();}};this.createRenderer=function(e,i){var I,J,K;q.sap.measure.start("FLP:Container.InitLoading","Initial Loading","FLP");u.setPerformanceMark("FLP - renderer created");e=e||o.defaultRenderer;if(!e){throw new Error("Missing renderer name");}K=(o.renderers&&o.renderers[e])||{};J=K.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);if(K.componentData&&K.componentData.config){I={config:K.componentData.config};}function M(){var N=new(q.sap.getObject(J))({componentData:I});var O=N instanceof sap.ui.core.UIComponent?new sap.ui.core.ComponentContainer({component:N,height:"100%",width:"100%"}):N;if(!(O instanceof C)){throw new Error("Unsupported renderer type for name "+e);}O.placeAt=function(P,Q){var T=P,V="canvas",W=document.body;if(P===W.id){T=document.createElement("div");T.setAttribute("id",V);T.classList.add("sapUShellFullHeight");switch(Q){case"first":if(W.firstChild){W.insertBefore(T,W.firstChild);break;}case"only":W.innerHTML="";default:W.appendChild(T);}P=V;Q="";}C.prototype.placeAt.call(this,P,Q);};t[e]=N;n.fireEvent("rendererCreated",{renderer:N});return O;}if(i){return new Promise(function(N,O){var P=J.replace(/\./g,"/");sap.ui.require([P],function(){try{N(M());}catch(Q){O(Q);}});});}q.sap.require(J);return M();};this.getRenderer=function(e){var i,I;e=e||o.defaultRenderer;if(e){i=t[e];}else{I=Object.keys(t);if(I.length===1){i=t[I[0]];}else{q.sap.log.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",undefined,d);}}if(i instanceof sap.ui.core.ComponentContainer){return i.getComponentInstance();}return i;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,I=new q.Deferred(),J=q.sap.uid(),K,P=0,M=this.DirtyState.CLEAN;function N(){if(P===0||M===B.DirtyState.DIRTY){I.resolve(M);q.sap.log.debug("getGlobalDirty() Resolving: "+M,null,"sap.ushell.Container");}}function O(Q){if(Q.key.indexOf(f)===0&&Q.newValue!==B.DirtyState.INITIAL&&Q.newValue!==B.DirtyState.PENDING){q.sap.log.debug("getGlobalDirty() Receiving event key: "+Q.key+" value: "+Q.newValue,null,"sap.ushell.Container");if(Q.newValue===B.DirtyState.DIRTY||Q.newValue===B.DirtyState.MAYBE_DIRTY){M=Q.newValue;}P-=1;N();}}try{L.setItem(J,"CHECK");L.removeItem(J);}catch(e){q.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return I.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=I;window.addEventListener("storage",O);I.always(function(){window.removeEventListener("storage",O);G=undefined;});for(i=L.length-1;i>=0;i-=1){K=L.key(i);if(K.indexOf(f)===0){if(L.getItem(K)==="PENDING"){L.removeItem(K);q.sap.log.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+K,null,"sap.ushell.Container");}else{P+=1;u.localStorageSetItem(K,this.DirtyState.PENDING,true);q.sap.log.debug("getGlobalDirty() Requesting status for: "+K,null,"sap.ushell.Container");}}}N();setTimeout(function(){if(I.state()!=="resolved"){I.resolve("MAYBE_DIRTY");q.sap.log.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},P*2000);return I.promise();};this.getLogonSystem=function(){return A.getSystem();};this.getUser=function(){return A.getUser();};this.getDirtyFlag=function(){for(var i=0;i<R.length;i++){s=s||R[i].call();}return s;};this.setDirtyFlag=function(i){s=i;};this.sessionKeepAlive=function(){if(A.sessionKeepAlive){A.sessionKeepAlive();}};this.registerDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}R.push(e);};this.getService=function(e,P,i){var I={},M,K,J,N,O,Q;function T(X){var Y=new q.Deferred();if(!X){throw new Error("Missing system");}Y.resolve(k(e,X,P));sap.ushell.Container.addRemoteSystem(X);return Y.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}O=j(e);M=O.module||"sap.ushell.services."+e;K=M+"/"+(P||"");Q={config:O.config||{}};function V(X,N){I.createAdapter=T;return new X(N,I,P,Q);}function W(J,i){var X;if(J.hasNoAdapter){X=new J(I,P,Q);}else{N=k(e,A.getSystem(),P,i);if(i){return N.then(function(Y){var X=V(J,Y);y.put(K,X);return X;});}X=V(J,N);}y.put(K,X);return i?Promise.resolve(X):X;}if(!y.containsKey(K)){if(i){return new Promise(function(X){sap.ui.require([M.replace(/[.]/g,"/")],function(Y){X(W(Y,true));});});}J=sap.ui.requireSync(M.replace(/[.]/g,"/"));return W(J);}if(i){return Promise.resolve(y.get(K));}return y.get(K);};this.getServiceAsync=function(e,P){return Promise.resolve(this.getService(e,P,true));};function D(){var I,J,i,K;for(i=L.length-1;i>=0;i-=1){K=L.key(i);if(K.indexOf(v)===0){try{I=K.substring(v.length);J=JSON.parse(L.getItem(K));w[I]=new S(J);}catch(e){L.removeItem(K);}}}return w;}function H(){if(typeof OData==="undefined"){return;}function e(i,I,J){q.sap.log.warning(i,null,"sap.ushell.Container");if(J){setTimeout(J.bind(null,i),5000);}return{abort:function(){return;}};}OData.read=function(i,I,J){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",I,J);};OData.request=function(i,I,J){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",I,J);};}this.addRemoteSystem=function(e){var i=e.getAlias(),O=w[i];if(O){if(O.toString()===e.toString()){return;}q.sap.log.warning("Replacing "+O+" by "+e,null,"sap.ushell.Container");}else{q.sap.log.debug("Added "+e,null,"sap.ushell.Container");}w[i]=e;u.localStorageSetItem(v+i,e);};this.addRemoteSystemForServiceUrl=function(e){var M,i={baseUrl:";o="};if(!e||e.charAt(0)!=="/"||e.indexOf("//")===0){return;}M=/^[^?]*;o=([^\/;?]*)/.exec(e);if(M&&M.length>=2){i.alias=M[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){i.platform="hana";i.alias=i.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){i.platform="abap";}if(i.alias&&i.platform){this.addRemoteSystem(new S(i));}};this.attachLogoutEvent=function(e){n.attachEvent("Logout",e);};this.detachLogoutEvent=function(e){n.detachEvent("Logout",e);};this.attachRendererCreatedEvent=function(e){n.attachEvent("rendererCreated",e);};this.detachRendererCreatedEvent=function(e){n.detachEvent("rendererCreated",e);};this.logout=function(){var i=new q.Deferred();function I(){A.logout(true).always(function(){L.removeItem(z);i.resolve();});}function J(){if(n.fireEvent("Logout",true)){I();}else{setTimeout(I,1000);}}function K(){var w,M=[];if(x){window.removeEventListener("storage",x);}u.localStorageSetItem(z,"pending");B._suppressOData();w=B._getRemoteSystems();Object.keys(w).forEach(function(N){try{M.push(k("Container",w[N]).logout(false));}catch(e){q.sap.log.warning("Could not create adapter for "+N,e.toString(),"sap.ushell.Container");}L.removeItem(v+N);});q.when.apply(q,M).done(J);}if(typeof A.addFurtherRemoteSystems==="function"){A.addFurtherRemoteSystems().always(K);}else{K();}return i.promise();};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.logonFrameProvider=e;}};this.setXhrLogonTimeout=function(P,T){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(P,T);}};this.getFLPUrl=function(i){var e=u.getLocationHref(),I=e.indexOf(this.getService("URLParsing").getShellHash(e));if(I===-1||i===true){return e;}return e.substr(0,I-1);};this._closeWindow=g;this._redirectWindow=r;this._getRemoteSystems=D;this._suppressOData=H;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,i,I){B.addRemoteSystemForServiceUrl(I);});if(typeof A.logoutRedirect==="function"){x=function(e){function i(){B._closeWindow();B._redirectWindow();}if(sap.ushell.Container!==B){return;}if(e.key.indexOf(v)===0&&e.newValue&&e.newValue!==L.getItem(e.key)){u.localStorageSetItem(e.key,e.newValue);}if(e.key===z){if(e.newValue==="pending"){B._suppressOData();if(n.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener("storage",x);}this._getFunctionsForUnitTest=function(){return{createAdapter:k};};}function m(s,A){s.forEach(function(e){var i=U.createServiceFactory(e,A);b.register("sap.ushell.ui5service."+e,i);});}function _(s){s.forEach(function(e){var i=a.createServiceFactory(e);b.register("sap.ushell.ui5service."+e,i);});}sap.ushell.bootstrap=function(P,A){var e,D=new q.Deferred();q.sap.initMobile();if(sap.ushell.Container!==undefined){e=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+F);q.sap.log.error(e,e.stack,d);throw e;}F=(new Error()).stack;o=q.extend({},true,window["sap-ushell-config"]||{});p=A;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}if(o.modulePaths){Object.keys(o.modulePaths).forEach(function(M){q.sap.registerModulePath(M,o.modulePaths[M]);});}m(["Personalization","URLParsing","CrossApplicationNavigation"],true);m(["Configuration"],false);_(["CardNavigation","CardUserRecents","CardUserFrequents"]);var s=new S({alias:"",platform:o.platform||P});k("Container",s,null,true).then(function(i){i.load().then(function(){function n(){var v,w;var x=window["sap-ushell-config"];if(!x||!x.services){return false;}v=x.services.PluginManager;w=v&&v.config;return w&&w.loadPluginsFromSite;}sap.ushell.Container=new l(i);var t=[sap.ushell.Container.getServiceAsync("PluginManager")];if(n()){t.push(sap.ushell.Container.getServiceAsync("CommonDataModel"));}Promise.all(t).then(function(v){var w=v[0],x=v[1];var y=x?x.getPlugins():q.when({});y.then(function(z){var B=q.extend(true,{},o.bootstrapPlugins,z);w.registerPlugins(B);});}).then(function(){if(u.hasFLPReadyNotificationCapability()){u.getPrivateEpcm().doEventFlpReady();}});D.resolve();});});return D.promise();};});
