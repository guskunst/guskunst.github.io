// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/components/applicationIntegration/elements/model','sap/ushell/components/applicationIntegration/Storage','sap/ushell/components/container/ApplicationContainer','sap/ushell/ui5service/ShellUIService','sap/ushell/components/applicationIntegration/application/Application','sap/ushell/components/applicationIntegration/relatedServices/RelatedServices','sap/ushell/components/applicationIntegration/relatedShellElements/RelatedShellElements','sap/ushell/components/applicationIntegration/configuration/AppMeta','sap/ushell/services/AppConfiguration','sap/ushell/utils','sap/ushell/resources','sap/ui/Device','sap/ushell/Config','sap/ushell/EventHub','sap/ushell/ui5service/AppIsolationService','sap/ushell/ApplicationType'],function(E,S,A,a,b,R,c,d,e,u,r,D,C,f,g,h){"use strict";function i(){var v,j=["URL"],s,o,k,l,m=false,n={},p={home:{embedded:"embedded-home",headerless:"headerless-home",merged:"blank-home",blank:"blank-home"},app:{minimal:"minimal",app:"app",standalone:"standalone",embedded:"embedded",headerless:"headerless",merged:"merged",home:"home",blank:"blank",lean:"lean"}},q,G=[],t={};this.shellElements=function(){return c;};this.service=function(){return R;};this.isCurrentApp=function(w){return(n.appId===w);};this.isAppWithSimilarShellHashInCache=function(w,F){var x=S.get(w);if(x){if(x.shellHash===F){return true;}else{return false;}}else{return false;}};this.isAppInCache=function(w){return!!S.get(w);};this.normalizeAppId=function(w){var x="-component",y=w.endsWith(x);if(y){return w.substring(0,w.length-x.length);}else{return w;}};this.onComponentCreated=function(w,x,y){var z=y.component,B=this.normalizeAppId(z.getId());if(this.isAppInCache(B)){S.get(B).app=z;this.active(B);}else{n.app=z;if(z.active){z.active();}}};this.onGetMe=function(w,x,y){y.AppLifeCycle=this;};this.store=function(w){var x=S.get(w);if(x){b.store(x.app);R.store(x.service);d.store(x.meta);}};this.destroy=function(w,F){var x=S.get(w);this.removeControl(w);if(x){x.container.destroy();S.remove(w);}else{b.destroy(F);c.destroy(F);d.destroy(F);}};this.restore=function(w){var x=S.get(w);if(x){b.restore(x.app);R.restore(x.service);d.restore(x.meta);}};this.active=function(w){var x=S.get(w);if(x){b.active(x.app);}};this.onAfterNavigate=function(F,w,T){var I;if(F&&w){if(S.get(F)){this.store(F);}else if(w.getApplicationType&&this.applicationIsStatefulType(w.getApplicationType())){if(T.indexOf("Shell-appfinder-component")>0||T.indexOf("Shell-home-component")>0){w.postMessageRequest("sap.gui.triggerCloseSessionImmediately");}}else{I=j.indexOf(w.getApplicationType)>=0;if(this.isAppOfTypeCached(F,I)===false){this.destroy(F,w);}}if(F.indexOf("Shell-appfinder-component")>0){sap.ui.getCore().getEventBus().publish("sap.ushell","appFinderAfterNavigate");}}if(T){if(S.get(T)){this.restore(T);}else{}}};this.storeApp=function(w,x,T,F){if(!this.isAppInCache(w)){S.set(w,{service:R.create(),shellHash:F,appId:w,stt:'loading',appRelatedElements:c.getAppRelatedElement(),container:x,meta:e.getMetadata(T),app:undefined});return true;}return false;};this.resoterApp=function(w){if(this.isAppInCache(w)){n=S.get(w);}};this.isAppOfTypeCached=function(w,I){if(!m&&w.indexOf(s)!==-1){return true;}if(!m&&w.indexOf("Shell-appfinder")!==-1){return true;}if(jQuery.sap.getUriParameters().get("sap-keep-alive")=="true"&&I){return true;}return false;};i.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};this.openApp=function(w,T,x,F){var y,I=j.indexOf(T.applicationType)>=0;var z="application"+w;if(this.isAppOfTypeCached(z,I)||this.isCachedEnabledAsAppParameter(x,T)){if(!this.isAppInCache(z)){y=this.createApplicationContainer(w,T);this.storeApp(z,y,T,F);}this.resoterApp(z);}else if(this.applicationIsStatefulType(T.applicationType)){y=this.getStatefulContainer(T.applicationType);if(!y){y=this.createApplicationContainer(w,T);this.setStatefulContainer(T.applicationType,y);y.setIsStateful(true);}n={appId:z,stt:'loading',container:y,meta:e.getMetadata(T),app:undefined};}else{y=this.createApplicationContainer(w,T);n={appId:z,stt:'loading',container:y,meta:e.getMetadata(T),app:undefined};}};this.getAppMeta=function(){return d;};this.init=function(w,I,x,y,z,B,F){o=new a({scopeObject:z.ownerComponent,scopeType:"component"});l=new g({scopeObject:z.ownerComponent,scopeType:"component"});k=w;v=I;s=x;d.init(s);m=y;S.init(B,function(H){var J=H.value;this.destroy(J.appId,J.container);}.bind(this));sap.ui.getCore().getEventBus().subscribe("sap.ushell","appComponentLoaded",this.onComponentCreated,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell","getAppLifeCycle",this.onGetMe,this);c.init(this.getElementsModel(),F);};this.addControl=function(w){v.addCenterViewPort(w);};this.removeControl=function(I){v.removeCenterViewPort(I,true);};this.removeApplication=function(I){var w=this.getControl(I);if(w){this.removeControl(w.getId());w.destroy();}};this.getControl=function(I){return v&&(v.getViewPortControl('centerViewPort',"application-"+I)||v.getViewPortControl('centerViewPort',"applicationShellPage-"+I));};this.getViewPortContainer=function(){return v;};this.navTo=function(I){v.navTo('centerViewPort',I,'show');};this.getCurrentApplication=function(){return n;};this.setApplicationFullWidth=function(I){var w=this.getCurrentApplication();if(w.container){w.container.toggleStyleClass("sapUShellApplicationContainerLimitedWidth",!I);}};this.createComponent=function(w,P){this.shellElements().setDangling(true);return b.createComponent(w,P);};this.getAppContainer=function(w,x,I,y,F){x.shellUIService=o.getInterface();x.appIsolationService=l.getInterface();x.targetNavigationMode=I?"explace":"inplace";this.openApp(w,x,y,F);if(G.length>0){n.container.registerShellCommunicationHandler(G);}if(t["UI5APP"]){n.container.setIframeHandlers(t["UI5APP"]);}return n.container;};this.getShellUIService=function(){return o;};this.getAppIsolationService=function(){return l;};this.initShellUIService=function(w){o._attachHierarchyChanged(d.onHierarchyChange.bind(this));o._attachTitleChanged(d.onTitleChange.bind(this));o._attachRelatedAppsChanged(d.onRelatedAppsChange.bind(this));o._attachBackNavigationChanged(w.fnOnBackNavigationChange.bind(this));};this.parseStatefulContainerConfiguration=function(w){var x={};if(w){var y={"GUI":true};Object.keys(w).filter(function(z){return true===w[z]&&y[z];}).map(function(U){var z=U;if(z==="GUI"){z="TR";}return z;}).forEach(function(z){x[z]=null;});}q=x;};this.setStatefulApplicationContainer=function(w){q=w;};this.getStatefulApplicationContainer=function(){return q;};this.applicationIsStatefulType=function(w){return q.hasOwnProperty(w);};this.getStatefulContainer=function(w){return q[w];};this.setStatefulContainer=function(w,x){q[w]=x;};this.statefulContainerForTypeExists=function(w){return!!this.getStatefulContainer(w);};this.getAllApplicationContainers=function(){return Object.keys(q).map(function(K){return q[K];}).filter(function(w){return!!w;});};this.getElementsModel=function(){return E;};this.activeContainer=function(w){var x=this.getAllApplicationContainers();x.forEach(function(y){jQuery.sap.log.info("Deactivating container "+y.getId());y.setActive(false);});if(w){jQuery.sap.log.info("Activating container "+w.getId());w.setActive(true);}};this.reuseApplicationContainer=function(w,x,y){var z=this;return w.setNewApplicationContext(x,y).then(function(){z.navTo(w.getId());w.toggleStyleClass("hidden",false);jQuery.sap.log.info("New application context opened successfully in an existing transaction UI session.");},function(B){jQuery.sap.log.error(B&&B.message||B);});};this.createApplicationContainer=function(w,x){return b.createApplicationContainer(w,x);};this.publishNavigationStateEvents=function(w,x,O){var y,I=w.getId?w.getId():"",z=this;var B=e.getMetadata(),F=B.icon,T=B.title;w.addEventDelegate({onAfterRendering:O});y=w.exit;w.exit=function(){if(y){y.apply(this,arguments);}z.getAppMeta()._applyContentDensityByPriority();setTimeout(function(){var H=jQuery.extend(true,{},x);delete H.componentHandle;H["appId"]=I;H["usageIcon"]=F;H["usageTitle"]=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",H);jQuery.sap.log.info('app was closed');},0);var P=z._publicEventDataFromResolutionResult(x);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appClosed",P);};};this._publicEventDataFromResolutionResult=function(w){var P={};if(!w){return w;}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(x){P[x]=w[x];});Object.freeze(P);return P;};this.isCachedEnabledAsAppParameter=function(w,T){if(w&&w.params&&w.params["sap-keep-alive"]){if(w.params["sap-keep-alive"]=="true"){return true;}}if(T&&T.url){if(jQuery.sap.getUriParameters(T.url).get("sap-keep-alive")=="true"){return true;}}return false;};this.getInMemoryInstance=function(I,F){var w="application-"+I,x=S.get(w);if(x){if(x.shellHash===F){return{isInstanceSupported:true,appId:x.appId,container:x.container};}else{return{isInstanceSupported:false,appId:x.appId,container:x.container};}}return{isInstanceSupported:false,appId:undefined,container:undefined};};this.handleControl=function(I,w,x,T,W,F){var y=this.getControl(I),z=this.statefulContainerForTypeExists(T.applicationType),M=e.getMetadata(T),B=j.indexOf(T.applicationType)>=0,H="application-"+I,J=this.isAppOfTypeCached(H,B)||this.isCachedEnabledAsAppParameter(x,T),K=T.applicationType,L;if(T.applicationType==="URL"&&T.additionalInformation&&T.additionalInformation.startsWith("SAPUI5.Component=")){K="SAPUI5";}L=h.getDefaultFullWidthSetting(K);if(!z&&y&&!J){this.destroy(y.getId(),y);y=W(I,M,x,T,w,T.fullWidth||M.fullWidth||L,F);}else if(!y){y=W(I,M,x,T,w,T.fullWidth||M.fullWidth||L,F);}if(!z){this.resoterApp(y.getId());this.navTo(y.getId());}v.switchState("Center");u.setPerformanceMark("FLP -- centerViewPort");this.activeContainer(y);if(z){this.reuseApplicationContainer(y,T.applicationType,T.url);}};this.switchViewState=function(w,x,y){var z=w,B;if(p[w]&&p[w][k]){z=p[w][k];}var I=C.last("/core/shell/model/currentState/stateName")==="home";if(!I&&(!n.appId||!S.get(n.appId))){E.destroyManageQueue();}B=S.get("application"+y);if(B){c.restore(B);}else{c.assignNew(w);}E.switchState(z,x,y);this.shellElements().setDangling(false);this.shellElements().processDangling();if(w==="searchResults"){this.getElementsModel().setProperty("/lastSearchScreen",'');if(!window.hasher.getHash().indexOf("Action-search")===0){var F=sap.ui.getCore().getModel("searchModel");window.hasher.setHash("Action-search&/searchTerm="+F.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(F.getProperty("/uiFilter/dataSource").getJson()));}}};this.registerShellCommunicationHandler=function(w){b.registerShellCommunicationHandler(w);};this.registerIframeCommunicationHandler=function(H,T){t[T]=H;};this.postMessageToIframeApp=function(w,I,M,W){var x,y=b.getActiveAppContainer(),z=[];if(y&&b.isAppTypeSupported(y,w,I)){z.push(b.postMessageToIframeApp(y,w,I,M,W));}if(!b.isActiveOnly(w,I)){S.forEach(function(F){if(F&&F.value&&F.value.container){if(b.isAppTypeSupported(F.value.container,w,I)){z.push(b.postMessageToIframeApp(F.value.container,w,I,M,W));}}});}x=b.getResponseHandler(w,I);var B=Promise.all(z);if(x){x(B);}return B;};}return new i();},true);
