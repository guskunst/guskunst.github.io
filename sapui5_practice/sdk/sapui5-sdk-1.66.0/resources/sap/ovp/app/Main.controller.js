sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/library","sap/ui/model/odata/ODataUtils","sap/ovp/cards/generic/Component","sap/ui/generic/app/navigation/service/NavigationHandler","sap/m/MessageBox","sap/ovp/cards/CommonUtils","sap/ovp/cards/PersonalizationUtils","sap/ovp/cards/charts/VizAnnotationManager","sap/m/BusyDialog","sap/ui/model/Filter","sap/ui/fl/ControlPersonalizationAPI","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/m/ColumnListItem","sap/m/Text","sap/m/Switch","sap/m/Table","sap/m/Column","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel","jquery.sap.global","sap/ui/Device","sap/ovp/ui/SmartphoneHeaderToggle","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataMetadata","sap/ui/fl/FlexControllerFactory","sap/ui/thirdparty/hasher","sap/m/BackgroundDesign","sap/m/ListSeparators","sap/ui/core/TextAlign","sap/ovp/support/lib/CommonMethods","sap/ovp/app/resources","sap/ovp/app/TemplateBaseExtension","sap/ui/core/mvc/ControllerExtension","sap/ovp/cards/loading/State"],function(C,S,O,a,N,M,b,P,V,B,F,c,d,U,f,T,g,h,m,n,D,J,q,o,p,r,s,t,u,v,L,w,x,y,z,A,E){"use strict";var G="sap.ovp.app.customData",H="sap.ovp.app.extensionData";return C.extend("sap.ovp.app.Main",{getCustomAppStateDataExtension:function(e){},restoreCustomAppStateDataExtension:function(e){},getCustomFilters:function(){},onCustomActionPress:function(e){},onCustomParams:function(e){},modifyStartupExtension:function(e){},getCustomMessage:function(R,e){},onBeforeRebindPageExtension:function(){},oRefreshTimer:null,nRefreshInterval:0,filterItemInFocus:null,bFinishedCardsCreationProcess:false,storeIncomingDeltaChanges:function(e){this.deltaCardsInfo=e?e:[];},appendIncomingDeltaChange:function(e){this.deltaChanges.push(e);},templateBaseExtension:z,onInit:function(){this.bDeltaChangesEnabled=false;this.deltaChanges=[];this._initFlexibilityPersonalization();this.getView().loaded().then(function(){var e=this.getOwnerComponent();var i=e.getMetadata();if(e&&i&&i.getManifest()){x.setAppComponent(this.getOwnerComponent());}x.setApplicationStatus(x.mApplicationStatus.LOADING);x.publishEvent("elements","ViewRenderingStarted",{});this.oContainer=sap.ushell&&sap.ushell.Container;this.aErrorCards=[];this.oCardsModels={};this.aFilters=[];this.errorHandlingObject={atLeastOneRequestSuccess:false,errorLoadingTimeout:{}};this.sPreviousEntityType="";this.sCurrentEntityType="";this.oLoadedComponents={};this.bGlobalFilterLoaded=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;q.sap.measure.start("ovp:GlobalFilter","Main Controller init -> Global Filter loaded","ovp");q.sap.measure.start("ovp:Personalization","Main Controller init -> Personalization loaded","ovp");this.isInitialLoading=true;var j=this.getUIModel();this.bDisableErrorPage=j&&j.getProperty("/disableErrorPage");this.oNavigationHandler=this.oNavigationHandler||new N(this);this.getLayout().addStyleClass("ovpLayoutElement");this.oState={};this.oState.oSmartFilterbar=this.byId("ovpGlobalFilter");this._initGlobalFilter();this._createModelForTile();this._checkJamAuth();b.enable(this,this.oNavigationHandler);}.bind(this));},performRecreationOfCard:function(e){this.createLoadingCard(e);e.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(e.model);e=this._getTemplateForChart(e);this._loadCardComponent(e.template);this._createModelViewMap(e);q.when(this.createCard(e)).then(function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var i=this.getLayout().getDashboardLayoutUtil();if(i){var j=i.getDashboardLayoutModel();var k=j.getCardById(e.id);i._sizeCard(k);j.extractCurrentLayoutVariant();}}}.bind(this));},recreateCard:function(e){var i=this._getCardFromManifest(e.cardId);if(i.template=="sap.ovp.cards.charts.analytical"||i.template=="sap.ovp.cards.charts.smart.chart"){i.settings.chartAnnotationPath=e.chartAnnotationPath;i.settings.colorPalette=e.colorPalette;i.settings.bEnableStableColors=e.bEnableStableColors;if(e.navigation){i.settings.navigation=e.navigation;}}if(e.entitySet){i.settings.entitySet=e.entitySet;}i.settings.annotationPath=e.annotationPath;i.settings.dynamicSubtitleAnnotationPath=e.dynamicSubtitleAnnotationPath;i.settings.presentationAnnotationPath=e.presentationAnnotationPath;i.settings.selectionAnnotationPath=e.selectionAnnotationPath;i.settings.selectionPresentationAnnotationPath=e.selectionPresentationAnnotationPath;i.settings.kpiAnnotationPath=e.kpiAnnotationPath;i.settings.dataPointAnnotationPath=e.dataPointAnnotationPath;i.settings.identificationAnnotationPath=e.identificationAnnotationPath;i.settings.headerAnnotationPath=e.headerAnnotationPath;var j=i.settings.selectedKey;i.settings.selectedKey=e.selectedKey;if(i){this.performRecreationOfCard(i);}var k={changeType:"viewSwitch",content:{cardId:e.cardId,selectedKey:e.selectedKey,oldKey:j},isUserDependent:true};this.savePersonalization(k);},recreateRTAClonedCard:function(e){var i=this._getCardFromManifest(e.id);if(i){i.settings=e.settings;this.performRecreationOfCard(i);}},onBeforeRendering:function(){},onRequestCompleted:function(R){if(R&&R.getParameters()&&R.getParameters().success){var e=R.getParameters().response&&R.getParameters().response.responseText?JSON.parse(R.getParameters().response.responseText):"";if(e&&e.d&&e.d.results&&e.d.results.length==0){this.fVerifyAndSetErrorOrCustomMessageCard(R,true);}}else if(R&&R.getParameters()&&R.getParameters().response&&R.getParameters().response.statusCode!==0){this.fVerifyAndSetErrorOrCustomMessageCard(R,false);}},fVerifyAndSetErrorOrCustomMessageCard:function(R,i){var k;for(k in this.aOrderedCards){var j=this.getView().byId(this.aOrderedCards[k].id);var l=j&&j.getComponentInstance();var I=l&&l.getComponentData();var K=l&&l.getRootControl();var Q=K&&K.getController();var W=Q&&Q.getCardItemsBinding();if(W){var X=R.getParameters().url;var Y=W.sCustomParams;var Z=W.sFilterParams;var $=W.sPath.replace("/","");var _=W.sRangeParams;var a1=W.sCountMode&&W.sCountMode.indexOf("Inline");var b1=W.sSortParams;var c1=R.getSource().sServiceUrl;var d1=R.oSource&&R.oSource.oMetadata;var e1=Q.getEntityType();var f1;try{f1=sap.ui.model.odata.ODataUtils.createFilterParams(this.aFilters,d1,e1);}catch(e){q.sap.log("applying filter on a card which is not valid");}X=X.split($).join("").split(Y).join("").split(Z).join("").split(_).join("").split(b1).join("").split(c1).join("").split(f1).join("").split("?").join("").split("&").join("").split("/").join("");if(!a1){X=X.split("$inlinecount=allpages").join("");}var g1=I&&I.cardId;var h1=this._getCardFromManifest(g1);if(X){var i1=/sap-client=[0-9][0-9][0-9]/i;X=X.replace(i1,"");}if(h1&&this.aErrorCards.indexOf(g1)==-1&&!X){var j1=q.extend(true,{},R);var k1=q.extend(true,{},h1);var l1=this.getCustomMessage(j1,k1.id);l1=l1&&typeof l1==="object"?l1:"";if(i&&!l1){return;}if(l1){if(i&&l1.hasOwnProperty("sMessage")&&l1.sMessage&&typeof l1.sMessage==="string"){R.getParameters().response.statusText=l1.sMessage;if(l1.hasOwnProperty("sIcon")&&l1.sIcon&&typeof l1.sIcon==="string"&&l1.sIcon.indexOf("sap-icon")!==-1){R.getParameters().response.sIcon=l1.sIcon;}}else if(!i&&l1.hasOwnProperty("sMessage")&&l1.sMessage&&typeof l1.sMessage==="string"){R.getParameters().response.statusText=l1.sMessage;}}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var m1=this.getLayout();var n1=m1.getDashboardLayoutModel();var o1=n1.getCardById(h1.id);h1=o1;}this.aErrorCards.push(h1.id);this.createErrorCard(h1,R);}}}},onAfterRendering:function(){x.setApplicationStatus(x.mApplicationStatus.RENDERED);x.publishEvent("elements","ViewRendered",{});this.oModelViewMap={};this.oAppStatePromise=null;if(this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes")){this.nRefreshInterval=this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes");this.nRefreshInterval=(this.nRefreshInterval<=1?1:this.nRefreshInterval)*60000;}var e=this._getCardsModel();var i=[];var k;for(k in e){if(i.indexOf(e[k].model)==-1){i.push(e[k].model);}}var j=this.getOwnerComponent();if(j){for(k in i){var l=j.getModel(i[k]);if(l){l.attachRequestCompleted(this.onRequestCompleted.bind(this));l.attachRequestSent(this.destroyErrorCardsAndReplaceWithOriginal.bind(this));}}}if(this.initialized){return;}this.initialized=true;this.oFlexibilityPersonalizationPromise.then(function(){q.sap.measure.end("ovp:Personalization");this.persistencyVariantLoaded=true;var I;var K=[],Q=[];this.aManifestOrderedCards=this._getCardArrayAsVariantFormat(this.getLayout().getContent());for(var R=0;R<this.aManifestOrderedCards.length;R++){I=this._getCardFromManifest(this.aManifestOrderedCards[R].id);if(I&&I.settings&&I.settings.requireAppAuthorization){K.push({id:I.id,cardIntent:I.settings.requireAppAuthorization});Q.push(I.settings.requireAppAuthorization);}}if(Q.length>0){this._checkForAuthorization(K,Q);}else{this.aOrderedCards=this._mergeLREPContent(this.aManifestOrderedCards);this.organizeCards(this.aOrderedCards);}}.bind(this),function(I){q.sap.log.error("Could not load information from LREP Persistency");q.sap.log.error(I);});if(o.system.phone){p.enable(this);}setTimeout(function(){if(!this.persistencyVariantLoaded){this.busyDialog=new B({text:y.getText("loading_dialog_text")});this.busyDialog.open();this.busyDialog.addStyleClass('sapOVPBusyDialog');}}.bind(this),500);},organizeCards:function(e){var k;var l=[];this._updateLayoutWithOrderedCards();this._updateDashboardLayoutCards(e);if(this.isDragAndDropEnabled()){if(sap.ushell&&sap.ushell.Container){this._initShowHideCardsButton();}}this._clearStoredEntities();for(var i=0;i<this.aOrderedCards.length;i++){if(this.aOrderedCards[i].visibility){k=this._getCardFromManifest(this.aOrderedCards[i].id);if(k){l.push(k);}}}for(var i=0;i<l.length;i++){this._initCardModel(l[i].model);this._loadCardComponent(l[i].template);this._createModelViewMap(l[i]);}q.sap.measure.start("ovp:CreateLoadingCards","Create Loading cards","ovp");for(var i=0;i<l.length;i++){this.createLoadingCard(l[i]);}q.sap.measure.end("ovp:CreateLoadingCards");setTimeout(function(){this.getLayout().addStyleClass("ovpLayoutElementShow");}.bind(this),0);setTimeout(function(){q.sap.measure.start("ovp:CreateCards","Create cards loop","ovp");var I=this.fGetViewSwitchIndex(l);for(var i=0,j=0;j<l.length;i++,j++){while(l[j].id!==e[i].id){i++;}k=l[j];if(!k.settings.title){q.sap.log.error("title is mandatory for card ID : "+k.id);}if(k.settings.tabs){var K=0;var Q=I&&I.hasOwnProperty(k.id)?I[k.id]:"";if(Q&&typeof Q=="number"&&Q>0&&Q<=k.settings.tabs.length){K=Q>=1?Q-1:Q;this.setOrderedCardsSelectedKey(k.id,Q);}else if(this.aOrderedCards[i].selectedKey&&k.settings.tabs.length>=this.aOrderedCards[i].selectedKey){K=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(k,K);}k=this._getTemplateForChart(k);this._loadCardComponent(k.template);k.settings.baseUrl=this._getBaseUrl();this.createCard(k);}this.bFinishedCardsCreationProcess=true;q.sap.measure.end("ovp:CreateCards");}.bind(this),10);if(this.busyDialog){this.busyDialog.close();}},_getTemplateForChart:function(e){if(e.template==="sap.ovp.cards.charts.smart.chart"){var i=this.getView();var j=i.getModel(e.model);var k=j.getMetaModel();var l=k.getODataEntitySet(e.settings.entitySet);var I=k.getODataEntityType(l.entityType);var K;var Q;var R;var W=false;var X;if(e&&e.settings){if(!W&&e.settings.kpiAnnotationPath){var Y=I[e.settings.kpiAnnotationPath];X=Y.Detail.DefaultPresentationVariant&&Y.Detail.DefaultPresentationVariant.Path;if(X){R=this._getTemplateForChartFromVisualization(X,e,j,l,I);W=R.bTemplateUpdated;if(W){e=R.oCard;return e;}}}if(!W&&e.settings.selectionPresentationAnnotationPath){var Z=I[e.settings.selectionPresentationAnnotationPath];if(Z){X=Z.PresentationVariant&&Z.PresentationVariant.Path;if(X){R=this._getTemplateForChartFromVisualization(X,e,j,l,I);W=R.bTemplateUpdated;if(W){e=R.oCard;return e;}}}}if(!W&&e.settings.presentationAnnotationPath){X=e.settings.presentationAnnotationPath;R=this._getTemplateForChartFromVisualization(X,e,j,l,I);W=R.bTemplateUpdated;if(W){e=R.oCard;return e;}}if(!W&&e.settings.chartAnnotationPath){K=I[e.settings.chartAnnotationPath];Q=K&&K.ChartType&&K.ChartType.EnumMember;if(Q&&Q.split("/")[1]==="Donut"){e.template="sap.ovp.cards.charts.analytical";}else{e.template="sap.ovp.cards.charts.smart.chart";}}}}return e;},_getTemplateForChartFromVisualization:function(e,i,j,k,l){if(/^@/.test(e)){e=e.slice(1);}i.settings.presentationAnnotationPath=e;var I=l[e]&&l[e].Visualizations;var K;var Q;var R;var W=false;if(I&&I.length>0){for(K=0;K<I.length;K++){var X=I[K].AnnotationPath;if(!X){return{oCard:i,bTemplateUpdated:W};}X.trim();if(X.startsWith("@")){X=X.slice(1);}if(X.indexOf("Chart")!=-1){i.settings.chartAnnotationPath=X;Q=l[X];R=Q&&Q.ChartType&&Q.ChartType.EnumMember;if(R&&R.split("/")[1]==="Donut"){i.template="sap.ovp.cards.charts.analytical";}else{i.template="sap.ovp.cards.charts.smart.chart";}}W=true;}}return{oCard:i,bTemplateUpdated:W};},_createModelViewMap:function(e){if(!e||!e.settings||!e.model){return;}if(!e.settings.entitySet||e.settings.entitySet===""){return;}if(!(e.template.startsWith("sap.ovp.cards"))){return;}var i=e.model;if(!this.oModelViewMap[i]){this.oModelViewMap[i]={};}this.oModelViewMap[i][e.id]=true;},setTabIndex:function(e){if(typeof e=="object"){this.oTabIndexList=e;}else{this.oTabIndexList={};}},getTabIndex:function(){return this.oTabIndexList;},fGetViewSwitchIndex:function(e){var j=this.getGlobalFilter();var k=j&&j.getUiState();var l=k?JSON.stringify(k.getSelectionVariant()):"{}";var I=JSON.parse(l);var K=q.extend(true,{},I);var Q=[];if(e&&e.length>0){for(var i=0;i<e.length;i++){var R=q.extend(true,{},e[i]);Q.push(R);}}this.onBeforeRebindPageExtension(Q,K);return this.getTabIndex();},changeViewSwitchForVisibleCard:function(){var e=this.aOrderedCards;if(e&&e.length>0){var j=[],k=[];for(var i=0;i<e.length;i++){j.push(this._getCardFromManifest(e[i].id));}var l=this.fGetViewSwitchIndex(j);if(l&&typeof l=="object"){k=Object.keys(l);}if(k&&k.length>0){for(var i=0;i<e.length;i++){if(e[i]&&e[i].visibility==true){var I=this._getCardFromManifest(e[i].id);if(I&&I.settings&&I.settings.tabs&&I.settings.hasOwnProperty("selectedKey")){var K=l&&l.hasOwnProperty(I.id)?l[I.id]:"";var Q=I.settings.selectedKey;if(K&&typeof K=="number"&&K<=I.settings.tabs.length&&K!==Q){this.setOrderedCardsSelectedKey(I.id,K);var R={};R=I.settings.tabs[K-1];var W={cardId:I.id,selectedKey:K};for(var X in R){W[X]=R[X];}this.recreateCard(W);}}}}}}},setOrderedCardsSelectedKey:function(e,j){var k=this.aOrderedCards;for(var i=0;i<k.length;i++){if(k[i]&&k[i].id==e){this.aOrderedCards[i].selectedKey=j;break;}}},getOrderedCardsSelectedKey:function(e){var j=this.aOrderedCards;for(var i=0;i<j.length;i++){if(j[i]&&j[i].id==e){return this.aOrderedCards[i].selectedKey;}}},initializeTabbedCard:function(e,i){if(e.template=="sap.ovp.cards.charts.analytical"||e.template=="sap.ovp.cards.charts.smart.chart"){e.settings.chartAnnotationPath=e.settings.tabs[i].chartAnnotationPath;e.settings.colorPalette=e.settings.tabs[i].colorPalette;e.settings.bEnableStableColors=e.settings.tabs[i].bEnableStableColors;if(e.settings.tabs[i].navigation){e.settings.navigation=e.settings.tabs[i].navigation;}}if(e.settings.tabs[i].entitySet){e.settings.entitySet=e.settings.tabs[i].entitySet;}e.settings.annotationPath=e.settings.tabs[i].annotationPath;e.settings.dynamicSubtitleAnnotationPath=e.settings.tabs[i].dynamicSubtitleAnnotationPath;e.settings.presentationAnnotationPath=e.settings.tabs[i].presentationAnnotationPath;e.settings.selectionAnnotationPath=e.settings.tabs[i].selectionAnnotationPath;e.settings.selectionPresentationAnnotationPath=e.settings.tabs[i].selectionPresentationAnnotationPath;e.settings.kpiAnnotationPath=e.settings.tabs[i].kpiAnnotationPath;e.settings.dataPointAnnotationPath=e.settings.tabs[i].dataPointAnnotationPath;e.settings.identificationAnnotationPath=e.settings.tabs[i].identificationAnnotationPath;e.settings.params=e.settings.tabs[i].params;e.settings.selectedKey=i+1;},_getLibraryResourceBundle:function(){if(!this.oLibraryResourceBundle){this.oLibraryResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");}return this.oLibraryResourceBundle;},_getOvplibResourceBundle:function(){return this.getOwnerComponent()._getOvpLibResourceBundle();},_getCardsModel:function(){if(!this.oCards){var e=this.getUIModel();this.oCards=e.getProperty("/cards");}return this.oCards;},_getBaseUrl:function(){var e=this.getUIModel();if(!this.sBaseUrl){this.sBaseUrl=e.getProperty("/baseUrl");}return this.sBaseUrl;},_getApplicationId:function(){var e=this.getUIModel();return e.getProperty("/applicationId");},_getCardFromManifest:function(e){var j=this._getCardsModel();for(var i=0;i<j.length;i++){if(j[i].id===e){return j[i];}}return null;},_getCardArrayAsVariantFormat:function(e){var j=[];for(var i=0;i<e.length;i++){var I=this._getCardId(e[i].getId());j.push({id:I,visibility:e[i].getVisible()});var k;if(this.getView()&&this.getView().byId){if(this.getView().byId(I).getComponentInstance()){k=this.getView().byId(I).getComponentInstance().getComponentData().settings.selectedKey;}}if(k){j[j.length-1].selectedKey=k;}}return j;},_checkForAuthorization:function(e,I){if(!this.oContainer){return;}var K=this;var Q=[];var R=b.getNavigationHandler();if(R&&R.oCrossAppNavService){R.oCrossAppNavService.isIntentSupported(I).done(function(W){for(var i=0;i<e.length;i++){if(W[e[i].cardIntent].supported===false){Q.push(e[i].id);for(var j=0;j<K.aManifestOrderedCards.length;j++){if(e[i].id===K.aManifestOrderedCards[j].id){K.aManifestOrderedCards.splice(j,1);break;}}}}K.aOrderedCards=K._mergeLREPContent(K.aManifestOrderedCards);function X(Y,Z,$){if(Y.id===Q[this.unsupportedCardIndex]){$.splice(Z,1);}}for(var k=0;k<Q.length;k++){for(var l=0;l<K.aOrderedCards.length;l++){if(K.aOrderedCards[l].id==Q[k]){K.aOrderedCards.splice(l,1);if(K.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){K.getLayout().dashboardLayoutUtil.aCards.map(X,{unsupportedCardIndex:k});K.getLayout().dashboardLayoutUtil.dashboardLayoutModel.oLayoutVars.map(X,{unsupportedCardIndex:k});}break;}}}K.organizeCards(K.aOrderedCards);}).fail(function(){q.sap.log.error("Could not get authorization from isIntentSupported");K.aOrderedCards=K._mergeLREPContent(K.aOrderedCards);K.organizeCards(K.aOrderedCards);});}},_mergeLREPContent:function(l){var e=[];var i=false;if(this.bDeltaChangesEnabled&&Array.isArray(this.deltaCardsInfo)&&this.deltaCardsInfo.length>0){l=P.addMissingCardsFromManifest(l,this.deltaCardsInfo);i=true;}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(!i){l=this.getLayout().getLayoutDataJSON();}e=P.mergeChanges(l,this.deltaChanges);this._bDashboardLayoutLrepActive=true;this.getLayout().getDashboardLayoutModel().setLayoutVars(e);}else{e=P.mergeChanges(l,this.deltaChanges);}return e?e:[];},_updateLayoutWithOrderedCards:function(){var l=this.getLayout();var e=this.aOrderedCards;l.removeAllContent();var k,I=false;if(this.getView().getModel("ui")&&this.getView().getModel("ui").getProperty("/cards")){k=this.getView().getModel("ui").getProperty("/cards");for(var i=0;i<k.length;i++){I=false;for(var j=0;j<e.length;j++){if(k[i].id==e[j].id){I=true;break;}}if(!I&&this.getView().byId(k[i].id)){this.getView().byId(k[i].id).destroy();}}}for(var i=0;i<e.length;i++){var K=this.getView().byId(e[i].id);if(K){K.setVisible(e[i].visibility);l.addContent(K);}}},_updateErrorCardsArray:function(e){var i;for(i=0;i<e.length;i++){var j=this.aErrorCards.indexOf(e[i].id);if((j>-1)&&e[i].visibility==false){this.aErrorCards.splice(j,1);}}},_updateDashboardLayoutCards:function(e){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().updateCardVisibility(e);}}},_resetDashboardLayout:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().resetToManifest();}this.getLayout().rerender();}},_getCardArrayAsVariantFormatDashboard:function(){var e=[];var l=this.getLayout();var i=l.dashboardLayoutUtil.aCards;l.dashboardLayoutUtil.dashboardLayoutModel._sortCardsByRow(i);i.forEach(function(j){e.push({id:j.id,visibility:j.dashboardLayout.visible});});return e;},verifyGlobalFilterLoaded:function(){var e=this.getGlobalFilter();if(e.search()){if(e.validateMandatoryFields()){E.GLOBALFILTERFILLED=true;return true;}}this.getView().byId("ovpMain").setHeaderExpanded(true);E.GLOBALFILTERFILLED=false;return false;},onGlobalFilterChange:function(){this.filterChanged=true;if(this.bGlobalFilterInitialized){var e=this.getGlobalFilter();var l=e.getLiveMode();var i=this.getLayout();if(!l&&i){i.setActive(false);}else{this.changeViewSwitchForVisibleCard();}}},destroyErrorCardsAndReplaceWithOriginal:function(){if(this.isModelRefreshTriggered||this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var k;var e=q.sap.extend({},this.aErrorCards);for(k in e){var i=this.getView().byId(e[k]);var j=i&&i.getComponentInstance();var l=j&&j.getComponentData();var I=l&&l.cardId;var K=this._getCardFromManifest(I);j.destroy();var Q=this.aErrorCards.indexOf(I);if((Q>-1)){this.aErrorCards.splice(Q,1);}this.createCard(K);}this.isModelRefreshTriggered=false;}},onGlobalFilterSearch:function(){if(this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var e=this.getGlobalFilter();var k=this.getLayout();if(k){k.setActive(true);}if(this.aErrorCards&&this.aErrorCards.length>0){this.destroyErrorCardsAndReplaceWithOriginal();}if(e&&!e.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}this._clearStoredEntities();var l=[];if(this.oGlobalFilter['_aFields'].length>0){l=this.oGlobalFilter["_aFields"];}else{var I=this.oGlobalFilter['_aFilterBarViewMetadata'];for(var i=0;i<I.length;i++){var K=I[i];for(var j=0;j<K.fields.length;j++){l.push(K.fields[j]);}}}for(var i=0;i<l.length;i++){if(l[i].control){var Q=document.getElementById(l[i].control.sId);if(q(Q).hasClass('sapMFocus')){this.filterItemInFocus=l[i].control;break;}}}var R="ovp-"+new Date().getTime();for(var W in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(W)){try{this.oCardsModels[W].refresh(false,false,R);}catch(X){q.sap.log.warning(X);}}}this.filterChanged=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this._clearStoredEntities();}},_clearStoredEntities:function(){if(this.sPreviousEntityType){this.sPreviousEntityType="";}if(this.sCurrentEntityType){this.sCurrentEntityType="";}},_processFilters:function(){this.aFilters=[];var e=this.getGlobalFilter();if(!e){return;}var i=e.getFilters();var j=this.getCustomFilters();var I=true;var k;var l=function(R,W){if(!(R instanceof A)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!I){throw new Error("State must always be provided synchronously");}if(W){k=W;}};this.templateBaseExtension.addFilters(l);I=false;var K=[];if(j&&(j instanceof F)){K.push(j);}if(k&&(k instanceof F)){K.push(k);}if(K.length!==0){var Q=[];if(i&&i.length>0){K.push(i[0]);}Q.push(new F(K,true));if(Q.length>0){i=Q;}}this.aFilters=i;},_processSearch:function(){var e,i;var j=this.getGlobalFilter();if(!j){return;}var k=j.getParameters();var i=k&&k["custom"];if(!i){return;}for(var l in i){e=l+"="+q.sap.encodeURL(i[l]);}return e;},_initGlobalFilter:function(){var e=this.getGlobalFilter();if(!e){this.bGlobalFilterLoaded=true;this._parseNavigationVariant();q.sap.measure.end("ovp:GlobalFilter");return;}e.attachFiltersDialogClosed(this._storeCurrentAppStateAndAdjustURL.bind(this));var i=e.getVariantManagement();if(i){i.attachAfterSave(function(j){this._storeCurrentAppStateAndAdjustURL();}.bind(this));}this.oGlobalFilterLoadedPromise=new Promise(function(j,k){e.attachInitialized(function(){this._parseNavigationVariant();if(this.oParseNavigationPromise){var _;this.oParseNavigationPromise.done(function(l,I,K){if(l){_=Promise.resolve(this._setNavigationVariantToGlobalFilter(l,I,K)).then(function(){this.filterChanged=false;}.bind(this));}}.bind(this));this.oParseNavigationPromise.fail(function(){q.sap.log.error("Could not parse navigation variant from URL");});this.oParseNavigationPromise.always(function(){Promise.all([_]).then(function(){this.bGlobalFilterInitialized=true;if(e&&this.verifyGlobalFilterLoaded()){j();}}.bind(this));}.bind(this));}else{if(e&&this.verifyGlobalFilterLoaded()){j();}}},this);e.attachSearch(function(){if(!this.bGlobalFilterLoaded){j();this.bGlobalFilterLoaded=true;if(!e.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}var l=this.getLayout();if(l){l.setActive(true);}return;}this.onGlobalFilterSearch();},this);e.attachFilterChange(this.onGlobalFilterChange,this);e._oSearchButton&&e._oSearchButton.attachPress(function(){this.bGoButtonPressed=true;var l=this.getLayout();if(l){l.setActive(true);}}.bind(this));}.bind(this));this.oGlobalFilterLoadedPromise.then(function(j){this.bGlobalFilterLoaded=true;q.sap.measure.end("ovp:GlobalFilter");e._oBasicSearchField&&e._oBasicSearchField.attachSearch(function(){this.bSearchButtonPressed=true;}.bind(this));}.bind(this));},onShareButtonPress:function(e){var l=this._getLibraryResourceBundle();var i=this.getUIModel();var j=i&&i.getProperty("/title");if(!this._oShareActionButton){this._oShareActionButton=sap.ui.xmlfragment("sap.ovp.app.SharePage",{shareEmailPressed:function(){S.URLHelper.triggerEmail(null,l.getText("Email_Subject",[j]),document.URL);},shareJamPressed:function(){var k=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:j}}});k.open();}});this.getView().addDependent(this._oShareActionButton);}this._oShareActionButton.openBy(e.getSource());},_checkJamAuth:function(){var e=q.sap.getObject("sap.ushell.Container.getUser");var i=this.getUIModel();if(i){i.setProperty("/jamVisible",!!e&&e().isJamActive());}},_createModelForTile:function(){var e=this.getUIModel();var i,j=e&&e.getProperty("/title");var k={tileTitle:j,tileCustomURL:function(){i=u.getHash();return i?("#"+i):window.location.href;}};if(e){e.setProperty("/tileInfo",k);}},_loadCardComponent:function(e){if(!this.oLoadedComponents[e]){q.sap.measure.start("ovp:CardComponentLoad:"+e,"Card Component load","ovp");this.oLoadedComponents[e]=sap.ui.component.load({name:e,url:q.sap.getModulePath(e),async:true});this.oLoadedComponents[e].then(function(){q.sap.measure.end("ovp:CardComponentLoad:"+e);});}},_initCardModel:function(e){var i=false;if(this.oCardsModels[e]||!e){return;}this.oCardsModels[e]=this.getView().getModel(e);if(!this.oCardsModels[e].bUseBatch){this.oCardsModels[e].setUseBatch(false);}else{this.oCardsModels[e].setUseBatch(true);}if(this.getGlobalFilter()){i=true;}this._overrideCardModelRead(this.oCardsModels[e],i);},getVisibleCustomFields:function(){var e=this.getGlobalFilter();var i=e.getAllFilterItems(true);var l,I,j=[];if(i){l=i.length;while(l--){I=i[l];if(I&&I.getVisibleInFilterBar()){j.push(I.getName());}}}var k,K,Q,R=e.getFilterBarViewMetadata();var W=[];if(R){k=R.length;while(k--){Q=R[k].fields;if(Q){K=Q.length;while(K--){if(Q[K].isCustomFilterField&&j.indexOf(Q[K].fieldName)>-1){W.push({name:Q[K].fieldName});}}}}}return W;},_showErrorPage:function(e){if(this.bDisableErrorPage){return;}var i=this.getView().byId('ovpErrorPage');var j=this.getView().byId('ovpMain');if(e){i.setVisible(true);j.setVisible(false);return;}i.setVisible(false);j.setVisible(true);},_isValueHelpCall:function(e,j){var k=this.getGlobalFilter();if(!e||!k||!k._oFilterProvider){return false;}if(e.getId()!==k.getModel().getId()){return false;}var l=k._oFilterProvider;var I=l.getAssociatedValueHelpProviders().concat(l.getAssociatedValueListProviders());var K;for(var i=0;i<I.length;i++){K=I[i]&&I[i].oPrimaryValueListAnnotation;if(K&&K.valueListEntitySetName===j){return true;}}return false;},_removeFilter:function(e,i){var l=e.lastIndexOf(i);var j=e.indexOf(i);if(l===-1||j===-1){return e;}var k="%20and%20";var I=e.substring(l).indexOf(k);I=(I!==-1)?l+I:I;var K=e.substring(0,j).lastIndexOf(k);if(I===-1&&K===-1){if(e.lastIndexOf("$filter=")===0){return e.slice(0,8);}else{return"";}}else if(K===-1){if(e.lastIndexOf("$filter=")===0){return e.slice(0,8)+e.slice(I+k.length);}else{return e.slice(I+k.length);}}else if(I===-1){return e.slice(0,K);}else{return e.slice(0,K)+e.slice(I);}},_removeRelevantFilterRecursively:function(R,e){if(!R._bMultiFilter){if(R.sPath===e){return undefined;}return R;}else{R.aFilters.forEach(function(j,I){R.aFilters[I]=this._removeRelevantFilterRecursively(j,e);}.bind(this));for(var i=0;i<R.aFilters.length;i++){if(!R.aFilters[i]){R.aFilters.splice(i,1);i--;}}if(R.aFilters.length>0){return R;}else{return undefined;}}},_removeRelevantFilter:function(R,e){if(!R||R.length===0){return R;}R[0]=this._removeRelevantFilterRecursively(R[0],e);return(!R[0])?undefined:R;},_getFilterPreference:function(e){var i;var j=this._getCardFromManifest(e);if(j){if(j.settings.tabs){var I=0;var k=j.settings.selectedKey;if(k&&j.settings.tabs.length>=k){I=k-1;}i=j.settings.tabs[I].mFilterPreference;}else{i=j.settings.mFilterPreference;}}return i;},_getFilterPreferenceFromUrlParams:function(e){var i=e.urlParameters;var j;var k="cardId=";var l=-1;if(i){for(var I=0;I<i.length;I++){if((i[I]).lastIndexOf(k)>=0){l=I;break;}}if(l>=0){var K=(i[l]).lastIndexOf(k);var Q=i[l].slice(K+k.length);j=this._getFilterPreference(Q);if(K>0){i[l]=i[l].slice(0,K-1);}else{i.splice(l,1);}}}return j;},_addRelevantFilters:function(e,i,j,k){var l=e.urlParameters;var I=-1;if(l){for(var K=0;K<l.length;K++){if((l[K]).lastIndexOf("$filter=",0)===0){I=K;break;}}}if(this.aRelevantFilters&&this.aRelevantFilters.length>0){if(I>=0){var Q=O.createFilterParams(this.aRelevantFilters,i.oMetadata,j).substr(8);if(k&&k.filterAll==="card"){l[I]=l[I];}else if(k&&k.filterAll==="global"){l[I]=l[I].slice(0,8)+Q;}else if(k&&(k.cardFilter||k.globalFilter)){if(Array.isArray(k.cardFilter)&&k.cardFilter.length>0){k.cardFilter.forEach(function(R){Q=this._removeFilter(Q,R);}.bind(this));}if(Array.isArray(k.globalFilter)&&k.globalFilter.length>0){k.globalFilter.forEach(function(R){l[I]=this._removeFilter(l[I],R);}.bind(this));}if(Q===""&&l[I].length===8){l.splice(I,1);}else if(Q===""){l[I]=l[I];}else if(l[I].length===8){l[I]=l[I]+Q;}else{if(this.aRelevantFilters.length===1){Q="("+Q+")";}l[I]=l[I].slice(0,8)+"("+l[I].slice(8,l[I].length)+")%20and%20"+Q;}}else{if(this.aRelevantFilters.length===1){Q="("+Q+")";}l[I]=l[I].slice(0,8)+"("+l[I].slice(8,l[I].length)+")%20and%20"+Q;}}else{if(k&&k.filterAll==="card"){e.filters=undefined;}else if(k&&k.filterAll==="global"){e.filters=this.aRelevantFilters;}else if(k&&(k.cardFilter||k.globalFilter)){if(Array.isArray(k.cardFilter)&&k.cardFilter.length>0){k.cardFilter.forEach(function(R){this.aRelevantFilters=this._removeRelevantFilter(this.aRelevantFilters,R);}.bind(this));}if(this.aRelevantFilters&&this.aRelevantFilters.length>0){e.filters=this.aRelevantFilters;}}else{e.filters=this.aRelevantFilters;}}}else{if(I>=0){if(k&&k.filterAll==="card"){l[I]=l[I];}else if(k&&k.filterAll==="global"){l.splice(I,1);}else if(k&&k.globalFilter){if(Array.isArray(k.globalFilter)&&k.globalFilter.length>0){k.globalFilter.forEach(function(R){l[I]=this._removeFilter(l[I],R);}.bind(this));}if(l[I].length===8){l.splice(I,1);}}}}return e;},_overrideCardModelRead:function(e,j){var k=e.read;var l=this;e.read=function(){var I=arguments[1];if(!I){I={};Array.prototype.push.call(arguments,I);}var K=l._getEntityTypeFromPath(e,arguments[0],I.context,false);var Q=l._getEntitySetFromEntityType(e,K);if(l._isValueHelpCall(e,Q.name)){return k.apply(e,arguments);}var R=l._getFilterPreferenceFromUrlParams(I);if(j){l._processFilters();var W=l.getGlobalFilter();if(!l.aFilters){l.aFilters=[];}var X=false;var Y;var Z=Q["Org.OData.Capabilities.V1.SearchRestrictions"];if(Q["sap:searchable"]==="true"||(Z&&Z.Searchable&&Z.Searchable.Bool&&Z.Searchable.Bool==="true")){Y=l._processSearch();}l.sCurrentEntityType=K.entityType;if(l.sPreviousEntityType!==l.sCurrentEntityType){l.sPreviousEntityType=l.sCurrentEntityType;X=true;}if(!l.aRelevantFilters){l.aRelevantFilters=[];X=true;}if(X){l.aRelevantFilters=[];if(K){l.aRelevantFilters=l._getEntityRelevantFilters(K,l.aFilters,e,W.getModel());}}I=l._addRelevantFilters(I,e,K,R);var $=I.urlParameters;if(Y){$[$.length]=Y;}if(W&&W.getConsiderAnalyticalParameters()){var _=W.getAnalyticBindingPath();var a1,b1,c1;if(_&&_.length>0){if(K.entityType===W.getEntityType()){b1=arguments[0];a1=arguments[0].indexOf('$');if(a1>0){b1=arguments[0].substring(0,a1-1);}c1=_;if(b1!==c1){arguments[0]=arguments[0].replace(b1,c1);}}else{var d1=l._getParametersFromEntityPath(arguments[0]);var e1=l._getParametersFromEntityPath(_);var f1,g1,h1;if(d1&&d1.length>0){var i1=l._getEntityTypeFromPath(e,arguments[0],I.context,true);for(var i=0;i<e1.length;i++){f1=l._getPropertyMapping(d1,e1[i].name,i1.name,W.getEntityType(),e,W.getModel());if(f1){g1=f1+"=.*?[,\)]";h1=arguments[0].match(new RegExp(g1));if(h1&&h1.length>0){b1=h1[0].slice(0,-1);c1=f1+"="+e1[i].sValue;if(b1!==c1){arguments[0]=arguments[0].replace(b1,c1);}}}}}}}}}var j1=e.getMetaModel();var k1=j1.getODataEntityType(Q.entityType);$=l._getExpandPropertiesForSmartCharts($,j1,k1);var l1=arguments[1].success;arguments[1].success=(function(n1,l){return function(){if(!l.errorHandlingObject.atLeastOneRequestSuccess){l.errorHandlingObject.atLeastOneRequestSuccess=true;l._showErrorPage(false);}if(l.filterItemInFocus!=null){l.filterItemInFocus.focus();l.filterItemInFocus=null;}if(l.nRefreshInterval!==0){if(l.oRefreshTimer!==null){clearTimeout(l.oRefreshTimer);}l.attachRefreshInterval(l.nRefreshInterval);}return n1.apply(this,arguments);};})(l1,l);var m1=arguments[1].error;arguments[1].error=(function(n1,l){return function(){if(!l.errorHandlingObject.atLeastOneRequestSuccess){clearTimeout(l.errorHandlingObject.errorLoadingTimeout);l.errorHandlingObject.errorLoadingTimeout=setTimeout(function(){if(!l.errorHandlingObject.atLeastOneRequestSuccess){l._showErrorPage(true);}},9000);}return n1.apply(this,arguments);};})(m1,l);return k.apply(e,arguments);};},_getExpandPropertiesForSmartCharts:function(e,i,I){var K;var Q="";var R;var W;var X;var Y="$expand";var Z=false;var $=false;var _;var a1;var b1;var c1="com.sap.vocabularies.Common.v1.Text";var d1=I&&I.property;if(!e||!(e.length>0)){return e;}for(var l=0;l<e.length;l++){if(e[l].indexOf("$expand")>-1){return e;}}for(var e1=0;e1<e.length;e1++){if(e[e1].indexOf("$select")>-1){$=true;a1=e[e1];X=e[e1].split("$select=");if(X&&X[1]){_=decodeURIComponent(X[1]);K=_.split(",");if(!K||!(K.length>1)){return e;}}break;}}if(!$){return e;}if(!K||!(K.length>0)||!d1||!(d1.length>0)){return e;}for(var j=0;j<K.length;j++){for(var k=0;k<d1.length;k++){if(K[j]==(d1[k]&&d1[k].name)){if(d1[k]&&d1[k]["sap:aggregation-role"]&&d1[k]["sap:aggregation-role"]=="dimension"){if(!d1[k][c1]||!d1[k][c1].Path||!(d1[k][c1].Path.indexOf("/")>0)){break;}Q=d1[k][c1].Path;R=Q.split("/");if(!R.length){break;}W=i.getODataAssociationEnd(I,R[0]);if(!W){break;}if(!Z){Y=Y+"="+R[0];Z=true;}else if(Z){Y=Y+","+R[0];}b1=a1+","+Q;}break;}}}if(b1&&Y){e[e1]=b1;e.push(Y);}return e;},attachRefreshInterval:function(e){this.oRefreshTimer=setTimeout(function(){var l=this.getLayout();if(l&&l.getActive()){for(var i in this.oCardsModels){this.isModelRefreshTriggered=true;this.oCardsModels[i].refresh(false,false);}}}.bind(this),e);},_getEntityTypeFromPath:function(e,i,j,I){var k=r.prototype._normalizePath.apply(e,[i,j]);if(I){k=i.replace(/^\/|\/$/g,"").split("/")[0];if(k.indexOf("(")!=-1){k=k.substring(0,k.indexOf("("));}}var l=s.prototype._getEntityTypeByPath.apply(e.oMetadata,[k]);return l;},_getEntitySetFromEntityType:function(e,j){if(!e||!j){return;}var k=e.getMetaModel();var l=k&&k.getODataEntityContainer();var I=l&&l.entitySet;if(!I||!q.isArray(I)){return;}var K=I.length;for(var i=0;i<K;i++){if(I[i].entityType===j.entityType){return I[i];}}},_getPropertyMapping:function(e,j,k,l,I,K){var i,Q;for(i=0;i<e.length;i++){if(e[i].name===j){Q=e[i].name;return Q;}if((("P_"+e[i].name)===j)||(e[i].name===("P_"+j))){Q=e[i].name;return Q;}}if(!k||!l||!I||!K){return;}var R=I.oMetadata._getEntityTypeByName(k);var W=K.oMetadata._getEntityTypeByName(l);if(!R||!W){return;}var X="com.sap.vocabularies.Common.v1.SemanticObject";var Y="com.sap.vocabularies.Common.v1.SemanticObjectMapping";var Z=I.oAnnotations.getAnnotationsData();if(!Z||!Z.propertyAnnotations){return;}var $=Z.propertyAnnotations[R.namespace+"."+R.name];var _=K.oAnnotations.getAnnotationsData();if(!_||!_.propertyAnnotations){return;}var a1=_.propertyAnnotations[W.namespace+"."+W.name];var b1=a1&&a1[j];if(!b1||!b1[X]){return;}var c1,d1,e1,f1,g1;for(c1 in $){d1=$[c1];if(d1[X]&&d1[X].String===b1[X].String){e1=d1[Y];if(!e1){continue;}f1=e1.length;g1="";while(f1--){if(e1[f1].SemanticObjectProperty.String===j){g1=e1[f1].LocalProperty.PropertyPath;break;}}if(g1!==""){for(i=0;i<e.length;i++){if(e[i].name===g1){Q=e[i].name;return Q;}}}}}return Q;},_getParametersFromEntityPath:function(e){e=e.split("?")[0];var j=e.match(/\(.*=.*\)/);var k=[];if(!j){return k;}var l=j[0].slice(1,-1).trim().split(/\=|\,/);for(var i=0;i<l.length;i=i+2){k.push({name:l[i],sValue:l[i+1]});}return k;},_checkRelevantFiltersRecursive:function(e,j,k,l,I,K){if(!j._bMultiFilter){j.sPath=j.sPath.split('/').pop();var Q=this._getPropertyMapping(e,j.sPath,k,l,I,K);if(Q){j.sPath=Q;return j;}}else{var R=j.aFilters;var W,X=[];if(R){for(var i=0;i<R.length;i++){W=this._checkRelevantFiltersRecursive(e,R[i],k,l,I,K);if(W){X.push(W);}}if(X.length>0){return(new F(X,j.bAnd));}}}},_getEntityRelevantFilters:function(e,i,j,k){var R=[];if(i.length>0&&e){var l=this._checkRelevantFiltersRecursive(e.property,i[0],e.name,this.getGlobalFilter().getEntityType(),j,k);if(l){R.push(l);}}return R;},_checkIsCardValid:function(e){var i=e+".Component";var j,k;q.sap.require(i);var l=q.sap.getObject(i);if(!l){return false;}if((l!==a)&&!(l.prototype instanceof a)){return false;}if((j=l.getMetadata())&&(k=j.getCustomizing())){if(k["sap.ui.viewReplacements"]&&k["sap.ui.viewReplacements"]["sap.ovp.cards.generic.Card"]){return false;}}if(l.prototype.createContent!=a.prototype.createContent){return false;}if(l.prototype.getPreprocessors!=a.prototype.getPreprocessors){return false;}return true;},_createCardComponent:function(e,i,j){var I="ovp:CreateCard-"+j.template+":"+j.id;q.sap.measure.start(I,"Create Card","ovp");var k=e.getModel("@i18n");if(j.template&&this._checkIsCardValid(j.template)){var l={async:true,name:j.template,componentData:{model:i,modelName:j.model,i18n:k,cardId:j.id,settings:j.settings,appComponent:this.getOwnerComponent(),mainComponent:this}};var K=this.getGlobalFilter();if(j.errorReason){l.componentData.errorReason=j.errorReason;}if(K){l.componentData.globalFilter={getUiState:K.getUiState.bind(K)};}var Q=e;sap.ui.component(l).then(function(R){var W=Q.byId(R.getComponentData().cardId);W.setPropagateModel(true);var X=W.getComponentInstance();W.setComponent(R);if(X){setTimeout(function(){X.destroy();},0);}});}else{q.sap.log.error("Could not create Card from '"+j.template+"' template. Card is not valid.");}q.sap.measure.end(I);},createErrorCard:function(e,i){var j=q.extend(true,{},e,{template:"sap.ovp.cards.error"});j.errorReason=q.extend({},i);j.settings.oldTemplate=e.template;j.settings.template="sap.ovp.cards.error";this._createCardComponent(this.getView(),undefined,j);},createLoadingCard:function(e){var l=q.extend(true,{},e,{template:"sap.ovp.cards.loading"});this._createCardComponent(this.getView(),undefined,l);},createCard:function(e){var i=this.getView();var j=i.getModel(e.model);Promise.all([j.getMetaModel().loaded(),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[e.template]]).then(function(){this._createCardComponent(i,j,e);}.bind(this),function(k){q.sap.log.error("Can't load card with id:'"+e.id+"' and type:'"+e.template+"', reason:"+k);});},_getCardId:function(e){var i=this.getView().getId()+"--";if(e.indexOf(i)!=-1){var j=e.indexOf(i)+i.length;return e.substr(j);}return e;},_initFlexibilityPersonalization:function(){this.oFlexibilityPersonalizationPromise=new Promise(function(e,i){var l=this.getLayout();this.oFlexController=t.createForControl(l);this.oFlexController.getComponentChanges().then(function(j){if(j.length>0){this.bDeltaChangesEnabled=true;}e();}.bind(this),function(j){e();});}.bind(this));},layoutChanged:function(e){var j=e.getParameter("positionChanges");var k=[],l=[];var I,K;if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var Q=this.getLayout().dashboardLayoutUtil.dashboardLayoutModel.iColCount;if(j){for(var i=j.length-1;i>=0;i--){I=j[i];K=I.content.cardId;if(I.content.dashboardLayout.oldRow&&I.content.dashboardLayout.oldRow===I.content.dashboardLayout.row&&I.content.dashboardLayout.oldColumn&&I.content.dashboardLayout.oldColumn===I.content.dashboardLayout.column){continue;}if(l[K]){if(I.content.dashboardLayout.oldRow){l[K].content.dashboardLayout.oldRow=I.content.dashboardLayout.oldRow;}continue;}l[K]=I;}Object.keys(l).forEach(function(W){var I=l[W];if(I.content.dashboardLayout.oldRow&&I.content.dashboardLayout.oldRow===I.content.dashboardLayout.row&&I.content.dashboardLayout.oldColumn&&I.content.dashboardLayout.oldColumn===I.content.dashboardLayout.column){return;}k.push(l[W]);});k.forEach(function(I){var W=I.content.dashboardLayout;I.content.dashboardLayout={};I.content.dashboardLayout["C"+Q]=W;});}}else{var R=this.getLayout().getContent();this.aOrderedCards=this._getCardArrayAsVariantFormat(R);k=j;}this.savePersonalization(k);},saveVariant:function(e){var i=this;this.smartVariandManagement.getVariantsInfo(function(j){var k=null;if(j&&j.length>0){k=j[0].key;}var l=k!==null;var I={name:"Personalisation",global:false,overwrite:l,key:k,def:true};i.smartVariandManagement.fireSave(I);});},createChangesForNewAPI:function(e,i){if(e&&i){var j=[];if(!Array.isArray(e)){e=[e];}e.forEach(function(k){j.push({selectorControl:i,changeSpecificData:k});});c.addPersonalizationChanges({controlChanges:j}).then(function(j){c.saveChanges(j,i).then(function(){q.sap.log.info("Personalization changes have been saved in lrep backend");},function(){q.sap.log.error("Personalization changes are not being saved by 'saveChanges' function");});},function(){q.sap.log.error("Personalization changes are not being added by 'addPersonalizationChanges' function");});}},savePersonalization:function(e){var l=this.getLayout();if(l){if(e){this.createChangesForNewAPI(e,l);return;}var i,j;if(l.getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){i={cards:l.getLayoutDataJSON()};j="manageCardsForDashboardLayout";}else{i=this._getCardArrayAsVariantFormat(l.getContent());j="manageCardsForEasyScanLayout";}this.createChangesForNewAPI({changeType:j,content:i,isUserDependent:true},l);}},getLayout:function(){return this.getView()?this.getView().byId("ovpLayout"):null;},_initShowHideCardsButton:function(){var R=sap.ushell.Container.getRenderer("fiori2");if(R){var e={controlType:"sap.ushell.ui.launchpad.ActionItem",bCurrentState:false,oControlProperties:{icon:"sap-icon://dimension",text:y.getText("hideCardsBtn_title"),tooltip:y.getText("hideCardsBtn_title"),press:this._onCardMenuButtonPress.bind(this)},bIsVisible:true,aStates:["app"]};R.addUserAction(e);}},createOrDestroyCards:function(e,k,R){var l=-1;var I=[];var K=[];for(var i=0;i<k.length;i++){if(e[i].id==k[i].id){l=i;}else{l=this.getCardIndexInArray(e,k[i].id);}var Q=this.getView().byId(k[i].id);var W=Q.getComponentInstance();if(R){if(W){W.destroy();}}if(k[i].visibility!=e[l].visibility||R){if(k[i].visibility===true){var X=this._getCardFromManifest(k[i].id);I.push({oCard:X,sCreateOrDestroy:"create"});K.push(X);}else{if(W){I.push({oCard:W,sCreateOrDestroy:"destroy"});}}}}var Y=this.fGetViewSwitchIndex(K);if(I&&I.length>0){for(var j=0;j<I.length;j++){if(I[j]&&I[j].oCard&&I[j].hasOwnProperty("sCreateOrDestroy")&&I[j].sCreateOrDestroy=="create"){var Z=I[j].oCard;if(Z){this.createLoadingCard(Z);Z.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(Z.model);Z=this._getTemplateForChart(Z);this._loadCardComponent(Z.template);this._createModelViewMap(Z);if(Z.settings.tabs){var $=0;var _=[];_.push(Z);var a1=Y&&Y.hasOwnProperty(Z.id)?Y[Z.id]:"";var b1=this.getOrderedCardsSelectedKey(Z.id);if(a1&&typeof a1=="number"&&a1<=Z.settings.tabs.length&&a1!==b1){$=a1>=1?a1-1:a1;this.setOrderedCardsSelectedKey(Z.id,a1);}else if(this.aOrderedCards[j].selectedKey&&Z.settings.tabs.length>=this.aOrderedCards[j].selectedKey){$=this.aOrderedCards[j].selectedKey-1;}this.initializeTabbedCard(Z,$);}this.createCard(Z);}}else if(I[j]&&I[j].oCard&&I[j].hasOwnProperty("sCreateOrDestroy")&&I[j].sCreateOrDestroy=="destroy"){I[j].oCard.destroy();}}}},getCardIndexInArray:function(e,j){for(var i=0;i<e.length;i++){if(e[i].id==j){return i;}}return-1;},rerenderCards:function(e){var j=e;this.createOrDestroyCards.apply(this,[this.aOrderedCards,j,false]);this.aOrderedCards=j;this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.savePersonalization(this.visibilityChanges);for(var i=0;i<this.aOrderedCards.length;i++){var k=this.aOrderedCards[i];var l=this.aErrorCards.indexOf(k.id);if(l>-1&&k.visibility==false){this.aErrorCards.splice(l,1);}}},_onCardMenuButtonPress:function(){var e,l=this.getLayout().getMetadata().getName();this.visibilityChanges=[];function j(i){var Z=this._getCardFromManifest(i);if(Z){var $=Z.settings;if($.title){return $.title;}else if($.category){return($.category);}else if($.subTitle){return $.subTitle;}return i;}else{q.sap.log.error("Card id "+i+" is not available in the manifest");return"";}}var k=new f({cells:[new T({text:{path:"id",formatter:j.bind(this)}}),new g({state:"{visibility}",customTextOff:" ",customTextOn:" ",change:function(i){var Z=i.oSource.getParent();Z.toggleStyleClass('sapOVPHideCardsTableItem');Z.getCells()[0].toggleStyleClass('sapOVPHideCardsDisabledCell');var $=i.getSource().getBindingContext().getObject();var _=-1;this.visibilityChanges.forEach(function(a1,b1){if(a1.content.cardId===$.id){_=b1;}});if(_>-1){this.visibilityChanges.splice(_,1);}else{this.visibilityChanges.push({changeType:"visibility",content:{cardId:$.id,visibility:i.getParameter("state")},isUserDependent:true});}}.bind(this),tooltip:y.getText("hideCards_switchTooltip")})]});var I=new h("sapOVPHideCardsTable",{backgroundDesign:v.Transparent,showSeparators:L.Inner,columns:[new m({vAlign:"Middle"}),new m({hAlign:w.Right,vAlign:"Middle",width:"4.94rem"})]});I.addStyleClass('sapOVPHideCardsTable');I.bindItems({path:"/cards",template:k});var K=I.onAfterRendering;I.onAfterRendering=function(Z){K.apply(I,arguments);var $=Z.srcControl.mAggregations.items;if($){for(var i=0;i<$.length;i++){if(!$[i].getCells()[1].getState()){$[i].addStyleClass('sapOVPHideCardsTableItem');$[i].getCells()[0].addStyleClass('sapOVPHideCardsDisabledCell');}}}setTimeout(function(){q('.sapMListTblRow').first().focus();},200);};var Q=new n("manageCardsokBtn",{text:y.getText("okBtn"),type:"Emphasized",press:function(){var Z=this.oDialog.getModel().getProperty('/cards');this.createOrDestroyCards.apply(this,[this.aOrderedCards,Z,false]);this.aOrderedCards=Z;this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.savePersonalization(this.visibilityChanges);this.oDialog.close();for(var i=0;i<this.aOrderedCards.length;i++){var $=this.aOrderedCards[i];var _=this.aErrorCards.indexOf($.id);if(_>-1&&$.visibility==false){this.aErrorCards.splice(_,1);}}}.bind(this)});var R=this.getUIModel()&&this.getUIModel().getProperty("/enableFiori3");var W=new n("manageCardsCancelBtn",{text:y.getText("cancelBtn"),type:R?"Transparent":"Default",press:function(){this.oDialog.close();}.bind(this)});var X=new n("manageCardsResetBtn",{text:y.getText("resetBtn"),enabled:((l==="sap.ovp.ui.DashboardLayout")?true:this.isValidForReset()),press:function(){M.show(y.getText("reset_cards_confirmation_msg"),{id:"resetCardsConfirmation",icon:M.Icon.QUESTION,title:y.getText("reset_cards_confirmation_title"),actions:[M.Action.OK,M.Action.CANCEL],onClose:function(i){if(i===M.Action.OK){this.oDialog.setBusy(true);this.createOrDestroyCards.apply(this,[this.aOrderedCards,this.aManifestOrderedCards,(l==="sap.ovp.ui.DashboardLayout")?true:false]);this.aOrderedCards=this.aManifestOrderedCards;this._resetDashboardLayout();this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.oFlexController.discardChangesForId(this.getLayout().getId(),true).then(function(){this.oDialog.setBusy(false);this.oDialog.close();}.bind(this),function(){this.oDialog.setBusy(false);this.oDialog.close();q.sap.log.error("Discarding all personalization changes failed");}.bind(this));}}.bind(this)});}.bind(this)});this.oDialog=new D({title:y.getText("hideCardsBtn_title"),contentWidth:"29.6rem",contentHeight:"50%",stretch:o.system.phone,content:I,buttons:R?[Q,X,W]:[Q,W,X],afterClose:function(){this.visibilityChanges=[];this.oDialog.destroy();}.bind(this)}).addStyleClass("sapOVPCardsVisibilityDialog");this.oDialog.setBusyIndicatorDelay(0);var Y;if(l==="sap.ovp.ui.DashboardLayout"){Y=q.extend(true,[],this._getCardArrayAsVariantFormatDashboard());}else{Y=q.extend(true,[],this.aOrderedCards);}e=new J({cards:Y});this.oDialog.setModel(e);this.oDialog.open();},isValidForReset:function(){for(var i=0;i<this.aManifestOrderedCards.length;i++){if(this.aManifestOrderedCards[i].id!==this.aOrderedCards[i].id||this.aManifestOrderedCards[i].visibility!==this.aOrderedCards[i].visibility){return true;}}return false;},isDragAndDropEnabled:function(){return!o.system.phone;},getGlobalFilter:function(){if(!this.oGlobalFilter){this.oGlobalFilter=this.getView().byId("ovpGlobalFilter");}return this.oGlobalFilter;},getUIModel:function(){if(!this.oUIModel){var e=this.getOwnerComponent();this.oUIModel=e&&e.getModel("ui");}return this.oUIModel;},_parseNavigationVariant:function(){if(!this.oContainer){this.oParseNavigationPromise=q.Deferred().resolve();return;}this.oParseNavigationPromise=this.oNavigationHandler.parseNavigation();},_setUiStateToGlobalFilter:function(e,i,R){var j=this.getGlobalFilter();var k=new U({selectionVariant:e.toJSONObject()});j.setUiState(k,{replace:R,strictMode:false});i=i.concat(e.getParameterNames().concat(e.getSelectOptionsPropertyNames()));i=i.filter(function(l,I,K){return K.indexOf(l)==I;});return i;},_processModifyStartupExtension:function(e){if(!e){e=[];}var i=this.getGlobalFilter();var j=i.getUiState();var k=new d(j.getSelectionVariant());var l=JSON.parse(JSON.stringify(k));return new Promise(function(I,K){Promise.all([this.modifyStartupExtension(k),this.templateBaseExtension.provideStartupExtension(k)]).then(function(){if(JSON.stringify(k)!==JSON.stringify(l)){try{e=this._setUiStateToGlobalFilter(k,e,true);}catch(Q){q.sap.log.error("Error with modifyStartupExtension, falling back to default behavior"+Q);e=this._setUiStateToGlobalFilter(l,e,true);}}I(e);}.bind(this));}.bind(this));},_addFieldsToSFBAdvancedArea:function(e){var l;var i=this.getGlobalFilter();if(e&&e.length>0){l=e.length;while(l--){i.addFieldToAdvancedArea(e[l]);}}},_restoreAppState:function(e){this.restoreCustomAppStateDataExtension(e._CUSTOM);var i=e._EXTENSION;if(!i){return;}var I=true;var j=function(k){if(!(k instanceof A)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var l=k.getMetadata().getNamespace();if(!I){throw new Error("State must always be restored synchronously");}return i[l];};this.templateBaseExtension.restoreExtensionAppStateData(j);I=false;},_setNavigationVariantToGlobalFilter:function(e,j,k){return new Promise(function(l,I){var K=this.getGlobalFilter();if(!K){return;}switch(k){case"iAppState":if(e.selectionVariant){var Q,R,W,X=false;var Y,Z,$,_;var a1,b1,c1;K.clearVariantSelection();Q=JSON.parse(e.selectionVariant);K.setCurrentVariantId(Q.SelectionVariantID);b1=K.getUiState({allFilters:false});Z=b1&&JSON.stringify(b1.getSelectionVariant());_=K.getFilterData()._CUSTOM;_=((typeof _=='undefined')?{}:_);a1=new U({selectionVariant:e.oSelectionVariant.toJSONObject()});K.setUiState(a1,{replace:true,strictMode:false});R=new d(e.selectionVariant);W=R.getParameterNames().concat(R.getSelectOptionsPropertyNames());for(var i=0;i<W.length;i++){K.addFieldToAdvancedArea(W[i]);}c1=K.getUiState({allFilters:false});Y=c1&&JSON.stringify(c1.getSelectionVariant());if(Z!==Y){X=true;}if(e.customData&&Object.keys(e.customData).length>0){var $=e.customData;this._restoreAppState($);if(JSON.stringify(_)!==JSON.stringify($)){X=true;}}K.getSmartVariant().currentVariantSetModified(X);K._updateToolbarText();}l();break;case"xAppState":case"URLParams":var d1=[];var e1=new d(e.oSelectionVariant.toJSONObject());var f1=new d(e.oDefaultedSelectionVariant.toJSONObject());if(!e.bNavSelVarHasDefaultsOnly&&!e1.isEmpty()){K.clearVariantSelection();K.clear();d1=this._setUiStateToGlobalFilter(e1,d1,true);}if(e.bNavSelVarHasDefaultsOnly&&!f1.isEmpty()&&K.getCurrentVariantId()===""){K.clear();d1=this._setUiStateToGlobalFilter(f1,d1,true);}if(K.getCurrentVariantId()!==""){this._setDisplayCurrency(f1);}Promise.resolve(this._processModifyStartupExtension(d1)).then(function(d1){this._addFieldsToSFBAdvancedArea(d1);l();}.bind(this));break;case"initial":Promise.resolve(this._processModifyStartupExtension()).then(function(d1){this._addFieldsToSFBAdvancedArea(d1);l();}.bind(this));break;}}.bind(this));},_setDisplayCurrency:function(e){var i=this.getGlobalFilter();if(!i){return;}var l,j;var k=i.getAnalyticalParameters();if(k&&k.length>0){l=k.length;while(l--){if((k[l].name==="P_DisplayCurrency")||(k[l].name==="DisplayCurrency")){j=k[l];break;}}}if(!j){return;}var I=i.getFilters([j.fieldName]);var K=I&&I[0]&&I[0].oValue1;if(K&&K!==" "){return;}var Q,R;if(j.name.indexOf("P_")===0){R=j.name;Q=j.name.substr(2);}else{R="P_"+j.name;Q=j.name;}if(e&&!e.isEmpty()){var W;K=e.getParameter(Q);if(!K||K===" "){K=e.getParameter(R);}if(!K||K===" "){W=e.getSelectOption(Q);K=W&&W[0]&&W[0].Low;}if(!K||K===" "){W=e.getSelectOption(R);K=W&&W[0]&&W[0].Low;}}if(!K||K===" "){K=j.defaultPropertyValue;}if(!K||K===" "){return;}var X=new d();X.addParameter(j.name,K);var Y=new U({selectionVariant:X.toJSONObject()});i.setUiState(Y,{replace:false,strictMode:false});},_getCustomAppState:function(){var e={},i={};this.getCustomAppStateDataExtension(e);if(!(q.isEmptyObject(e))){i[G]=e;}var j;var I=true;var k=function(l,K){if(!(l instanceof A)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!I){throw new Error("State must always be provided synchronously");}if(K){j=j||Object.create(null);var Q=l.getMetadata().getNamespace();j[Q]=K;}};this.templateBaseExtension.provideExtensionAppStateData(k);I=false;if(j){i[H]=j;}return i;},onBeforeSFBVariantSave:function(){var e=this._getCustomAppState();this.getGlobalFilter().setFilterData({_CUSTOM:e[G],_EXTENSION:e[H]});},onAfterSFBVariantLoad:function(){var e=this.getGlobalFilter().getFilterData();if(e){this._restoreAppState(e);}},onAssignedFiltersChanged:function(e){if(e.getSource()&&this.getView().byId("ovpFilterText")){this.getView().byId("ovpFilterText").setText(e.getSource().retrieveFiltersWithValuesAsText());}},_CustomFilterField:function(e,i){for(var k in e){if(e.hasOwnProperty(k)){i[k]=e[k];}}},_getCurrentAppState:function(){var e=this.getGlobalFilter();if(!e){return;}var i={};var j=this._getCustomAppState();var k={_CUSTOM:j[G],_EXTENSION:j[H]};if(k._CUSTOM){this._CustomFilterField(k._CUSTOM,i);}if(k._EXTENSION){var l=Object.keys(k._EXTENSION);if(l){this._CustomFilterField(k._EXTENSION[l],i);}}if(!q.isEmptyObject(i)){this.getGlobalFilter().setFilterData({_CUSTOM:i});}var I=e.getUiState({allFilters:false});var K=I&&I.getSelectionVariant();if(e.getSmartVariant().currentVariantGetModified()){K.SelectionVariantID="";}var Q=K&&JSON.stringify(K);var R=new d(Q);return{selectionVariant:R.toJSONString(),customData:k};},_storeCurrentAppStateAndAdjustURL:function(e){if(e&&!e.oSource._bDirtyViaDialog){return;}if(!this.bGlobalFilterLoaded){return;}if(!this.oNavigationHandler){return;}if(this.oAppStatePromise){this.rejectPreviousPromise&&this.rejectPreviousPromise("skip");}this.oAppStatePromise=new Promise(function(j,k){this.rejectPreviousPromise=k;var l=this._getCurrentAppState();var I=this.oNavigationHandler.storeInnerAppStateWithImmediateReturn(l);I.promise.then(function(K){j(K);},function(K){k(K.getErrorCode());});}.bind(this));var i=function(j){this.oAppStatePromise=null;if(j&&j.length>0){this.oNavigationHandler.replaceHash(j);return;}throw"AppState key is empty";};var R=function(j){this.oAppStatePromise=null;if(j==="skip"){throw j;}throw("Something went wrong while storing AppState - "+j);};this.oAppStatePromise.then(i.bind(this),R.bind(this)).catch(function(j){if(j==="skip"){return;}q.sap.log.error(j);});}});});
