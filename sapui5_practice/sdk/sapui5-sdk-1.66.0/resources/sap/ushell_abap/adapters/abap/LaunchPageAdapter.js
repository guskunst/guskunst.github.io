// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/ui2/srvc/chipinstance","sap/ui2/srvc/catalog","sap/ui2/srvc/chipdefinition","sap/ushell/components/cards/ManifestPropertyHelper","sap/base/Log"],function(U,c,a,b,M,L){"use strict";var C="sap.ushell_abap.adapters.abap.LaunchPageAdapter",d="/UI2/Fiori2LaunchpadHome",D="/UI2/FLPD_CATALOG",f="X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER",S="X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER",g="X-SAP-UI2-CHIP:/UI2/CARD",O={catalogTileNotFound:"catalogTileNotFound",referenceTileNotFound:"referenceTileNotFound",noTargetMapping:"noTargetMapping",emptyConfiguration:"emptyConfiguration",tileIntentSupportException:"tileIntentSupportException"};var h=function(u,p,A){var j,o=null,P=false,G,k,t=new sap.ui2.srvc.Map(),l=(A&&A.config)||{},T=l.services&&l.services.targetMappings,m=l.services&&l.services.launchPage,E={},q=this;if(!T){throw new Error("Configuration for target mappings service not passed");}if(!T.baseUrl){throw new Error("baseUrl was not passed in Configuration for target mappings service");}if(!T.relativeUrl){throw new Error("relativeUrl was not passed in Configuration for target mappings service");}function r(e,s,i){try{return e.getImplementationAsSapui5();}catch(n){jQuery.sap.log.error(i+": "+(n.message||n),n.stack,C);return new sap.ushell.ui.tile.StaticTile({icon:"sap-icon://error",info:"",infoState:"Critical",subtitle:n.message||n,title:s}).addStyleClass("sapUshellTileError");}}sap.ui2.srvc.testPublishAt(q);function v(e,s,i){if(e.getBagIds().indexOf(s)>-1&&e.getBag(s).getTextNames().indexOf(i)>-1){return e.getBag(s).getText(i);}}sap.ui2.srvc.testPublishAt(q);function w(i,s,n){var x,d1;try{x=i.getConfigurationParameter(s);d1=JSON.parse(x);}catch(e){return;}if(d1[n]!==undefined){return d1[n];}}sap.ui2.srvc.testPublishAt(q);function y(e,s){var x=e&&sap.ui2.srvc.isArray(e.order)?e.order:[],d1={},e1=[],f1,g1,i,n;x=e&&sap.ui2.srvc.isArray(e.order)?e.order:[];x=x.concat(e&&sap.ui2.srvc.isArray(e.linkOrder)?e.linkOrder:[]);for(i=0,n=s.length;i<n;i+=1){f1=s[i];d1[f1.getId()]=f1;}for(i=0,n=x.length;i<n;i+=1){g1=x[i];if(Object.prototype.hasOwnProperty.call(d1,g1)){e1.push(d1[g1]);delete d1[g1];}}for(i=0,n=s.length;i<n;i+=1){f1=s[i];if(Object.prototype.hasOwnProperty.call(d1,f1.getId())){e1.push(f1);}}return e1;}function z(e,i,s){if(s==="link"){return B(e.linkOrder,i.getId());}else{return B(e.order,i.getId());}}function B(e,i){var s=e.indexOf(i);if(s<0){return s;}e.splice(s,1);return s;}function F(e,s,i,n){if(n==="link"){i=i-e.order.length;e.linkOrder.splice(i,0,s);}else{e.order.splice(i,0,s);}}function H(e,i){var n=i.getGroupTiles(e),s={order:[],linkOrder:[]};n.forEach(function(x){var d1=i.getTileType(x);if(d1==="link"){s.linkOrder.push(x.getId());}else{s.order.push(x.getId());}});return s;}function I(){var i;try{i=JSON.parse(o.getConfiguration());i.order.splice(0,0,o.getDefaultPage().getId());}catch(e){i={order:[o.getDefaultPage().getId()]};}return y(i,o.getPages());}this.hideGroups=function(e){var i,n=new jQuery.Deferred();if(!e||!(e instanceof Array)){n.reject('Input parameter must be of type Array.');}else{i=JSON.parse(o.getConfiguration()||"{}");i.hiddenGroups=e;o.setConfiguration(JSON.stringify(i),n.resolve.bind(n),n.reject.bind(n));}return n.promise();};this.isGroupVisible=function(e){var s=o.getConfiguration(),n,x,i;if(!s){return true;}n=JSON.parse(s);if(!n||!n.hiddenGroups){return true;}x=n.hiddenGroups;for(i=0;i<x.length;i+=1){if(x[i]===e.getId()){return false;}}return true;};sap.ui2.srvc.testPublishAt(q);function J(e){function s(){if(e._loadingDeferred){e._loadingDeferred.resolve();}delete e._loadingDeferred;delete e.$loadingPromise;}function i(n){jQuery.sap.log.error("Failed to load tile: "+n,e.toString(),C);if(e._loadingDeferred){e._loadingDeferred.reject();}delete e._loadingDeferred;delete e.$loadingPromise;}e.load(s,i);}this._loadApplaunchersAndDelayLoadingOfOtherChips=function(e,i){var n=0,s=[],x=[];function d1(){if(n<=0){i();}}function e1(g1){g1._loadingDeferred=new jQuery.Deferred();g1.$loadingPromise=g1._loadingDeferred.promise();if(window["sap-ui-debug"]===true){J(g1);}else{sap.ui.require(["sap/ushell/EventHub"],function(h1){var i1=h1.on("CoreResourcesComplementLoaded");i1.do(function(j1){if(j1.status==="success"){J(g1);i1.off();}else{jQuery.sap.log.error("Did not load custom tile as core resources where not loaded",null,C);}});});}}function f1(g1){function h1(){n-=1;d1();}n+=1;g1.load(h1,function(i1){jQuery.sap.log.error("Failed to load tile: "+i1,g1.toString(),C);h1();});}e.forEach(function(g1){g1.getChipInstances().forEach(function(h1){if(Y(h1)){x.push(h1);}else if(Z(h1)){}else if(W(h1)||X(h1)){f1(h1);}else{s.push(h1);}});});s.forEach(function(g1){e1(g1);});x.forEach(function(g1){e1(g1);});d1();};sap.ui2.srvc.testPublishAt(q,"readTargetMappings");function K(){var e=new jQuery.Deferred(),i,s,n;function d1(f1){var g1=[];Object.keys(f1).forEach(function(h1){var x={};["semanticObject","semanticAction","formFactors"].forEach(function(i1){x[i1]=f1[h1][i1];});g1.push(x);});return g1;}if(jQuery.sap.getObject("compactTMPromise",undefined,l)){l.compactTMPromise.then(function(x){var f1=d1(x||{});e.resolve({results:f1});},function(x){e.reject(x);});return e.promise();}i=jQuery.sap.getObject("services.targetMappings",0,l);s=i.cacheId||"";n="/sap/bc/ui2/start_up?so=%2A&action=%2A&tm-compact=true&shellType="+q._getShellType()+"&depth=0";if(s){n+=(n.indexOf("?")<0?"?":"&")+"sap-cache-id="+s;}var e1=i.sUI2CacheDisable;if(e1){n+=(n.indexOf("?")<0?"?":"&")+"sap-ui2-cache-disable="+e1;}sap.ui2.srvc.get(n,false,function(x){var f1=JSON.parse(x),g1=f1.targetMappings||{};var h1=d1(g1);e.resolve({results:h1});},function(x){e.reject(x);});return e.promise();}sap.ui2.srvc.testPublishAt(q);function N(s,e){return s+"-"+e;}sap.ui2.srvc.testPublishAt(q);function Q(e){return!e.getConfiguration();}function R(e){var i=[],n=sap.ushell.Container.getService("PageBuilding").getFactory();e.forEach(function(s){var x=s.getRemoteCatalog(),d1;if(s.getBaseChipId()==="X-SAP-UI2-CHIP:/UI2/ACTION"){return;}d1=n.createChipInstance({chipId:s.getId(),remoteCatalogId:x&&x.getId()});i.push(d1);});return i;}function V(){var e=o.getDefaultPage().getAllCatalogs(),n,s=e.getCatalogs(),x=[],i;for(i=0;i<s.length;i+=1){n=s[i];x.push({data:{},errorMessage:undefined,id:n.getId(),title:n.isStub()?n.getId():n.getTitle(),tiles:n.isStub()?[]:R(n.getChips()),ui2catalog:n});}return x;}function W(e){var s=e.getChip().getBaseChipId();return s===f||s===S;}function X(e){var s=e.getChip().getBaseChipId();return g===s;}function Y(e){return!!e.getChip().getRemoteCatalog();}function Z(e){return!Y(e)&&e.getChip().getBaseChipId()===undefined;}function $(e){var i,s=e.getConfigurationParameter("tileConfiguration");try{i=JSON.parse(s||"{}");}catch(n){jQuery.sap.log.error("Tile with ID '"+e.getId()+"' has a corrupt configuration containing a 'tileConfiguration' value '"+s+"' which could not be parsed. If present, a (stringified) JSON is expected as value.",n.message,"sap.ushell_abap.adapters.abap.LaunchPageAdapter");return{};}return i;}function _(e){var i={},n,s,x;try{n=JSON.parse(e.getChip()._getChipRawConfigurationString());s=JSON.parse(n&&n.tileConfiguration||"{}");x=JSON.parse(s&&s["TILE_PROPERTIES"]||"{}");if(x.semanticObject&&x.semanticAction){i["navigation_use_semantic_object"]=true;i["navigation_semantic_object"]=x.semanticObject;i["navigation_semantic_action"]=x.semanticAction;}}catch(d1){return{};}return i;}function a1(e){var s,i,n;s=_(e);if(s["navigation_use_semantic_object"]){return s;}try{n=JSON.parse(e.getChip()._getChipRawConfigurationString());i=JSON.parse(n&&n.tileConfiguration||"{}");}catch(x){return{};}return i;}this._parseFullChipId=function(s){var e=s.split(":"),i=e.pop(),n=null;if(e.length>2){n=e.shift();}return{id:i,prefix:n,catalog:e.join(":")};};this._parseReferenceLost=function(s){var e;var i=s||Object.prototype.toString.apply(i);if(!i.match(/^Reference lost: Note \d+ Page.+\s,\sInstance ID.+$/)){jQuery.sap.log.warning("The string that describes a lost reference is in an unexpected format","This is expected to be a string exactly like 'Reference lost: Note <#> Page <CATALOG_ID> , Instance ID <CHIP_ID>' instead of the given '"+s+"'","sap.ushell_abap.adapters.abap.LaunchPageAdapter");return{id:"Unknown",catalog:"Unknown"};}e=i.split(" , ").map(function(n){return n.split(" ").pop();});return{id:e[1],catalog:e[0]};};this._flattenArray=function(i){var q=this;if(Object.prototype.toString.apply(i)!=="[object Array]"){return i;}return i.reduce(function(e,n){return e.concat(q._flattenArray(n));},[]);};this._findAndReportTileErrors=function(e,t){var i;i=this._getPossibleTileErrors(e,t);if(i.length>0){this._reportTileErrors(i);}};this._getPossibleTileErrors=function(e,t){var q=this;return e.map(function(i){return{group:{id:i.getId(),title:i.getTitle()},errors:q._getPossibleTileErrorsFromOnePage(i,t)};});};this._getPossibleTileErrorsFromOnePage=function(e,t){var q=this;var i=e.getChipInstances().reduce(function(n,s){var x,d1,e1,f1,g1,h1,i1,j1;j1=s.getChip();d1=q._parseFullChipId(j1.getId());if(!j1.isInitiallyDefined()){n.push({type:O.catalogTileNotFound,chipInstanceId:s.getId(),chipId:d1.id,chipCatalogId:d1.catalog});}else if(j1.isReference()&&j1.isBrokenReference()){g1=q._parseReferenceLost(j1.getTitle());n.push({type:O.referenceTileNotFound,chipInstanceId:s.getId(),referenceChipId:d1.id,referenceChipCatalogId:d1.catalog,missingReferredChipId:g1.id,missingReferredCatalogId:g1.catalog});}else{try{x=q._checkTileIntentSupport(s,t);}catch(k1){x={isSupported:false,reason:O.tileIntentSupportException,exception:k1};}if(!x.isSupported){f1=v(s,"tileProperties","display_title_text");e1=v(s,"tileProperties","display_subtitle_text");switch(x.reason){case O.noTargetMapping:if(W(s)){h1=$(s);}else{h1=a1(s);}n.push({type:O.noTargetMapping,chipInstanceId:s.getId(),chipInstanceTitle:f1||h1.display_title_text||s.getTitle(),chipInstanceSubtitle:e1||h1.display_subtitle_text,tileURL:h1.navigation_target_url||"#"+h1.navigation_semantic_object+"-"+h1.navigation_semantic_action+(h1.navigation_semantic_parameters?"?"+h1.navigation_semantic_parameters:"")});break;case O.emptyConfiguration:i1=s.getConfigurationParameter("tileConfiguration");n.push({type:O.emptyConfiguration,chipInstanceId:s.getId(),chipInstanceTitle:f1||s.getTitle(),chipInstanceSubtitle:e1||null,tileConfiguration:i1});break;case O.tileIntentSupportException:n.push({type:O.tileIntentSupportException,exception:x.exception,chipInstanceId:s.getId()});break;case O.referenceTileNotFound:break;default:}}}return n;},[]);return i;};this._formatTileError=function(e){switch(e.type){case O.catalogTileNotFound:return"comes from catalog tile with ID '"+e.chipId+"' but this cannot be found in catalog '"+e.chipCatalogId+"' (CATALOG TILE NOT FOUND).";case O.referenceTileNotFound:return"comes from reference tile '"+e.referenceChipId+"'"+" in catalog '"+e.referenceChipCatalogId+"'"+" which in turn refers to the tile '"+e.missingReferredChipId+"'"+" from catalog '"+e.missingReferredCatalogId+"', but this is missing (REFERENCED TILE NOT FOUND).";case O.noTargetMapping:return"was hidden because a target mapping for the tile URL '"+e.tileURL+"' was not found (TARGET MAPPING NOT FOUND).";case O.emptyConfiguration:return"the tile configuration '"+e.tileConfiguration+"' is empty or invalid (BAD CONFIGURATION).";case O.tileIntentSupportException:return"exception occurred while checking tile intent support: "+e.exception+" (EXCEPTION RAISED).";default:return"unknown error type '"+e.type+"' (UNKNOWN ERROR). Error data: "+JSON.stringify(e,null,3);}};this._reportTileErrors=function(e){var q=this;var n=[];var x=[];function d1(e1,f1){var g1=[e1,f1].map(function(s,i){return i===1&&s?"("+s+")":s;}).filter(function(s){return typeof s==="string"&&s.length>0;}).join(" ");return g1.length>0?"'"+g1+"'":"";}e.forEach(function(i){var e1="  in Group '"+i.group.title+"' with Group ID '"+i.group.id+"'",f1=[],g1=[];i.errors.forEach(function(h1){var i1=["  - tile instance",d1(h1.chipInstanceTitle,h1.chipInstanceSubtitle),"with ID '"+h1.chipInstanceId+"'"].filter(function(s){return s.length>0;}).join(" ");if(h1.type===O.noTargetMapping){g1.push([i1,"    "+q._formatTileError(h1)].join("\n"));}else{f1.push([i1,"    "+q._formatTileError(h1)].join("\n"));}});if(f1.length>0){x.push([e1,f1.join("\n")].join("\n"));}if(g1.length>0){n.push([e1,g1.join("\n")].join("\n"));}});if(x.length>0){x.unshift("Tile error(s) were detected:");jQuery.sap.log.error(x.join("\n"),null,"sap.ushell_abap.adapters.abap.LaunchPageAdapter");}if(n.length>0){n.unshift("Tile warning(s) were detected:");jQuery.sap.log.warning(n.join("\n"),null,"sap.ushell_abap.adapters.abap.LaunchPageAdapter");}};this.getGroups=function(){var q=this,e,i,n,s;if(P){return(new jQuery.Deferred()).resolve(I()).promise();}if(!G){G=new jQuery.Deferred();e=new jQuery.Deferred();n=sap.ushell.Container.getService("PageBuilding");if(m&&m.cacheId){n.getFactory().getPageBuildingService().readPageSet.cacheBusterTokens.put(d,m.cacheId);}if(m&&m["sap-ui2-cache-disable"]&&n.getFactory().getPageBuildingService().readPageSet){n.getFactory().getPageBuildingService().readPageSet.appendedParameters={"sap-ui2-cache-disable":m["sap-ui2-cache-disable"]};}s=n.getPageSet(d);s.fail(e.reject.bind(e)).done(function(x){o=x;o.filter([d],[D]);q._loadApplaunchersAndDelayLoadingOfOtherChips(x.getPages(),e.resolve.bind(e,x));});i=K().done(function(x){var d1=sap.ui2.srvc.getFormFactor();x.results.forEach(function(e1){var f1=N(e1.semanticObject,e1.semanticAction);t.put(f1,t.get(f1)||!!(e1.formFactors&&e1.formFactors[d1]));});});jQuery.when(i,e).done(function(x,d1){P=true;if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.DEBUG){q._findAndReportTileErrors(d1.getPages(),t);}G.resolve(I());}).fail(G.reject.bind(G));}return G.promise();};this.getDefaultGroup=function(){var e=new jQuery.Deferred();this.getGroups().done(function(){e.resolve(o.getDefaultPage());}).fail(e.reject.bind(e));return e.promise();};this.getGroupTitle=function(e){return e.getTitle();};this.getGroupId=function(e){return e.getId();};this.getGroupTiles=function(i){var n;try{n=JSON.parse(i.getLayout());}catch(e){jQuery.sap.log.warning("Group "+i.getId()+": invalid layout: "+i.getLayout(),null,C);}return y(n,i.getChipInstances());};this.addGroup=function(s){var e=new jQuery.Deferred();o.appendPage(s,D,e.resolve.bind(e),e.reject.bind(e,I()));return e.promise();};this.removeGroup=function(e){var i=new jQuery.Deferred();if(o.isPageRemovable(e)){o.removePage(e,i.resolve.bind(i),i.reject.bind(i,I()));}else{i.reject(I());}return i.promise();};this.resetGroup=function(e){var i=new jQuery.Deferred(),q=this;if(o.isPageRemovable(e)){i.reject(I());}else if(o.isPageResettable(e)){o.resetPage(e,function(){q._loadApplaunchersAndDelayLoadingOfOtherChips([e],i.resolve.bind(i,e));},i.reject.bind(i,I()));}else{i.resolve();}return i.promise();};this.isGroupRemovable=function(e){return o.isPageRemovable(e);};this.isGroupLocked=function(e){return e.isPersonalizationLocked();};this.isLinkPersonalizationSupported=function(e){if(!e){return true;}if(!e.isStub()){var i=e.getContract&&e.getContract("types"),n=i&&i.getAvailableTypes()||[];return n.indexOf("link")!==-1;}return false;};this.isTileIntentSupported=function(e){var i,s,n,x;var d1=this._checkTileIntentSupport(e,t);if(!d1.isSupported&&d1.reason===O.noTargetMapping){if(W(e)){i=$(e);}else{i=a1(e);}x=v(e,"tileProperties","display_title_text")||i.display_title_text;n=v(e,"tileProperties","display_subtitle_text")||i.display_subtitle_text;s=i.navigation_target_url;jQuery.sap.log.warning("Group tile with ID '"+e.getId()+"' is filtered out as the current user has no target mapping assigned for the intent '"+s+"'","\nGroup Tile ID: '"+e.getId()+"'\n"+"Title: '"+x+"'\n"+"Subtitle: '"+n+"'\n"+"Intent: '"+s+"' - ","sap.ushell_abap.adapters.abap.LaunchPageAdapter");}return d1.isSupported;};this._checkTileIntentSupport=function(e,t){var i,n;var s=N;if(!W(e)){i=a1(e);if(!i.navigation_use_semantic_object||!i.navigation_semantic_object||!i.navigation_semantic_action){return{isSupported:true};}n=t.get(s(i.navigation_semantic_object,i.navigation_semantic_action));if(!n){return{isSupported:false,reason:O.noTargetMapping};}return{isSupported:true};}if(e.isStub()){throw new sap.ui2.srvc.Error("Applauncher Tile not loaded completely","sap.ushell_abap.adapters.abap.LaunchPageAdapter");}if(e.getChip()&&typeof e.getChip().isBrokenReference==="function"&&e.getChip().isBrokenReference()){return{isSupported:false,reason:O.referenceTileNotFound};}i=$(e);if(jQuery.isEmptyObject(i)){return{isSupported:false,reason:O.emptyConfiguration};}if(!i.navigation_use_semantic_object){return{isSupported:true};}n=t.get(s(i.navigation_semantic_object,i.navigation_semantic_action));if(n){return{isSupported:true};}return{isSupported:false,reason:O.noTargetMapping};};this.moveGroup=function(e,n){var i=new jQuery.Deferred();function s(x){var d1,e1=[];x.forEach(function(f1){e1.push(f1.getId());});d1=JSON.parse(o.getConfiguration()||"{}");d1.order=e1;o.setConfiguration(JSON.stringify(d1),i.resolve.bind(i),i.reject.bind(i,I()));}this.getGroups().done(function(x){var d1=x.indexOf(e);x.splice(d1,1);x.splice(n,0,e);s(x);});return i.promise();};this.setGroupTitle=function(e,n){var i=new jQuery.Deferred();e.setTitle(n,i.resolve.bind(i),function(){i.reject(e.getTitle());});return i.promise();};this.addTile=function(e,i){var n=new jQuery.Deferred(),s=e.getChip();if(e.isStub()){n.reject(I(),"Tile was not added to the group as the tile failed loading");}else{if(!i){i=o.getDefaultPage();}i.addChipInstance(s,n.resolve.bind(n),n.reject.bind(n,I()));}return n.promise();};this.removeTile=function(e,i){var n=jQuery.Deferred();e.removeChipInstance(i,n.resolve.bind(n),n.reject.bind(n,I()));return n.promise();};this.moveTile=function(e,s,i,n,x,d1){var e1=new jQuery.Deferred(),f1=Q(e),g1,h1=new sap.ui2.srvc.Map(),i1,j1,k1,l1,m1,n1=e1.reject.bind(e1,I()),o1=2,p1;function q1(r1){o1-=1;i1=i1||r1;if(o1<=0){e1.resolve(i1);}}if(!x){x=n;}k1=H(n,this);l1=H(x,this);p1=this.getTileType(e);s=z(k1,e,p1);if(s<0){jQuery.sap.log.error("moveTile: tile not found in source group",null,C);n1();return e1.promise();}if(n===x){F(k1,e.getId(),i,d1);n.setLayout(JSON.stringify(k1),e1.resolve.bind(e1,e),n1);}else{g1=sap.ushell.Container.getService("PageBuilding").getFactory().getPageBuildingService();j1=e.getBagIds();j1.forEach(function(r1){var s1={texts:[],properties:[]},t1=e.getBag(r1);t1.getOwnTextNames().forEach(function(u1){s1.texts.push({name:u1,value:t1.getText(u1)});});t1.getOwnPropertyNames().forEach(function(u1){s1.properties.push({name:u1,value:t1.getProperty(u1)});});if(s1.texts.length>0||s1.properties.length>0){h1.put(r1,s1);}});g1.openBatchQueue();m1=this.getGroupTiles(x);x.addChipInstance(f1?e.getChip():e,function(r1){var s1,t1;m1.splice(i,0,r1);j1.forEach(function(u1){t1=h1.get(u1);if(t1){s1=r1.getBag(u1);t1.texts.forEach(function(v1){s1.setText(v1.name,v1.value);});t1.properties.forEach(function(v1){s1.setProperty(v1.name,v1.value);});s1.save(function(){},function(){jQuery.sap.log.error("Bag "+u1+": could not be saved",null,C);});}});F(l1,r1.getId(),i,d1);x.setLayout(JSON.stringify(l1),q1.bind(this,r1),n1);},n1,e.isStub());n.removeChipInstance(e,q1,n1);n.setLayout(JSON.stringify(k1),undefined,n1);g1.submitBatchQueue(undefined,n1);}return e1.promise();};this.getTileId=function(e){return e.getId();};this.getTileType=function(i){var n=i.getPage(),s;try{s=JSON.parse(n.getLayout());if(s.linkOrder&&s.linkOrder.indexOf(i.getId())>-1){return"link";}}catch(e){jQuery.sap.log.warning("Group "+n.getId()+": invalid layout: "+n.getLayout(),null,C);}if(i.isStub()===false){var x=i.getContract("types");if(x&&x.getAvailableTypes().indexOf("card")>-1){return"card";}}return"tile";};this.getCardManifest=function(e){var s,i,n;try{s=e.getConfigurationParameter("cardManifest");i=JSON.parse(s);n=M.getCardData(e);i=M.mergeCardData(i,n);return i;}catch(x){L.error("Manifest of card with id '"+e.getId()+"' could not be read. "+x.message);}};this.getTileTitle=function(e){return e.getTitle();};this.getTileView=function(e){var q=this,i=new jQuery.Deferred(),n;function s(){var d1,e1;n=e.getContract("types");if(n){d1=q.getTileType(e);n.setType(d1);}e1=e.getImplementationAsSapui5();if(d1==="link"){var f1=e1.getModel(),g1=e1.getController();var h1=new sap.m.GenericTile({mode:"{view>/mode}",header:"{view>/config/display_title_text}",subheader:"{view>/config/display_subtitle_text}",sizeBehavior:"{view>/sizeBehavior}",size:"Auto",press:[g1.onPress,g1]});h1.setModel(f1,"view");i.resolve(h1);return;}i.resolve(e1);}function x(d1){i.reject("Tile not successfully loaded"+(d1?(": "+d1):""));}if(!e.$loadingPromise){if(!e.isStub()){sap.ui2.srvc.call(s,x,!W(e));}else{x();}}else{e.$loadingPromise.fail(x).done(function(){try{s();}catch(ex){x((ex.message||ex));}});}return i.promise();};this.getTileSize=function(e){var i=(!e.isStub()&&e.getConfigurationParameter("row"))||"1",n=(!e.isStub()&&e.getConfigurationParameter("col"))||"1";return i+"x"+n;};this.refreshTile=function(e){e.refresh();};this.setTileVisible=function(e,n){var i=!e.isStub()&&e.getContract("visible"),s,x;if(i){i.setVisible(n);return;}if(e.isStub()&&e.$loadingPromise){s=this.getTileId(e);x=E[s];E[s]=n;if(x===undefined){e.$loadingPromise.done(function(){var i=e.getContract("visible");if(i){i.setVisible(E[s]);}});}return;}};this.getTileActions=function(e){var i=!e.isStub()&&e.getContract("actions");if(i){return i.getActions();}return[];};this.getTileTarget=function(e){return null;};this.getTileDebugInfo=function(e){var i,s,n=e.getChip(),x=n.getCatalog();i={chipId:n.getId(),chipInstanceId:e.getId(),completelyLoaded:!e.isStub()};if(x){i.catalogId=x.getId();}s=JSON.stringify(i);return s;};this.getCatalogs=function(){var e,i=k,n=j===false;function s(){var f1=0,g1=V();g1.forEach(function(h1){var i1=h1.ui2catalog;if(i1.isStub()||i1.getType()==='H'||i1.getType()==='REMOTE'){f1+=1;i1.refresh(function(){h1.title=i1.getTitle();h1.tiles=R(i1.getChips());e.notify(h1);f1-=1;if(f1<=0){e.resolve(g1);}},function(j1){jQuery.sap.log.error("Failed to load catalog: "+j1,i1.toString(),C);h1.errorMessage=j1||"Error";e.notify(h1);f1-=1;if(f1<=0){e.resolve(g1);}});}else{e.notify(h1);e.$notified=true;}});if(f1<=0){e.resolve(g1);}}function x(){var f1=V();f1.forEach(function(g1){e.notify(g1);});e.resolve(f1);}function d1(f1){var g1=o.getDefaultPage().getAllCatalogs();if(g1.isStub()){g1.load(s,e.reject.bind(e),"type eq 'CATALOG_PAGE' or type eq 'H' or type eq 'SM_CATALOG'"+" or type eq 'REMOTE'",true,"title");}else{sap.ui2.srvc.call(n?s:x,e.reject.bind(e),f1);}}function e1(f1){if(T&&T.cacheId){sap.ushell.Container.getService("PageBuilding").getFactory().getPageBuildingService().readAllCatalogs.cacheBusterTokens.put(d,T.cacheId);}if(P){d1(f1);}else{q.getGroups().done(d1).fail(e.reject.bind(e));}}if(k&&!k.$notified&&!n){e=k;}else{e=k=new jQuery.Deferred();e.done(function(){if(e===k){j=true;}}).always(function(){if(e===k){k=null;}});if(i){if(n){j=undefined;}i.always(e1);}else{e1(true);}}return e.promise();};this.isCatalogsValid=function(){return!!j;};this.getCatalogData=function(e){return e.ui2catalog.getCatalogData();};this.getCatalogError=function(e){return e.errorMessage;};this.getCatalogId=function(e){return e.id;};this.getCatalogTitle=function(e){return e.title;};this.getCatalogTiles=function(e){var i,n,s=new jQuery.Deferred(),x=0;function d1(){x-=1;if(x===0){s.resolve(e.tiles);}}function e1(f1,g1){jQuery.sap.log.error("Failed to load catalog tile: "+g1,f1.toString(),C);d1();}for(i=0;i<e.tiles.length;i+=1){n=e.tiles[i];if(n.isStub()){x+=1;n.load(d1,e1.bind(null,n));}}if(x===0){s.resolve(e.tiles);}return s.promise();};this.getCatalogTileId=function(e){var i=e.getChip(),s=i.getId();if(i.getCatalog()&&i.getCatalog().getCatalogData()&&i.getCatalog().getCatalogData().systemAlias){s+="_"+i.getCatalog().getCatalogData().systemAlias;}return s;};this.getCatalogTileTitle=function(e){return e.getChip().getTitle();};this.getCatalogTileSize=function(e){return this.getTileSize(e);};this.getCatalogTileView=function(e){var s=this.getCatalogTileTitle(e);if(e.isStub()){jQuery.sap.log.warning("CHIP (instance) is just a stub!",e.toString(true),C);return new sap.ushell.ui.tile.StaticTile({icon:"sap-icon://hide",info:"",infoState:"Critical",subtitle:"",title:s}).addStyleClass("sapUshellTileError");}if(e.getContract("preview")){e.getContract("preview").setEnabled(true);return r(e,s,"Cannot get catalog tile view as SAPUI5");}return new sap.ushell.ui.tile.StaticTile({title:s,subtitle:"",info:"",infoState:"Neutral",icon:"sap-icon://folder-full"});};this.getCatalogTileTargetURL=function(e){var s=w(e,"tileConfiguration","navigation_target_url");return s||(!e.isStub()&&e.getContract("preview")&&e.getContract("preview").getTargetUrl())||undefined;};this.getCatalogTilePreviewSubtitle=function(e){var s=v(e,"tileProperties","display_subtitle_text");return s||(!e.isStub()&&e.getContract("preview")&&e.getContract("preview").getPreviewSubtitle())||undefined;};this.getCatalogTilePreviewTitle=function(e){var s=v(e,"tileProperties","display_title_text");return s||(!e.isStub()&&e.getContract("preview")&&e.getContract("preview").getPreviewTitle())||undefined;};this.getCatalogTilePreviewIcon=function(e){var s=w(e,"tileConfiguration","display_icon_url");return s||(!e.isStub()&&e.getContract("preview")&&e.getContract("preview").getPreviewIcon())||undefined;};this.getCatalogTileKeywords=function(e){var i={},s=e.getTitle(),n=e.getChip().getDescription();function x(i,h1){if(sap.ui2.srvc.isArray(h1)){h1.forEach(function(i1){if(i.hasOwnProperty(i1)){return;}i[i1]=null;});}}function d1(e){var h1=v(e,"tileProperties","display_search_keywords");if(!sap.ui2.srvc.isString(h1)||h1===""){return[];}return h1.trim().split(/\s*,\s*/g);}function e1(e){var h1=v(e,"tileProperties","display_info_text");if(h1){return[h1];}return[];}function f1(e){var h1=w(e,"tileConfiguration","display_number_unit");if(h1){return[h1];}return[];}function g1(e){var h1;if(e.isStub()){return[];}h1=e.getContract("search");if(h1){return h1.getKeywords();}return[];}x(i,d1(e));x(i,e1(e));x(i,f1(e));x(i,g1(e));if(s){x(i,[s]);}if(n){x(i,[n]);}return Object.keys(i);};this.addBookmark=function(i,n){var s=S,x={display_icon_url:i.icon||"",display_info_text:i.info||"",display_subtitle_text:i.subtitle||"",display_title_text:i.title,navigation_target_url:i.url,navigation_use_semantic_object:false},d1=new jQuery.Deferred(),e1=sap.ushell.Container.getService("PageBuilding").getFactory(),f1,g1=new U(),h1,i1,j1=e1.getPageBuildingService(),k1,l1=N;function m1(k1,x,d1){k1.getBag("tileProperties").setText("display_title_text",x.display_title_text||"");k1.getBag("tileProperties").setText("display_subtitle_text",x.display_subtitle_text||"");k1.getBag("tileProperties").setText("display_info_text",x.display_info_text||"");k1.getBag("tileProperties").save(function(){d1.resolve();},function(n1){d1.reject(n1);});}h1=new U(i.url);if(i.url&&(i.url[0]==='#'||h1.host()+h1.path()===g1.host()+g1.path())){f1=sap.ushell.Container.getService("URLParsing");i1=f1.parseShellHash(f1.getShellHash(i.url));if(i1&&t.get(l1(i1.semanticObject,i1.action))!==undefined){x.navigation_use_semantic_object=true;x.navigation_semantic_object=i1.semanticObject;x.navigation_semantic_action=i1.action;x.navigation_semantic_parameters=f1.paramsToString(i1.params);}}if(i.serviceUrl){s=f;x.display_number_unit=i.numberUnit;x.service_refresh_interval=i.serviceRefreshInterval||0;x.service_url=i.serviceUrl;}if(n&&!(n instanceof sap.ui2.srvc.Page)){d1.reject("The given object is not a group");return d1.promise();}if(P){n=n||o.getDefaultPage();k1=e1.createChipInstance({chipId:s,pageId:n.getId(),title:i.title,configuration:JSON.stringify({tileConfiguration:JSON.stringify(x)}),layoutData:""});n.addChipInstance(k1,function(n1){m1(n1,x,d1);},d1.reject.bind(d1),undefined);}else{try{j1.createPageChipInstanceFromRawData({chipId:s,configuration:JSON.stringify({tileConfiguration:JSON.stringify(x)}),pageId:"/UI2/Fiori2LaunchpadHome",title:i.title},function(n1){e1.createChipInstance(n1,function(o1){m1(o1,x,d1);},d1.reject.bind(d1),undefined);},d1.reject.bind(d1));}catch(e){d1.reject(e.toString());}}return d1.promise();};sap.ui2.srvc.testPublishAt(q);function b1(e,s){return W(e)&&$(e).navigation_target_url===s;}sap.ui2.srvc.testPublishAt(q);function c1(s,e){var i=[],n=new jQuery.Deferred();q.getGroups().fail(n.reject.bind(n)).done(function(x){var d1=0;x.forEach(function(e1){e1.getChipInstances().forEach(function(f1){if(b1(f1,s)){d1+=1;if(e){i.push(e(f1));}}});});if(i.length===0){n.resolve(d1);}else{jQuery.when.apply(jQuery,i).fail(function(e1){n.reject(e1);}).done(function(){n.resolve(d1);});}});return n.promise();}this.countBookmarks=function(s){return c1(s);};this.deleteBookmarks=function(s){return c1(s,function(e){var i=new jQuery.Deferred();e.remove(i.resolve.bind(i),i.reject.bind(i));return i.promise();});};this.updateBookmarks=function(s,e){return c1(s,function(i){var n=$(i),x=new jQuery.Deferred(),d1=false;function e1(){i.getContract("configuration").fireConfigurationUpdated(["tileConfiguration"]);g1();}function f1(){i.getContract("bag").fireBagsUpdated(["tileProperties"]);x.resolve();}function g1(){if(typeof n.display_title_text==="string"){i.getBag("tileProperties").setText("display_title_text",n.display_title_text);d1=true;}if(typeof n.display_subtitle_text==="string"){i.getBag("tileProperties").setText("display_subtitle_text",n.display_subtitle_text);d1=true;}if(typeof n.display_info_text==="string"){i.getBag("tileProperties").setText("display_info_text",n.display_info_text);d1=true;}if(d1){i.getBag("tileProperties").save(f1,x.reject.bind(x));}else{x.resolve();}}n.display_icon_url=e.icon||n.display_icon_url;n.display_info_text=e.info||n.display_info_text;n.display_subtitle_text=e.subtitle||n.display_subtitle_text;n.display_title_text=e.title||n.display_title_text;n.navigation_target_url=e.url||n.navigation_target_url;n.display_number_unit=e.numberUnit||n.display_number_unit;n.service_refresh_interval=e.serviceRefreshInterval||n.service_refresh_interval;n.service_url=e.serviceUrl||n.service_url;i.updateConfiguration({tileConfiguration:JSON.stringify(n)},e1,x.reject.bind(x));return x.promise();});};this.onCatalogTileAdded=function(s){j=false;};};h.prototype._getShellType=function(){if(sap&&sap.ushell_abap&&typeof sap.ushell_abap.getShellType==="function"){return sap.ushell_abap.getShellType();}return"FLP";};return h;},true);
