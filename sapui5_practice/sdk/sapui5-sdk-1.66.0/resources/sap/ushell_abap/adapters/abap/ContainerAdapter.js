// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["jquery.sap.global","sap/ushell/System","sap/ushell/User","sap/ushell/utils","sap/ushell_abap/bootstrap/evo/abap.bootstrap.utils","sap/ui2/srvc/ODataWrapper","sap/ui/thirdparty/URI","sap/ui/thirdparty/datajs"],function(q,S,U,u,a,O,b,c){"use strict";var C=function(s,p,P){var o,d="/sap/public/bc/icf/logoff";this._logoutViaHiddenIFrame=function(D,e){var f=document.createElement("iframe"),g=e.replace(/"/g,'\\"');window.addEventListener("message",function(E){if(E.data===e){D.resolve();}});f.style.visibility="hidden";document.body.appendChild(f);var h=f.contentWindow.document;function i(){parent.postMessage(g,"*");}var I=h.createElement("img");I.src=e;I.addEventListener("load",i);I.addEventListener("error",i);h.body.appendChild(I);};this.getSystem=function(){return s;};this.getUser=function(){return o;};this._determineAccessibility=function(e){var A=u.getParameterValueBoolean("sap-accessibility");if(A!==undefined){return A;}A=e.accessibility;if(A!==undefined){return A;}return false;};this._setThemeAccessibilityFlags=function(e){if(e.userProfile&&e.userProfile.length){var f,g;f=e.userProfile.filter(function(h){return h.id&&h.id==='THEME';})[0];if(f&&f.value){e.setThemePermitted=(f.editState===3);}else{e.oUserProfileDataTheme=false;}g=e.userProfile.filter(function(h){return h.id&&h.id==='ACCESSIBILITY';})[0];if(g&&g.id){e.setAccessibilityPermitted=(g.editState===3);}else{e.setAccessibilityPermitted=false;}if(g&&g.value==="true"){e.accessibility=true;}if(g&&g.value==="false"){e.accessibility=false;}e.accessiblity=this._determineAccessibility(e);}};this._setUserProfileFlags=function(e){if(e.userProfile&&e.userProfile.length&&q.isArray(e.userProfile)){var f={};e.setContentDensityPermitted=false;e.userProfile.forEach(function(g){if((g.id in f)){return;}f[g.id]=g.id;if(g.id==="CONTENT_DENSITY"){e.contentDensity=g.value;e.setContentDensityPermitted=(g&&g.editState===3)||false;}if(g.id==="TRACKING_USAGE_ANALYTICS"){if(typeof g.value==="string"){if(g.value.toLowerCase()==="true"||g.value.toLowerCase()==="false"){g.value=(g.value.toLowerCase()==="true")||false;}else{g.value=undefined;}}if(typeof g.value==="undefined"||typeof g.value==="boolean"){e.trackUsageAnalytics=g.value;}else{e.trackUsageAnalytics=undefined;}}});}};this.load=function(){var D=new q.Deferred(),e=P.config;e.alias=s.getAlias();e.platform=s.getPlatform();s=new S(e);this._setThemeAccessibilityFlags(e);this._setUserProfileFlags(e);o=new U(e);sap.ui2.srvc.ODataWrapper["sap-language"]=e.language;sap.ui2.srvc.ODataWrapper["sap-client"]=e.client;if(e.target){C.startUpApplication={adjustedInitialTarget:e.adjustedInitialTarget,target:e.target};}this._setUserImage(o);return D.resolve().promise();};this.addFurtherRemoteSystems=function(){var D=new q.Deferred(),e;e=sap.ushell.Container.getService("PageBuilding").getFactory().getPageBuildingService();e.readAllCatalogsForUser("type eq 'H' or type eq 'REMOTE'",function(f){var g=f.results,h="/sap/opu/odata/sap/SM_CATALOG_SRV/";if(g){g.forEach(function(i){var I=/^\/sap\/hba\//.test(i.baseUrl);if(i.type==='H'||i.baseUrl===h||I){sap.ushell.Container.addRemoteSystem(new S({alias:i.systemAlias,platform:(I||i.type==='H')?"hana":"abap",baseUrl:i.type==='H'?"":";o="}));}});}D.resolve();},function(E){q.sap.log.error("Reading REMOTE catalogs failed: "+E,null,"sap.ushell_abap.adapters.abap.ContainerAdapter");D.reject();});return D.promise();};this.getCurrentUrl=function(){return window.location.href;};this.sessionKeepAlive=function(){var e="/sap/opu/odata/UI2/PAGE_BUILDER_PERS/PageSets";var x=a.createAndOpenXHR(e,null,"HEAD");x.onreadystatechange=function(){if(this.readyState===4){q.sap.log.debug("server session was extended");}};x.send();};this.logout=function(l){var D=new q.Deferred(),e;if(l){if(u.hasNativeLogoutCapability()){var f=(new b(d)).absoluteTo(this.getCurrentUrl()).search("").toString();window.external.getPrivateEpcm().doLogOff(f);}else{this.logoutRedirect();}q.sap.log.info("ABAP system logged out: "+s.getAlias(),null,"sap.ushell_abap.adapters.abap.ContainerAdapter");D.resolve();}else{e=s.adjustUrl(d);q.sap.log.info("Logging out from system '"+s.getAlias()+"' via hidden iframe");this._logoutViaHiddenIFrame(D,e);}return D.promise();};this.logoutRedirect=function(){var e=s.adjustUrl(d);this._setDocumentLocation(e);};this._setDocumentLocation=function(l){window.document.location=l;};this._setUserImage=function(o){function i(){var e=window["sap-ushell-config"],v=q.sap.getObject("renderers.fiori2.componentData.config.enableUserImage",undefined,e);return!!v;}if(i()&&o&&o.isJamActive&&o.isJamActive()){c.read('/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Self?$format=json',function(r){var j=r.results.Id,J="/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Members('"+j+"')/ProfilePhoto/$value";o.setImage(J);},function(){q.sap.log.error("Could not recieve JAM user data");});}};};return C;},true);
