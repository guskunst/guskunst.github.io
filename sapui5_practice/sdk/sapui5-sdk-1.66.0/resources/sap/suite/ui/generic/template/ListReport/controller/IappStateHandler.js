sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/base/Log"],function(q,B,C,N,S,U,L){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.extensionData",b="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function l(m,D){if(sap.ui.support){var i=L.getLevel();if(i<L.Level.INFO){L.setLevel(L.Level.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var c="";for(var k in D){s=s+c+k+": "+D[k];c="; ";}}L.info(m,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function g(s,c,t){var o=t.oCommonUtils.getNavigationHandler();var e=c.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var h=false;var j=null;var A=Promise.resolve();var D=false;var k=false;var E=c.byId("editStateFilter");var m;var p=null;var u=null;s.oSmartFilterbar.setSuppressSelection(true);var v=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function w(){return D;}function x(){var h1={};var i1=[];var j1=v();for(var i=0;i<j1.length;i++){var k1=j1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(k1)){i1.push(k1);}}var l1={suppressDataSelection:!D,visibleCustomFields:i1};h1[b]=l1;if(E){l1.editStateFilter=E.getSelectedKey();var m1=t.oComponentUtils.getTemplatePrivateModel();var n1=m1.getProperty("/listReport/activeObjectEnabled");l1.activeStateFilter=n1;}var o1=s.oMultipleViewsHandler.getContentForIappState();if(o1){var p1=o1.mode==="single"?"tableViewData":"tableTabData";l1[p1]=o1.state;}if(s.oWorklistData.bWorkListEnabled){var q1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var r1={"searchString":q1};l1.Worklist=r1;}var s1={};h1[d]=s1;c.getCustomAppStateDataExtension(s1);var t1;var u1=true;var v1=function(w1,x1){if(!(w1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!u1){throw new Error("State must always be provided synchronously");}if(x1){t1=t1||Object.create(null);var y1=w1.getMetadata().getNamespace();t1[y1]=x1;}};c.templateBaseExtension.provideExtensionAppStateData(v1);u1=false;if(t1){h1[a]=t1;}return h1;}function y(){var h1=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var i1=new S(h1);var j1=c.getVisibleSelectionsWithDefaults();for(var i=0;i<j1.length;i++){if(!i1.getValue(j1[i])){i1.addSelectOption(j1[i],"I","EQ","");}}if(c.byId('template::PageVariant')&&c.byId('template::PageVariant').currentVariantGetModified()&&i1.getID()){i1.setID("");}if(s.oWorklistData.bWorkListEnabled){var k1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";i1.addSelectOption("Worklist.SearchField","I","EQ",k1);}var l1={selectionVariant:i1.toJSONString(),tableVariantId:(!e&&s.oSmartTable.getCurrentVariantId())||"",customData:x()};return l1;}function z(){l("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:k,bDataAreShownInTable:D});if(!k){return;}k=false;try{p=o.storeInnerAppStateWithImmediateReturn(y(),true);}catch(i){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(p instanceof N){k=true;p=null;return;}p.promise.fail(function(h1){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+h1);});l("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:p.appStateKey,sAppStateKeyInUrl:u});if(u===p.appStateKey){p=null;}else{l("Call NavigationHandler.replaceHash",{appStateKey:p.appStateKey});o.replaceHash(p.appStateKey);}}function R(h1,i1){var j1=t.oComponentUtils.getTemplatePrivateModel();if(h1&&h1.editStateFilter!==undefined){if(E){E.setSelectedKey((h1.editStateFilter===null)?0:h1.editStateFilter);j1.setProperty("/listReport/vDraftState",(h1.editStateFilter===null)?0:h1.editStateFilter);}j1.setProperty("/listReport/activeObjectEnabled",!!h1.activeStateFilter);if(s.oMultipleViewsHandler.getMode()==="multi"&&E){s.oMultipleViewsHandler.restoreActiveButtonState(h1);}}var k1=h1&&h1.visibleCustomFields;if(k1&&k1.length>0){var l1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<l1.length;i++){var m1=l1[i];var n1=m1.getName();if(k1.indexOf(n1)!==-1){m1.setVisibleInFilterBar(true);}}}D=i1&&!(h1&&h1.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();b1(D);}}function F(i,e){if(e){var h1=i['sap-ui-fe-variant-id'];if(h1&&h1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(h1[0]);}}else{var i1=i['sap-ui-fe-variant-id'],j1=i['sap-ui-fe-filterbar-variant-id'],k1=i['sap-ui-fe-chart-variant-id'],l1=i['sap-ui-fe-table-variant-id'];G(j1&&j1[0],k1&&k1[0],l1&&l1[0],i1&&i1[0]);}}function G(i,h1,i1,j1){if(i||j1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||j1);}if(s.oSmartTable&&(i1||j1)){s.oSmartTable.attachAfterVariantInitialise(function(k1){s.oSmartTable.setCurrentVariantId(i1||j1);});s.oSmartTable.setCurrentVariantId(i1||j1);}if(s.oMultipleViewsHandler.getMode()==="multi"){s.oMultipleViewsHandler.setControlVariant(h1,i1,j1);}}function H(i){c.restoreCustomAppStateDataExtension(i||{});}function J(i){if(!i){return;}var h1=true;var i1=function(j1){if(!(j1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var k1=j1.getMetadata().getNamespace();if(!h1){throw new Error("State must always be restored synchronously");}return i[k1];};c.templateBaseExtension.restoreExtensionAppStateData(i1);h1=false;}function K(i,h1){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(b)){J(i[a]);H(i[d]);R(i[b],h1);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}H(i);}s.oSmartFilterbar.fireFilterChange();}function M(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function O(i){var h1=t.oComponentUtils.getTemplatePrivateModel();h1.setProperty("/generic/bDataAreShownInTable",i);}function P(i,h1){l("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:h1,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:h,bAppStateDirty:k});O(h1);if(h){return;}if(i||h1!==D){D=h1;if(!k){k=true;if(!s.oSmartFilterbar.isDialogOpen()){if(j){z();}else{setTimeout(z,0);}}}}}function Q(i){var h1=s.oSmartFilterbar.determineMandatoryFilterItems(),i1;for(var j1=0;j1<h1.length;j1++){if(h1[j1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){i1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(i1){i.oSelectionVariant.addParameter("P_DisplayCurrency",i1);}}break;}}}function T(i,h1,i1){l("fnAdaptToAppState called",{sNavType:i1,sAppStateKeyInUrl:u,sAppStateKey:i.appStateKey,storingInformationAppStateKey:p&&p.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=i1;var j1=i.appStateKey||"";if(h){return;}if(u===null){u=j1;}else if(j1!==u){return;}var k1=(!j1&&h1)||{};F(k1,e);h=true;var l1=i.selectionVariant||"";var m1=(!e&&i.tableVariantId)||"";var n1=i.oSelectionVariant||"";var o1={selectionVariant:n1,urlParameters:h1,selectedQuickVariantSelectionKey:""};var p1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant()));var q1=p1.getSelectOption(d);var r1=p1.getSelectOption(b);if((r.appStateKey!==j1||r.selectionVariant!==l1||r.tableVariantId!==m1||f(r.urlParams,k1))&&i1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!p||p.appStateKey!==j1){var s1=i&&i.bNavSelVarHasDefaultsOnly;if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){Q(i);}if(!s.oWorklistData.bWorkListEnabled){if(!s1||s.oSmartFilterbar.isCurrentVariantStandard()){o1.selectionVariant=i.oSelectionVariant;if(i1!==sap.ui.generic.app.navigation.service.NavType.iAppState){c.modifyStartupExtension(o1);g1(o1.selectionVariant,r,l1,true);}else{g1(o1.selectionVariant,r,l1,!s1);}}else{d1(p1,q1,r1,true);o1.selectionVariant=p1;c.modifyStartupExtension(o1);d1(o1.selectionVariant,q1,r1,false);if(!q.sap.equal(o1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){g1(o1.selectionVariant,r,l1,true);}}}if(m1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(m1);}i.customData=i.customData||{};var t1=s.oMultipleViewsHandler.getMode();if(t1){var u1=t1==="single"?"tableViewData":"tableTabData";if(i.customData[b]&&i.customData[b][u1]){s.oMultipleViewsHandler.restoreFromIappState(i.customData[b][u1]);}}if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=i.customData[b]&&i.customData[b]["Worklist"]?i.customData[b]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}K(i.customData,true);}r={appStateKey:j1,urlParams:k1,selectionVariant:l1,tableVariantId:m1};}if(i1!==sap.ui.generic.app.navigation.service.NavType.iAppState){if(i1===sap.ui.generic.app.navigation.service.NavType.initial){d1(p1,q1,r1,true);o1.selectionVariant=p1;c.modifyStartupExtension(o1);d1(o1.selectionVariant,q1,r1,false);if(!q.sap.equal(o1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){g1(o1.selectionVariant,r,l1,true);}}if(o1.selectedQuickVariantSelectionKey){var t1=s.oMultipleViewsHandler.getMode();if(t1){var v1=c.getOwnerComponent().getModel("_templPriv");v1.setProperty("/listReport/multipleViews/selectedKey",o1.selectedQuickVariantSelectionKey);}}}if(j){j();j=null;}if(i1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var w1=(i1===sap.ui.generic.app.navigation.service.NavType.xAppState||i1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!i.bNavSelVarHasDefaultsOnly;D=w1||s.bLoadListAndFirstEntryOnStartup||m||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()||s.oMultipleViewsHandler.getEnableAutoBinding();O(D);if(D){s.oSmartFilterbar.search();b1(D);}}if(i1==="initial"&&s.oWorklistData.bWorkListEnabled){if(s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}p=null;h=false;}function V(){if(!j){A=new Promise(function(h1){j=h1;});}var i=new Promise(function(h1,i1){var j1=o.parseNavigation();j1.done(function(k1,l1,m1){T(k1,l1,m1);h1();});j1.fail(function(k1,l1,m1){L.warning(k1.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");T({},l1,sap.ui.generic.app.navigation.service.NavType.initial);h1();});});return i;}function W(){var i=y();s.oSmartFilterbar.setFilterData({_CUSTOM:i.customData});}function X(){P(true,D);}function Y(i){var h1=i.getParameter("context");var i1=s.oSmartFilterbar.getFilterData();if(i1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var j1=i1._CUSTOM[b]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(j1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{K(i1._CUSTOM);}}else{var k1=x();n(k1[d]);n(k1[b]);K(k1);}if(I.indexOf(h1)<0){D=i.getParameter("executeOnSelect");P(true,D);}}function Z(){if(!e){P(true,D);}}function $(){if(!e){P(true,D);}}function _(i){var h1=i.getParameter("arguments");var i1=h1&&h1["?query"];u=(i1&&i1["sap-iapp-state"])||"";if(p){if(p.appStateKey!==u){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+u+" expected "+p.appStateKey);return false;}V();return true;}return false;}function a1(){m=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(z);}function b1(D){var i=c.getOwnerComponent().getModel("_templPriv");if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}function c1(i,h1,i1){var j1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(j1,{replace:h1,strictMode:i1});}function d1(i,h1,i1,j1){if(i&&(h1||i1)){if(j1){i.removeSelectOption(d);i.removeSelectOption(b);}else{i.massAddSelectOption(d,h1);i.massAddSelectOption(b,i1);}}}function e1(h1,r,i1){if(h1&&(r.selectionVariant!==i1||s.sNavType==="initial")){var j1=h1.getParameterNames().concat(h1.getSelectOptionsPropertyNames());for(var i=0;i<j1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(j1[i]);}}}function f1(i){var h1=c.getOwnerComponent().getModel().getMetaModel();var i1=c.getOwnerComponent().getEntitySet();var j1=h1.getODataEntityType(h1.getODataEntitySet(i1).entityType);j1.property.forEach(function(k1){if(k1["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var l1=k1["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var m1=k1.name;if(i.getParameter(l1)&&!i.getParameter(m1)){i.addParameter(m1,i.getParameter(l1));}if(i.getSelectOption(l1)&&!i.getSelectOption(m1)){var n1=i.getSelectOption(l1);n1.forEach(function(o1){i.addSelectOption(m1,o1.Sign,o1.Option,o1.Low,o1.High);});}if(i.getParameter(m1)&&!i.getParameter(l1)){i.addParameter(l1,i.getParameter(m1));}if(i.getSelectOption(m1)&&!i.getSelectOption(l1)){var n1=i.getSelectOption(m1);n1.forEach(function(o1){i.addSelectOption(l1,o1.Sign,o1.Option,o1.Low,o1.High);});}}});}function g1(i,r,h1,i1){f1(i);e1(i,r,h1);c1(i.toJSONObject(),i1,false);}s.getCurrentAppState=y;return{areDataShownInTable:w,parseUrlAndApplyAppState:V,getUrlParameterInfo:M,changeIappState:P,onSmartFilterBarInitialise:a1,onBeforeSFBVariantFetch:W,onAfterSFBVariantSave:X,onAfterSFBVariantLoad:Y,onAfterTableVariantSave:Z,onAfterApplyTableVariant:$,isStateChange:_};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,c,t){q.extend(this,g(s,c,t));}});});
