sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsSingleTableModeHelper","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsMultipleTablesModeHelper","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/testableHelper","sap/base/Log"],function(q,B,M,a,F,t,L){"use strict";var P="/listReport/multipleViews";var b=P+"/selectedKey";var c=P+"/mode";var d=P+"/items";function s(o,I){if(o.getBindings){var e=o.getBindings();for(var i=0;i<e.length;i++){s(e[i],I);}}else{var T=o.getType();o.setType(T,I);}}function g(S,C,T){var I;var Q;var m;var e;var o=T.oComponentUtils.getTemplatePrivateModel();var f;var D=T.oServices.oApplication.getBusyHelper().getBusyDelay();function h(){return Q&&Q.enableAutoBinding;}function r(){if(I&&I.fnRegisterToChartEvents){return I.fnRegisterToChartEvents.apply(null,arguments);}}function k(){if(I&&I.onDetailsActionPress){return I.onDetailsActionPress.apply(null,arguments);}}function l(){if(!I){return;}var i=A();return i.templateSortOrder;}function n(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var h1=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=h1.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function p(){if(I){var i=o.getProperty(b);var j=I.getContentForIappState(i);return{mode:m,state:j};}}function R(i){if(I){var j=I.getSelectedKeyAndRestoreFromIappState(i);if(f[j]){o.setProperty(b,j);}}}function u(i,j,h1){if(I){I.setControlVariant&&I.setControlVariant(i,j,h1);}}function v(){return o.getProperty(b);}function w(h1,i1){var j1=[],k1;var l1=T.oCommonUtils.getElementCustomData(i1).variantAnnotationPath;if(l1){var m1=h1[l1];if(!m1){return[];}if(!m1.SelectOptions&&m1.SelectionVariant){m1=m1.SelectionVariant;if(m1.Path){l1=m1.Path.split("@")[1];m1=l1&&h1[l1];}}if(m1.AnnotationPath){k1=m1.AnnotationPath.split("@")[1];m1=h1[k1];}for(var i in m1.SelectOptions){if(m1.SelectOptions[i].PropertyName){var n1=m1.SelectOptions[i].PropertyName.PropertyPath;for(var j in m1.SelectOptions[i].Ranges){var o1=m1.SelectOptions[i].Ranges[j].Option;o1.EnumMember=o1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var p1=m1.SelectOptions[i].Ranges[j].Low;var q1=m1.SelectOptions[i].Ranges[j].High;var r1=Object.keys(p1)[0];if(q1){var s1=Object.keys(q1)[0];j1.push(new F(n1,o1.EnumMember,p1[r1],q1[s1]));}else{j1.push(new F(n1,o1.EnumMember,p1[r1]));}}}}}return j1;}function x(j,h1){j.getCustomData().forEach(function(i1){var j1=i1.getKey();if(j1==="text"){var k1=i1.getBinding("value");var l1=!k1&&i1.getBindingInfo("value");if(!k1&&!l1){var m1=q.extend({},o.getProperty(h1));m1.text=i1.getValue();o.setProperty(h1,m1);return;}var n1=function(o1){var k1=o1.getSource();var m1=q.extend({},o.getProperty(h1));m1.text=k1.getExternalValue();o.setProperty(h1,m1);};if(k1){k1.attachChangeOnce(n1);s(k1,"string");}else{l1.events={change:n1};for(var i=0;i<l1.parts.length;i++){l1.parts[i].targetType="string";}}}});}function y(i,j,h1){var i1=C.getOwnerComponent().getModel().getMetaModel();var j1=i1.getODataEntitySet(h1);var k1=i1.getODataEntityType(j1.entityType);var l1=w(k1,j);var m1=T.oCommonUtils.getElementCustomData(j);var n1=f[i]||Object.create(null);n1.selectionVariantFilters=l1;n1.templateSortOrder=m1.TemplateSortOrder;n1.implementingControl=j;n1.entitySet=h1;n1.dirtyState=0;f[i]=n1;if(e){var o1=d+"/"+i;var p1=function(r1,s1,t1){if(n1.numberOfUpdates!==s1){return;}var q1=q.extend({},o.getProperty(o1));if(!q1.state&&r1=="busy"){setTimeout(function(){if(o.getProperty(o1).state==="busy"){q1=q.extend({},o.getProperty(o1));q1.state="busyLong";o.setProperty(o1,q1);}},D);}q1.state=r1;if(!r1){q1.count=t1;}o.setProperty(o1,q1);};n1.numberOfUpdates=0;n1.updateStartFunction=p1.bind(null,"busy");n1.updateSuccessFunction=p1.bind(null,"");n1.errorFunction=p1.bind(null,"error");var q1={count:0,state:""};o.setProperty(o1,q1);x(j,o1);}}function z(){return m;}function A(){return f[o.getProperty(b)];}function E(i){if(!I){return;}var j=i.getParameter("bindingParams");S.oFiltersWithoutSmartFilterBar=q.extend(true,{},j);if(z()==="multi"){var h1=S.oSmartFilterbar.getFilters();S.oFiltersForCounts=H(j);K(S.oSmartTable,j,h1);}else if(z()==="single"){S.oFiltersForCounts=q.extend(true,{},j);}G(j);}function G(j){var h1=A();if(h1){var i1=h1.selectionVariantFilters;for(var i in i1){j.filters.push(i1[i]);}}}function H(i){var j=q.extend(true,{},i);J(j.filters,S.oMultipleViewsHandler.aTableFilters);return j;}function J(h1,i1){for(var i in i1){var j1=i1[i];for(var j=h1.length;j--;j>=0){if(JSON.stringify(h1[j])===JSON.stringify(j1)){h1.splice(j,1);break;}}}}function U(){var i=S.oSmartTable.getModel();var j=[],h1,i1;var j1=S.oSmartFilterbar.getBasicSearchValue();var k1={};var l1;var m1=S.oSmartTable;var n1=f[o.getProperty(b)];if(j1){k1={search:j1};}var o1;for(var p1 in f){o1=q.extend(true,{},S.oFiltersForCounts);l1=S.oSmartFilterbar.getFilters();var q1=f[p1];h1=q1.entitySet;if(!h1){h1=S.oSmartTable.getEntitySet();}i1=typeof S.oSmartTable.getTableBindingPath==="function"?S.oSmartTable.getTableBindingPath():S.oSmartTable.getChartBindingPath();q1.numberOfUpdates++;q1.updateStartFunction(q1.numberOfUpdates);if(z()==="multi"){K(q1.implementingControl,o1,l1);}j=o1.filters.concat(q1.selectionVariantFilters);var r1=i1!==""?i1:"/"+h1;i.read(r1+"/$count",{urlParameters:k1,filters:j,groupId:"updateMultipleViewsItemsCounts",success:q1.updateSuccessFunction.bind(null,q1.numberOfUpdates),error:q1.errorFunction.bind(null,q1.numberOfUpdates)});}if(n1&&n1.entitySet===m1.getEntitySet()&&(n1.implementingControl.getMetadata().getElementName()===m1.getMetadata().getElementName())){if(I&&I.fnCheckForMessageDisplay&&I.fnGetNotAppliedFilter){var s1=I.fnGetNotAppliedFilter();I.fnCheckForMessageDisplay(s1);}}}function K(i,j,h1){W(i,h1,j);}function N(){if(e){U();}}function O(){return e;}function V(i){var j=T.oCommonUtils.getMetaModelEntityType(i);return j.navigationProperty;}function W(i,j,h1){var i1=[],j1=[],k1;if(j.length<1){return;}i1=a1(i,j);j1=h1.filters&&h1.filters.slice();j1=j1.concat(i1);k1=new F(j1,true);h1.filters=[k1];}function X(i){var j;for(j in f){if(f[j].implementingControl===i){return f[j].properties;}}}function Y(j,h1,i1,j1,k1){var l1,m1,n1,o1,p1;if(j.indexOf("/")!==-1){l1=j.split("/");for(var i=0;i<l1.length-1;i++){m1=l1[i];for(var i in k1){if(k1[i].name===m1){n1=true;break;}}if(!n1){return false;}o1=i1.getODataAssociationEnd(j1,m1);j1=o1&&i1.getODataEntityType(o1.type);k1=j1&&j1.navigationProperty;}p1=j1&&j1.property;}else{p1=X(h1);}return p1;}function Z(i){var j,h1;if(i.indexOf("/")!==-1){j=i.split("/");h1=j.pop();}else{h1=i;}return h1;}function $(i){var j=T.oCommonUtils.isSmartTable(S.oSmartTable);if(i!==2){S.oSmartTable[j?"rebindTable":"rebindChart"]();}if(i>1){if(j){T.oCommonUtils.refreshModel(S.oSmartTable);T.oCommonUtils.refreshSmartTable(S.oSmartTable);}else{}}}function _(i,j,h1){if(!I){return false;}var i1=Array.isArray(j);if((i1&&j.length===0)||(h1&&q.isEmptyObject(h1))){return true;}var j1=v();var k1=T.oComponentUtils.isComponentActive();if(m==="single"){if(i1?j.indexOf(j1)<0:(j&&j!==j1)){return true;}if(k1){$(i);return true;}else{j=j1;i1=false;}}var l1=function(m1){if(m1===j1&&k1){$(i);return;}var n1=f[m1];if(n1.dirtyState>0&&n1.dirtyState!==i){n1.dirtyState=3;}else{n1.dirtyState=i;}};if(j){if(i1){j.forEach(l1);return true;}l1(j);return true;}for(var m1 in f){if(!h1||h1[f[m1].implementingControl.getEntitySet()]){l1(m1);}}return true;}function a1(i,h1){var i1,j1,k1,j,l1,m1,n1,o1,p1,q1,p1,r1,s1=[];if(!h1||h1.length<1){return;}n1=i.getModel().getMetaModel();o1=T.oCommonUtils.getMetaModelEntityType(i);m1=V(i);r1=f[o.getProperty(b)];p1=q.extend(true,[],h1);if(p1[0]&&p1[0].aFilters instanceof Array){l1=p1[0].aFilters;}else{l1=p1;}if(!l1){return;}for(j=l1.length-1;j>=0;j--){j1=false;if(l1[j].aFilters instanceof Array){if(l1[j].aFilters[0].sPath){k1=l1[j].aFilters[0].sPath;}else if(l1[j].aFilters[0].aFilters[0].sPath){k1=l1[j].aFilters[0].aFilters[0].sPath;}else{L.error("MultipleViewsHandler: The filter name could not be determined.");}}else{k1=l1[j].sPath;}i1=Y(k1,i,n1,o1,m1);if(!i1){l1.splice(j,1);continue;}q1=Z(k1);i1.some(function(t1){var u1;if(t1.name===q1){u1=t1["com.sap.vocabularies.UI.v1.Hidden"];j1=u1?u1.Bool!=="true":true;return j1;}});if(!j1){if(r1&&r1.entitySet===i.getEntitySet()&&(r1.implementingControl.getMetadata().getElementName()===i.getMetadata().getElementName())){if(!s1.includes(q1)){s1.push(q1);}}l1.splice(j,1);}}if(p1&&p1[0]&&p1[0].aFilters&&p1[0].aFilters.length<1){p1=[];}if(r1&&r1.entitySet===i.getEntitySet()&&(r1.implementingControl.getMetadata().getElementName()===i.getMetadata().getElementName())){if(I&&I.formatNotAppliedFilters){I.formatNotAppliedFilters(s1,i);}}return p1;}function b1(){var j=false;for(var i in Q.variants){if(!!Q.variants[i].entitySet){j=true;}else{j=false;}}return j;}function c1(){if(I&&I.setActiveButtonState){I.setActiveButtonState();}}function d1(){if(I&&I.restoreActiveButtonState){I.restoreActiveButtonState();}}function e1(){if(I&&I.getActiveButtonStateCustomData){var i=I.getActiveButtonStateCustomData();var j=i?JSON.parse(i.getValue()):false;o.setProperty("/listReport/activeObjectEnabled",j);}}function f1(){if(I&&I.onMessageCloseActionPress){I.onMessageCloseActionPress();}}function g1(i){if(!I){return C.getOwnerComponent().getEntitySet()===i;}for(var j in f){var h1=f[j];if(h1.entitySet===i){return true;}}return false;}(function(){var i,j,h1,i1;i=C.getOwnerComponent().getAppComponent().getConfig();j=i&&i.pages[0]&&i.pages[0].component&&i.pages[0].component.settings;if(!j){return;}h1=j.quickVariantSelectionX;i1=j.quickVariantSelection;if(h1&&i1){throw new Error("Defining both QuickVariantSelection and QuickVariantSelectionX in the manifest is not allowed.");}Q=h1||i1;if(!Q){return;}if(h1&&b1()){e=Q.showCounts===false?false:true;}else{e=Q.showCounts;}f=Object.create(null);o.setProperty(P,Object.create(null));o.setProperty(d,Object.create(null));var j1=C.byId("page");var k1=function(l1){o.setProperty(b,l1);var m1=o.bindProperty(b);m1.attachChange(function(n1){if(I&&I.fnSetMessageVisibility&&I.fnSetNotAppliedFilter){I.fnSetNotAppliedFilter([]);I.fnSetMessageVisibility(I.fnGetNotAppliedFilter());}if(j1){j1.setPreserveHeaderStateOnScroll(true);}var o1=n1.getSource().getValue();if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(o1);}e1();var p1=S.oIappStateHandler.areDataShownInTable()||S.oWorklistData.bWorkListEnabled;var q1=(m==="single")?3:f[o1].dirtyState;if(S.oWorklistData.bWorkListEnabled&&q1<2){q1=q1+2;}if(p1&&q1>0){$(q1);}else{T.oCommonUtils.setEnabledToolbarButtons(S.oSmartTable);if(I&&I.fnUpdateMessageForFilter){I.fnUpdateMessageForFilter(S.oSmartTable);}}f[o1].dirtyState=0;S.oIappStateHandler.changeIappState(true,p1);if(T.oCommonUtils.isSmartTable(S.oSmartTable)){if(j1&&j1.getPreserveHeaderStateOnScroll()){j1.setPreserveHeaderStateOnScroll(false);}}});};if(i1){I=new M(i1,S,C,T,k1,f,y);m="single";L.info("This list supports multiple views with single table");}else{I=new a(h1,S,C,T,k1,f,y);m="multi";L.info("This list supports multiple views with multiple tables/charts");}o.setProperty(c,m);})();var J=t.testable(J,"fnRemoveTableSettingsFromFilters");var a1=t.testable(a1,"fnCleanupIrrelevantFilters");var X=t.testable(X,"findEntityProperties");var W=t.testable(W,"fnAddFiltersFromSmartFilterbar");var w=t.testable(w,"getSelectionVariantFilters");t.testable(function(){return I;},"getImplementingHelper");return{getEnableAutoBinding:h,fnRegisterToChartEvents:r,onDetailsActionPress:k,determineSortOrder:l,onDataRequested:N,formatItemTextForMultipleView:n,getContentForIappState:p,restoreFromIappState:R,getVariantSelectionKey:v,getMode:z,onRebindContentControl:E,getShowCounts:O,refreshOperation:_,onMessageCloseActionPress:f1,setActiveButtonState:c1,restoreActiveButtonState:d1,setControlVariant:u,hasEntitySet:g1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.MultipleViewsHandler",{constructor:function(S,C,T){q.extend(this,g(S,C,T));}});});
