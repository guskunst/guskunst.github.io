/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/MessageScope","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/suite/ui/generic/template/library","sap/base/Log"],function(q,U,N,F,a,b,M,J,R,A,c,B,d,P,T,C,V,t,e,f,L){"use strict";A=t.observableConstructor(A);var D=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function g(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function h(){return new P({processObservers:[]});}var m=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function j(k,l){var n={oAppComponent:k,componentRegistry:Object.create(null),aRunningSideEffectExecutions:[],getText:g,mRouteToTemplateComponentPromise:Object.create(null),oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oPaginatorInfo:Object.create(null),oStatePreserversAvailablePromise:Promise.resolve(),oValidationMessageBinding:m.bindList("/",null,null,v)};n.oValidationMessageBinding.attachChange(q.noop);var p;var s;var u;function w(){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("URLParsing");n.oTemplatePrivateGlobalModel.setProperty("/generic",{crossAppNavSupport:!!i&&i.isIntentUrl(document.URL),draftIndicatorState:D.Clear,shellServiceUnavailable:false,forceFullscreenCreate:false});k.setModel(n.oTemplatePrivateGlobalModel,"_templPrivGlobal");n.oShellServicePromise.catch(function(){n.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});}function x(){n.fnAddSideEffectPromise=function(b1){var i=0;for(;n.aRunningSideEffectExecutions[i];){i++;}n.aRunningSideEffectExecutions[i]=b1;var c1=function(){n.aRunningSideEffectExecutions[i]=null;};b1.then(c1,c1);};p.attachEvent("beforeSideEffectExecution",function(i){if(i.getParameter("valueChange")||i.getParameter("fieldControl")){var b1=i.getParameter("promise");n.oBusyHelper.setBusy(b1);n.fnAddSideEffectPromise(b1);}});var _=k.getModel("_templPrivGlobal");var a1="/generic/draftIndicatorState";p.attachBeforeQueueItemProcess(function(i){if(i.draftSave){_.setProperty(a1,D.Saving);}});p.attachOnQueueCompleted(function(){if(_.getProperty(a1)===D.Saving){_.setProperty(a1,D.Saved);}});p.attachOnQueueFailed(function(){if(_.getProperty(a1)===D.Saving){_.setProperty(a1,D.Clear);}});_.setProperty("/generic/appComponentName",k.getMetadata().getComponentName());}function y(){var i={appComponent:k,oTemplateContract:n,application:new c(n),oViewDependencyHelper:new V(n)};n.oViewDependencyHelper=i.oViewDependencyHelper;n.oShellServicePromise=k.getService("ShellUIService").catch(function(){var b1=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");return((b1&&b1.createInstance())||Promise.reject());});n.oShellServicePromise.catch(function(){L.warning("No ShellService available");});(U.prototype.init||q.noop).apply(k,arguments);n.oBusyHelper.setBusy(n.oShellServicePromise);u=r(i);var _=k.getModel();n.bCreateRequestsCanonical=true;var a1=Promise.resolve(false)||_.messageScopeSupported();a1.then(function(b1){if(b1){_.setMessageScope(M.BusinessObject);_.enableCanonicalRequests(true);n.bCreateRequestsCanonical=false;}p=new A(_);w();s=new d(n);x();C.enableAutomaticDraftSaving(n);if((!_.oMetadata||!_.oMetadata.isLoaded())||_.oMetadata.isFailed()){_.attachMetadataFailed(function(){s.navigateToMessagePage({title:g("ST_GENERIC_ERROR_TITLE"),text:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var c1 in n.componentRegistry){n.componentRegistry[c1].fnViewRegisteredResolve(true);}});}if(k&&k.getMetadata()&&k.getMetadata().getManifest()){e.setAppComponent(k);}e.setApplicationStatus(e.mApplicationStatus.LOADING);e.publishEvent("elements","ViewRenderingStarted",{});n.oBusyHelper.setBusyReason("initAppComponent",false);});}function z(){if(n.oNavigationHost){return"";}if(n.sRoutingType==="f"){var i=new F();n.oNavigationHost=i;n.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];n.oNavigationObserver=new P({processObservers:n.aNavigationObservers});n.aHeaderLoadingObservers=[h(),h(),h()];}else{var _=new N({id:k.getId()+"-appContent"});n.oNavigationHost=_;n.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:_.attachNavigate.bind(_),attachProcessStop:_.attachAfterNavigate.bind(_)}});}n.oHeaderLoadingObserver=new P({processObservers:n.aHeaderLoadingObservers||[]});n.oPagesDataLoadedObserver=new P({processObservers:[n.oHeaderLoadingObserver,n.oNavigationObserver]});n.oNavigationHost.addStyleClass(n.oApplicationProxy.getContentDensityClass());n.oBusyHelper=new B(n);n.oBusyHelper.setBusyReason("initAppComponent",true,true);return n.oNavigationHost;}function E(){if(n.oNavigationHost){n.oNavigationHost.destroy();}if(p){p.destroy();}if(s){s.destroy();}if(n.oValidationMessageBinding){n.oValidationMessageBinding.destroy();}e.setAppComponent(null);(U.prototype.exit||q.noop).apply(k,arguments);u();t.endApp(l);}function G(i){var _=Object.keys(i).map(function(a1){var b1=i[a1];if(b1.pages){b1.pages=G(b1.pages);}return i[a1];});return _;}function H(_,a1){if(!_){return;}for(var i=0;i<_.length;i++){var b1=_[i];if(b1.routingSpec&&b1.routingSpec.noOData){b1.entitySet=b1.routingSpec.routeName;if(a1>1){b1.navigationProperty=b1.routingSpec.routeName;}}H(b1.pages,a1+1);if(b1.embeddedComponents){for(var c1 in b1.embeddedComponents){var d1=b1.embeddedComponents[c1];if(d1.pages){d1.pages=G(d1.pages);H(d1.pages,a1+1);}}}if(b1.implementingComponent&&b1.implementingComponent.pages){b1.implementingComponent.pages=G(b1.implementingComponent.pages);H(b1.implementingComponent.pages,a1+1);}}}function I(i){if(i){var _=i.entitySet;var a1=(i.component&&i.component.settings&&i.component.settings.quickVariantSelectionX&&i.component.settings.quickVariantSelectionX.variants)||{};var b1=function(a1){for(var c1 in a1){var d1=a1[c1];if(!!d1.entitySet){return true;}}return false;};if(b1(a1)){for(var c1 in a1){var d1=a1[c1];if(d1.entitySet===undefined){d1.entitySet=_;}}}}}var K;function O(){if(!K){var i=k.getMetadata();K=i.getManifestEntry("sap.ui.generic.app");if(K._version==="1.3.0"&&K.pages&&q.isPlainObject(K.pages)){K.pages=G(K.pages);}H(K.pages,0);I(K.pages[0]);}return K;}var Q;function S(){if(!Q){Q=q.extend({},k.getMetadata().getManifest());Q["sap.ui.generic.app"]=O();}return Q;}function W(){var i=k.getManifestObject();var _=i.getEntry("sap.ui.generic.app").settings;n.sRoutingType=(_&&_.flexibleColumnLayout)?"f":"m";return"sap."+n.sRoutingType+".routing.Router";}var X=Promise.resolve();function Y(){var i=new Promise(function(_){X.then(function(){var a1=[];n.oNavigationControllerProxy.getActiveComponents().forEach(function(b1){var c1=n.componentRegistry[b1];var d1=c1.oComponent.getComponentContainer();var e1=d1.getParent();if(e1.getMetadata().getName()!=="sap.m.NavContainer"){throw new Error("Recreation only possible for sap.m.NavContainer");}var f1=n.oNavigationControllerProxy.createComponentInstance(n,c1.routeConfig,n.oNavigationControllerProxy.mRouteToComponentResolve[c1.route]);a1.push(f1.loaded().then(function(f1){var g1=d1.getComponentInstance().getBindingContext();e1.removePage(d1);e1.addPage(f1);e1.to(f1);d1.destroy();var h1=f1.getComponentInstance();var i1=n.componentRegistry[h1.sId];n.mRouteToTemplateComponentPromise[c1.route]=Promise.resolve(h1);if(g1){Promise.all([i1.viewRegistered,i1.reuseComponentsReady]).then(function(){i1.utils.bindComponent(g1.getPath(),true);});}return i1.oViewRenderedPromise;}));});_(Promise.all(a1));});});X=i.then(q.noop);return X;}var Z={init:y,createContent:z,exit:E,_getRouterClassName:W,getConfig:O,getInternalManifest:S,getTransactionController:function(){return p.getTransactionController();},getApplicationController:function(){return p;},getNavigationController:function(){return s;}};var $={retemplateActiveComponents:Y};if(sap.ui.getCore().getConfiguration().getDesignMode()){q.extend(Z,$);}return Z;}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true},"considerAnalyticalParameters":{"type":"boolean","defaultValue":"false"},"showDraftToggle":{"type":"boolean","defaultValue":false}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},constructor:function(){var i=t.startApp();q.extend(this,j(this,i));(U.prototype.constructor||q.noop).apply(this,arguments);}});});
