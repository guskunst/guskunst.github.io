sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Control","sap/suite/ui/commons/library","sap/ui/core/library","sap/m/library","sap/base/Log","sap/ui/Device","sap/ui/core/Icon","sap/ui/core/ResizeHandler","./ResizeHistoryItem","./RotateHistoryItem","./CropRectangleHistoryItem","./CropEllipseHistoryItem","./FilterHistoryItem","./FlipHistoryItem","./FilterUtils","./ImageEditorRenderer","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-resizable"],function(q,C,l,a,M,L,D,I,R,b,c,d,e,F,f,g){"use strict";var h=l.ImageEditorMode;var j=C.extend("sap.suite.ui.commons.imageeditor.ImageEditor",{metadata:{library:"sap.suite.ui.commons",properties:{src:{type:"string",defaultValue:""},mode:{type:"sap.suite.ui.commons.ImageEditorMode",defaultValue:h.Default},keepCropAspectRatio:{type:"boolean",defaultValue:true},keepResizeAspectRatio:{type:"boolean",defaultValue:true}},events:{loaded:{},error:{},sizeChanged:{parameters:{width:{type:"int"},height:{type:"int"},originalWidth:{type:"int"},originalHeight:{type:"int"}}},cropAreaChanged:{parameters:{cropArea:{type:"object"},originalCropArea:{type:"object"}}},zoomChanged:{parameters:{zoom:{type:"int"}}},historyChanged:{history:{type:"sap.suite.ui.commons.imageeditor.HistoryItem[]"},index:{type:"int"}}}}});j.LIMITS=Object.freeze({ZOOM_MIN:100,ZOOM_MAX:500,WIDTH_MIN:1,WIDTH_MAX:8096,HEIGHT_MIN:1,HEIGHT_MAX:8096,ROTATION_MIN:-360,ROTATION_MAX:360,SEPIA_MIN:0,SEPIA_MAX:100,GRAYSCALE_MIN:0,GRAYSCALE_MAX:100,SATURATE_MIN:0,SATURATE_MAX:500,INVERT_MIN:0,INVERT_MAX:100,BRIGHTNESS_MIN:0,BRIGHTNESS_MAX:500,CONTRAST_MIN:0,CONTRAST_MAX:500,CROP_AREA_MIN:55});var k=Object.freeze({CROP_AREA_SHORTER_SIDE_OFFSET:0.8});j.prototype.init=function(){var t=this;this._oCanvas=document.createElement("canvas");this._initCanvas();this._oOrigImg=new Image();this._oSavedImg=document.createElement("canvas");this._oSavedImg.width=0;this._oSavedImg.height=0;this._oOrigImg.crossOrigin="Anonymous";this._oOrigImg.onload=function(){t._bImageLoaded=true;t._drawImage(t._oOrigImg);t._storeCurrentImg();if(t._isReady()){t._onAfterIsReady();}t.fireLoaded();};this._oOrigImg.onerror=function(E){t.fireError();};};j.prototype.onBeforeRendering=function(){if(this._sResizeHandlerId){R.deregister(this._sResizeHandlerId);}};j.prototype.onAfterRendering=function(){this._$Container=this.$("canvasInnerContainer");this._$Container.prepend(this._oCanvas);this._initContainer();this._initCropArea();this._sResizeHandlerId=R.register(this,this._refreshContainerSize.bind(this));if(this._isReady()){this._onAfterIsReady();}};j.prototype.exit=function(){R.deregister(this._sResizeHandlerId);};j.prototype.setSrc=function(s){this.setProperty("src",s,true);this._reset();if(s){this._oOrigImg.src=s;}else{this.fireLoaded();}return this;};j.prototype.setKeepCropAspectRatio=function(K){this.setProperty("keepCropAspectRatio",K,true);this._updateResizableCropAspectRatio();return this;};j.prototype.setKeepResizeAspectRatio=function(K){this.setProperty("keepResizeAspectRatio",K,true);this._updateResizableResizeAspectRatio();return this;};j.prototype.getLoaded=function(){return!!this.getSrc()&&this._bImageLoaded;};j.prototype.setSize=function(w,H,p){this._throwIfNotLoaded("setSize");var o,O;w=this._constraintValue(w,j.LIMITS.WIDTH_MIN,j.LIMITS.WIDTH_MAX);H=this._constraintValue(H,j.LIMITS.HEIGHT_MIN,j.LIMITS.HEIGHT_MAX);this._cancelPreview();o=this.getWidth();O=this.getHeight();this._setCanvasSize(w,H);this._addHistory(new b({width:w,height:H,oldWidth:o,oldHeight:O}),p);return this;};j.prototype.getWidth=function(){this._throwIfNotLoaded("getWidth");return this._getLastImg().width;};j.prototype.getPreviewWidth=function(){this._throwIfNotLoaded("getPreviewWidth");return this._oCanvas.width;};j.prototype.setWidth=function(w,p){this._throwIfNotLoaded("setWidth");var o=this.getHeight(),O=this.getWidth(),H=this.getPreviewHeight();w=this._constraintValue(w,j.LIMITS.WIDTH_MIN,j.LIMITS.WIDTH_MAX);if(this.getKeepResizeAspectRatio()){H=Math.round(w*H/this.getPreviewWidth());}this._cancelPreview();this._setCanvasSize(w,H);this._addHistory(new b({width:w,height:H,oldWidth:O,oldHeight:o}),p);return this;};j.prototype.getHeight=function(){this._throwIfNotLoaded("getHeight");return this._getLastImg().height;};j.prototype.getPreviewHeight=function(){this._throwIfNotLoaded("getPreviewHeight");return this._oCanvas.height;};j.prototype.setHeight=function(H,p){this._throwIfNotLoaded("setHeight");var o=this.getWidth(),O=this.getHeight(),w=this.getPreviewWidth();H=this._constraintValue(H,j.LIMITS.HEIGHT_MIN,j.LIMITS.HEIGHT_MAX);if(this.getKeepResizeAspectRatio()){w=Math.round(H*w/this.getPreviewHeight());}this._cancelPreview();this._setCanvasSize(w,H);this._addHistory(new b({width:w,height:H,oldWidth:o,oldHeight:O}),p);return this;};j.prototype.rotate=function(i,p){this._throwIfNotLoaded("rotate");i=this._constraintValue(i,j.LIMITS.ROTATION_MIN,j.LIMITS.ROTATION_MAX);this._cancelPreview();this._setRotation(i);this._addHistory(new c({degrees:i}),p);return this;};j.prototype.flipVertical=function(p){this._throwIfNotLoaded("flipVertical");this._cancelPreview();this._flipVertical();this._addHistory(new f({vertical:true,horizontal:false}),p);return this;};j.prototype.flipHorizontal=function(p){this._throwIfNotLoaded("flipHorizontal");this._cancelPreview();this._flipHorizontal();this._addHistory(new f({vertical:false,horizontal:true}),p);return this;};j.prototype.flip=function(v,H,p){this._throwIfNotLoaded("flip");this._cancelPreview();this._flip(v,H);this._addHistory(new f({vertical:v,horizontal:H}),p);return this;};j.prototype.applyVisibleCrop=function(p){this._throwIfNotReady("applyVisibleCrop");switch(this.getMode()){case h.CropRectangle:{this._applyRectangleCrop(p);break;}case h.CropEllipse:{this._applyEllipseCrop(p);break;}case h.CropCustom:{this._applyCustomShapeCrop(p);break;}default:{L.warning("No cropping mode is selected, applyVisibleCrop does nothing");break;}}};j.prototype.rectangleCrop=function(x,y,w,H,p){this._throwIfNotLoaded("rectangleCrop");var o=this.getWidth(),O=this.getHeight();this._cancelPreview();this._rectangleCrop(x,y,w,H);this._addHistory(new d({x:Math.round(x),y:Math.round(y),width:Math.round(w),height:Math.round(H),oldWidth:o,oldHeight:O}),p);};j.prototype.ellipseCrop=function(x,y,X,Y,p){this._throwIfNotLoaded("ellipseCrop");var o=this.getWidth(),O=this.getHeight();this._cancelPreview();this._ellipseCrop(x,y,X,Y);this._addHistory(new e({x:Math.round(x),y:Math.round(y),rx:Math.round(X),ry:Math.round(Y),width:Math.round(X*2),height:Math.round(Y*2),oldWidth:o,oldHeight:O}),p);};j.prototype.setCropArea=function(x,y,w,H){this._throwIfNotLoaded("setCropArea");var o=this._limitCropArea(x,y,w,H);this._setCropArea(o.x,o.y,o.width,o.height);return this;};j.prototype.setCropAreaByRatio=function(w,H){this._throwIfNotLoaded("setCropAreaByRatio");var o=this._oCanvas.width/this._oCanvas.height,i=w/H,W,m,x,y,n;if(typeof w!=="number"||typeof H!=="number"){return this;}if(o>=i){m=k.CROP_AREA_SHORTER_SIDE_OFFSET;W=this._oCanvas.height*m*i;W=100*W/this._oCanvas.width;m*=100;x=(100-W)/2;y=(100-m)/2;}else{W=k.CROP_AREA_SHORTER_SIDE_OFFSET;m=this._oCanvas.width*W/i;m=100*m/this._oCanvas.height;W*=100;y=(100-m)/2;x=(100-W)/2;}n=this._transposePercentToImageCoordsPx(x,y,W,m);Object.keys(n).forEach(function(K){n[K]=n[K]*100/this._iZoom;},this);this._setCropArea(n.x,n.y,n.width,n.height);return this;};j.prototype.setCropAreaBySize=function(w,H){this._throwIfNotLoaded("setCropAreaBySize");var o=this._limitCropArea(null,null,w,H);this._setCropArea(null,null,o.width,o.height);return this;};j.prototype.getCropArea=function(){return this._oCropArea?q.extend({},this._oCropArea):null;};j.prototype.zoom=function(z){this._throwIfNotLoaded("setZoom");z=this._constraintValue(z,j.LIMITS.ZOOM_MIN,j.LIMITS.ZOOM_MAX);this._setZoom(z);return this;};j.prototype.sepia=function(v,p){this._throwIfNotLoaded("sepia");this._constraintValue(v,j.LIMITS.SEPIA_MIN,j.LIMITS.SEPIA_MAX);this._cancelPreview();this._addHistory(new F({type:"sepia",value:v,unit:"%"}),p);};j.prototype.grayscale=function(v,p){this._throwIfNotLoaded("grayscale");this._constraintValue(v,j.LIMITS.GRAYSCALE_MIN,j.LIMITS.GRAYSCALE_MAX);this._cancelPreview();this._addHistory(new F({type:"grayscale",value:v,unit:"%"}),p);};j.prototype.saturate=function(v,p){this._throwIfNotLoaded("saturate");this._constraintValue(v,j.LIMITS.SATURATE_MIN,j.LIMITS.SATURATE_MAX);this._cancelPreview();this._addHistory(new F({type:"saturate",value:v,unit:"%"}),p);};j.prototype.invert=function(v,p){this._throwIfNotLoaded("invert");this._constraintValue(v,j.LIMITS.INVERT_MIN,j.LIMITS.INVERT_MAX);this._cancelPreview();this._addHistory(new F({type:"invert",value:v,unit:"%"}),p);};j.prototype.brightness=function(v,p){this._throwIfNotLoaded("brightness");this._constraintValue(v,j.LIMITS.BRIGHTNESS_MIN,j.LIMITS.BRIGHTNESS_MAX);this._cancelPreview();this._addHistory(new F({type:"brightness",value:v,unit:"%"}),p);};j.prototype.contrast=function(v,p){this._throwIfNotLoaded("contrast");this._constraintValue(v,j.LIMITS.CONTRAST_MIN,j.LIMITS.CONTRAST_MAX);this._cancelPreview();this._addHistory(new F({type:"contrast",value:v,unit:"%"}),p);};j.prototype.applyPreview=function(){this._throwIfNotLoaded("applyPreview");this._applyPreview();};j.prototype.cancelPreview=function(){this._throwIfNotLoaded("cancelPreview");this._cancelPreview();};j.prototype.undo=function(){this._throwIfNotLoaded("undo");this._jumpToHistory(this._iHistoryIndex+1);};j.prototype.redo=function(){this._throwIfNotLoaded("redo");this._jumpToHistory(this._iHistoryIndex-1);};j.prototype.jumpToHistory=function(i){this._throwIfNotLoaded("jumpToHistory");this._jumpToHistory(i);};j.prototype.getHistory=function(){return this._aHistory;};j.prototype.getHistoryIndex=function(){return this._iHistoryIndex;};j.prototype.getImagePngDataURL=function(){this._throwIfNotLoaded("getImagePngDataURL");return this._getFinalisedCanvas().toDataURL("image/png");};j.prototype.getImageJpegDataURL=function(Q){this._throwIfNotLoaded("getImageJpegDataURL");return this._getFinalisedCanvas().toDataURL("image/jpeg",Q);};j.prototype._throwIfNotLoaded=function(m){if(!this.getLoaded()){throw Error("Cannot call "+m+" before image is set and loaded");}};j.prototype._throwIfNotReady=function(m){if(!this._isReady()){throw Error("Cannot call "+m+" before image is set and loaded and control is rendered");}};j.prototype._onAfterIsReady=function(){var t=this;this.$().removeClass("sapSuiteUiCommonsImageEditorEmpty");t._refreshContainerSize();if(!this.getCropArea()){this.setCropAreaByRatio(this.getWidth(),this.getHeight());}else{this._setCropArea(this._oCropArea.x,this._oCropArea.y,this._oCropArea.width,this._oCropArea.height);}};j.prototype._isReady=function(){return!!this._$Container&&this.getLoaded();};j.prototype._refreshContainerSize=function(){if(!this._$Container||!this._$Container[0]){return;}this._$Container.css({top:"",left:"",width:"",height:""});this._$Container.css({width:this._oCanvas.clientWidth,height:this._oCanvas.clientHeight});this._refreshOverlayMask();};j.prototype._refreshOverlayMask=function(){var o=this.$().find(".sapSuiteUiCommonsImageEditorCropOverlayContainer")[0];if(!o||!this._$Container){return;}this._$Container[0].removeChild(o);this._$Container[0].insertBefore(o,this._oCanvas.nextSibling);};j.prototype._initCanvas=function(){this._oCanvas.id=this.getId()+"-image";this._oCanvas.classList.add("sapSuiteUiCommonsImageEditorCanvas");this._oContext=this._oCanvas.getContext("2d");this._oCanvas.onmousedown=this._onMouseDown.bind(this);this._oCanvas.onmousewheel=this._onMouseWheel.bind(this);};j.prototype._initContainer=function(){var t=this,H=this.$().find(".sapSuiteUiCommonsImageEditorTransformHandlers .sapSuiteUiCommonsImageEditorHandlerContainer");this._$Container.resizable({containment:"parent",aspectRatio:this.getKeepResizeAspectRatio(),start:function(E,u){t.$("image").addClass("sapSuiteUiCommonsImageEditorCanvasResize");q(this).css({top:u.position.top,left:u.position.left,width:u.size.width,height:u.size.height});},stop:function(E,u){var n=u.size.width*t._oCanvas.width/u.originalSize.width,N=u.size.height*t._oCanvas.height/u.originalSize.height,o=t._oCanvas.width,O=t._oCanvas.height;t.$("image").removeClass("sapSuiteUiCommonsImageEditorCanvasResize");t.setSize(n,N,true);t._refreshContainerSize();t.fireSizeChanged({width:t.getPreviewWidth(),height:t.getPreviewHeight(),originalWidth:o,originalHeight:O});},handles:{nw:H.filter(".ui-resizable-nw"),ne:H.filter(".ui-resizable-ne"),sw:H.filter(".ui-resizable-sw"),se:H.filter(".ui-resizable-se"),n:H.filter(".ui-resizable-n"),s:H.filter(".ui-resizable-s"),w:H.filter(".ui-resizable-w"),e:H.filter(".ui-resizable-e")}});};j.prototype._initCropArea=function(){var t=this,B=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle"),H=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle .sapSuiteUiCommonsImageEditorHandlerContainer"),o=this.$().find(".sapSuiteUiCommonsImageEditorDragHandlerContainer")[0];function i(E,u){var s=getComputedStyle(u.helper[0]);t._setOverlayMaskSize(u.position.left,u.position.top,u.size?u.size.width:parseFloat(s.width),u.size?u.size.height:parseFloat(s.height),"px");}function m(E,u){var $=q(this),n=this.getBoundingClientRect(),p=$.position(),r=t._transposeViewportCoordsToImageCoords(p.left,p.top,n.width,n.height),O=t.getCropArea(),s;s=t._limitCropArea(r.x,r.y,r.width,r.height);t._setCropArea(s.x,s.y,s.width,s.height);s=t.getCropArea();t.fireCropAreaChanged({cropArea:s,originalCropArea:O});}B.resizable({aspectRatio:this.getKeepCropAspectRatio(),containment:"parent",minWidth:j.LIMITS.CROP_AREA_MIN,minHeight:j.LIMITS.CROP_AREA_MIN,resize:i,stop:m,handles:{nw:H.filter(".ui-resizable-nw"),ne:H.filter(".ui-resizable-ne"),sw:H.filter(".ui-resizable-sw"),se:H.filter(".ui-resizable-se"),n:H.filter(".ui-resizable-n"),s:H.filter(".ui-resizable-s"),w:H.filter(".ui-resizable-w"),e:H.filter(".ui-resizable-e")}});o.onmousewheel=this._onMouseWheel.bind(this);B.draggable({containment:"parent",handle:o,drag:i,stop:m});B.css("position","absolute");};j.prototype._getLastImg=function(){return this._oSavedImg;};j.prototype._storeCurrentImg=function(){this._oSavedImg.width=this._oCanvas.width;this._oSavedImg.height=this._oCanvas.height;this._oSavedImg.getContext("2d").drawImage(this._oCanvas,0,0);};j.prototype._addHistory=function(H,p){if(p){this._oPreview=H;}else{this._addNewHistory(H);this._oPreview=null;}this._updateFilters();};j.prototype._applyPreview=function(){if(!this._oPreview){return;}this._addNewHistory(this._oPreview);this._oPreview=null;};j.prototype._addNewHistory=function(n){this._aHistory=this._aHistory.slice(this._iHistoryIndex);this._iHistoryIndex=0;if(this._aHistory.length===0||!this._aHistory[0].compare(n)){this._aHistory.unshift(n);this._storeCurrentImg();this._fireHistoryChanged();}};j.prototype._cancelPreview=function(){if(!this._oPreview){return;}this._oPreview=null;this._updateFilters();this._drawImage(this._getLastImg());};j.prototype._jumpToHistory=function(m){var n=this._iHistoryIndex,H,i;this._iHistoryIndex=Math.min(this._aHistory.length,Math.max(0,m));if(n===this._iHistoryIndex){return;}if(n<this._iHistoryIndex){this._drawImage(this._oOrigImg);this._storeCurrentImg();i=this._aHistory.length-1;}else{i=n-1;}for(i;i>=this._iHistoryIndex;i--){H=this._aHistory[i];switch(H.getMetadata().getName()){case"sap.suite.ui.commons.imageeditor.RotateHistoryItem":{this._setRotation(H.getDegrees());break;}case"sap.suite.ui.commons.imageeditor.ResizeHistoryItem":{this._setCanvasSize(H.getWidth(),H.getHeight());break;}case"sap.suite.ui.commons.imageeditor.FlipHistoryItem":{this._flip(H.getVertical(),H.getHorizontal());break;}case"sap.suite.ui.commons.imageeditor.FilterHistoryItem":{if(D.browser.msie){this._applyFilterItem(H);}break;}case"sap.suite.ui.commons.imageeditor.CropRectangleHistoryItem":{this._rectangleCrop(H.getX(),H.getY(),H.getWidth(),H.getHeight());break;}case"sap.suite.ui.commons.imageeditor.CropEllipseHistoryItem":{this._ellipseCrop(H.getX(),H.getY(),H.getRx(),H.getRy());break;}default:{break;}}this._storeCurrentImg();}this._updateFilters();this._fireHistoryChanged();};j.prototype._fireHistoryChanged=function(){this.fireHistoryChanged({history:this._aHistory.slice(),index:this._iHistoryIndex});};j.prototype._onMouseDown=function(E){if(E.button!==0||this._iZoom===100){return;}var t=this,o=t._oTransform,s=E.clientX,S=E.clientY;E.preventDefault();function i(E){var n=E.clientX,p=E.clientY,r=100*(n-s)/t._oCanvas.clientWidth/o.scale,u=100*(p-S)/t._oCanvas.clientHeight/o.scale;t._oTransform.translateX+=r;t._oTransform.translateY+=u;t._updateTransform();s=n;S=p;}function m(){document.removeEventListener("mousemove",i);document.removeEventListener("mouseup",m);}document.addEventListener("mousemove",i);document.addEventListener("mouseup",m);};j.prototype._onMouseWheel=function(E){if(!(this.getMode()===h.CropRectangle||this.getMode()===h.CropEllipse)){return;}E.preventDefault();var s=20,S=E.wheelDeltaY>0?1:-1,z=this._iZoom+s*S;this.zoom(z);this.fireZoomChanged({zoom:this._iZoom});};j.prototype._updateTransform=function(){this._setTransform(this._oTransform);if(!this._$Container){return;}var o=this._oCanvas.getBoundingClientRect(),i=getComputedStyle(this._$Container[0]);var x=100*(parseFloat(i.width)-o.width)/this._oCanvas.clientWidth/this._oTransform.scale,y=100*(parseFloat(i.height)-o.height)/this._oCanvas.clientHeight/this._oTransform.scale,w=(o.width<=parseFloat(i.width))?1:-1,H=(o.height<=parseFloat(i.height))?1:-1;this._oTransform.translateX=Math.min(Math.max(this._oTransform.translateX,-x*w/2),x*w/2);this._oTransform.translateY=Math.min(Math.max(this._oTransform.translateY,-y*H/2),y*H/2);this._setTransform(this._oTransform);};j.prototype._setTransform=function(t){this._oCanvas.style.transform="scale("+t.scale+") translateX("+(t.translateX)+"%) translateY("+(t.translateY)+"%)";};j.prototype._limitCropArea=function(x,y,w,H){var m=this._getMaxCropAreaWidth(),i=this._getMinCropAreaWidth(),n=this._getMaxCropAreaHeight(),o=this._getMinCropAreaHeight();x=x&&x<0?0:x;y=y&&y<0?0:y;w=this._constraintValue(w,i,m-x);H=this._constraintValue(H,o,n-y);return{x:x,y:y,width:w,height:H};};j.prototype._getMaxCropAreaWidth=function(r){var m,o=this.getCropArea();if(r&&this.getKeepCropAspectRatio()&&o&&this.getWidth()/this.getHeight()>o.width/o.height){m=o.width*this._getMaxCropAreaHeight()/o.height;}else{m=this.getWidth()*100/this._iZoom;}return Math.round(m);};j.prototype._getMinCropAreaWidth=function(r){var m,o=this.getCropArea();if(r&&this.getKeepCropAspectRatio()&&o&&o.width>o.height){o=this.getCropArea();m=o.width*this._getMinCropAreaHeight()/o.height;}else{m=this._transposeViewportCoordsToImageCoords(null,null,j.LIMITS.CROP_AREA_MIN,null).width;}return Math.round(m);};j.prototype._getMaxCropAreaHeight=function(r){var m,o=this.getCropArea();if(r&&this.getKeepCropAspectRatio()&&o&&this.getWidth()/this.getHeight()<o.width/o.height){o=this.getCropArea();m=o.height*this._getMaxCropAreaWidth()/o.width;}else{m=this.getHeight()*100/this._iZoom;}return Math.round(m);};j.prototype._getMinCropAreaHeight=function(r){var m,o=this.getCropArea();if(r&&this.getKeepCropAspectRatio()&&o&&o.width<o.height){o=this.getCropArea();m=o.height*this._getMinCropAreaWidth()/o.width;}else{m=this._transposeViewportCoordsToImageCoords(null,null,null,j.LIMITS.CROP_AREA_MIN).height;}return Math.round(m);};j.prototype._setCropArea=function(x,y,w,H){this._oCropArea={x:x,y:y,width:w,height:H};if(!this._isReady()){return;}var p,$;if(typeof this._oCropArea.x!=="number"){this._oCropArea.x=(this.getWidth()*100/this._iZoom-w)/2;x=this._oCropArea.x;this._oCropArea.y=(this.getHeight()*100/this._iZoom-H)/2;y=this._oCropArea.y;}p=this._transposeImageCoordsPxToPercent(x,y,w,H);Object.keys(p).forEach(function(K){p[K]=p[K]*this._iZoom/100;},this);$=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle");$.css({left:p.x+"%",top:p.y+"%"});$.width(p.width+"%");$.height(p.height+"%");this._setOverlayMaskSize(p.x,p.y,p.width,p.height,"%");this._refreshOverlayMask();this._updateCropAreaHandlerColors();};j.prototype._setOverlayMaskSize=function(x,y,w,H,u){var $;$=this.$("overlayMaskRect");$.attr({x:x+u,y:y+u,width:w+u,height:H+u});$=this.$("overlayMaskEllipse");$.attr({cx:(x+w/2)+u,cy:(y+H/2)+u,rx:(w/2)+u,ry:(H/2)+u});$=this.$("overlayMaskCustomBlack");$.attr({x:x+u,y:y+u,width:w+u,height:H+u});$=this.$("overlayMaskCustomWhite");$.attr({x:x+u,y:y+u,width:w+u,height:H+u});};j.prototype._constraintValue=function(v,m,i){if(isNaN(v)||v<m){v=m;}else if(v>i){v=i;}return Math.round(v);};j.prototype._setZoom=function(z){var i=this._iZoom;this._iZoom=z;this._oTransform.scale=this._iZoom/100;this._updateTransform();var o=this.getCropArea();if(o){Object.keys(o).forEach(function(K){o[K]=o[K]*i/this._iZoom;},this);this._setCropArea(o.x,o.y,o.width,o.height);}};j.prototype._setCanvasSize=function(w,H){this._redraw({width:w,height:H});};j.prototype._setRotation=function(r){var o=this._getLastImg();var i=this._degToRad(r);this._oCanvas.width=Math.abs(o.width*Math.cos(i))+Math.abs(o.height*Math.sin(i));this._oCanvas.height=Math.abs(o.width*Math.sin(i))+Math.abs(o.height*Math.cos(i));this._oContext.save();this._oContext.translate(this._oCanvas.width/2,this._oCanvas.height/2);this._oContext.rotate(i);this._oContext.translate(-this._oCanvas.width/2,-this._oCanvas.height/2);this._oContext.drawImage(o,0,0,o.width,o.height,Math.round((this._oCanvas.width-o.width)/2),Math.round((this._oCanvas.height-o.height)/2),o.width,o.height);this._oContext.restore();this._refreshContainerSize();};j.prototype._flipVertical=function(){this._flip(true,false);};j.prototype._flipHorizontal=function(){this._flip(false,true);};j.prototype._flip=function(v,H){var o=this._getLastImg(),t=document.createElement("canvas"),i=t.getContext("2d");t.width=o.width;t.height=o.height;i.translate(H?o.width:0,v?o.height:0);i.scale(H?-1:1,v?-1:1);i.drawImage(o,0,0);this._oContext.clearRect(0,0,this._oCanvas.width,this._oCanvas.height);this._oContext.drawImage(t,0,0);};j.prototype._transposeViewportCoordsToImageCoords=function(x,y,w,H){if(!this._isReady()){return{x:0,y:0,width:0,height:0};}var o=this._oCanvas.getBoundingClientRect(),r=this._oCanvas.width/o.width,i=this._oCanvas.height/o.height;return{x:x*r,y:y*i,width:w*r,height:H*i};};j.prototype._transposeImageCoordsToViewportCoords=function(x,y,w,H){if(!this._isReady()){return{x:0,y:0,width:0,height:0};}var o=this._oCanvas.getBoundingClientRect(),r=this._oCanvas.width/o.width,i=this._oCanvas.height/o.height;return{x:x/r,y:y/i,width:w/r,height:H/i};};j.prototype._transposeImageCoordsPxToPercent=function(x,y,w,H){return{x:x*100/this._oCanvas.width,y:y*100/this._oCanvas.height,width:w*100/this._oCanvas.width,height:H*100/this._oCanvas.height};};j.prototype._transposePercentToImageCoordsPx=function(x,y,w,H){return{x:x*this._oCanvas.width/100,y:y*this._oCanvas.height/100,width:w*this._oCanvas.width/100,height:H*this._oCanvas.height/100};};j.prototype._transposeViewPortPxToPercent=function(x,y,w,H){var o=this.$("canvasInnerContainer")[0].getBoundingClientRect();return{x:x*100/o.width,y:y*100/o.height,width:w*100/o.width,height:H*100/o.height};};j.prototype._updateCropAreaHandlerColors=function(){var s;if(!this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle").is(":visible")){return;}var t=this;this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle .sapSuiteUiCommonsImageEditorHandlerContainer").each(function(){if(!q(this).is(":visible")){return;}s=t._getContrastColorForElement(this);for(var i=0;i<this.childElementCount;i++){this.children[i].style.background=s;}});};j.prototype._getContrastColorForElement=function(E){var o=this._oCanvas.getBoundingClientRect(),i=E.getBoundingClientRect(),m=this._transposeViewportCoordsToImageCoords(i.left-o.left,i.top-o.top,i.width,i.height),s=this._getContrastColorForRectangleArea(m.x,m.y,m.width,m.height);return s;};j.prototype._getContrastColorForRectangleArea=function(x,y,w,H){var A=this._getRectangleAreaAvg(x,y,w,H);return A>0.5*0.5?"white":"black";};j.prototype._getRectangleAreaAvg=function(x,y,w,H){if(w===0||H===0){return 0;}var o=this._oContext.getImageData(x,y,w,H).data,s=0,r,G,B,A;for(var i=0;i<o.length;i+=4){r=1-(o[i]/255);G=1-(o[i+1]/255);B=1-(o[i+2]/255);A=o[i+3]/255;s+=(0.2126*r*r+0.7152*G*G+0.0722*B*B)*A;}return s/(o.length/4);};j.prototype._updateResizableCropAspectRatio=function(){var B=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle"),K=this.getKeepCropAspectRatio();this._updateResizableAspectRatio(B,K);};j.prototype._updateResizableResizeAspectRatio=function(){var K=this.getKeepResizeAspectRatio();this._updateResizableAspectRatio(this._$Container,K);};j.prototype._updateResizableAspectRatio=function($,K){if($&&$.data("uiResizable")){$.resizable("option","aspectRatio",K).data("uiResizable")._aspectRatio=K;}};j.prototype._applyRectangleCrop=function(p){var o=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle")[0].getBoundingClientRect(),i=this._oCanvas.getBoundingClientRect(),m=this._transposeViewportCoordsToImageCoords(o.left-i.left,o.top-i.top,o.width,o.height);this.rectangleCrop(m.x,m.y,m.width,m.height,p);};j.prototype._rectangleCrop=function(x,y,w,H){var t=document.createElement("canvas");t.width=Math.round(w);t.height=Math.round(H);t.getContext("2d").drawImage(this._oCanvas,x,y,w,H,0,0,w,H);this._drawImage(t);};j.prototype._applyEllipseCrop=function(p){var o,i,m;o=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle")[0].getBoundingClientRect();i=this._oCanvas.getBoundingClientRect();m=this._transposeViewportCoordsToImageCoords(o.left-i.left,o.top-i.top,o.width,o.height);this.ellipseCrop(m.width/2+m.x,m.height/2+m.y,m.width/2,m.height/2,p);};j.prototype._ellipseCrop=function(x,y,X,Y){var t=document.createElement("canvas"),r=X*2,i=Y*2,o=t.getContext("2d");t.width=Math.round(r);t.height=Math.round(i);if(!o.ellipse){o.save();o.translate(X,Y);o.scale(X,Y);o.arc(0,0,1,0,360);o.restore();}else{o.ellipse(X,Y,X,Y,0,0,2*Math.PI);}o.fill();o.globalCompositeOperation="source-in";o.drawImage(this._oCanvas,x-X,y-Y,r,i,0,0,r,i);this._drawImage(t);};j.prototype._getFinalisedCanvas=function(){var w=this.getWidth(),H=this.getHeight(),i,t,o;i=this._getLastImg().getContext("2d").getImageData(0,0,w,H);this._applyFilterHistory(i);t=document.createElement("canvas");o=t.getContext("2d");t.width=w;t.height=H;o.putImageData(i,0,0);return t;};j.prototype._applyFilterHistory=function(o){var m;for(var i=this._aHistory.length-1;i>=0;i--){if(this._aHistory[i].isA("sap.suite.ui.commons.imageeditor.FilterHistoryItem")){m=this._aHistory[i];g[m.getType()](o,m.getValue()/100);}}};j.prototype._applyFilterItem=function(o){var i=this._getLastImg(),m=i.getContext("2d"),n=m.getImageData(0,0,i.width,i.height);g[o.getType()](n,o.getValue()/100);this._oContext.putImageData(n,0,0);};j.prototype._updateFilters=function(){var s="",H;function m(o){return o.getType()+"("+o.getValue()+o.getUnit()+") ";}if(D.browser.msie){if(this._isReady()){if(this._oPreview&&this._oPreview.isA("sap.suite.ui.commons.imageeditor.FilterHistoryItem")){this._applyFilterItem(this._oPreview);}}}else{for(var i=this._aHistory.length-1;i>=this._iHistoryIndex;i--){H=this._aHistory[i];if(H.isA("sap.suite.ui.commons.imageeditor.FilterHistoryItem")){s+=m(H);}}if(this._oPreview&&this._oPreview.isA("sap.suite.ui.commons.imageeditor.FilterHistoryItem")){s+=m(this._oPreview);}this._oCanvas.style.filter=s.trim();}};j.prototype._reset=function(){this._iZoom=100;this._oTransform={translateX:0,translateY:0,rotate:0,scale:1};this._aHistory=[];this._iHistoryIndex=0;this._oPreview=null;this._bImageLoaded=false;this._oCropArea=null;this._oCanvas.width=0;this._oCanvas.height=0;this._updateFilters();this._updateTransform();};j.prototype._drawImage=function(s){this._oCanvas.width=s.width;this._oCanvas.height=s.height;this._oContext.drawImage(s,0,0);this._refreshContainerSize();};j.prototype._redraw=function(s){var o=this._getLastImg(),w=s&&s.width?s.width:o.width,H=s&&s.height?s.height:o.height;this._oCanvas.width=w;this._oCanvas.height=H;this._oContext.drawImage(o,0,0,o.width,o.height,0,0,w,H);this._refreshContainerSize();};j.prototype._degToRad=function(i){return i*Math.PI/180;};j.prototype._RadToDeg=function(r){return r*180/Math.PI;};j.prototype._getCropAreaDragIcon=function(){if(!this._cropAreaDragIcon){this._cropAreaDragIcon=new I({src:"sap-icon://move",useIconTooltip:false});}return this._cropAreaDragIcon;};return j;});
