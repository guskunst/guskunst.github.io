sap.ui.define(["./TotaraUtils","./GeometryFactory","./SceneStateContext"],function(T,G,S){"use strict";var M=function(){};M.setMesh=function(s,c,b){if(T.checkError(c)){return c;}var r={updatedContexts:[],materialIdSet:new Set(),geometryIdMap:new Map()};var m=c.meshes;var a=s.materialIdsToRequest;var d;var v=s.contextMap.values();var e=v.next();while(!e.done){e.value.isUpdatedBySetMesh=false;e=v.next();}for(var i=0;i<m.length;i++){var f=m[i];var g=f.id;for(var j=0;j<f.submeshes.length;j++){var h=f.submeshes[j];var l=s.sceneBuilder.setSubmesh(g,h);if(l.needUpdataMaterial){r.materialIdSet.add(h.materialId);a.add(h.materialId);}if(l.geometryIdToRequest){r.geometryIdMap.set(l.geometryIdToRequest,l.geometryPriority);s.geometryIdMaterialIdMap.set(l.geometryIdToRequest,h.materialId);}}v=s.contextMap.values();e=v.next();while(!e.done){d=e.value;e=v.next();var o=d.meshGroupListMap.get(g);if(o){d.isUpdatedBySetMesh=true;var p=function(A){var B=[];A.forEach(function(C){B.push(C);});return B;};for(var k=0;k<o.length;k++){var q=o[k];var t=s.sceneBuilder.attachSubMeshesToNode(q,d.sceneId);s.sceneBuilder.applyNodeMaterialToSubmeshes(q,d.sceneId);var u=s.sceneBuilder.applyNodeOpacityToSubmeshes(q,d.sceneId);if(u.materialIds.length){for(var w=0;w<u.materialIds.length;w++){var x=d.materialIdNodeListMapForOpacityUpdate.getOrCreate(u.materialIds[w]);x.push(q);}}var y=p(t.idOfGeometriesToUpdate);for(var n=0;n<y.length;n++){var z=d.boundingBoxNodeIdsListMap.getOrCreate(y[n]);z.push(q);}}d.meshGroupListMap.delete(g);d.progressCount.mesh.count++;}}}v=s.contextMap.values();e=v.next();while(!e.done){d=e.value;e=v.next();if(d.isUpdatedBySetMesh){r.updatedContexts.push(d);delete d.isUpdatedBySetMesh;}}return r;};M.setGeometry=function(s,g,a){if(T.checkError(g)){return g;}var r={updatedContexts:[]};var b=g.id;if(!a||a.length===0){r.error="missing geometry "+b;return r;}var c=G.getGeometryInfo(g,a);s.sceneBuilder.setGeometry(c);var v=s.contextMap.values();var d=v.next();while(!d.done){var e=d.value;d=v.next();var n=e.boundingBoxNodeIdsListMap.get(b);if(n){r.updatedContexts.push(e);for(var i=0;i<n.length;i++){s.sceneBuilder.updateGeometryInNode(n[i],b,e.sceneId);}e.boundingBoxNodeIdsListMap.delete(b);}if(e.boundingBoxNodeIdsListMap.size===0){e.phase=S.Phase.FinishedGeometry;}e.progressCount.geometry.count++;}if(g&&g.flags){var h=(g.flags&2)>0;if(!h){var m=s.geometryIdMaterialIdMap.get(b);if(m){s.sceneBuilder.updateMaterialForGeometryWithoutNormal(m);}}}return r;};return M;});
