/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","./Gizmo"],function(q,l,G){"use strict";var A=G.extend("sap.ui.vk.tools.AnchorPointToolGizmo",{metadata:{library:"sap.ui.vk.tools"}});A.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene();var d=new THREE.DirectionalLight(0xFFFFFF,0.5);d.position.set(1,3,2);this._sceneGizmo.add(d);this._sceneGizmo.add(new THREE.AmbientLight(0xFFFFFF,0.5));this._touchAreas=new THREE.Group();this._gizmo=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._coordinateSystem=sap.ui.vk.tools.CoordinateSystem.World;this._matViewProj=new THREE.Matrix4();this._gizmoSize=144;this._gizmoOffset=new THREE.Vector3();this._gizmoRotation=new THREE.Vector3();function e(a,b,t){var n=144,o=window.devicePixelRatio*0.5,p=32,r=6,s=48;a.multiplyScalar(1/n);var u=new THREE.CylinderBufferGeometry(o,o,n-p,4);var m=new THREE.Matrix4().makeBasis(new THREE.Vector3(a.y,a.z,a.x),a,new THREE.Vector3(a.z,a.x,a.y));m.setPosition(a.clone().multiplyScalar((n-p)*0.5));u.applyMatrix(m);var v=new THREE.MeshLambertMaterial({color:b,transparent:true});var w=new THREE.Mesh(u,v);w.matrixAutoUpdate=false;w.userData.color=b;var x=new THREE.CylinderBufferGeometry(0,r,p,12,1);m.setPosition(a.clone().multiplyScalar(n-p*0.5));x.applyMatrix(m);var y=new THREE.Mesh(x,v);y.matrixAutoUpdate=false;w.add(y);var z=new THREE.CylinderGeometry(s*0.5,s*0.5,s,12,1);z.applyMatrix(m);var B=new THREE.CylinderGeometry(s*0.5,s*0.2,s,12,1);m.setPosition(a.clone().multiplyScalar(n*0.5));z.merge(B,m);t.add(new THREE.Mesh(z,v));return w;}function f(a,b,t){var m=new Float32Array(9);m[a]=m[b+6]=1;m[a+3]=m[b+3]=0.5;var v=new THREE.Vector3().setComponent(a,0.333);var n=new THREE.Vector3().setComponent(b,0.333);var k=new THREE.Geometry();k.vertices.push(new THREE.Vector3(),v,n,v.clone().add(n));k.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));var o=new THREE.MeshBasicMaterial({color:0xFFFF00,opacity:0.5,transparent:true,visible:false,side:THREE.DoubleSide});var p=new THREE.Mesh(k,o);p.matrixAutoUpdate=false;p.userData.colors=m;var r=new THREE.BufferGeometry();var s=new Float32Array(9);s[a]=s[a+3]=s[b+3]=s[b+6]=0.333;r.addAttribute("position",new THREE.Float32BufferAttribute(s,3));r.addAttribute("color",new THREE.Float32BufferAttribute(m,3));var u=new THREE.Line(r,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:true,linewidth:window.devicePixelRatio}));u.matrixAutoUpdate=false;p.add(u);var w=new THREE.Geometry();w.vertices.push(new THREE.Vector3(),v,n,v.clone().add(n));w.faces.push(new THREE.Face3(0,1,2),new THREE.Face3(2,1,3));t.add(new THREE.Mesh(w,new THREE.MeshBasicMaterial({side:THREE.DoubleSide})));return p;}function g(a,b,r,s){var k=new THREE.TorusBufferGeometry(r,window.devicePixelRatio/288,4,s,Math.PI/2);if(a===0){k.rotateY(Math.PI/-2);}else if(a===1){k.rotateX(Math.PI/2);}var m=new THREE.Mesh(k,new THREE.MeshBasicMaterial({color:b,transparent:true}));m.matrixAutoUpdate=false;m.userData.color=b;return m;}function h(a,r,s){var k=new THREE.TorusBufferGeometry(r,24/144,4,s,Math.PI/2);if(a===0){k.rotateY(Math.PI/-2);}else if(a===1){k.rotateX(Math.PI/2);}return new THREE.Mesh(k,new THREE.MeshBasicMaterial({opacity:0.2,transparent:true}));}this._gizmo.add(e(new THREE.Vector3(1,0,0),l.AxisColours.x,this._touchAreas));this._gizmo.add(e(new THREE.Vector3(0,1,0),l.AxisColours.y,this._touchAreas));this._gizmo.add(e(new THREE.Vector3(0,0,1),l.AxisColours.z,this._touchAreas));this._gizmo.add(f(1,2,this._touchAreas));this._gizmo.add(f(2,0,this._touchAreas));this._gizmo.add(f(0,1,this._touchAreas));for(var i=0;i<3;i++){this._gizmo.add(g(i,0xFF<<8*(2-i),1,32));this._touchAreas.add(h(i,1,24));}var j=new THREE.MeshBasicMaterial({color:0x0080FF,opacity:0.5,transparent:true,side:THREE.DoubleSide});this._arcMesh=new THREE.Mesh(new THREE.Geometry(),j);this._arcMesh.drawMode=THREE.TriangleFanDrawMode;this._arcMesh.visible=false;this._gizmo.add(this._arcMesh);this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);var k=new THREE.Geometry();k.vertices.push(new THREE.Vector3(),new THREE.Vector3());this._line=new THREE.LineSegments(k,new THREE.LineBasicMaterial());this._line.frustumCulled=false;this._line.visible=false;this._gizmo.add(this._line);};A.prototype.hasDomElement=function(){return false;};A.prototype.getCoordinateSystem=function(){return this._coordinateSystem;};A.prototype.setCoordinateSystem=function(a){this._coordinateSystem=a;};A.prototype.show=function(v,t){this._viewport=v;this._tool=t;var a=v.getScene().getSceneRef().userData.anchorPoint;if(a){this._gizmo.position.copy(a.position);this._gizmo.quaternion.copy(a.quaternion);}else{v.getScene().getSceneRef().userData.anchorPoint=this._gizmo;}};A.prototype.hide=function(){this._viewport=null;this._tool=null;};A.prototype.getGizmoCount=function(){return 1;};A.prototype.getTouchObject=function(i){this._touchAreas.position.copy(this._gizmo.position);this._touchAreas.quaternion.copy(this._gizmo.quaternion);this._touchAreas.scale.copy(this._gizmo.scale);this._touchAreas.updateMatrixWorld(true);return this._touchAreas;};var c=[1,2,4,6,5,3,1,2,4];A.prototype.highlightHandle=function(a,h){var i;for(i=0;i<3;i++){var b=this._gizmo.children[i];var d=c[a]&(1<<i);var e=d?0xFFFF00:b.userData.color;b.material.color.setHex(e);b.children[0].material.color.setHex(e);this._axisTitles.children[i].material.color.setHex(e);}for(i=3;i<6;i++){var p=this._gizmo.children[i];p.material.visible=i===a;var f=p.children[0].geometry.attributes.color;f.copyArray(i===a?[1,1,0,1,1,0,1,1,0]:p.userData.colors);f.needsUpdate=true;p.children[0].material.opacity=(i===a||(h&&a===-1))?1:0.35;p.children[0].visible=(i===a||h);}for(i=6;i<9;i++){var g=this._gizmo.children[i];g.visible=(i===a||h);g.material.color.setHex(i===a?0xFFFF00:g.userData.color);g.material.opacity=(i===a||(h&&a===-1))?1:0.35;}};A.prototype.beginGesture=function(){this._isMoved=false;this._isRotated=false;this._originPosition=new THREE.Vector3().setFromMatrixPosition(this._gizmo.matrixWorld);this._originQuaternion=this._gizmo.quaternion.clone();};A.prototype.endGesture=function(){if(this._isMoved){this._tool.fireMoved({x:this._gizmoOffset.x,y:this._gizmoOffset.y,z:this._gizmoOffset.z});}if(this._isRotated){this._tool.fireRotated({x:this._gizmoRotation.x,y:this._gizmoRotation.y,z:this._gizmoRotation.z});}this._line.visible=false;this._arcMesh.visible=false;};A.prototype._setOffset=function(o,g){if(this._tool.fireEvent("moving",{x:o.x,y:o.y,z:o.z},true)){this._move(o);var m=new THREE.Matrix4().getInverse(this._gizmo.matrixWorld);var s=new THREE.Vector3().setFromMatrixScale(this._gizmo.matrixWorld);var n=this._gizmo.position.clone().applyMatrix4(m);o.copy(this._originPosition).applyMatrix4(m).sub(n).multiply(s);this._line.geometry.vertices[0].copy(o);this._line.geometry.verticesNeedUpdate=true;this._line.geometry.computeBoundingBox();o.set(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z));o.multiplyScalar(1/Math.max(o.x,o.y,o.z));this._line.material.color.setRGB(o.x,o.y,o.z);this._line.visible=true;}};A.prototype._move=function(o){this._isMoved=true;this._gizmoOffset.copy(o);this._gizmo.position.copy(this._originPosition).add(o);this._viewport.setShouldRenderFrame();};A.prototype.move=function(x,y,z){this.beginGesture();this._move(new THREE.Vector3(x,y,z||0));};A.prototype._setRotationAxisAngle=function(b,d,e){var f=e-d;if(Math.abs(f)>Math.PI){f-=Math.PI*2*Math.sign(f);}var g=[0,0,0];g[b]=f;g=new THREE.Euler().fromArray(g);if(this._tool.fireEvent("rotating",{x:THREE.Math.radToDeg(g.x),y:THREE.Math.radToDeg(g.y),z:THREE.Math.radToDeg(g.z)},true)){this._rotate(g);var v=[0,0,0];var h=new THREE.Vector3();var j=(b+1)%3,k=(b+2)%3;var n=Math.max(Math.ceil(Math.abs(f)*64/Math.PI),1);f*=this._coordinateSystem===l.CoordinateSystem.Local?-1:1;for(var i=0;i<=n;i++){var a=d-f*(i/n);h.set(0,0,0).setComponent(j,Math.cos(a)).setComponent(k,Math.sin(a));v.push(h.x,h.y,h.z);}this._arcMesh.geometry=new THREE.BufferGeometry().addAttribute("position",new THREE.Float32BufferAttribute(v,3));this._arcMesh.visible=true;}};A.prototype._rotate=function(e){this._isRotated=true;this._gizmoRotation.set(THREE.Math.radToDeg(e.x),THREE.Math.radToDeg(e.y),THREE.Math.radToDeg(e.z));var a=new THREE.Quaternion().setFromEuler(e);this._gizmo.quaternion.copy(this._originQuaternion).multiply(a);this._viewport.setShouldRenderFrame();};A.prototype.rotate=function(x,y,z){this.beginGesture();this._rotate(new THREE.Euler(THREE.Math.degToRad(x||0),THREE.Math.degToRad(y||0),THREE.Math.degToRad(z||0)));};A.prototype.expandBoundingBox=function(b){if(this._viewport){this._expandBoundingBox(b,this._viewport.getCamera().getCameraRef());}};A.prototype._updateGizmoTransformation=function(i,a){this._matViewProj.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);var s=this._getGizmoScale(this._gizmo.position);this._gizmo.scale.setScalar(this._gizmoSize*s);this._gizmo.updateMatrixWorld(true);this._updateAxisTitles(this._axisTitles,this._gizmo,a,this._gizmoSize+18,s);this._line.scale.setScalar(1/(this._gizmoSize*s));};A.prototype.render=function(){var r=this._viewport.getRenderer(),a=this._viewport.getCamera().getCameraRef();r.clearDepth();this._updateGizmoTransformation(0,a);r.render(this._sceneGizmo,a);};A.prototype.onBeforeRendering=function(){};A.prototype.onAfterRendering=function(){};return A;},true);
