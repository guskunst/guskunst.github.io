/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","sap/ui/core/Control"],function(a,C){"use strict";var G=C.extend("sap.ui.vk.tools.Gizmo",{metadata:{library:"sap.ui.vk.tools"}});G.prototype.hasDomElement=function(){return true;};G.prototype._createAxisTitles=function(s,f,d){s=s||32;f=f||20;function c(t,b){var e=document.createElement("canvas");e.width=e.height=s*window.devicePixelRatio;var h=e.getContext("2d");var i=e.width*0.5;h.font="Bold "+f*window.devicePixelRatio+"px Arial";h.textAlign="center";h.textBaseline="middle";h.fillStyle="#000";h.globalAlpha=0.5;h.filter="blur(3px)";h.fillText(t,i+1,i+1);h.fillStyle="#fff";h.globalAlpha=1;h.filter="blur(0px)";h.fillText(t,i,i);if(d){h.beginPath();h.arc(i,i,i-window.devicePixelRatio,0,2*Math.PI,false);h.closePath();h.lineWidth=window.devicePixelRatio*2;h.strokeStyle="#fff";h.stroke();}var j=new THREE.Texture(e);j.needsUpdate=true;var m=new THREE.MeshBasicMaterial({map:j,color:b,transparent:true,alphaTest:0.05,premultipliedAlpha:true,side:THREE.DoubleSide});var k=new THREE.Mesh(new THREE.PlaneGeometry(s,s),m);k.userData.color=b;return k;}var g=new THREE.Group();g.add(c("X",a.AxisColours.x));g.add(c("Y",a.AxisColours.y));g.add(c("Z",a.AxisColours.z));return g;};G.prototype._extractBasis=function(m){var b=[new THREE.Vector3(),new THREE.Vector3(),new THREE.Vector3()];m.extractBasis(b[0],b[1],b[2]);b[0].normalize();b[1].normalize();b[2].normalize();return b;};G.prototype._updateAxisTitles=function(o,g,c,d,s){var b=this._extractBasis(g.matrixWorld);o.children.forEach(function(e,i){e.position.copy(b[i]).multiplyScalar(d.constructor===THREE.Vector3?d.getComponent(i):d);e.quaternion.copy(c.quaternion);});o.position.copy(g.position);o.scale.setScalar(s);};G.prototype._updateSelection=function(b){var n=[];b.enumerateSelection(function(c){n.push({node:c});});if(this._nodes.length===n.length&&this._nodes.every(function(v,i){return n[i].node===v.node;})){return false;}this._nodes=n;n.forEach(function(c){c.ignore=false;var p=c.node.parent;while(p&&!c.ignore){for(var i=0,l=n.length;i<l;i++){if(n[i].node===p){c.ignore=true;break;}}p=p.parent;}});return true;};G.prototype._getAnchorPoint=function(){return null;};G.prototype._getSelectionCenter=function(t){if(this._nodes.length===1){t.setFromMatrixPosition(this._nodes[0].node.matrixWorld);}else{t.setScalar(0);if(this._nodes.length>0){var c=new THREE.Vector3();this._nodes.forEach(function(n){var b=n.node;if(b.userData.boundingBox){b.userData.boundingBox.getCenter(c);t.add(c.applyMatrix4(b.matrixWorld));}else{t.add(c.setFromMatrixPosition(b.matrixWorld));}});t.multiplyScalar(1/this._nodes.length);}}};G.prototype._getGizmoScale=function(p){var r=this._viewport.getRenderer();var c=this._viewport.getCamera().getCameraRef();var b=new THREE.Vector4();b.copy(p).applyMatrix4(this._matViewProj);return b.w*r.getPixelRatio()/(r.getSize().width*c.projectionMatrix.elements[0]);};G.prototype._updateGizmoObjectTransformation=function(o,i){var c=this._viewport.getCamera().getCameraRef();var b=this._getAnchorPoint();var n;if(b&&this._coordinateSystem===a.CoordinateSystem.Custom){o.position.copy(b.position);o.quaternion.copy(b.quaternion);}else if(this._coordinateSystem===a.CoordinateSystem.Local){n=this._nodes[i].node;n.matrixWorld.decompose(o.position,o.quaternion,o.scale);}else if(this._nodes.length>0){this._getSelectionCenter(o.position);if(this._coordinateSystem===a.CoordinateSystem.Screen){o.quaternion.copy(c.quaternion);}else{o.quaternion.set(0,0,0,1);}}var s=this._getGizmoScale(o.position);o.scale.setScalar(this._gizmoSize*s);if(n){var d=this._extractBasis(n.matrixWorld);o.matrix.makeBasis(d[0],d[1],d[2]);o.matrix.scale(o.scale);o.matrix.copyPosition(n.matrixWorld);o.matrixAutoUpdate=false;}else{o.matrixAutoUpdate=true;}o.updateMatrixWorld(true);return s;};G.prototype._expandBoundingBox=function(b,c){var g=this.getGizmoCount();if(g>0){this._matViewProj.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);for(var i=0;i<g;i++){this._updateGizmoTransformation(i,c);this._sceneGizmo._expandBoundingBox(b,true);}}};return G;},true);
