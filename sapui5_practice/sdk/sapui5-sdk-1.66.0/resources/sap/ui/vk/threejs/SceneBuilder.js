/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./thirdparty/three","./BBoxSubdivider","./UsageCounter","../totara/ListMap","./OrthographicCamera","./PerspectiveCamera","./AnimationHelper","sap/ui/vk/View","sap/ui/vk/threejs/Billboard","sap/ui/vk/threejs/Callout"],function(q,t,B,U,L,O,P,A,V,a,C){"use strict";var S=function(r){this._id=S._nextId++;S._add(this);this._submeshes=new Map();this._callouts=new Map();this._cameras=new Map();this._materials=new Map();this._images=new Map();this._geometries=new Map();if(r){this._rootNode=r;this._nodes=new Map();this._NodeMeshIdSubmeshIdsMap=new Map();this._sequences=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new L();this._viewGroups=new Map();this._views=new Map();}else{this._rootNode=null;this._nodes=null;this._NodeMeshIdSubmeshIdsMap=null;this._sequences=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdNodMeshIdMap=new Map();this._sceneIdViewGroupMap=new Map();this._sceneIdViewMap=new Map();this._highlightStyles=new Map();this._animationHelper=new A(this);};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S._add=function(s){S._map.set(s.getId(),s);return this;};S.prototype.setRootNode=function(r,e,s){this._rootNode=r;this._nodes=new Map();this._nodes.set(e,r);this._NodeMeshIdSubmeshIdsMap=new Map();if(!this._rootNode.userData){this._rootNode.userData={};}this._sequences=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new L();this._viewGroups=new Map();this._views=new Map();if(s){this._sceneIdTreeNodesMap.set(s,this._nodes);this._sceneIdRootNodeMap.set(s,r);this._sceneIdNodMeshIdMap.set(s,this._NodeMeshIdSubmeshIdsMap);this._sceneIdViewGroupMap.set(s,this._viewGroups);this._sceneIdViewMap.set(s,this._views);this._currentSceneId=s;}return this;};S.prototype._resetCurrentScene=function(s){if(s&&s!==this._currentSceneId){var e=this._sceneIdTreeNodesMap.get(s);if(e){this._nodes=e;}else{this._nodes=null;}var i=this._sceneIdRootNodeMap.get(s);if(i){this._rootNode=i;}else{this._rootNode=null;}this._currentSceneId=s;}};S.prototype.getNode=function(e,s){this._resetCurrentScene(s);if(!this._nodes){return null;}return this._nodes.get(e);};S.prototype.getObjectId=function(e){do{if(e.userData&&e.userData.treeNode&&e.userData.treeNode.sid){return e.userData.treeNode.sid;}e=e.parent;}while(e);return null;};var b=function(e){var i=new THREE.Matrix4();if(e.length===3){i.setPosition(new THREE.Vector3().fromArray(e));}else if(e.length===12){i.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0.0,0.0,0.0,1.0);}else if(e.length===16){i.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]);}else{throw"Invalid matrix format";}return i;};var D={r:0.0235,g:0.0235,b:0.0235};var c={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(e){var i=new THREE.MeshPhongMaterial({color:0xaaaaaa});if(!i.userData){i.userData={};}i.userData.defaultHighlightingEmissive=D;i.userData.defaultHighlightingSpecular=c;i.userData.materialUsed=0;i.userData.materialId=e;i.userData.toBeUpdated=true;this._materials.set(e,i);return i;};S.prototype.createNode=function(e,i,s){var r={needUpdateMaterial:false,needSetSubmesh:false,idOfGeometriesToUpdate:null,materialIds:[]};this._resetCurrentScene(s);var l=this._nodes.get(i)||null;var v=new THREE.Group();v.userData.treeNode=e;if(e.renderOrder){v.renderOrder=e.renderOrder;}v.visible=e.visible!==undefined?e.visible:true;if(e.name){v.name=e.name;}v.userData.opacity=e.opacity;if(e.transform){v.applyMatrix(b(e.transform));}(l||this._rootNode).add(v);this._nodes.set(e.sid,v);var w=this.attachSubMeshesToNode(e.sid,s);var x=this.applyNodeMaterialToSubmeshes(e.sid,s);var y=this.applyNodeOpacityToSubmeshes(e.sid,s);r.needUpdateMaterial=x.needUpdateMaterial;r.needSetSubmesh=w.needSetSubmesh;r.idOfGeometriesToUpdate=w.idOfGeometriesToUpdate;r.materialIds=y.materialIds;return r;};S.prototype.applyNodeMaterialToSubmeshes=function(e,s){var r={needUpdateMaterial:false};this._resetCurrentScene(s);var l=this._nodes.get(e);if(!l){return r;}var v=l.userData.treeNode;l.userData.materialId=v.materialId;if(!v.meshId||!l.userData.materialId){return r;}var w=this._materials.get(l.userData.materialId);if(!w){w=this._createTemporaryMaterial(l.userData.materialId);r.needUpdateMaterial=true;}if(l&&l.children){for(var i=0;i<l.children.length;i++){var x=l.children[i];x.material=w;x.userData.materialId=l.userData.materialId;U.increaseMaterialUsed(w);}}return r;};S.prototype.applyNodeOpacityToSubmeshes=function(e,s,l){var r={materialIds:[]};this._resetCurrentScene(s);var w=this._nodes.get(e);if(!w){return r;}var x=w.userData.treeNode;if(!x.meshId||!x.opacity){return r;}if(w&&w.children){var y=new Set();for(var i=0;i<w.children.length;i++){var z=w.children[i];if(z.material&&(!l||l===z.material.userData.materialId)){if(!z.material.userData.toBeUpdated){z.userData.opacity=x.opacity;z.userData.originalMaterial=z.material;z.material=z.material.clone();z.material.opacity*=z.userData.opacity;z.material.transparent=z.material.opacity<0.99;}else{y.add(z.material.userData.materialId);}}}y.forEach(function(v){r.materialIds.push(v);});}return r;};S.prototype.attachSubMeshesToNode=function(e,s){var r={needSetSubmesh:false,idOfGeometriesToUpdate:new Set()};this._resetCurrentScene(s);var l=this._nodes.get(e);var v=l.userData.treeNode;if(!v.meshId){return r;}var w=this._NodeMeshIdSubmeshIdsMap.get(v.meshId);if(!w){r.needSetSubmesh=true;return r;}var x=[];w.forEach(function(E){x.push(E);});var i;var y;for(i=0;i<x.length;i++){y=x[i];this._insertSubmesh(v.sid,y,s);}for(i=0;i<x.length;i++){y=x[i];var z=this._submeshes.get(y);if(z&&z.userData&&z.userData.isBoundingBox&&z.userData.geometryId){r.idOfGeometriesToUpdate.add(z.userData.geometryId);}}return r;};S.prototype.updateMaterialInNode=function(e,s){this._resetCurrentScene(s);var r={needUpdateMaterial:false,nodeUpdated:false};var l=this._nodes.get(e.sid);var v=l.userData.materialId;var w=l.userData.opacity;l.userData.treeNode=e;l.userData.materialId=e.materialId;l.userData.opacity=e.opacity;var x=false;if(v===undefined){if(l.userData.materialId!==undefined){x=true;}}else if(v!==l.userData.materialId){x=true;}var y=false;if(w===undefined){if(l.userData.opacity!==undefined){y=true;}}else if(w!==l.userData.opacity){y=true;}if(!x&&!y){return r;}r.nodeUpdated=true;var z=null;if(l.userData.materialId){z=this._materials.get(l.userData.materialId);if(z===undefined){z=this._createTemporaryMaterial(l.userData.materialId);r.needUpdateMaterial=true;}}if(l&&l.children){for(var i=0;i<l.children.length;i++){var E=l.children[i];if(z){E.material=z;E.userData.materialId=e.materialId;U.increaseMaterialUsed(z);}else{var F=this._materials.get(E.userData.initialMaterialId);E.material=F;E.userData.materialId=E.userData.initialMaterialId;U.increaseMaterialUsed(F);}delete E.userData.originalMaterial;if(l.userData.opacity!==undefined&&(E.material&&E.material.userData&&!E.material.userData.toBeUpdated)){E.userData.opacity=l.userData.opacity;E.userData.originalMaterial=E.material;E.material=E.material.clone();E.material.opacity*=E.userData.opacity;E.material.transparent=E.material.opacity<0.99;}else{E.userData.opacity=undefined;}}}return r;};S.prototype.updateGeometryInNode=function(e,l,s){this._resetCurrentScene(s);var r=this._nodes.get(e);if(r&&r.children){for(var i=0;i<r.children.length;i++){var v=r.children[i];if(!v.isMesh){continue;}if(v.userData.geometryId===l){var w=this._geometries.get(l);if(w){if(w.isPolyline&&!v.isLineSegment){var x=v.parent;var y=v.material;x.remove(v);var z=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1,depthTest:false});z.color.copy(y.color);var E=new THREE.LineSegments(w,z);x.add(E);E.userData.meshId=v.userData.meshId;if(w.isPositionQuantized){E.position.copy(v.position);E.scale.copy(v.scale);}E.userData.initialMaterialId=v.userData.initialMaterialId;E.userData.isBoundingBox=false;E.userData.geometryId=v.userData.geometryId;E.userData.meshId=v.userData.meshId;E.userData.materialId=v.userData.materialId;E.userData.submeshInfo=v.userData.submeshInfo;E.userData.submeshId=v.userData.submeshId;var F=this._submeshes.get(E.userData.submeshId);if(F&&F.renderOrder){E.renderOrder=F.renderOrder;}this._submeshes.set(E.userData.submeshId,E);}else{v.geometry=w;v.userData.isBoundingBox=false;if(!w.isPositionQuantized){v.position.set(0,0,0);v.scale.set(1,1,1);}}U.increaseGeometryUsed(w);}}}}return this;};S.prototype.getChildNodeIds=function(e,s,l){this._resetCurrentScene(s);var r=this._nodes.get(e);var v=[];if(!r){return v;}if(r&&r.children){for(var i=0;i<r.children.length;i++){var w=r.children[i];if(w.userData&&w.userData.treeNode&&w.userData.treeNode.sid){v.push(w.userData.treeNode.sid);}else if(l&&w.userData&&w.userData.submeshInfo&&w.userData.submeshInfo.id){v.push(w.userData.submeshInfo.id);}}}return v;};function d(e){var l=atob(e);var r=l.length;var s=new Uint8Array(r);for(var i=0;i<r;i++){s[i]=l.charCodeAt(i);}return s;}function f(l){if(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}}return null;}function g(v){if(v===0){return Number.EPSILON;}return v;}function u(e,i){e.position.set((i[3]+i[0])/2,(i[4]+i[1])/2,(i[5]+i[2])/2);e.scale.set(g(i[3]-i[0]),g(i[4]-i[1]),g(i[5]-i[2]));}S.prototype.setSubmesh=function(l,s){var r={needUpdataMaterial:false,geometryIdToRequest:null,geometryPriority:0};var v=this._NodeMeshIdSubmeshIdsMap.get(l);if(!v){v=new Set();this._NodeMeshIdSubmeshIdsMap.set(l,v);}v.add(s.id);if(!s.lods){return false;}var w=null;for(var i=0;i<s.lods.length;i++){if(s.lods[i].type===undefined||s.lods[i].type==="mesh"||s.lods[i].type==="line"){w=s.lods[i];}}if(!w){return false;}var x=null;if(s.materialId){x=this._materials.get(s.materialId);if(!x){x=this._createTemporaryMaterial(s.materialId);r.needUpdataMaterial=true;}}var y=null;var z=this._geometries.get(w.id);if(z){if(x){y=new THREE.Mesh(z,x);}else{y=new THREE.Mesh(z);}y.userData.initialMaterialId=s.materialId;y.userData.isBoundingBox=false;y.userData.geometryId=w.id;y.userData.meshId=l;y.userData.submeshId=s.id;y.userData.materialId=s.materialId;if(z.isPositionQuantized){u(y,w.boundingBox);}U.increaseGeometryUsed(z);}else{r.geometryIdToRequest=w.id;var E;try{var F=f(s.lods);if(F&&F.data){var G=d(F.data);var H=B.unpackSubDividedBoundingBox(G);E=B.makeSubDividedBoundingBoxGeometry(H);}}catch(e){}var I=new THREE.BoxBufferGeometry(1,1,1);y=new THREE.Mesh(E?E:I,x);var J=w.boundingBox;if(Array.isArray(J)&&J.length===6){r.geometryPriority=new THREE.Vector3(J[3]-J[0],J[4]-J[1],J[5]-J[2]).length();}else{J=[0,0,0,1,1,1];}u(y,J);y.userData.initialMaterialId=s.materialId;y.userData.isBoundingBox=true;y.userData.geometryId=w.id;y.userData.meshId=l;y.userData.materialId=s.materialId;y.userData.submeshId=s.id;}y.userData.submeshInfo=s;this._submeshes.set(s.id,y);return r;};S.prototype.getSubmesh=function(s){return this._submeshes.get(s);};S.prototype.setGeometry=function(e){if(e.error){return this;}var i=new THREE.BufferGeometry();var l=new THREE.BufferAttribute(new Uint16Array(e.data.indices),1);var r=new THREE.BufferAttribute(new Float32Array(e.data.points),3);i.setIndex(l);i.addAttribute("position",r);if(!e.isPolyline){if(e.data.normals.length===e.data.points.length){var s=new THREE.BufferAttribute(new Float32Array(e.data.normals),3);i.addAttribute("normal",s);}if(e.data.uvs&&e.data.uvs.length*3===e.data.points.length*2){i.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.data.uvs),2));}}else{i.isPolyline=true;}try{i.computeBoundingSphere();}catch(v){return this;}i.isPositionQuantized=e.isPositionQuantized;if(!i.userData){i.userData={};}i.userData.geometryId=e.id;i.userData.geometryUsed=0;this._geometries.set(e.id,i);return this;};S.prototype.getGeometry=function(e){return this._geometries.get(e);};S.prototype._insertSubmesh=function(e,s,i){this._resetCurrentScene(i);var l=this._nodes.get(e);var r=this._submeshes.get(s);if(!l||!r){return false;}if(r.parent){r=r.clone();if(r.userData){if(r.userData.submeshInfo&&r.userData.initialMaterialId){var v=this._materials.get(r.userData.initialMaterialId);if(v){r.material=v;U.increaseMaterialUsed(v);}}if(r.userData&&r.userData.opacity){delete r.userData.opacity;}}}l.add(r);return true;};var h=[sap.ui.vk.BillboardStyle.RectangularShape,sap.ui.vk.BillboardStyle.CircularShape,sap.ui.vk.BillboardStyle.None,sap.ui.vk.BillboardStyle.TextGlow];var j=[sap.ui.vk.BillboardCoordinateSpace.Viewport,sap.ui.vk.BillboardCoordinateSpace.Screen,sap.ui.vk.BillboardCoordinateSpace.World];var k=[sap.ui.vk.BillboardBorderLineStyle.None,sap.ui.vk.BillboardBorderLineStyle.Solid,sap.ui.vk.BillboardBorderLineStyle.Dash,sap.ui.vk.BillboardBorderLineStyle.Dot,sap.ui.vk.BillboardBorderLineStyle.DashDot,sap.ui.vk.BillboardBorderLineStyle.DashDotDot];var m=[sap.ui.vk.LeaderLineMarkStyle.None,sap.ui.vk.LeaderLineMarkStyle.Point,sap.ui.vk.LeaderLineMarkStyle.Arrow];function n(e){var i=(((e[0]*255)<<16)|((e[1]*255)<<8)|(e[2]*255)).toString(16);return"#"+"000000".substring(i.length)+i;}S.prototype.createAnnotation=function(s,e,i){this._resetCurrentScene(s);var l=this._nodes.get(e);var r=i.position;i.coordinateSpace|=0;var v={coordinateSpace:j[i.coordinateSpace],style:h[i.shape||0],width:i.width,height:i.height,backgroundColor:i.backgroundColour?n(i.backgroundColour):"#fff",backgroundOpacity:i.backgroundColour?i.backgroundColour[3]:0,borderColor:i.borderColour?n(i.borderColour):"#000",borderOpacity:i.borderColour?i.borderColour[3]:0,borderWidth:i.borderWidth,borderLineStyle:k[i.borderLineStyle]};if(i.fontFace){v.encoding=sap.ui.vk.BillboardTextEncoding.PlainText;v.font=i.fontFace;v.fontSize=Math.abs(i.fontSize);v.fontWeight=Math.min(i.fontWeight,900);v.textColor=n(i.textColour);}else{v.encoding=sap.ui.vk.BillboardTextEncoding.HtmlText;}if(i.coordinateSpace<2){v.position=new THREE.Vector3(r[0]*2-1,r[1]*-2+1,r[2]);v.renderOrder=(i.order|0)+1000;var w=new a(v);w.setText(i.text);l.add(w._node);if(!this._rootNode.userData._vkBillboards){this._rootNode.userData._vkBillboards=[];}this._rootNode.userData._vkBillboards.push(w);}else{v.anchorNode=this._nodes.get(i.sid);v.position=new THREE.Vector3().fromArray(r);v.depthTest=false;v.renderOrder=i.order|0;var x=new C(v);x.setText(i.text);this._callouts.set(i.id,x);l.add(x._node);if(!this._rootNode.userData._vkCallouts){this._rootNode.userData._vkCallouts=[];}this._rootNode.userData._vkCallouts.push(x);}};S.prototype.createImageNote=function(s,e,i,l){this._resetCurrentScene(s);var r=this._nodes.get(e);r.updateMatrix();var v=new THREE.Vector3().fromArray(i.position);v.x+=i.width*0.5;v.y+=i.height*0.5;v.applyMatrix4(r.matrix);var w=new a({coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.Screen,renderOrder:(i.order|0)+1000,position:v,width:i.width*0.5*r.matrix.elements[0],height:i.height*0.5*r.matrix.elements[5]});w.setMaterial(l);r.add(w._node);if(!this._rootNode.userData._vkBillboards){this._rootNode.userData._vkBillboards=[];}this._rootNode.userData._vkBillboards.push(w);};S.prototype.insertLeaderLine=function(s,e,r){var v=this._callouts.get(e);if(v){var w=[];for(var i=0,l=r.points.length;i<l;i++){w.push(new THREE.Vector3().fromArray(r.points[i]));}var x=this._nodes.get(r.startPointSid);v.addLeaderLine(w,x,r.material,m[r.startPointHeadStyle],m[r.endPointHeadStyle],r.pointHeadConstant,r.extensionLength);}};S.prototype._decrementResourceCounters=function(e){e.traverse(function(i){if(i.isMesh){U.decreaseMaterialUsed(i.material);U.decreaseGeometryUsed(i.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(e,s){this._resetCurrentScene(s);var i=this;e=[].concat(e);e.forEach(function(l){var r=i._nodes.get(l);if(r){i._decrementResourceCounters(r);i._nodes.delete(l);}});return this;};S.prototype.remove=function(e,s){this._resetCurrentScene(s);var l=this;e=[].concat(e);e.forEach(function(r){var v=l._nodes.get(r);if(v){l._decrementResourceCounters(v);if(v.parent){v.parent.remove(v);}l._nodes.delete(r);for(var i=0;i<v.children.length;i++){var w=v.children[i];if(w.userData&&w.userData.treeNode&&w.userData.treeNode.sid){l.remove(w.userData.treeNode.sid,s);}}}});return this;};S.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(l){var r=l.userData.geometryUsed;if(r<=0){l.dispose();}});var i=this._materials;if(i){i.forEach(function(l){var r=l.userData.materialUsed;if(r<=0){l.dispose();}});}return this;};S.prototype.createCamera=function(e,s){this._resetCurrentScene(s);var i=null;var l=e.id;i=this._cameras.get(l);var r;if(i){r=i.getCameraRef();}if(!i||!r||(!r.isOrthographicCamera&&e.ortho)){if(e.ortho){r=new THREE.OrthographicCamera(-1,1,1,-1,e.near,e.far);}else{r=new THREE.PerspectiveCamera(e.fov*180/Math.PI,1,e.near,e.far);}}if(e.origin){var v=new THREE.Vector3().fromArray(e.origin);r.position.copy(v);}if(e.up){var w=new THREE.Vector3().fromArray(e.up).normalize();r.up.copy(w);}if(e.target){r.lookAt((new THREE.Vector3().fromArray(e.target)).add(r.position));}if(e.ortho){r.zoom=e.zoom||0.02;}this._rootNode.userData.camera=r;if(r.isOrthographicCamera){i=new O();}else if(r.isPerspectiveCamera){i=new P();}i.setCameraRef(r);i.setUsingDefaultClipPlanes(true);if(e.zoom===-1){i.setZoomNeedRecalculate(true);}i.cameraInfo=e;if(l){this._cameras.set(l,i);}return i;};S.prototype.insertCamera=function(e,i,s){this._resetCurrentScene(s);var l=this._nodes.get(e);var r=this._cameras.get(i);if(l&&r){l.add(r.parent?r.clone():r);}return this;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.updateMaterialForGeometryWithoutNormal=function(e){var i=this._materials.get(e);if(i&&i.emissive){i.emissive.copy(i.color);i.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(e){var r=[];var i=this._materials.get(e.id);if(e.lineWidth>0){if(!i||!i.isLineBasicMaterial){i=new THREE.LineBasicMaterial();this._materials.set(e.id,i);}i.color=new THREE.Color(e.lineColour[0],e.lineColour[1],e.lineColour[2]);i.depthTest=false;i.linewidth=e.lineWidth;i.userData.lineStyle={width:e.lineWidth,haloWidth:e.lineHaloWidth||0,endCapStyle:e.lineEndRound?1:0,dashPattern:e.lineDashPattern||[],dashPatternScale:e.lineDashPatternScale};i.userData.mateialInfo=e;i.userData.materialId=e.id;return r;}if(!i){i=this._createTemporaryMaterial(e.id);}if(i.userData&&i.userData.toBeUpdated){delete i.userData.toBeUpdated;}i.userData.materialInfo=e;if(e.diffuseColour){i.color.fromArray(e.diffuseColour);}if(e.specularColour){i.specular.fromArray(e.specularColour);}var l=true;if(e.emissiveColour){i.emissive.fromArray(e.emissiveColour);if(i.emissive.r!==0||i.emissive.g!==0||i.emissive.b!==0){l=false;}}if(l&&e.ambientColour){i.emissive.fromArray(e.ambientColour);i.emissive.multiplyScalar(0.2);}if(i.opacity!==undefined){i.opacity=e.opacity;i.transparent=e.opacity<1;if(i.transparent){i.side=THREE.DoubleSide;}}var s=i.glossiness?i.glossiness:0;var v=i.specularLevel?i.specularLevel:0;i.shininess=s*2+v*3;i.userData.defaultHighlightingEmissive=D;i.userData.defaultHighlightingSpecular=c;r=this.updateTextureMaps(e.id);return r;};S.prototype.getMaterial=function(e){return this._materials.get(e);};var o=function(i){var l="";try{var r=0x8000;var s=0;var v=i.length;var w;while(s<v){w=i.slice(s,Math.min(s+r,v));l+=String.fromCharCode.apply(null,w);s+=r;}}catch(e){l="";}return l;};S.prototype.createImage=function(i){var e=new DataView(i.binaryData.buffer);var l=true;if(e.getUint8(0,true)===parseInt("0xFF",16)&&e.getUint8(1,true)===parseInt("0xD8",16)){l=false;}var r=o(i.binaryData);var s="data:image/"+(l?"png":"jpeg")+";base64,"+btoa(r);this._images.set(i.id,s);return this;};var p=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(e){var r=[];var i=this._materials.get(e);if(!i){return r;}var l=i.userData.materialInfo;if(!l){return r;}if(l.textureDiffuse){var s=this.updateTextureMap(l.id,S.TextureType.Diffuse);if(s.imageId){r.push(s);}}if(l.textureBump){var v=this.updateTextureMap(l.id,S.TextureType.Bump);if(v.imageId){r.push(v);}}if(l.textureOpacity){var w=this.updateTextureMap(l.id,S.TextureType.Opacity);if(w.imageId){r.push(w);}}if(l.textureEmissive){var x=this.updateTextureMap(l.id,S.TextureType.Emissive);if(x.imageId){r.push(x);}}if(l.textureAmbientOcclusion){var y=this.updateTextureMap(l.id,S.TextureType.AmbientOcclusion);if(y.imageId){r.push(y);}}if(l.textureReflection){var z=this.updateTextureMap(l.id,S.TextureType.Reflection);if(z.imageId){r.push(z);}}return r;};S.prototype.updateTextureMap=function(e,i){var r={textureType:i,imageId:null};var l=this._materials.get(e);if(!l){return r;}var s=l.userData.materialInfo;if(!s){return r;}var v=null;switch(i){case S.TextureType.Diffuse:v=s.textureDiffuse;break;case S.TextureType.Bump:v=s.textureBump;break;case S.TextureType.Opacity:v=s.textureOpacity;break;case S.TextureType.Reflection:v=s.textureReflection;break;case S.TextureType.Emissive:v=s.textureEmissive;break;case S.TextureType.AmbientOcclusion:v=s.textureAmbientOcclusion;break;default:break;}if(!v){return r;}var w=v[0];var x=this._images.get(w.imageId);if(!x){r.imageId=w.imageId;return r;}var y=p.load(x);y.wrapS=w.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;y.wrapT=w.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;y.magFilter=w.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;y.minFilter=w.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;y.anisotropy=4;var z=w.influence!==undefined?w.influence:0;var E=w.uvHorizontalScale!==undefined?w.uvHorizontalScale:1;var F=w.uvVerticalScale!==undefined?w.uvVerticalScale:1;var G=w.uvHorizontalOffset!==undefined?w.uvHorizontalOffset:0;var H=w.uvVerticalOffset!==undefined?w.uvVerticalOffset:0;y.repeat.set(E,F);y.center.set(-G,-H);y.offset.set(G,H);y.rotation=-w.uvRotationAngle;switch(i){case S.TextureType.Diffuse:l.map=y;l.transparent|=x.startsWith("data:image/png");break;case S.TextureType.Bump:l.bumpMap=y;l.bumpScale=z;break;case S.TextureType.Opacity:l.alphaMap=y;break;case S.TextureType.Reflection:y.mapping=THREE.SphericalReflectionMapping;l.envMap=y;l.combine=THREE.AddOperation;l.reflectivity=z;break;case S.TextureType.Emissive:l.emissiveMap=y;l.emissive.setRGB(1,1,1);break;case S.TextureType.AmbientOcclusion:l.aoMap=y;break;default:}l.userData.textureAdded=true;l.needsUpdate=true;return r;};S.prototype.insertPlayback=function(e,v,s){this._resetCurrentScene(s);var i={id:e.id,sequenceId:e.sequenceId,playbackSpeed:e.speed?e.speed:0,playbackPreDelay:e.preDelay?e.preDelay:0,playbackPostDelay:e.postDelay?e.postDelay:0,playbackRepeat:e.repeat?Math.abs(e.repeat):0,playbackReversed:e.reversed?true:false,isContinuity:e.isContinuity};var l=this._views.get(v);if(l){var r=l.getPlaybacks();if(!r){r=[];}r.push(i);l.setPlaybacks(r);}return this;};S.prototype.insertSequence=function(i){var s=this._sequences.get(i.id);if(!s){var e=[];var l=new THREE.AnimationClip(i.name,-1,e);if(!l.userData){l.userData={};}l.userData.startTime=i.startTime?i.startTime:0;l.userData.endTime=i.endTime?i.endTime:1;l.userData.frameRate=i.frameRate?i.frameRate:30;l.userData.active=i.active?i.active:true;l.userData.cyclic=i.cyclic?i.cyclic:false;l.userData.currentTime=i.currentTime?i.currentTime:0;l.userData.name=i.name?i.name:"";l.userData.nodesEndData=new Map();l.userData.nodesStartData=new Map();l.userData.nodesStartDataByViewGroupId=new Map();this._sequences.set(i.id,l);if(i.nodes&&i.nodes.length>0){for(var r=0;r<i.nodes.length;r++){var v=i.nodes[r];var w=this._trackIdSequenceNodeMap.getOrCreate(v.trackId);w.push({sequenceId:i.id,targetId:v.sid,type:v.binding,pivot:v.pivot});}}}return this;};S.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._sequences);return this;};S.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}e.userData.sequences=this._sequences;e.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}}else{return this;}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map();}var v,i;var l=this._viewGroups.entries();var r=l.next();while(!r.done){v=r.value[1];i=r.value[0];r=l.next();this._animationHelper.setInitialNodePositionsFromSubsequentViews(v,i,this._views,this._sequences);this._animationHelper.setInitialNodePositionsFromCurrenetView(v,i,this._views,this._sequences);}return this;};S.prototype.finalizeViewGroups=function(s){this._resetCurrentScene(s);var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}}else{return this;}var v=[];var i=this._viewGroups.entries();var l=i.next();while(!l.done){var r=l.value[1];var w=l.value[0];if(!r||!r.views||!r.views.length){l=i.next();continue;}var x=[];for(var y=0;y<r.views.length;y++){var z=r.views[y].id;var E=this._views.get(z);if(E&&E.userData.viewInfo.thumbnailId&&!E.thumbnailData){var F=this._images.get(E.userData.viewInfo.thumbnailId);if(F){E.thumbnailData=F;}}if(E){E.viewGroupId=w;x.push(E);}}var G={};G.originalId=l.value[0];G.name=r.name;G.modelViews=x;G.sceneId=l.value[1].sceneId;v.push(G);l=i.next();}e.userData.viewportGroups=v;return this;};S.prototype.insertViewGroup=function(i,s){this._resetCurrentScene(s);this._viewGroups.set(i.id,i);return this;};S.prototype.getViewGroup=function(v,s){this._resetCurrentScene(s);var e=this._viewGroups.get(v);var i=[];if(e&&e.views){for(var l=0;l<e.views.length;l++){var r=e.views[l].id;var w=this._views.get(r);if(w){i.push(w);}}}return i;};S.prototype.insertView=function(v,s){this._resetCurrentScene(s);var e=new V({name:v.name});e.userData={};e.userData.viewInfo=v;if(v.thumbnailId){var i=this._images.get(e.thumbnailId);if(i){e.thumbnailData=i;}}this._views.set(v.id,e);return this;};S.prototype.recordHighlightedNodeInView=function(e,i,v,s){this._resetCurrentScene(s);var l=this._views.get(v);if(!l){return this;}var r=this._nodes.get(i);if(!r){return this;}if(!l.highlightIdNodesMap){l.highlightIdNodesMap=new Map();}var w=l.highlightIdNodesMap.get(e);if(!w){w=[];}w.push(r);l.highlightIdNodesMap.set(e,w);return this;};S.prototype.insertHighlightStyle=function(i){var e=this._highlightStyles.get(i.id);if(e){return this;}e=i;this._animationHelper.addAnimationTracksToHighlight(e);this._highlightStyles.set(i.id,e);return this;};S.prototype.highlightStyleExists=function(i){var e=this._highlightStyles.get(i);return e!==undefined;};S.prototype.finalizeHighlightsInViews=function(){var e=this._viewGroups.entries();var i=e.next();while(!i.done){var v=i.value[1];var l=i.value[0];i=e.next();if(!v||!v.views||!v.views.length){continue;}for(var r=0;r<v.views.length;r++){var s=v.views[r].id;var w=this._views.get(s);if(w&&w.highlightIdNodesMap){w.highlights=[];var x=w.highlightIdNodesMap.entries();var y=x.next();while(!y.done){var z=y.value[1];var E=y.value[0];var F=this._highlightStyles.get(E);if(F){F.highlightNodes=z;w.highlights.push(F);}y=x.next();}this._animationHelper.processHighlights(w,s,this._sequences);}}this._animationHelper.setInitialNodePositionsFromSubsequentViews(v,l,this._views,this._sequences,true);this._animationHelper.setInitialNodePositionsFromPreviousViews(v,l,this._views,this._sequences,true);this._animationHelper.setInitialNodePositionsFromCurrenetView(v,l,this._views,this._sequences,true);}return this;};S.prototype.getView=function(v,s){this._resetCurrentScene(s);return this._views.get(v);};S.prototype.getSequence=function(s){return this._sequences.get(s);};S.prototype.setViewCamera=function(e,v,s){this._resetCurrentScene(s);var i=this._cameras.get(e);var l=this._views.get(v);if(i&&l){l.camera=i;var r=i.getCameraRef();if(i.cameraInfo&&r){var w=true;var x=false;if(i.cameraInfo.zoom===-1){x=true;}if(r.type==="PerspectiveCamera"){l.setCameraInfo({type:r.type,fov:i.cameraInfo.fov*180/Math.PI,position:r.position.toArray(),nearClipPlane:r.near,farClipPlane:r.far,upDirection:r.up.toArray(),targetDirection:r.getWorldDirection().toArray(),usingDefaultClipPlanes:w});}if(r.type==="OrthographicCamera"){l.setCameraInfo({type:r.type,zoomFactor:r.zoom,position:r.position.toArray(),nearClipPlane:r.near,farClipPlane:r.far,upDirection:r.up.toArray(),targetDirection:r.getWorldDirection().toArray(),usingDefaultClipPlanes:w,zoomNeedRecalculate:x});}}}return this;};S.prototype.setViewNodeInfos=function(e,v,s){this._resetCurrentScene(s);var i=this._views.get(v);i.setNodeInfos(e);return this;};S.prototype.setViewThumbnail=function(i,v,s){this._resetCurrentScene(s);var e=this._views.get(v);var l=this._images.get(i);if(e&&l){e.thumbnailData=l;}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._nodes){this._nodes.clear();}if(this._NodeMeshIdSubmeshIdsMap){this._NodeMeshIdSubmeshIdsMap.clear();}this._submeshes.clear();this._callouts.clear();this._cameras.clear();this._materials.clear();this._images.clear();this._geometries.clear();this._currentSceneId=null;this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdNodMeshIdMap.clear();this._sequences.clear();this._tracks.clear();this._trackIdSequenceNodeMap.clear();this._viewGroups.clear();this._views.clear();this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdNodMeshIdMap.clear();this._sceneIdViewGroupMap.clear();this._sceneIdViewMap.clear();this._highlightStyles.clear();S._map.delete(this._id);};return S;});
