/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","./thirdparty/three","sap/ui/base/ManagedObject","./PolylineGeometry","./PolylineMaterial","./PolylineMesh"],function(q,l,t,B,P,a,b){"use strict";var T=B.extend("sap.ui.vk.threejs.Thrustline",{metadata:{properties:{renderOrder:{type:"int",defaultValue:0},depthTest:{type:"boolean",defaultValue:true},node:{type:"object"},principleAxis:{type:"float[]"},material:{type:"object"},items:{type:"object[]"},segments:{type:"object[]"}}},constructor:function(i,s,S){B.apply(this,arguments);}});T.prototype.setRenderOrder=function(v){this.setProperty("renderOrder",v,true);this._segments=[];return this;};T.prototype.setDepthTest=function(v){this.setProperty("depthTest",v,true);return this;};T.prototype._update=function(r,c){var n=this.getNode();if(!n||!n.visible){return;}var v=new THREE.Vector2(),m=new THREE.Matrix4(),d=new THREE.Matrix4();var e=r.getSize();v.set(e.width*0.001,e.height*0.001);m.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);d.multiplyMatrices(m,n.matrixWorld);var f=this.getPrincipleAxis();var p=new THREE.Vector3(f[0],f[1],f[2]);var i=this.getItems();var s=this.getSegments();for(var g=0;g<s.length;g++){var h=s[g];if(h.polylineMesh){n.remove(h.polylineMesh);h.polylineMesh=null;}if(h.haloMesh){n.remove(h.haloMesh);h.haloMesh=null;}var j;var k=i[h.startItemIndex];var o=k.target;j=k.boundPoints[h.startBoundIndex];var w=new THREE.Vector3(j.x,j.y,j.z);w.applyMatrix4(o.matrixWorld);var x=i[h.endItemIndex];var y=x.target;j=x.boundPoints[h.endBoundIndex];var z=new THREE.Vector3(j.x,j.y,j.z);z.applyMatrix4(y.matrixWorld);var A=z.clone();A.sub(w);if(A.dot(p)<0){p.x=-p.x;p.y=-p.y;p.z=-p.z;}var C=w.clone();C.sub(z);var D=p.clone();var E=D.dot(D);var u=D.dot(C)/E;var F=D.clone();F.multiplyScalar(u);F.add(z);var G=F.clone();G.sub(w);var H=G.length();G.normalize();var I=z.clone();I.sub(F);var J=I.length();var K=[];for(var L=0;L<h.ratios.length;L++){var M=h.ratios[L];var N=w.clone();var O=p.clone();O.multiplyScalar(M.x*J);N.add(O);var Q=G.clone();Q.multiplyScalar(M.y*H);N.add(Q);K.push(N);}var R=this.getMaterial();var S={};if(R&&R.userData&&R.userData.lineStyle){S=R.userData.lineStyle;}S.width=S.width||1;S.haloWidth=S.haloWidth||0;S.endCapStyle=S.endCapStyle||0;var U=sap.ui.vk.LeaderLineMarkStyle.None;var V=sap.ui.vk.LeaderLineMarkStyle.None;var W=S.endCapStyle||K.length>2?1:0;var X=(W&&(U!==sap.ui.vk.LeaderLineMarkStyle.None||S.endCapStyle===0)?1:0)|(W&&(V!==sap.ui.vk.LeaderLineMarkStyle.None||S.endCapStyle===0)?2:0);var Y=new P();Y.setVertices(K);var Z=new a({color:0xFFFFFF,lineColor:R.color,linewidth:S.width*0.6,dashCapStyle:S.endCapStyle,segmentCapStyle:W,trimStyle:X,dashPattern:S.dashPattern||[],dashScale:S.dashPatternScale||1,transparent:true,depthTest:this.getDepthTest()});var $=new b(Y,Z);if(c.type==="PerspectiveCamera"){$.computeLineDistances(d,v,c.near);}else{$.computeLineDistances(d,v);}$.matrixAutoUpdate=false;$.renderOrder=this.getRenderOrder();h.polylineMesh=$;n.add($);}};return T;});
