/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/vk/threejs/Billboard","sap/ui/vk/threejs/Callout","sap/ui/vk/threejs/PerspectiveCamera","sap/ui/vk/threejs/OrthographicCamera","sap/ui/vk/threejs/DetailView","../totara/ListMap","./AnimationHelper","./Thrustline"],function(L,B,C,P,O,D,a,A,T){"use strict";var S=function(b,e,i,l){this._id=S._nextId++;S.add(this);this._parentNode=b;this._contentResource=e;this._resolve=i;this._reject=l;this._nodes=new Map();this._meshes=new Map();this._callouts=new Map();this._cameras=new Map();this._detailViews=new Map();this._materials=new Map();this._images=new Map();this._viewportGroups=new Map();this._modelViews=new Map();this._modelViewThumbnails=new Map();this._animations=new Map();this._animationTracks=new Map();this._sequences=new Map();this._thrustlines=new Map();this._trackIdSequenceNodeMap=new a();var u=this._parentNode;while(u.parent){u=u.parent;}if(!u.userData){u.userData={};}u.userData.animations=this._animations;u.userData.animationTracks=this._animationTracks;u.userData.sequences=this._sequences;this._animationHelper=new A();};S._nextId=1;S._map=new Map();S.add=function(b){this._map.set(b.getId(),b);return this;};S.getById=function(i){return this._map.get(i);};S.prototype.getId=function(){return this._id;};S.prototype.setScene=function(i){if(i.result!==1){this._reject(i.result);}else{var b=this._cameras.get(i.cameraRef);this._resolve({node:this._parentNode,camera:b,contentResource:this._contentResource,builder:this});}};S.prototype.createNode=function(i){var b=this._nodes.get(i.parentRef)||null;var e=new THREE.Group();e.name=i.name;e.visible=i.visible;e.matrix.set(i.matrix[0],i.matrix[4],i.matrix[8],i.matrix[12],i.matrix[1],i.matrix[5],i.matrix[9],i.matrix[13],i.matrix[2],i.matrix[6],i.matrix[10],i.matrix[14],i.matrix[3],i.matrix[7],i.matrix[11],i.matrix[15]);e.matrix.decompose(e.position,e.quaternion,e.scale);e.userData.metadata=i.metadata;e.userData.veids=i.veids;(b||this._parentNode).add(e);this._nodes.set(i.nodeRef,e);};var n=new Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0]);var c=new Uint16Array([0,1,2,2,1,3,4,6,5,5,6,7,8+0,8+1,8+2,8+2,8+1,8+3,8+4,8+6,8+5,8+5,8+6,8+7,16+0,16+1,16+2,16+2,16+1,16+3,16+4,16+6,16+5,16+5,16+6,16+7]);S.prototype.createMesh=function(i){var b=i.boundingBox;var v=new Float32Array([b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[3],b[1],b[5],b[3],b[1],b[2],b[3],b[4],b[5],b[3],b[4],b[2],b[0],b[1],b[5],b[0],b[1],b[2],b[0],b[4],b[5],b[0],b[4],b[2]]);var e=new THREE.BufferGeometry();e.setIndex(new THREE.BufferAttribute(c,1));e.addAttribute("position",new THREE.BufferAttribute(v,3));e.addAttribute("normal",new THREE.BufferAttribute(n,3));var l=new THREE.Mesh(e,this._materials.get(i.materialRef));this._meshes.set(i.meshRef,l);if(i.matrix){l.matrix.set(i.matrix[0],i.matrix[4],i.matrix[8],i.matrix[12],i.matrix[1],i.matrix[5],i.matrix[9],i.matrix[13],i.matrix[2],i.matrix[6],i.matrix[10],i.matrix[14],i.matrix[3],i.matrix[7],i.matrix[11],i.matrix[15]);l.matrix.decompose(l.position,l.quaternion,l.scale);}};S.prototype.setMeshGeometry=function(b){var e=this._meshes.get(b.meshRef);var u=b.data;var v=new THREE.BufferGeometry();v.setIndex(new THREE.BufferAttribute(u.index,1));v.addAttribute("position",new THREE.BufferAttribute(u.position,3));if(u.normal){v.addAttribute("normal",new THREE.BufferAttribute(u.normal,3));}if(u.uv){v.addAttribute("uv",new THREE.BufferAttribute(u.uv,2));}if(b.flags&1){for(var i=0,l=e.parent.children.length;i<l;i++){if(e.parent.children[i]===e){e.parent.children[i]=new THREE.LineSegments(v,new THREE.LineBasicMaterial({color:e.material.color}));break;}}}else{e.geometry.copy(v);}if(this._fireSceneUpdated){this._fireSceneUpdated();}};S.prototype.insertMesh=function(b,e){var i=this._nodes.get(b);var l=this._meshes.get(e);i.add(l.parent?l.clone():l);};var d=[sap.ui.vk.BillboardTextEncoding.PlainText,sap.ui.vk.BillboardTextEncoding.HtmlText];var f=[sap.ui.vk.BillboardStyle.RectangularShape,sap.ui.vk.BillboardStyle.CircularShape,sap.ui.vk.BillboardStyle.None,sap.ui.vk.BillboardStyle.TextGlow];var g=[sap.ui.vk.BillboardBorderLineStyle.None,sap.ui.vk.BillboardBorderLineStyle.Solid,sap.ui.vk.BillboardBorderLineStyle.Dash,sap.ui.vk.BillboardBorderLineStyle.Dot,sap.ui.vk.BillboardBorderLineStyle.DashDot,sap.ui.vk.BillboardBorderLineStyle.DashDotDot];var h=[sap.ui.vk.BillboardHorizontalAlignment.Left,sap.ui.vk.BillboardHorizontalAlignment.Center,sap.ui.vk.BillboardHorizontalAlignment.Right];var j=[sap.ui.vk.LeaderLineMarkStyle.None,sap.ui.vk.LeaderLineMarkStyle.Point,sap.ui.vk.LeaderLineMarkStyle.Arrow];function k(b){var e=b.toString(16);return"#"+"000000".substring(e.length)+e;}function m(b){for(var i=0,l=b.length;i<l;i++){if(!isFinite(b[i])){return false;}}return true;}S.prototype.createTextAnnotation=function(i){if(!m(i.position)){return;}var b=new B({coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.Viewport,renderOrder:3,position:new THREE.Vector3().fromArray(i.position),encoding:d[i.encoding],font:i.font,fontSize:i.fontSize,fontWeight:Math.min(i.fontWeight,900),fontItalic:i.fontItalic,style:f[i.style],width:i.width,height:i.height,textColor:k(i.textColor),backgroundColor:k(i.backgroundColor),backgroundOpacity:i.backgroundOpacity,borderColor:k(i.borderColor),borderOpacity:i.borderOpacity,borderWidth:i.borderWidth,borderLineStyle:g[i.borderLineStyle],horizontalAlignment:h[i.horizontalAlignment],link:i.link});b.setText(i.text);var e=this._nodes.get(i.nodeRef);(e||this._parentNode).add(b._node);if(!this._parentNode.userData._vkBillboards){this._parentNode.userData._vkBillboards=[];}this._parentNode.userData._vkBillboards.push(b);};S.prototype.createImageNote=function(i){var b=this._materials.get(i.materialRef);var e=new B({coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.Screen,renderOrder:2,position:new THREE.Vector3().fromArray(i.position),width:i.width,height:i.height,texture:b?b.emissiveMap:null});var l=this._nodes.get(i.nodeRef);(l||this._parentNode).add(e._node);if(!this._parentNode.userData._vkBillboards){this._parentNode.userData._vkBillboards=[];}this._parentNode.userData._vkBillboards.push(e);};S.prototype.createTextNote=function(i){var b=new C({anchorNode:this._nodes.get(i.targetNodeRef)||this._parentNode,coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.World,position:new THREE.Vector3().fromArray(i.position),renderOrder:i.alwaysOnTop?1:0,depthTest:!i.alwaysOnTop,encoding:d[i.encoding],font:i.font,fontSize:i.fontSize,fontWeight:Math.min(i.fontWeight,900),fontItalic:i.fontItalic,style:f[i.style],width:i.width,height:i.height,textColor:k(i.textColor),backgroundColor:k(i.backgroundColor),backgroundOpacity:i.backgroundOpacity,borderColor:k(i.borderColor),borderOpacity:i.borderOpacity,borderWidth:i.borderWidth,borderLineStyle:g[i.borderLineStyle],horizontalAlignment:h[i.horizontalAlignment],link:i.link});b.setText(i.text);var e=this._nodes.get(i.nodeRef);this._callouts.set(e,b);(e||this._parentNode).add(b._node);if(!this._parentNode.userData._vkCallouts){this._parentNode.userData._vkCallouts=[];}this._parentNode.userData._vkCallouts.push(b);};S.prototype.insertLeaderLine=function(b){var e=this._nodes.get(b.nodeRef);var l=this._nodes.get(b.targetNodeRef)||this._parentNode;var u=this._materials.get(b.materialRef);var v=this._callouts.get(e);if(v){var w=[];for(var i=0;i<b.points.length;i+=3){w.push(new THREE.Vector3().fromArray(b.points,i));}v.addLeaderLine(w,l,u,j[b.startPointStyle],j[b.endPointStyle],b.styleConstant,b.extensionLength);}};S.prototype.createCamera=function(i){var b=null;if(i.projection==="perspective"){b=new P();b.setFov(i.fov);}else if(i.projection==="orthographic"){b=new O();b.setZoomFactor(i.orthoZoomFactor);}if(b){b.setNearClipPlane(i.nearClip);b.setFarClipPlane(i.farClip);b.setUsingDefaultClipPlanes(i.autoEvaluateClipPlanes);var e=new THREE.Vector3().fromArray(i.origin);var l=new THREE.Vector3().fromArray(i.target).sub(e);var u=new THREE.Vector3().fromArray(i.up).sub(e);b.setUpDirection(u.toArray());b.setPosition(e.toArray());b.setTargetDirection(l.toArray());}this._parentNode.userData.camera=b;this._cameras.set(i.cameraRef,b);};S.prototype.insertCamera=function(b,e){var i=this._nodes.get(b);var l=this._cameras.get(e);l=l?l.getCameraRef():null;if(i&&l){(i||this._parentNode).add(l.parent?l.clone():l);}};S.prototype.createViewportGroup=function(i){var b=this._parentNode;while(b.parent){b=b.parent;}var v={name:i.name,type:i.type,description:i.description,metadata:i.metadata,veids:i.veids,modelViews:[]};b.userData.viewportGroups=b.userData.viewportGroups||[];b.userData.viewportGroups.push(v);this._viewportGroups.set(i.viewportGroupRef,v);};S.prototype.insertModelView=function(i){var b={name:i.name,description:i.description?"<pre>"+i.description+"</pre>":i.descripton,camera:this._cameras.get(i.cameraRef),type:i.type,flyToTime:i.flyToTime,preDelay:i.preDelay,postDelay:i.postDelay,navigationMode:i.navigationMode,topColor:i.topColor,bottomColor:i.bottomColor,renderMethod:i.renderMethod,dimension:i.dimension,query:i.query,metadata:i.metadata,veids:i.veids,visibleNodes:[],highlights:[],viewGroupId:i.viewportGroupRef,id:i.modelViewRef};var v=this._viewportGroups.get(i.viewportGroupRef);if(v){v.modelViews.push(b);}this._modelViews.set(i.modelViewRef,b);this._modelViewThumbnails.set(i.thumbnail,b);};S.prototype.setModelViewVisibilitySet=function(i){var b=this._modelViews.get(i.modelViewRef);var e=new Set();i.visibleNodes.forEach(function(l){var u=this._nodes.get(l);if(u){while(u&&!e.has(u)){e.add(u);u=u.parent;}}else{}}.bind(this));b.visibleNodes=Array.from(e);};S.prototype.insertModelViewHighlight=function(i){var b=this._modelViews.get(i.modelViewRef);if(b){var e=[];i.highlightNodes.forEach(function(w){var x=this._nodes.get(w);if(x){e.push(x);}else{}}.bind(this));var l={highlightNodes:e,color1:i.color1,color2:i.color2,opacity1:i.opacity1,opacity2:i.opacity2,duration:i.duration,cycles:i.cycles};if(i.duration===0){l.type="STATIC";}else if(i.duration>0&&i.cycles===0){l.type="INFINITE";}else{l.type="FINITE";}var u=[(i.color1>>>16&0xff)/265,(i.color1>>>8&0xff)/265,(i.color1&0xff)/265];var v=[(i.color2>>>16&0xff)/265,(i.color2>>>8&0xff)/265,(i.color2&0xff)/265];l.colours=[u,v];l.opacities=[i.opacity1,i.opacity2];this._animationHelper.addAnimationTracksToHighlight(l);b.highlights.push(l);}};S.prototype.createThumbnail=function(i){var b=this._modelViewThumbnails.get(i.imageRef);if(b){b.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:b});}}};var o=[sap.ui.vk.DetailViewType.DetailView,sap.ui.vk.DetailViewType.Cutaway];var p=[sap.ui.vk.DetailViewShape.Box,sap.ui.vk.DetailViewShape.Circle,sap.ui.vk.DetailViewShape.CircleLine,sap.ui.vk.DetailViewShape.CirclePointer,sap.ui.vk.DetailViewShape.CircleArrow,sap.ui.vk.DetailViewShape.CircleBubbles,sap.ui.vk.DetailViewShape.BoxLine,sap.ui.vk.DetailViewShape.BoxNoOutline,sap.ui.vk.DetailViewShape.SolidPointer,sap.ui.vk.DetailViewShape.SolidArrow];S.prototype.createDetailView=function(i){var b=new D({name:i.name,camera:this._cameras.get(i.cameraRef),type:o[i.type],shape:p[i.shape],borderWidth:i.borderWidth,backgroundColor:k(i.backgroundColor),borderColor:k(i.borderColor),renderOrder:i.renderOrder||0,origin:new THREE.Vector2().fromArray(i.origin),size:new THREE.Vector2().fromArray(i.size),attachmentPoint:new THREE.Vector3().fromArray(i.attachmentPoint),metadata:i.metadata,veId:i.veid});this._detailViews.set(i.detailViewRef,b);var e=this._nodes.get(i.nodeRef);(e||this._parentNode).add(b._node);if(!this._parentNode.userData._vkDetailViews){this._parentNode.userData._vkDetailViews=[];}this._parentNode.userData._vkDetailViews.push(b);};S.prototype.createMaterial=function(i){var b;var l=i.linestyle;if(l.width>0){b=new THREE.LineBasicMaterial({color:new THREE.Color(l.color[0],l.color[1],l.color[2]),depthTest:false,linewidth:l.width});b.userData.lineStyle=l;}else{if(i.textures){i.textures.forEach(function(e){var u=new THREE.Texture(this._images.get(e.imageRef),e.type==="reflection"?THREE.SphericalReflectionMapping:THREE.UVMapping,e.repeatX?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,e.repeatY?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,e.filterMode===1?THREE.NearestFilter:THREE.LinearFilter,e.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter,undefined,undefined,4);u.offset.set(e.offsetX,e.offsetX);u.repeat.set(e.scaleX,e.scaleY);i[e.type+"Texture"]=u;u.needsUpdate=true;u.influence=e.amount;},this);}b=new THREE.MeshPhongMaterial({opacity:i.opacity,color:new THREE.Color(i.diffuse[0],i.diffuse[1],i.diffuse[2]),shininess:i.glossiness*2+i.specularLevel*3,emissive:new THREE.Color(i.emissive[0]+i.ambient[0]*0.2,i.emissive[1]+i.ambient[1]*0.2,i.emissive[2]+i.ambient[2]*0.2),specular:new THREE.Color(i.specular[0],i.specular[1],i.specular[2]),map:i.diffuseTexture?i.diffuseTexture:null,specularMap:i.specularTexture?i.specularTexture:null,emissiveMap:i.emissiveTexture?i.emissiveTexture:null,envMap:i.reflectionTexture?i.reflectionTexture:null,alphaMap:i.opacityTexture?i.opacityTexture:null,bumpMap:i.bumpTexture?i.bumpTexture:null,transparent:i.opacity<1||!!i.opacityTexture||(i.diffuseTexture&&i.diffuseTexture.image.hasAlpha)||false});if(b.map){b.color.lerp(new THREE.Color(1,1,1),b.map.influence?b.map.influence:0);}if(b.bumpMap){b.bumpScale=b.bumpMap.influence?b.bumpMap.influence:0;}if(b.envMap){b.mapping=THREE.SphericalReflectionMapping;b.combine=THREE.AddOperation;b.reflectivity=b.envMap.influence?b.envMap.influence:0;}}this._materials.set(i.materialRef,b);};S.prototype.createImage=function(i){var b=window.btoa(i.data.reduce(function(b,l){return b+String.fromCharCode(l);},""));var e=new THREE.ImageLoader().load("data:image/"+i.format+";base64,"+b);this._images.set(i.imageRef,e);e.hasAlpha=i.format==="png"&&i.data[25]===6;};S.prototype.insertThrustline=function(i){var b=this._thrustlines.get(i.thrustlineRef);if(!b){var e=[];e[0]=i.principleAxis[0];e[1]=i.principleAxis[1];e[2]=i.principleAxis[2];b=new T({node:this._nodes.get(i.thrustlineRef),principleAxis:e,material:this._materials.get(i.material)});var l=[];var u=0;var v=0;var w=0;for(var x=0;x<i.itemCount;x++){var y={};y.target=this._nodes.get(i.targets[x]);y.majorAxisIndex=i.itemMajorAxisesIndices[x];var z;y.basisAxises=[];w=u+i.itemBasisAxisesCounts[x];for(z=u;z<w;z++){var E={};E.x=i.itemBasisAxisesCoordinates[z*3];E.y=i.itemBasisAxisesCoordinates[z*3+1];E.z=i.itemBasisAxisesCoordinates[z*3+2];y.basisAxises.push(E);}u=w;y.dimension={};y.dimension.x=i.itemDimensionsCoordinates[x*3];y.dimension.y=i.itemDimensionsCoordinates[x*3+1];y.dimension.z=i.itemDimensionsCoordinates[x*3+2];y.center={};y.center.x=i.itemCentersCoordinates[x*3];y.center.y=i.itemCentersCoordinates[x*3+1];y.center.z=i.itemCentersCoordinates[x*3+2];y.boundPoints=[];w=v+i.itemBoundPointsCounts[x];for(z=v;z<w;z++){var F={};F.x=i.itemBoundPointsCoordinates[z*3];F.y=i.itemBoundPointsCoordinates[z*3+1];F.z=i.itemBoundPointsCoordinates[z*3+2];y.boundPoints.push(F);}v=w;l.push(y);}b.setItems(l);var G=0;var H=[];for(var I=0;I<i.segmentCount;I++){var J={};J.startItemIndex=i.segmentsStartItemIndices[I];J.endItemIndex=i.segmentsEndItemIndices[I];J.startBoundIndex=i.segmentsStartBoundIndices[I];J.endBoundIndex=i.segmentsEndBoundIndices[I];J.ratios=[];w=G+i.segmentRatioCounts[I];for(var K=0;K<w;K++){var M={};M.x=i.segmentRatiosCoordinates[K*2];M.y=i.segmentRatiosCoordinates[K*2+1];J.ratios.push(M);}G=w;H.push(J);}b.setSegments(H);this._thrustlines.set(i.thrustlineRef,b);if(!this._parentNode.userData._vkThrustlines){this._parentNode.userData._vkThrustlines=[];}this._parentNode.userData._vkThrustlines.push(b);}};S.prototype.insertAnimationGroup=function(i){var b=this._sequences.get(i.animationGroupRef);if(!b){var e=[];b=new THREE.AnimationClip(i.name,-1,e);if(!b.userData){b.userData={};}b.userData.startTime=i.startTime;b.userData.endTime=i.endTime;b.userData.frameRate=i.frameRate;b.userData.active=i.active;b.userData.cyclic=i.cyclic;b.userData.currentTime=i.currentTime;b.userData.name=i.name;b.userData.animations=[];b.userData.nodesEndData=new Map();b.userData.nodesStartData=new Map();b.userData.nodesStartDataByViewGroupId=new Map();this._sequences.set(i.animationGroupRef,b);}if(i.modelViewRef){var l=this._modelViews.get(i.modelViewRef);if(l){if(!l.playbacks){l.playbacks=[];}var u={sequenceId:i.animationGroupRef,playbackSpeed:i.playbackSpeed,playbackPreDelay:i.playbackPreDelay,playbackPostDelay:i.playbackPostDelay,playbackRepeat:i.playbackRepeat,playbackReversed:i.playbackReversed};l.playbacks.push(u);}}};S.prototype.insertAnimation=function(i){var b=this._animations.get(i.animationRef);if(!b){b={};b.type=i.animationType;b.targetRefs=[];b.targetPivots=[];b.sequenceId=i.animationGroupRef;b.animationTracks=new Set();this._animations.set(i.animationRef,b);}if(i.animationGroupRef){var e=this._sequences.get(i.animationGroupRef);if(!e.userData.animations.includes(i.animationRef)){e.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var b=this._animations.get(i.animationRef);if(b){if(!b.targetRefs.includes(i.targetRef)){b.targetRefs.push(i.targetRef);b.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var b=this._animationTracks.get(i.animationTrackRef);var e=i.animationRef;if(!b){delete i.animationRef;b=i;this._animationTracks.set(i.animationTrackRef,b);}if(!e){return;}var l=this._animations.get(e);if(!l||!l.sequenceId){return;}if(l.animationTracks.has(b.animationTrackRef)){return;}else{l.animationTracks.add(b.animationTrackRef);}var u=this._sequences.get(l.sequenceId);if(!u){return;}if(!u.userData){u.userData={};}if(!u.userData.tracks){u.userData.tracks=[];}for(var v=0;l.targetRefs&&v<l.targetRefs.length;v++){var w=l.targetRefs[v];var x=l.targetPivots[v];var y=this._nodes.get(w);if(!y){continue;}var z;if(x.x!==0||x.y!==0||x.z!==0){z=[x.x,x.y,x.z];}var E="";if(b.type===0){E="OPACITY";}else if(b.type===1){E="COLOUR";}else if(b.type===3){E="SCALE";}else if(b.type===2){E="TRANSLATE";}else if(b.type===4){E="ROTATE";}var F=this._trackIdSequenceNodeMap.getOrCreate(i.animationTrackRef);F.push({sequenceId:l.sequenceId,targetId:w,type:E,pivot:z});var G={};G.id=i.animationTrackRef;var H,I;var J;if(l.type===0){if(b.dataType===0){if(b.values.length!==b.keyCount||b.times.length!==b.keyCount){continue;}H=[];for(J=0;J<b.keyCount;J++){I={};I.time=b.times[J];if(b.type===0){I.values=[b.values[J]];}else if(b.type===3){I.values=[b.values[J],b.values[J],b.values[J]];}H.push(I);}G.keys=H;}else if(b.dataType===1||b.dataType===3){if(b.values.length!==3*b.keyCount||b.times.length!==b.keyCount){continue;}H=[];for(J=0;J<b.keyCount;J++){I={};I.time=b.times[J];I.values=[b.values[J*3],b.values[J*3+1],b.values[J*3+2]];H.push(I);}G.keys=H;}else if(b.dataType===4||b.dataType===5||b.dataType===6){if(b.values.length!==4*b.keyCount||b.times.length!==b.keyCount){continue;}if(b.dataType===4){G.type="angleAxis";}else if(b.dataType===6){G.type="euler";}H=[];for(J=0;J<b.keyCount;J++){I={};I.time=b.times[J];I.values=[b.values[J*4],b.values[J*4+1],b.values[J*4+2],b.values[J*4+3]];H.push(I);}G.keys=H;}}u.userData.tracks.push(G);}};S.prototype.finalizeAnimation=function(b){var e=this._animations.get(b);if(!e||!e.sequenceId){return;}var i=this._sequences.get(e.sequenceId);if(i){if(i.userData&&i.userData.tracks){this._animationHelper.insertTracks(i.userData.tracks,this._trackIdSequenceNodeMap,this._nodes,this._sequences);}i.resetDuration();i.optimize();i.hasOptimized=true;}};S.prototype.finalizePlaybacks=function(i){var v=this._viewportGroups.get(i.viewportGroupRef);for(var b=0;b<v.modelViews.length;b++){var e=v.modelViews[b];this._animationHelper.processHighlights(e,e.id,this._sequences);}this._animationHelper.setInitialNodePositionsFromSubsequentViews(v,i.viewportGroupRef,this._modelViews,this._sequences);this._animationHelper.setInitialNodePositionsFromPreviousViews(v,i.viewportGroupRef,this._modelViews,this._sequences);this._animationHelper.setInitialNodePositionsFromCurrenetView(v,i.viewportGroupRef,this._modelViews,this._sequences);};S.prototype.progress=function(b){L.log("reading progress:",b);};var q=function(e){var b=e.data;if(b.ready){q.resolve();}else{var i=S.getById(b.sceneBuilderId);i[b.method].apply(i,b.args);}};var r=function(e){L.error("Error in WebWorker",e);};var s=(function(){var b;return function(){return b||(b=new Promise(function(e){var w=new Worker(sap.ui.require.toUrl("sap/ui/vk/threejs/MataiLoaderWorker.js"));q.resolve=e.bind(null,w);w.onmessage=q;w.onerror=r;}));};})();var t=function(b,u,e,i,l,v){s().then(function(w){var x=new S(e,i,l,v);w.postMessage({method:"loadSceneFromArrayBuffer",sceneBuilderId:x.getId(),buffer:b,fileName:u,sourceLocation:"remote"},[b]);});};return function(b,i){return new Promise(function(l,u){if(typeof i.getSource()==="string"){var v=i.getSource();fetch(v).then(function(e){if(e.ok){return e.arrayBuffer();}throw(new Error(e.statusText));}).then(function(e){t(e,v,b,i,l,u);}).catch(function(e){u(e);});}else if(i.getSource()instanceof File){var w=new FileReader();w.onload=function(e){t(e.target.result,i.getSource().name,b,i,l,u);};w.onerror=function(e){u(e);};w.readAsArrayBuffer(i.getSource());}});};});
