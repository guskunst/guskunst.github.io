/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/XMLTemplateProcessor','sap/ui/core/util/XMLPreprocessor','sap/ui/core/Fragment','sap/ui/mdc/ResourceModel','sap/ui/fl/Utils','sap/base/Log'],function(X,a,F,R,f,L){"use strict";function _(s,S){var B=s.getBindingContext(),m=B.getModel().getMetaModel(),M=m.getMetaPath(B.getPath()),e=m.getObject(M)['$Type'],C=B,d;if(B.getBinding().getMetadata().getName()==='sap.ui.model.odata.v4.ODataListBinding'&&(S===e||!S)){return C;}C=b(s).getBindingContext();d=C.getBinding().getDependentBindings();return(d&&d[0].isPatchWithoutSideEffects()&&d[0].getBoundContext())||C;}function b(C){while(C&&!(C.getMetadata().getName()==="sap.ui.core.mvc.XMLView")){C=C.getParent();}return C;}var c={formatDraftOwnerText:function(h,d,D,s,e,i){var g='';if(h){var u=D||d||e||s;if(!i){g+=d?R.getText('draft.GENERIC_LOCKED_OBJECT_POPOVER_TEXT')+' ':R.getText('draft.LAST_CHANGE_USER_TEXT')+' ';}g+=u?R.getText('draft.OWNER',[u]):R.getText('draft.ANOTHER_USER');}return g;},formatDraftOwnerTextInline:function(h,d,D,s,e){return c.formatDraftOwnerText(h,d,s,D,e,true);},formatDraftOwnerTextInPopover:function(h,d,D,s,e){return c.formatDraftOwnerText(h,d,s,D,e,false);},onDraftLinkPressed:function(e,E){var t=this,s=e.getSource(),v=f.getViewForControl(s),B=s.getBindingContext(),m=B.getModel().getMetaModel(),V=v.getId(),d;this.mDraftPopovers=this.mDraftPopovers||{};this.mDraftPopovers[V]=this.mDraftPopovers[V]||{};d=this.mDraftPopovers[V][E];if(d){d.setBindingContext(B);d.openBy(s);}else{var g='sap.ui.mdc.odata.v4.field.DraftPopOverAdminData',p=X.loadTemplate(g,'fragment');Promise.resolve(a.process(p,{},{bindingContexts:{entitySet:m.createBindingContext("/"+E)},models:{entitySet:m}})).then(function(o){return F.load({definition:o,controller:t});}).then(function(P){d=t.mDraftPopovers[V][E]=P;d.setModel(R.getModel(),"i18n");v.addDependent(d);d.setBindingContext(B);d.openBy(s);});}},closeDraftAdminPopover:function(e){e.getSource().getParent().getParent().close();},prepareForSideEffects:function(s,S){var t=this,p=[],A=[],w=s.indexOf('#')>-1,d=(w&&s.split('#')[0])||s,q=(w&&s.split('#')[1])||'',e='/'+d+'@com.sap.vocabularies.Common.v1.SideEffects',B=S.getBindingContext(),m=B.getModel().getMetaModel(),C,g,P,Q,E,h,o,G=function(j){return j['$PropertyPath'];},i=function(j){return j['$NavigationPropertyPath'];};e=(w&&(e+'#'+q))||e;o=m.getObject(e);if(o&&t.aPendingSideEffects.indexOf(s)>-1){C=_(S,d);g=C.getPath();p=p.concat(o.TargetProperties||[]).concat(o.TargetEntities||[]);p.forEach(function(j){if(j['$PropertyPath']){var T=m.getObject('/'+d+'/'+j['$PropertyPath']+'@com.sap.vocabularies.Common.v1.Text');if(T&&T['$Path']){A.push({'$PropertyPath':T['$Path']});}}});p=p.concat(A);if(p.length){t.sideEffectsRequestsQueue=t.sideEffectsRequestsQueue||{};t.sideEffectsRequestsQueue[g]=t.sideEffectsRequestsQueue[g]||{};t.sideEffectsRequestsQueue[g]['context']=t.sideEffectsRequestsQueue[g]['context']||C;t.sideEffectsRequestsQueue[g]['pathExpressions']=t.sideEffectsRequestsQueue[g]['pathExpressions']||[];Q=t.sideEffectsRequestsQueue[g]['pathExpressions'].filter(G).map(G);h=t.sideEffectsRequestsQueue[g]['pathExpressions'].filter(i).map(i);P=p.map(G).filter(function(j){return j&&Q.indexOf(j)<0;}).map(function(j){return{'$PropertyPath':j};});E=p.map(i).filter(function(j){return j&&h.indexOf(j)<0;}).map(function(j){return{'$NavigationPropertyPath':j};});p=P.concat(E);t.sideEffectsRequestsQueue[g]['pathExpressions']=t.sideEffectsRequestsQueue[g]['pathExpressions'].concat(p);t.aPendingSideEffects.splice(t.aPendingSideEffects.indexOf(s),1);}}},requestSideEffects:function(){if(!this.sideEffectsRequestsQueue){return;}var t=this;Object.keys(this.sideEffectsRequestsQueue).forEach(function(p){var s=t.sideEffectsRequestsQueue[p];s['context'].requestSideEffects(s['pathExpressions']).then(function(){},function(){L.info('FieldRuntime: Failed to request side effect - '+p,'sap.ui.mdc.odata.v4.field.FieldRuntime','requestSideEffects');});});this.sideEffectsRequestsQueue=null;},requestTextIfRequired:function(s){var A=s.getBindingInfo('additionalValue');if(!A){return;}var p=A.binding.getPath(),C;C=_(s);C.requestSideEffects([{'$PropertyPath':p}]).then(function(){},function(){L.info('FieldRuntime: Failed to request Text association - '+p,'sap.ui.mdc.odata.v4.field.FieldRuntime','requestTextIfRequired');});},handleChange:function(e){var t=this,s=e.getSource();this.aPendingSideEffects=this.aPendingSideEffects||[];if(!s.getBindingContext().isTransient()){this.requestTextIfRequired(s);}if(s.getFieldGroupIds()&&!s.getBindingContext().isTransient()){s.getFieldGroupIds().forEach(function(d){var i=d.indexOf('$$ImmediateRequest')>-1;if(i){d=d.substr(0,d.indexOf('$$ImmediateRequest'));}if(t.aPendingSideEffects.indexOf(d)===-1){t.aPendingSideEffects.push(d);}if(i){t.prepareForSideEffects(d,s);}});this.requestSideEffects();}},handleSideEffect:function(e){if(!this.aPendingSideEffects||this.aPendingSideEffects.length===0){return;}var t=this,d=e.getParameter('fieldGroupIds'),s=e.getSource();d=d||[];d.forEach(function(g){t.prepareForSideEffects(g,s);});this.requestSideEffects();}};return c;},true);
