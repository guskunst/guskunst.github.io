/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/Control','sap/base/util/merge','sap/base/util/deepEqual','sap/ui/model/PropertyBinding','sap/ui/model/Context','sap/ui/model/base/ManagedObjectModel','sap/ui/base/ManagedObjectObserver','sap/base/Log','sap/ui/mdc/library','./FilterItemLayout','sap/ui/mdc/base/ConditionModel','sap/ui/mdc/base/Condition','sap/ui/mdc/base/FilterField','sap/ui/mdc/base/FieldValueHelp','sap/ui/mdc/PropertyInfo','sap/ui/mdc/util/IdentifierUtil','sap/ui/mdc/util/ConditionUtil','sap/ui/layout/AlignedFlowLayout','sap/m/library','sap/m/Button','sap/ui/model/json/JSONModel',"sap/ui/fl/ControlPersonalizationAPI"],function(C,m,d,P,a,M,b,L,c,F,e,f,g,h,k,I,l,A,n,B,J,o){"use strict";var p=c.FilterExpression;var q=n.ButtonType;var r;var s=C.extend("sap.ui.mdc.base.filterbar.FilterBar",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/base/filterbar/FilterBar.designtime",defaultAggregation:"filterItems",properties:{metadataDelegate:{type:"string",defaultValue:"sap/ui/mdc/base/filterbar/FilterBarDelegate"},liveMode:{type:"boolean",defaultValue:false},showGoButton:{type:"boolean",defaultValue:true},showAdaptFiltersButton:{type:"boolean",defaultValue:true},supportP13N:{type:"boolean",defaultValue:false},filtersConditions:{type:"object",defaultValue:{}},metadataInfo:{type:"object",defaultValue:{}}},aggregations:{filterItems:{type:"sap.ui.mdc.base.FilterField",multiple:true},basicSearchField:{type:"sap.ui.mdc.base.FilterField",multiple:false}},events:{search:{conditions:{type:"object"}},reset:{},filtersChanged:{filtersText:{type:"string"}}}},renderer:function(R,i){R.write("<div ");R.writeControlData(i);R.writeClasses();R.write(">");R.renderControl(i._getContent());R.write("</div>");}});s.INNER_MODEL_NAME="$sap.ui.mdc.base.filterbar.FilterBar";s.CONDITION_MODEL_NAME="$filters";var t=null;var u=null;s.prototype.init=function(){this.addStyleClass("sapUiMdcBaseFilterBar");this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._createInnerModel();this._oObserver=new b(this._observeChanges.bind(this));this._oObserver.observe(this,{aggregations:["filterItems"]});this._oFilterBarLayout=new A();this._addButtons();this._clearChanges();this._aProperties=null;this._fResolveFilterBarMetaModelSet=undefined;this._oMetaModelSetPromise=new Promise(function(i){this._fResolveFilterBarMetaModelSet=i;}.bind(this));this._fResolveFilterBarMetadataApplied=undefined;this._oMetadataAppliedPromise=new Promise(function(i){this._fResolveFilterBarMetadataApplied=i;}.bind(this));this._fResolveFilterBarConditionModel=undefined;this._oConditionModelPromise=new Promise(function(i){this._fResolveFilterBarConditionModel=i;}.bind(this));this._fResolveInitialFiltersApplied=undefined;this._oInitialFiltersAppliedPromise=new Promise(function(i){this._fResolveInitialFiltersApplied=i;}.bind(this));this._bIgnoreChanges=false;this.bWaiting=false;};s.prototype._getConditionModel=function(){return this._oConditionModel;};s.prototype.getConditionModelName=function(){return this._getConditionModelName();};s.prototype._getConditionModelName=function(){return s.CONDITION_MODEL_NAME;};s.prototype._createConditionModel=function(){this._oConditionModel=new e();this.setModel(this._oConditionModel,this._getConditionModelName());if(!this._oMetadataPromise){this._oMetadataPromise=this._retrieveMetadata();}Promise.all([this._oMetadataPromise]).then(function(){if(this._oConditionModel){this._oConditionChangeBinding=this._oConditionModel.bindProperty("/conditions",this._oConditionModel.getContext("/conditions"));this._oConditionChangeBinding.attachChange(this._handleConditionModelChange,this);this._fResolveFilterBarConditionModel();}}.bind(this));};s.prototype._getMetaModelName=function(){return this.getMetadataInfo().modelName;};s.prototype._getEntitySetName=function(){return this.getMetadataInfo().collectionName;};s.prototype._setMetadataModel=function(){var i=null,j=this._getMetaModelName();if(j){i=this.getModel(j);}else{i=this.getModel();}if(i){this.detachModelContextChange(this._setMetadataModel,this);this._fResolveFilterBarMetaModelSet(i);}};s.prototype.applySettings=function(S,i){C.prototype.applySettings.apply(this,arguments);this._createConditionModel();this._oConditionModelPromise.then(function(){this._applyInitialFiltersConditions();}.bind(this));};s.prototype.setMetadataDelegate=function(i){this.setProperty("metadataDelegate",i);return this;};s.prototype._createInnerModel=function(){this._oModel=new M(this);this.setModel(this._oModel,s.INNER_MODEL_NAME);return this;};s.prototype._addButtons=function(){if(this._oFilterBarLayout){this._btnAdapt=new B(this.getId()+"-btnAdapt",{text:this._oRb.getText("filterbar.ADAPT"),press:this.onAdaptFilters.bind(this)});this._btnAdapt.setModel(this._oModel,s.INNER_MODEL_NAME);this._btnAdapt.bindProperty("visible",{parts:[{path:'/showAdaptFiltersButton',model:s.INNER_MODEL_NAME},{path:"/supportP13N",model:s.INNER_MODEL_NAME}],formatter:function(v,V){return v&&V;}});this._btnAdapt.addStyleClass("sapUiMdcBaseFilterBarButtonPaddingRight");this._oFilterBarLayout.addEndContent(this._btnAdapt);this._btnSearch=new B(this.getId()+"-btnSearch",{text:this._oRb.getText("filterbar.GO"),press:this.onSearch.bind(this),type:q.Emphasized});this._btnSearch.setModel(this._oModel,s.INNER_MODEL_NAME);this._btnSearch.bindProperty("visible",{parts:[{path:'/showGoButton',model:s.INNER_MODEL_NAME},{path:"/liveMode",model:s.INNER_MODEL_NAME}],formatter:function(v,V){return v&&!V;}});this._oFilterBarLayout.addEndContent(this._btnSearch);}};s.prototype._initializeProvider=function(){var i=this.getMetadataDelegate();if(!i){return Promise.resolve(null);}var j=this.getMetadataInfo();if(Object.keys(j).length>0){this.attachModelContextChange(this._setMetadataModel,this);}else{this._fResolveFilterBarMetaModelSet(null);}return this._loadProvider(i);};s.prototype._loadProvider=function(i){return new Promise(function(R){sap.ui.require([i],function(j){R(j);});});};s.prototype.onAdaptFilters=function(E){this.showFiltersDialog();};s.prototype._getAssignedFilterNames=function(){var i,N,j=null,v=this._getConditionModel(),w;if(v){i=v.getAllConditions();j=[];for(N in i){if(j.indexOf(N)<0){var x=v.getConditions(N);if(x&&x.length>0){if(N==="$search"){j.push(this._oRb.getText("filterbar.ADAPT_SEARCHTERM"));}else{w=this._getFilterField(N);if(w){if(w.getVisible()){j.push(N);}}else{j.push(N);}}}}}}return j;};s.prototype._getAssignedFiltersText=function(j){var v,w;j=j||[];if(j.length>5){w=j.slice(0,5);w.push("...");}else{w=j;}v=Object.keys(w).map(function(i){return w[i];}).join(", ");if(j.length){return this._oRb.getText("filterbar.ADAPT_FILTERED",[j.length,v]);}return this._oRb.getText("filterbar.ADAPT_NOTFILTERED");};s.prototype.getAssignedFiltersText=function(){return this._getAssignedFiltersText(this._getAssignedFilterNames());};s.prototype._handleConditionModelChange=function(E){if(!this._bIgnoreChanges){this._handleAssignedFilterNames(E);this._handleCalculateDifferences();}};s.prototype._handleCalculateDifferences=function(S,i){var j=this.getProperty("filtersConditions");this._calculateConditionsDiffsToPrevState(j,this._getConditionModel());};s.prototype._calculateConditionsDiffsToPrevState=function(j,v){if(!this.getSupportP13N()){return;}if(!v){return;}var w=v.getAllConditions();if(d(w,j)){return;}for(var x in w){if(!j[x]){for(var i=0;i<w[x].length;i++){var y=this._createAddRemoveConditionChangeWithFieldPath("addCondition",x,w[x][i]);if(y){this._aChanges.push(y);}}}else{this._calculateConditionsDifference(x,w,j);}}this._storeChanges();};s.prototype._determineType=function(i){var j,v=this._getFilterField(i);if(v){return v;}j=this._getPropertyByName(i);if(j){return j;}L.error("not able to resolve metadata for "+i);return null;};s.prototype._calculateConditionsDifference=function(i,O,j){var T,v,w,x;var y=O[i]?m([],O[i]):[];var S=j[i]?m([],j[i]):[];this._cleanupConditions(y);this._cleanupConditions(S);if(d(y,S)){return;}this._removeSameConditions(y,S);if((y.length>0)||(S.length>0)){x=this._determineType(i);if(!x){return;}if(x.isA("sap.ui.mdc.base.FilterField")){T=x.getDataType();v=x.getDataTypeFormatOptions();w=x.getDataTypeConstraints();}else if(x.isA("sap.ui.mdc.PropertyInfo")){T=x.getType();v=x.getFormatOptions();w=x.getConstraints();}y.forEach(function(z){z=l.toExternal(z,T,v,w);});S.forEach(function(z){this._aChanges.push(this._createAddRemoveConditionChange("removeCondition",i,T,v,w,z));}.bind(this));y.forEach(function(z){this._aChanges.push(this._createAddRemoveConditionChange("addCondition",i,T,v,w,z));}.bind(this));}};s.prototype._cleanupConditions=function(i){if(i){i.forEach(function(j){if(j.hasOwnProperty("isEmpty")){delete j.isEmpty;}});}};s.prototype._removeSameConditions=function(v,S){var R;do{R=false;for(var i=0;i<v.length;i++){for(var j=0;j<S.length;j++){if(d(v[i],S[j])){v.splice(i,1);S.splice(j,1);R=true;break;}}if(R){break;}}}while(R);};s.prototype._handleAssignedFilterNames=function(E){var O={},i=this._getAssignedFilterNames();if(i){if(this._btnAdapt){this._btnAdapt.setText(this._oRb.getText(i.length?"filterbar.ADAPT_NONZERO":"filterbar.ADAPT",i.length));this._oFilterBarLayout.reflow();}O.filtersText=this._getAssignedFiltersText(i);this.fireFiltersChanged(O);if(this.getLiveMode()){this.fireSearch();}}};s.prototype.onReset=function(E){this.fireReset();};s.prototype.onSearch=function(E){this.fireSearch();};s.prototype.fireSearch=function(E){var i=this.getConditions(true);this.fireEvent("search",{conditions:i});};s.prototype.getConditions=function(D){var i={},j=this._getConditionModel();if(j){var v=j.getAllConditions();for(var w in v){if(v[w]&&(v[w].length>0)){i[w]=m([],v[w]);if(!D){this._cleanupConditions(i[w]);}}}}return i;};s.prototype.setConditions=function(i){var j=this._getConditionModel();if(j){for(var v in i){j.removeAllConditions(v);var w=i[v];w.forEach(function(x){j.addCondition(v,x);});}}};s.prototype.showFiltersDialog=function(){if(!this._oMetadataPromise){this._oMetadataPromise=this._retrieveMetadata();}if(!t){sap.ui.require(["sap/ui/mdc/base/filterbar/AdaptFiltersDialog","sap/ui/mdc/base/filterbar/AdaptFiltersDialogItem"],function(i,j){this._oMetadataPromise.then(function(){t=i;u=j;this._showFiltersDialog();}.bind(this));}.bind(this));}else{this._showFiltersDialog();}};s.prototype._showFiltersDialog=function(){this._clearChanges();var j=new J({showResetEnabled:false,items:this._setItemsForAdaptFiltersDialog()});var i=new u({key:"{$sapuimdcbasefilterbarAdaptFiltersDialog>key}",text:"{$sapuimdcbasefilterbarAdaptFiltersDialog>text}",tooltip:"{$sapuimdcbasefilterbarAdaptFiltersDialog>tooltip}",required:"{$sapuimdcbasefilterbarAdaptFiltersDialog>required}",visible:"{$sapuimdcbasefilterbarAdaptFiltersDialog>visible}",relativePosition:"{$sapuimdcbasefilterbarAdaptFiltersDialog>relativePosition}",controls:{path:'$sapuimdcbasefilterbarAdaptFiltersDialog>controls',templateShareable:false,factory:function(x,y){return y.getObject(y.getPath());}}});var v=new t({showReset:false,showResetEnabled:{path:'$sapuimdcbasefilterbarAdaptFiltersDialog>/showResetEnabled'},items:{path:'$sapuimdcbasefilterbarAdaptFiltersDialog>/items',templateShareable:false,template:i},visibilityChanged:function(E){this._addFilterVisibilityChange(E.getParameter("key"),E.getParameter("visible"));}.bind(this),positionChanged:function(E){this._addFilterPositionyChange(E.getParameter("key"),E.getParameter("relativePosition"));}.bind(this),ok:function(E){var x=this._oAdaptFiltersDialog.getModel("cmodel");this._calculateConditionsDiffsToPrevState(this._getConditionModel().getAllConditions(),x);E.getSource().close();E.getSource().destroy();this._oAdaptFiltersDialog=null;}.bind(this),reset:function(){this._oAdaptFiltersDialog=null;}.bind(this),cancel:function(E){E.getSource().close();E.getSource().destroy();this._oAdaptFiltersDialog=null;}.bind(this)});v.setModel(j,"$sapuimdcbasefilterbarAdaptFiltersDialog");var w=this._getConditionModel().clone();v.setModel(w,"cmodel");this.addDependent(v);this._oAdaptFiltersDialog=v;v.open();};s.prototype._addFilterPositionyChange=function(N,i){var j=this._getFilterField(N);var v=j?j.getId():this._getFilterFieldId(N);this._removeSetFilterPositionChange(v);var w={id:v,position:i};this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"setFilterPosition",content:w}});};s.prototype._createFilterVisibilityChangeContentByProperty=function(i,N,j){var v=(j.getFilterExpression()===p.Multi)?-1:1;return{id:i,name:N,type:j.getType(),path:'\{'+this._getConditionModelName()+">/conditions/"+N+'\}',constraints:j.getConstraints(),formatOptions:j.getFormatOptions(),required:j.getRequired(),label:j.getLabel(),maxConditions:v,fieldHelp:j.getFieldHelp()};};s.prototype._createFilterVisibilityChangeContentByFilterField=function(i,N,j){var v={id:i,name:N,type:j.getDataType(),path:'\{'+this._getConditionModelName()+">/conditions/"+N+'\}',constraints:m({},j.getDataTypeConstraints()),formatOptions:m({},j.getDataTypeFormatOptions()),required:j.getRequired(),label:j.getLabel(),maxConditions:j.getMaxConditions(),fieldHelp:j.getFieldHelp()};return v;};s.prototype._addFilterVisibilityChange=function(N,v){var i=this._getFilterField(N),j=this._getNonHiddenPropertyByName(N);if(v){if(!i){this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"addFilter",content:this._createFilterVisibilityChangeContentByProperty(this._getFilterFieldId(N),N,j)}});}else{if(i.getVisible()){this._removeRemoveFilterChange(i);}else{this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"addFilter",content:this._createFilterVisibilityChangeContentByFilterField(i.getId(),N,i)}});}}}else{if(i){this._aChanges.push({selectorControl:this,changeSpecificData:{changeType:"removeFilter",content:this._createFilterVisibilityChangeContentByFilterField(i.getId(),N,i)}});}else{this._removeAddFilterChange(j);}}};s.prototype._createAddRemoveConditionChangeWithFieldPath=function(i,j,v){var O=this._determineType(j);if(!O){return null;}if(O.isA("sap.ui.mdc.base.FilterField")){return this._createAddRemoveConditionChangeWithField(i,O,v);}else if(O.isA("sap.ui.mdc.PropertyInfo")){return this._createAddRemoveConditionChange(i,j,O.getType(),O.getFormatOptions(),O.getConstraints(),v);}};s.prototype._createAddRemoveConditionChange=function(i,j,T,v,w,x,O,y){var z=x;if(x&&x.values&&x.values.length>0){z=l.toExternal(x,T,v,w);}var D={selectorControl:this,changeSpecificData:{changeType:i,content:{name:j,type:T,constraints:m({},w),formatOptions:m({},v),condition:z,index:y,outConditions:O?O:null}}};return D;};s.prototype._createAddRemoveConditionChangeWithField=function(i,j,v,O,w){return this._createAddRemoveConditionChange(i,j.getFieldPath(),j.getDataType(),j.getDataTypeFormatOptions(),j.getDataTypeConstraints(),v,O,w);};s.prototype._removeAddFilterChange=function(i){var j=-1;this._aChanges.some(function(v,w){if((v.changeSpecificData.changeType==="addFilter")&&(v.changeSpecificData.content.name===i.getName())){j=w;}return j>-1;});if(j>-1){this._aChanges.splice(j,1);}};s.prototype._removeRemoveFilterChange=function(i){var j=-1;this._aChanges.some(function(v,w){if((v.changeSpecificData.changeType==="removeFilter")&&(v.changeSpecificData.content.id===i.getId())){j=w;}return j>-1;});if(j>-1){this._aChanges.splice(j,1);}};s.prototype._removeSetFilterPositionChange=function(i){var j=-1;this._aChanges.some(function(v,w){if((v.changeSpecificData.changeType==="setFilterPosition")&&(v.changeSpecificData.content.id===i)){j=w;}return j>-1;});if(j>-1){this._aChanges.splice(j,1);}};s.prototype._clearChanges=function(){this._aChanges=[];};s.prototype._condenseChange=function(){var R=[];this._aChanges.every(function(j){var i,v,w=false;if(j.changeSpecificData.changeType==="setFilterPosition"){if(j.changeSpecificData.content.id){for(i=0;i<this._aChanges.length;i++){v=this._aChanges[i];if((v.changeSpecificData.changeType==="removeFilter")&&(v.changeSpecificData.content.id===j.changeSpecificData.content.id)){w=true;break;}}}else if(j.changeSpecificData.content.name){w=true;for(i=0;i<this._aChanges.length;i++){v=this._aChanges[i];if((v.changeSpecificData.changeType==="addFilter")&&(v.changeSpecificData.content.name===j.changeSpecificData.content.name)){w=false;break;}}}if(!w){R.push(j);}}else{R.push(j);}return true;}.bind(this));this._aChanges=R;};s.prototype._storeChanges=function(){if(!this.getSupportP13N()){this._clearChanges();return;}this._condenseChange();if(this._aChanges&&this._aChanges.length){var H=o.hasVariantManagement(this);o.addPersonalizationChanges({controlChanges:this._aChanges,ignoreVariantManagement:!H});this._clearChanges();}};s.prototype._setItemsForAdaptFiltersDialog=function(){var i=this.getFilterItems();if(this._getNonHiddenPropertyInfoSet().length>0){return this._getNonHiddenPropertyInfoSet().map(function(j,v){var K=j.getName();var w=this._getFilterField(K);var x=i.indexOf(w);var y=w?w.clone():this.createFilterField(j);y.setVisible(true);y.bindProperty("conditions",{path:"cmodel>/conditions/"+K});return{key:K,text:j.getLabel(),tooltip:j.getTooltip(),required:j.getRequired(),relativePosition:x,visible:(x>-1)&&w.getVisible(),controls:[y]};}.bind(this));}else{return i.map(function(j,v){var w=j.clone();w.bindProperty("conditions",{path:"cmodel>/conditions/"+w.getFieldPath()});return{key:w.getFieldPath(),text:w.getFieldPath(),tooltip:w.getTooltip(),required:w.getRequired(),relativePosition:v,visible:j.getVisible(),controls:[w]};});}};s.prototype._getContent=function(){return this._oFilterBarLayout;};s.prototype._insertFilterFieldtoContent=function(i,j){if(!F){return;}var v=new F();v.setFilterField(i);this._oFilterBarLayout.insertContent(v,j);};s.prototype._filterItemInserted=function(i){if(!i.getVisible()){return;}if(i.setWidth){i.setWidth("");}if(this._isChangeApplying()){this._suspendBinding(i);}this._applyFilterItemInserted(i);};s.prototype._applyFilterItemInserted=function(j){var v,w;w=this.indexOfAggregation("filterItems",j);if(this.getAggregation("basicSearchField")){w++;}v=w;var x=this.getFilterItems();for(var i=0;i<v;i++){if(!x[i].getVisible()){w--;}}this._insertFilterFieldtoContent(j,w);if(!this._oObserver.isObserved(j,{properties:["visible"]})){this._oObserver.observe(j,{properties:["visible"]});}};s.prototype._filterItemRemoved=function(i){this._applyFilterItemRemoved(i.getFieldPath());};s.prototype._applyFilterItemRemoved=function(i){this._removeFilterFieldFromContentByName(i);};s.prototype._removeFilterFieldFromContent=function(i){this._removeFilterFieldFromContentByName(i.getFieldPath());};s.prototype._removeFilterFieldFromContentByName=function(i){var j=this._getFilterItemLayoutByName(i);if(j){this._oFilterBarLayout.removeContent(j);j.destroy();}};s.prototype._observeChanges=function(i){if(i.type==="aggregation"&&i.name==="filterItems"){switch(i.mutation){case"insert":this._filterItemInserted(i.child);break;case"remove":this._filterItemRemoved(i.child);break;default:L.error("operation "+i.mutation+" not yet implemented");}}else if(i.type==="property"){var j,v;if(i.object.isA("sap.ui.mdc.base.FilterField")){v=i.object;if(v){if(i.current){this._filterItemInserted(v);}else{this._filterItemRemoved(v);}this._oFilterBarLayout.rerender();}}else if(i.object.isA("sap.ui.mdc.PropertyInfo")){v=this._getFilterField(i.object.getName());if(v){if((i.name==="tooltip")){v.setTooltip(i.current);}else{v.setProperty(i.name,i.current);j=this._getFilterItemLayout(v);if(j){j.rerender();}}}}}};s.prototype._getFilterItemLayout=function(i){return this._getFilterItemLayoutByName(i.getFieldPath());};s.prototype._getFilterItemLayoutByName=function(i){var j=null;this._oFilterBarLayout.getContent().some(function(v){if(v._getFieldPath()===i){j=v;}return j!==null;});return j;};s.prototype._getFilterField=function(N){var i=null;this.getFilterItems().some(function(j){if(j&&j.getFieldPath&&(j.getFieldPath()===N)){i=j;}return i!==null;});return i;};s.prototype._retrieveMetadata=function(){return new Promise(function(i){Promise.all([this._initializeProvider(),this._oMetaModelSetPromise]).then(function(j){if(!this._bIsBeingDestroyed){var v=j[0];var w=j[1];this._aProperties=[];if(v&&v.fetchProperties){try{v.fetchProperties(w,this._getEntitySetName()).then(function(y){this._aProperties=y;if(this._aProperties.length===0){this._createLocalPropertySet();}this._observePropertySet();this._fResolveFilterBarMetadataApplied();}.bind(this));}catch(x){L.error("Exception during fetchProperties occured: "+x.message);}}else{L.error("Provided metadataDelegate '"+this.getMetadataDelegate()+"' not valid.");}if(this._aProperties.length===0){this._createLocalPropertySet();}this._observePropertySet();this._fResolveFilterBarMetadataApplied();}i();}.bind(this));}.bind(this));};s.prototype._createLocalPropertySet=function(){this.getFilterItems().forEach(function(i){var j=this._isInternalVH(i);var v=new k({name:i.getFieldPath(),label:i.getLabel(),required:i.getRequired(),type:i.getDataType(),constraints:i.getDataTypeConstraints(),formatOptions:i.getDataTypeFormatOptions(),visible:i.getVisible(),filterable:true,hiddenFilter:false,filterExpression:((i.getMaxConditions()===1)?p.Single:p.Multiple),hasFieldHelp:j,fieldHelp:j?"":i.getFieldHelp()});this._aProperties.push(v);}.bind(this));};s.prototype._observePropertySet=function(){this.getPropertyInfoSet().some(function(i){this._oObserver.observe(i,{properties:["required","label","toolbar","visible"]});}.bind(this));};s.prototype._isInternalVH=function(i){var j,v,w=false;if(i.getFieldHelp()){v=sap.ui.getCore().byId(i.getFieldHelp());if(v){do{j=v.getParent();if(j===i){w=true;}else if(j===this){j=null;}}while(!w&&j);}}return w;};s.prototype.enrichFiltersWithMetadata=function(){this.getFilterItems().every(function(i){var N=i.getFieldPath();this._getNonHiddenPropertyInfoSet().some(function(j){var v,w=1;if((j.getName()===N)&&(N!=="$search")){if(!i.getDataTypeConstraints()&&j.getConstraints()){i.setDataTypeConstraints(m({},j.getConstraints()));}i.setDataType(j.getType());i.setRequired(j.getRequired());if(j.getFilterExpression()===p.Multi){w=-1;}i.setMaxConditions(w);v=j.getFilterConditions();if(v&&(v.length>0)){i.setConditions(v);}if(j.getTooltip()){i.setTooltip(j.getTooltip());}this._oObserver.observe(j,{properties:["required","label","toolbar","visible"]});return true;}return false;}.bind(this));return true;}.bind(this));};s.prototype.setBasicSearchField=function(i){var O=this.getAggregation("basicSearchField");if(O){this._removeFilterFieldFromContent(O);}this.setAggregation("basicSearchField",i);if(i){if(!this._oObserver.isObserved(i,{properties:["visible"]})){this._oObserver.observe(i,{properties:["visible"]});}this._insertFilterFieldtoContent(i,0);}};s.prototype.getPropertyInfoSet=function(){return this._aProperties||[];};s.prototype._getNonHiddenPropertyInfoSet=function(){var v=[];this.getPropertyInfoSet().every(function(i){if(!i.getHiddenFilter()){if(i.getName()!=="$search"){v.push(i);}}return true;});return v;};s.prototype._getNonHiddenPropertyByName=function(N){var i=null;this._getNonHiddenPropertyInfoSet().some(function(j){if(j.getName()===N){i=j;}return i!=null;});return i;};s.prototype._getPropertyByName=function(N){var i=null;this.getPropertyInfoSet().some(function(j){if(j.getName()===N){i=j;}return i!=null;});return i;};s.prototype._getFilterFieldId=function(N){return this.getId()+"--filter--"+I.replace(N);};s.prototype.createFilterField=function(i){var j,v=1,V=null;if(i.getFilterExpression()===p.Multi){v=-1;}j=new g(this._getFilterFieldId(i.getName()),{label:i.getLabel(),dataType:i.getType(),dataTypeConstraints:m({},i.getConstraints()),dataTypeFormatOptions:m({},i.getFormatOptions()),maxConditions:v,required:i.getRequired(),visible:i.getVisible()});j.bindProperty("conditions",{path:this._getConditionModelName()+">/conditions/"+i.getName()},true);var w=i.getFilterConditions();if(w&&(w.length>0)){j.setConditions(w);}if(i.getTooltip()){j.setTooltip(i.getTooltip());}V=i.getFieldHelp();if(V){j.setFieldHelp(this._getView().createId(V));}var x=this._getConditionModel();if(x){j.setModel(x,this._getConditionModelName());}return j;};s.prototype.applyConditionsAfterChangesApplied=function(){if(r){this._applyConditionsAfterChangesApplied(r);}else{sap.ui.require(["sap/ui/fl/FlexControllerFactory"],function(i){r=i;this._applyConditionsAfterChangesApplied(r);}.bind(this));}};s.prototype.waitForInitialFiltersApplied=function(){return this._oInitialFiltersAppliedPromise;};s.prototype._suspendBinding=function(i){if(i){var j=i.getBinding("conditions");if(j){if(!this._aBindings){this._aBindings=[];}j.suspend();this._aBindings.push(i);}}};s.prototype._resumeBindings=function(){if(this._aBindings){this._aBindings.forEach(function(i){if(!i.bIsDestroy){var j=i.getBinding("conditions");if(j){j.resume();}}});this._aBindings=null;}};s.prototype._isChangeApplying=function(){return!!this._oFlexPromise;};s.prototype._applyConditionsAfterChangesApplied=function(i){if(this._isChangeApplying()){return;}this._bIgnoreChanges=true;var j=this.getFilterItems();j.forEach(function(v){this._suspendBinding(v);}.bind(this));this._oFlexPromise=i.createForControl(this).waitForChangesToBeApplied(this);this._bIgnoreChanges=true;Promise.all([this._oFlexPromise,this._oInitialFiltersAppliedPromise]).then(function(v){this._applyFiltersConditionsChanges();this._resumeBindings();this._oFlexPromise=null;setTimeout(function(){this._createShadowModel();}.bind(this),0);}.bind(this));};s.prototype._applyInitialFiltersConditions=function(){this._bIgnoreChanges=true;this._applyFiltersConditionsChanges();setTimeout(function(){this._createShadowModel();this._fResolveInitialFiltersApplied();}.bind(this),0);};s.prototype._applyFiltersConditionsChanges=function(){var i,j,v,O,T,w,x;var S=this.getProperty("filtersConditions");if(Object.keys(S).length>0){j=m([],S);v=this._getConditionModel();v.removeAllConditions();if(j){for(var y in j){i=j[y];O=this._determineType(y);if(O){if(O.isA("sap.ui.mdc.base.FilterField")){T=O.getDataType();w=O.getDataTypeFormatOptions();x=O.getDataTypeConstraints();}else if(O.isA("sap.ui.mdc.PropertyInfo")){T=O.getType();w=O.getFormatOptions();x=O.getConstraints();}i.forEach(function(z){z=l.toInternal(z,T,w,x);var N=f.createCondition(z.operator,z.values);v.addCondition(y,N);});}}}}};s.prototype._createShadowModel=function(){var i,S={};var j=this._getConditionModel();var v=j.getAllConditions();for(var w in v){i=v[w];i.forEach(function(x){if(!S[w]){S[w]=[];}S[w].push(x);});this._cleanupConditions(S[w]);}this.setProperty("filtersConditions",S);this._bIgnoreChanges=false;this._handleConditionModelChange();};s.prototype._getView=function(){if(!this._oView){var O=this.getParent();while(O){if(O.isA("sap.ui.core.mvc.View")){this._oView=O;break;}O=O.getParent();}}return this._oView;};s.prototype.exit=function(){C.prototype.exit.apply(this,arguments);if(this._oFilterBarLayout){this._oFilterBarLayout.destroy();this._oFilterBarLayout=null;}this._btnAdapt=undefined;this._btnSearch=undefined;this._oRb=null;if(this._oModel){this._oModel.destroy();this._oModel=null;}if(this._oConditionChangeBinding){this._oConditionChangeBinding.detachChange(this._handleConditionModelChange,this);this._oConditionChangeBinding=null;}if(this._oConditionModel){this._oConditionModel.destroy();this._oConditionModel=null;}this._oObserver.disconnect();this._oObserver=undefined;this._aProperties=null;this._oFlexPromise=null;this._oMetadataPromise=null;this._fResolveFilterBarConditionModel=undefined;this._oConditionModelPromise=null;this._fResolveFilterBarMetaModelSet=undefined;this._oMetaModelSetPromise=null;this._fResolveFilterBarMetadataApplied=undefined;this._oMetadataAppliedPromise=null;this._fResolveInitialFiltersApplied=undefined;this._oInitialFiltersAppliedPromise=null;this._aChanges=null;this._oView=null;this._aBindings=null;};return s;},true);
