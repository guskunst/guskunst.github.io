/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(['sap/m/MessageBox','sap/fe/factory/UI5ControlFactory','sap/ui/mdc/base/Field','sap/m/Label',"sap/ui/model/json/JSONModel",'sap/ui/core/XMLTemplateProcessor','sap/ui/core/util/XMLPreprocessor','sap/ui/core/Fragment','sap/fe/actions/messageHandling'],function(M,U,F,L,J,X,a,b,m){'use strict';function c(A,i,j,P){if(!i||i.length===0){return Promise.reject("Bound actions always requires at least one context");}P=P||{};if(Array.isArray(i)){P.bReturnAsArray=true;}else{i=[i];}var k=j.getMetaModel(),l=k.getMetaPath(i[0].getPath())+'/'+A,B=k.createBindingContext(l+'/@$ui5.overload/0');P.aContexts=i;return e(A,j,B,P);}function d(A,i,P){if(!i){return Promise.reject("Action expects a model/context for execution");}var j=i.getMetaModel(),k=i.bindContext("/"+A).getPath(),l=j.createBindingContext(k+'/0');return e(A,i,l,P);}function e(A,i,j,P){return new Promise(function(r,k){P=P||{};var l=P.actionParameters||[],n={},I,D,q,t=P.label,S=P.showActionParameterDialog,C=P.aContexts,u=P.bIsCreateAction;if(!j){k("Action not found");}I=h(A,i);if(S||l.length>0){l=p(j,l);if(!l||l.length===0){S=false;}}if(S){D=s;}else if(I){D=f;}n={fnOnSubmitted:P.onSubmitted,actionName:A,model:i,aActionParameters:l};if(j.getObject('$IsBound')){n.aContexts=C;n.mBindingParameters=P.mBindingParameters;n.bGrouped=P.invocationGrouping==='ChangeSet';n.bReturnAsArray=P.bReturnAsArray;}if(u){n.bIsCreateAction=u;}if(D){q=D(t,l,j,P.parentControl,n);}else{q=_(n);}return q.then(function(O){if(!O){k(O);}r(O);}).catch(function(O){k(O);});});}function f(A,i){return new Promise(function(r,j){var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),C;if(R.hasText("SAPFE_ACTION_CONFIRM|"+A)){C=R.getText("SAPFE_ACTION_CONFIRM|"+A);}else{C=R.getText("SAPFE_ACTION_CONFIRM");}M.confirm(C,{onClose:function(k){if(k===M.Action.OK){r(true);}r(false);},title:i||R.getText("SAPFE_ACTION_CONFIRM_TITLE")});});}function s(A,j,k,P,l){var n=l.aContexts?l.aContexts[0].getPath():('/'+k.getPath().split('/')[1]),q=k.getModel().oModel.getMetaModel(),r=q.createBindingContext(n),t=k.getObject("$IsBound")?k.getPath().split("/@$ui5.overload/0")[0]:k.getPath().split("/0")[0],u=q.createBindingContext(t);return new Promise(function(v,w){var x=X.loadTemplate('sap/fe/controls/ActionParameterDialog','fragment'),R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),y=new J({$valueState:{},$valueStateText:{}}),C={handleChange:function(E,i){var V=E.getParameter("value");var z=E.getParameter("valid");if(z&&V!=""){y.setProperty("/$valueState/"+i,'None');y.setProperty("/$valueStateText/"+i,'');}}};return a.process(x,{},{bindingContexts:{action:k,actionName:u,entitySet:r},models:{action:k.getModel(),actionName:u.getModel(),entitySet:r.getModel()}}).then(function(x){b.load({definition:x,controller:C}).then(function(D){var z=U.getDialogControl({title:A||R.getText("SAPFE_ACTION_PARAMETER_DIALOG_TITLE"),content:[D],escapeHandler:function(i){z.close();z.destroy();v(false);},beginButton:{text:A||R.getText("SAPFE_OK"),type:"Emphasized",press:function(E){var B=E.getSource(),G,i,H,I=D.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");B.setEnabled(false);z.setBusy(true);var K=function(Q){var S=[];for(i=0;i<Q.length;i++){var T=Q[i].getFields()[0];if(T.getProperty("required")&&T.mBindingInfos.value.binding){S.push(T.mBindingInfos.value.binding.getPath());}}return S;};var N=K(I);var O;for(i=0;i<j.length;i++){O="/"+j[i].$Name;H=y.getProperty(O);if(!H&&N.indexOf(O)>=0){G=true;y.setProperty("/$valueState/"+j[i].$Name,'Error');y.setProperty("/$valueStateText/"+j[i].$Name,R.getText("SAPFE_ACTION_PARAMETER_REQUIRED"));}else{j[i].value=H;}}if(!G){m.removeUnboundTransitionMessages();return _(l).then(function(Q){z.close();v(Q);}).catch(function(Q){z.setBusy(false);B.setEnabled(true);m.showUnboundMessages();});}}},endButton:{text:R.getText("SAPFE_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){z.close();v(false);}},afterClose:function(){z.destroy();}});z.setModel(k.getModel().oModel);z.setModel(y,"paramsModel");z.bindElement({path:'/',model:'paramsModel'});if(P){P.addDependent(z);}z.open();});});});}function p(A,P){var i=g(A);P=P||[];if(P.length>0){}return i;}function g(A){var P=A.getObject("$Parameter")||[];if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}}return P;}function h(A,i){return i.getMetaModel().getObject("/"+A+'@com.sap.vocabularies.Common.v1.IsActionCritical');}function _(P){var C=P.aContexts||[],k=P.model,A=P.aActionParameters||[],l=P.actionName,O=P.fnOnSubmitted,I=P.bIsCreateAction,n=false,q;function D(i){return i.then(function(j){return{response:j,status:"resolved"};},function(j){return{response:j,status:"rejected"};});}function r(){if(A&&A.length){n=true;for(var j=0;j<A.length;j++){if(!A[j].value&&A[j].$Nullable===false){switch(A[j].$Type){case"Edm.String":A[j].value="";break;case"Edm.Boolean":A[j].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":A[j].value=0;break;default:break;}}q.setParameter(A[j].$Name,A[j].value);}}}if(C.length){return new Promise(function(j,u){var B=P.mBindingParameters,G=P.bGrouped,R=P.bReturnAsArray,v=[],i,w,E=function(q,x){r();w=x&&!G?'$auto.'+x:undefined;v.push(q.execute(w));};for(i=0;i<C.length;i++){q=k.bindContext(l+'(...)',C[i],B);E(q,(C.length<=1?null:i));}(O||jQuery.noop)(v);Promise.all(v.map(D)).then(function(x){var y=[],z=[],H;for(H=0;H<x.length;H++){if(x[H].status==="rejected"){y.push(x[H].response);}if(x[H].status==="resolved"){if(I&&n){x[H].bConsiderDocumentModified=true;z.push(x[H]);}else{z.push(x[H].response);}}}if(!x||(x&&x.length===0)){u(true);}if(y.length===0){if(R){j(z);}else{j(z[0]);}}else{u({resolvedItems:z,rejectedItems:y});}});});}else{var t;q=k.bindContext("/"+l+'(...)');r();t=q.execute('actionImport');k.submitBatch('actionImport');(O||jQuery.noop)(t);return t;}}var o={callBoundAction:c,callActionImport:d};return o;});
