/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(['sap/ui/core/mvc/ControllerExtension',"sap/m/MessagePage","sap/m/Link","sap/m/MessageBox","sap/ui/core/routing/HashChanger","sap/base/Log"],function(C,M,L,a,H,b){'use strict';var u,d,A,t,o=[];var E=C.extend('sap.fe.controllerextensions.Routing',{navigateToContext:function(c,p){p=p||{};var n=this._getOwnerComponent().getRootControl(),P,e=this;if(c.getMetadata().getName()==="sap.ui.model.odata.v4.ODataListBinding"){if(p.asyncContext){p.asyncContext.then(function(c){e.navigateToContext(c,{noHistoryEntry:true,noHashChange:p.noHashChange,useCanonicalPath:p.useCanonicalPath,editable:p.editable});});A=p.asyncContext;}else if(p.deferredContext){d=true;}else{throw("navigation to a list binding is not yet supported");}}else{u=c;}t=p.editable;if(p.noHashChange){this._bindTargetPage(n,null,null,true);return;}if(!p.noHistoryEntry&&n&&n.getMetadata().getName()==="sap.m.NavContainer"){n.setBusy(true);}if(p.useCanonicalPath){P=c.getCanonicalPath();}else{P=c.getPath();}if(p.asyncContext||p.deferredContext){P+='(...)';}while(P.indexOf('/')===0){P=P.substr(1);}if(p.noHistoryEntry){H.getInstance().replaceHash(P);}else{H.getInstance().setHash(P);}return Promise.resolve();},setBreadcrumbLinks:function(c,l){if(l.length&&c!==null){if((c===undefined)&&(l[0].getBindingContext()!==null)){l.forEach(function(f){f.setBindingContext(null);});return;}else if(c&&c.getPath()){var n=c.getPath();var s=l[l.length-1].getElementBinding()&&l[l.length-1].getElementBinding().getPath();if(s&&n.indexOf(s)>-1){return;}var e=H.getInstance().hrefForAppSpecificHash("");var p="",P=n.split("/");e=e.split("/")[0];P.shift();P.splice(-1,1);for(var i=0;i<l.length;i++){var f=l[i];p=p+"/"+P[i];f.setHref(e+p);f.bindElement({path:p,parameters:{$$groupId:'$auto.associations'}});}}}},navigateOutbound:function(O,c){var e=this._getOutbounds(),D=e[O];if(D){var p={};if(D.parameters){for(var P in D.parameters){if(D.parameters[P].value.format==="binding"){p[P]=c.getProperty(D.parameters[P].value.value);}}}var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");f&&f.toExternal({target:{semanticObject:D.semanticObject,action:D.action},params:p});return Promise.resolve();}else{throw new Error("outbound target "+O+" not found in cross navigation definition of manifest");}},navigateToMessagePage:function(e,p){var n=p.navContainer||this._getOwnerComponent().getRootControl();if(!this.oMessagePage){this.oMessagePage=new M({showHeader:false,icon:"sap-icon://message-error"});n.addPage(this.oMessagePage);}this.oMessagePage.setText(e);if(p.technicalMessage){this.oMessagePage.setCustomDescription(new L({text:p.description||p.technicalMessage,press:function(){a.show(p.technicalMessage,{icon:a.Icon.ERROR,title:p.title,actions:[a.Action.OK],defaultAction:a.Action.OK,details:p.technicalDetails||"",contentWidth:"60%"});}}));}else{this.oMessagePage.setDescription(p.description||'');}n.to(this.oMessagePage);},setDirtyState:function(c,D){if(typeof c==="string"){sap.fe.controllerextensions.Routing.mAppDirtyState[c]=D;}else{var p=c.getPath();if(p){if(p.indexOf('/-1')!==-1){p=p.substring(0,p.indexOf('/-1'));}else{p=p.substring(0,p.lastIndexOf('('));}if(p.lastIndexOf('/')!==-1){p=p.substring(0,p.lastIndexOf('/'));}sap.fe.controllerextensions.Routing.mAppDirtyState[p]=D;}else{b.error(p+" could not be marked dirty");}}},resetDirtyState:function(){sap.fe.controllerextensions.Routing.mAppDirtyState={};},getDirtyState:function(p){return p?sap.fe.controllerextensions.Routing.mAppDirtyState[p]:sap.fe.controllerextensions.Routing.mAppDirtyState;},initializeRouting:function(c){var r=c.getRouter(),R,n=false,e=this,s=g(c),P,f=c.getComponentData(),S=f&&f.startupParameters,m=c.getModel(),h=S!==undefined&&Object.keys(S).length!==0;u=null;d=false;A=null;t=false;o=[];function g(c){var s;var k=c.getManifest();var l=k["sap.ui5"].routing.routes;var T=k["sap.ui5"].routing.targets;var p;for(var i=0;i<l.length;i++){p=l[i].pattern;if(p===""||":?query:"){s=T[l[i].target].options&&T[l[i].target].options.settings&&T[l[i].target].options.settings.entitySet;break;}}for(var j=0;j<l.length;j++){p=l[i].pattern;if((p!==""||":?query:")&&(T[l[j].target].options&&T[l[j].target].options.settings&&T[l[j].target].options.settings.entitySet===s)&&(T[l[j].target].name==="sap.fe.templates.ObjectPage")){return s;}}if(s==undefined){if(l.length===1){s=l[0].pattern.split('(')[0];return s;}}}R=function(i){var j=i.getParameters().arguments,T="",k,D;e.fireOnAfterNavigation();var N=c.getRootControl();if(!n&&N&&N.getMetadata().getName()==="sap.m.NavContainer"){N.attachAfterNavigate(function(){N.setBusy(false);});n=true;}if(Object.keys(j).length>0){T=i.getParameters().config.pattern;T=T.replace(":?query:","");for(var p in j){k=j[p];if(k==='...'){D=true;t=true;}T=T.replace('{'+p+'}',k);}T=T&&'/'+T;}e._bindTargetPage(N,T,D);};if(h){if(S.preferredMode&&S.preferredMode[0]==='create'){if(s){P=s+'(...)';}else{b.error('Cannot handle this App');}H.getInstance().replaceHash(P);r.attachRouteMatched(R);r.initialize();}else{m.getMetaModel().requestObject("/$EntityContainer/"+s+"/$Type/").then(function(j){var T=j["$Key"];if(S&&T&&S[T[0]]){P=s+"(";if(T.length===1){P=(j[T[0]].$Type==="Edm.String")?P+"'"+S[T[0]][0]+"'":P+S[T[0]][0];}else{for(var i=0;i<T.length;i++){if(S[T[i]]){if(i!==T.length-1){P=(j[T[i]].$Type==="Edm.String")?P+T[i]+"='"+S[T[i]][0]+"',":P+T[i]+"="+S[T[i]][0]+",";}else{P=(j[T[i]].$Type==="Edm.String")?P+T[i]+"='"+S[T[i]][0]+"'":P+T[i]+"="+S[T[i]][0];}}else{P=undefined;break;}}}if(P){P=P+")";H.getInstance().replaceHash(P);}}r.attachRouteMatched(R);r.initialize();}).catch(function(i){b.Error("Metadata not loaded");});}}else{r.attachRouteMatched(R);r.initialize();}},_bindTargetPage:function(n,T,D,N){var c=n.getCurrentPage(),O=(c.getComponentInstance().onBeforeBinding||Promise.resolve).bind(c.getComponentInstance()),f=(c.getComponentInstance().onAfterBinding||Promise.resolve).bind(c.getComponentInstance()),B,s;if(D){O(null,{editable:t});if(d||!A){if(c.getMetadata().getName()==="sap.ui.core.ComponentContainer"&&c.getComponentInstance().createDeferredContext){c.getComponentInstance().createDeferredContext(T);}}A=null;d=false;c.setBindingContext(null);return false;}if(!N){B=c.getBindingContext();s=B&&B.getPath();}if(N||s!==T){if(T||N){if(!u||u.getBinding().isA('sap.ui.model.odata.v4.ODataListBinding')){var h=c.getModel().bindContext(T,undefined,{$$patchWithoutSideEffects:true,$$groupId:'$auto'});u=h.getBoundContext();}B=u;O(B,{editable:t}).then(function(){c.setBindingContext(B);f(B);});u=null;}else if(T===""){O(null).then(function(){f(null);});}}else if(Object.keys(sap.fe.controllerextensions.Routing.mAppDirtyState).length>0){B.refresh();}},attachOnAfterNavigation:function(h){o.push(h);},detachOnAfterNavigation:function(h){for(var i=0;i<o.length;i++){if(o[i]===h){o.splice(i,1);}}},fireOnAfterNavigation:function(){for(var i=0;i<o.length;i++){o[i]();}o=[];},_getOutbounds:function(){if(!this.outbounds){if(!this.manifest){this.manifest=this._getOwnerComponent().getMetadata().getManifest();}this.outbounds=this.manifest["sap.app"]&&this.manifest["sap.app"].crossNavigation&&this.manifest["sap.app"].crossNavigation.outbounds;}return this.outbounds;},_getOwnerComponent:function(){return this.base.getView().getController().getOwnerComponent();}});sap.fe.controllerextensions.Routing.mAppDirtyState={};return E;});
