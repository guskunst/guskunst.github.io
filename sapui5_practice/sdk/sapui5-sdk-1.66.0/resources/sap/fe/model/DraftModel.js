/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/ODataListBinding","sap/ui/model/odata/v4/Context","sap/ui/model/Filter","sap/ui/base/ManagedObject","sap/ui/model/ChangeReason","sap/ui/model/resource/ResourceModel","sap/fe/core/internal/testableHelper","sap/ui/model/odata/v4/ODataContextBinding","sap/base/Log"],function(J,O,C,F,M,a,R,t,b,L){"use strict";var c="_$DraftModel";var A=false;var d=/( and )?\(*IsActiveEntity eq.*$/g;var p={};t.testableStatic(function(){A=true;},"addPrivateDataToModel");function s(y,K,z){var B=typeof y==="string"?y:y.getId(),P=p[B]=p[B]||{};P[K]=z;if(A&&!y[c]){y[c]=P;}}function g(y,K){var z=typeof y==="string"?y:y.getId();return p[z]&&p[z][K];}var E={ALL:"0",UNCHANGED:"1",OWN_DRAFT:"2",LOCKED:"3",UNSAVED_CHANGES:"4"};t.testableStatic(E,"EDITSTATE");function e(y){var z,B,G;if(!y.getObject()){z=y.getBinding().getDependentBindings();B=z&&z[0];if(B&&B.getPath()===''){G=B.getBoundContext();if(G.getObject()){return G;}}}return y;}function f(y){var z="";switch(y){case E.UNCHANGED:z="(IsActiveEntity eq true and HasDraftEntity eq false)";break;case E.OWN_DRAFT:z="(IsActiveEntity eq false)";break;case E.LOCKED:z="(IsActiveEntity eq true and SiblingEntity/IsActiveEntity eq null and DraftAdministrativeData/InProcessByUser ne '')";break;case E.UNSAVED_CHANGES:z="(IsActiveEntity eq true and SiblingEntity/IsActiveEntity eq null and DraftAdministrativeData/InProcessByUser eq '')";break;default:z="(IsActiveEntity eq false or SiblingEntity/IsActiveEntity eq null)";break;}return z;}t.testableStatic(f,"getFilterForEditState");function h(y){var z=y.getMetaModel(),B=g(y,"aEntitySets"),G=B?Promise.resolve(B):z&&z.requestObject("/").then(function(H){var P=[];Object.keys(H).forEach(function(I){var K=H[I],N;if(K.$kind==="EntitySet"){N=z.requestObject("/"+I+"@");P.push(N.then(function(Q){var S={};S["@"]=Q;S["@sapui.name"]=I;return S;}));}});return Promise.all(P);});return G;}function i(y,z,B){var G=y.getModel();B=B||{$$inheritExpandSelect:false};return G.bindContext(z+"(...)",y,B);}function j(){var y=e(this);if(!y.getProperty("IsActiveEntity")){var z=i(this,arguments[0]);return z.execute().then(function(B){return B;});}else{throw new Error("The activation action cannot be executed on an active document");}}function k(y){var z=e(this);if(!z.getProperty("IsActiveEntity")){var B=i(this,arguments[0]);y=arguments[1];if(typeof y==="undefined"){y="";}B.setParameter("SideEffectsQualifier",y);return B.execute().then(function(){return B;});}else{throw new Error("The preparation action cannot be executed on an active document");}}function l(){var y=e(this);if(!y.getProperty("IsActiveEntity")){var z=i(this,arguments[0]);return z.execute().then(function(){return z;});}else{throw new Error("The validation function cannot be executed on an active document");}}function m(y){var z=e(this);if(z.getProperty("IsActiveEntity")){var B=i(this,arguments[0]);y=arguments[1];B.setParameter("PreserveChanges",y);return B.execute().then(function(G){return G;});}else{throw new Error("The edit action cannot be executed on a draft document");}}var o={"ActivationAction":j,"PreparationAction":k,"ValidationFunction":l,"EditAction":m};function n(y,z){var B=z["@"]["@com.sap.vocabularies.Common.v1.DraftRoot"]||z["@"]["@com.sap.vocabularies.Common.v1.DraftNode"];Object.keys(B).forEach(function(G){var H=B[G];if(o[G]){y["executeDraft"+G]=o[G].bind(y,H);}});}function q(y){return h(y).then(function(z){var B=z.filter(function(H){var I=H["@"]||{};return I.hasOwnProperty("@com.sap.vocabularies.Common.v1.DraftRoot")||I.hasOwnProperty("@com.sap.vocabularies.Common.v1.DraftNode");}),G=Array.isArray(B)&&B.length>0;if(G){s(y,"aEntitySets",z);s(y,"aDraftEntitySets",B);}return G;});}function r(y,z){var B=f(y,""),G,H;if(z){G=z.match(d);if(Array.isArray(G)&&G[0]){H=G[0];z=z.replace(H,"");z=z.substr(1).slice(0,-1);}}if(z){z="("+z+") and "+B;}else{z=B;}return z;}function _(y){if(g(y,"bUpgraded")){L.warning("Model was already upgraded to DraftModel");return;}var z={},B={},G=-1,H=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),I={"editStates":[{id:E.ALL,name:H.getText("SAPFE_DRAFT_ALL_FILTER")},{id:E.UNCHANGED,name:H.getText("SAPFE_DRAFT_UNCHANGED_FILTER")},{id:E.OWN_DRAFT,name:H.getText("SAPFE_DRAFT_OWN_DRAFT_FILTER")},{id:E.LOCKED,name:H.getText("SAPFE_DRAFT_LOCKED_FILTER")},{id:E.UNSAVED_CHANGES,name:H.getText("SAPFE_DRAFT_UNSAVED_CHANGES_FILTER")}],"entitySets":{}},K,N=g(y,"aDraftEntitySets");s(y,"mListBindings",B);t.testableStatic(function(y){return g(y,"mListBindings");},"getOverwrittenListBindings");N.forEach(function(Q){I.entitySets[Q["@sapui.name"]]={editState:"0"};});K=new J(I);s(y,"oDraftAccessModel",K);y.getDraftAccessModel=w;K.attachPropertyChange(function(Q){var S=Q.getParameters(),T=S&&(S.path.indexOf("/entitySets")===0?S.path.split("/")[2]:false);if(T){T="/"+T;Object.keys(B).forEach(function(U){var V=B[U],W=V.mParameters,X="",Y="",Z=[];if(V instanceof O&&V.getPath()===T){X=W["$filter"];W["$filter"]=r(S.value,X);V.applyParameters(W);V.reset(sap.ui.model.ChangeReason.Filter);}});}});z.bindList=y.bindList;y.bindList=function(Q,S,T,U,V){var W=K.getObject("/entitySets"+Q),X,Y;if(W){var Z="";V=V||{};Z=V.$expand;if(Z){if(Z.indexOf("DraftAdministrativeData")<0){Z+=",DraftAdministrativeData";}}else{Z="DraftAdministrativeData";}V.$expand=Z;V.$filter=r(W.editState,V.$filter);}arguments[4]=V;X=z.bindList.apply(this,arguments);if(W){Y=X.changeParameters;X.changeParameters=function(V){var W=K.getObject("/entitySets"+Q);V.$filter=r(W.editState,V.$filter);return Y.call(this,V);};B[++G]=X;X.destroy=(function($){return function(){delete B[$];return O.prototype.destroy.apply(this,arguments);};})(G);z.bindProperty=z.bindProperty||y.bindProperty.bind(y);y.bindProperty=function(Q,S,V){if(Q.indexOf(":$count")>-1){var $=Q.split(":$")[0];return z.bindProperty("$count",y.mNamedBindings[$].getHeaderContext(),V);}return z.bindProperty.apply(this,arguments);};}return X;};function P(Q){var S=false,T=Q.getPath();if(g(y,"bUpgraded")&&T){N.forEach(function(U){var V=!S&&T.indexOf(U["@sapui.name"])===1;if(V){S=true;n(Q,U);}});}return Q;}z.create=C.create;C.create=function(y,Q,S,T,U){return P(z.create.apply(null,arguments));};z.createReturnValueContext=C.createReturnValueContext;C.createReturnValueContext=function(y,Q,S){return P(z.createReturnValueContext.apply(null,arguments));};z.modelDestroy=y.destroy;y.destroy=function(){delete p[this.getId()];return z.modelDestroy.apply(this,arguments);};s(y,"bUpgraded",true);}function u(y){return q(y).then(function(z){if(z){_(y);}else{throw new Error("The model is not draft enabled");}});}function v(y){return q(y).then(function(z){if(z){_(y);}return z;});}function w(){return g(this,"oDraftAccessModel");}var x={};var D={upgrade:u,upgradeOnDemand:v,isDraftModel:q,EDITSTATE:E};return D;},true);
