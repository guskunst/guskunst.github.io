/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["jquery.sap.global","sap/ovp/cards/CommonUtils","sap/ovp/cards/SettingsUtils","sap/ui/dt/plugin/ElementMover","sap/ui/dt/OverlayRegistry",'sap/ui/dt/OverlayUtil','sap/ui/rta/plugin/Plugin','sap/ui/rta/util/BindingsExtractor','sap/ui/dt/MetadataPropagationUtil','sap/ui/rta/Utils',"sap/ovp/app/resources","sap/ovp/app/OVPUtils"],function(q,C,S,E,O,a,P,B,M,U,b,c){"use strict";var A=C.getApp();var i=false;var _=function(){var u="https://"+window.location.host+"/sap/opu/odata/SSB/SMART_BUSINESS_DESIGNTIME_SRV/KPIs";q.ajax({type:"GET",url:u,dataType:"json",async:false,headers:"",success:function(m,t,n){var D={'d':{'results':[]}};D.d.results=m.d.results.filter(function(K){return!!K.ModelURI;});i=(D.d.results.length>0);if(i){var p=new sap.ui.model.json.JSONModel();p.setData(D);A.getView().setModel(p,"JSONModelForSSB");}},error:function(m){q.sap.log.error(m);}});};_();var e=new E(),d=function(m){m.setTargetZone(false);},f=function(m){m.setTargetZone(true);},g=function(t){var m=t.getAggregationOverlays();var p=m.filter(function(n){return n.isTargetZone();});if(p.length>0){return p[0];}else{return null;}},h=function(t){var m=e.getMovedOverlay();if(!m){return false;}var r=false;if(!(t.getElement()===m.getElement())){var T=g(t);if(T){r=true;}else if(a.isInTargetZoneAggregation(t)){r=true;}}if(r){m.setSelected(true);setTimeout(function(){m.focus();},0);}return r;},j=function(m,s){var n=m.getAggregationOverlays();n.forEach(function(p){s(p);});},k=function(s,m){var n=O.getOverlay(s),p=n.getParentElementOverlay(),r=a.findAllSiblingOverlaysInContainer(n,p);r.forEach(function(t){j(t,m);});};var l=E.prototype.checkTargetZone;E.prototype.checkTargetZone=function(m,n,p){var r=n?n:this.getMovedOverlay();var t=l.apply(this,arguments);if(!t){return false;}var s=r.getElement();var T=m.getParent();var u=r.getRelevantContainer();var v=T.getElement();var w=m.getDesignTimeMetadata();var x=M.getRelevantContainerForPropagation(w.getData(),s);x=x?x:v;if(!u||!x||!P.prototype.hasStableId(T)||u!==x){return false;}if(r.getParent().getElement()!==v){var y=B.getBindings(s,s.getModel());if(Object.keys(y).length>0&&s.getBindingContext()&&v.getBindingContext()){var z=U.getEntityTypeByPath(s.getModel(),s.getBindingContext().getPath());var D=U.getEntityTypeByPath(v.getModel(),v.getBindingContext().getPath());if(!(z===D)){return false;}}}return true;};E.prototype.deactivateAllTargetZones=function(s){k(s,d);};E.prototype.activateAllValidTargetZones=function(s){k(s,f);};var o={name:{singular:b.getText("Card"),plural:b.getText("Cards")},actions:{remove:{name:b.getText("OVP_KEYUSER_MENU_HIDE_CARD"),changeType:"hideCardContainer",changeOnRelevantContainer:true},reveal:{changeType:"unhideCardContainer",changeOnRelevantContainer:true,getLabel:function(m){var s=this._getCardId(m.getId()),n=this._getCardFromManifest(s);if(n){var p=n.settings;if(p.title){return p.title;}else if(p.category){return(p.category);}else if(p.subTitle){return p.subTitle;}return n.cardId;}else{q.sap.log.error("Card id "+s+" is not present in the manifest");return"";}}.bind(A)}}};var L=C._getLayer();o.actions["settings"]=function(m){if(!m.getComponentInstance()){return{};}var n=m.getComponentInstance().getComponentData(),p=n.mainComponent,r=p._getCardFromManifest(n.cardId);if(!r||!C.checkIfCardTypeSupported(r.template)){return{};}var s={};if(!L||L===c.Layers.customer){s["EditCard"]={icon:"sap-icon://edit",name:b.getText("OVP_KEYUSER_MENU_EDIT_CARD"),isEnabled:function(t){return true;},changeOnRelevantContainer:true,handler:S.fnEditCardHandler};s["CloneCard"]={icon:"sap-icon://value-help",name:b.getText("OVP_KEYUSER_MENU_CLONE_CARD"),isEnabled:function(t){return true;},handler:S.fnCloneCardHandler};s["Cut"]={icon:"sap-icon://scissors",name:b.getText("OVP_KEYUSER_MENU_CUT_CARD"),isEnabled:function(t){return true;},changeOnRelevantContainer:true,handler:function(t,G){var u=O.getOverlay(t),v=e.getMovedOverlay();if(v){v.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(t);}e.setMovedOverlay(u);u.addStyleClass("sapUiDtOverlayCutted");e.activateAllValidTargetZones(t);return Promise.resolve([]).then(function(){return[];});}};s["Paste"]={icon:"sap-icon://paste",name:b.getText("OVP_KEYUSER_MENU_PASTE_CARD"),isEnabled:function(t){var u=O.getOverlay(t),T=g(u);return!!((T)||(a.isInTargetZoneAggregation(u)));},changeOnRelevantContainer:true,handler:function(t,G){var u=O.getOverlay(t),v=e.getMovedOverlay();if(v){var w=v.getElement(),T=u.getElement(),x=a.getParentInformation(v),y=a.getParentInformation(u),z=t.getComponentInstance().getComponentData().mainComponent,D=z.getLayout(),F=z.getUIModel(),H={},I={},J=[];if(F.getProperty('/containerLayout')==='resizable'){var K=D.getDashboardLayoutModel(),N=z._getCardId(w.getId()),Q=z._getCardId(t.getId()),R=K.getCardById(N),V=K.getCardById(Q),W=K.getColCount(),X='C'+W,Y=[];H.cardId=N;H.dashboardLayout={};H.dashboardLayout[X]={row:V.dashboardLayout.row,oldRow:R.dashboardLayout.row,column:V.dashboardLayout.column,oldColumn:R.dashboardLayout.column};if(V.dashboardLayout.column+R.dashboardLayout.colSpan>W+1){H.dashboardLayout[X].colSpan=V.dashboardLayout.colSpan;H.dashboardLayout[X].oldColSpan=R.dashboardLayout.colSpan;H.dashboardLayout[X].rowSpan=R.dashboardLayout.rowSpan;H.dashboardLayout[X].oldRowSpan=R.dashboardLayout.rowSpan;}J.push({selectorControl:t.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:H}});J.push({selectorControl:t.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:H}});K._arrangeCards(R,{row:V.dashboardLayout.row,column:V.dashboardLayout.column},'drag',Y);K._removeSpaceBeforeCard(Y);Y.forEach(function($){var a1={};a1.dashboardLayout={};a1.cardId=$.content.cardId;a1.dashboardLayout[X]=$.content.dashboardLayout;J.push({selectorControl:t.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:a1}});});}else{var Z=y.parent.getContent().filter(function(r){return r.getVisible();});H={cardId:z._getCardId(w.getId()),position:Z.indexOf(T),oldPosition:Z.indexOf(w)};J.push({selectorControl:t.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"position",content:H}});I={cardId:z._getCardId(w.getId()),position:y.index,oldPosition:x.index};J.push({selectorControl:t.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:I}});}}h(u);if(v){v.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(t);return Promise.resolve(J).then(function($){return $;});}}};s["AddStaticLinkListCard"]={icon:"sap-icon://form",name:b.getText("OVP_KEYUSER_MENU_CREATE_LINK_LIST_CARD"),isEnabled:function(t){return true;},handler:S.fnAddStaticLinkListCardHandler};if(i){s["AddKPICard"]={icon:"sap-icon://kpi-corporate-performance",name:b.getText("OVP_KEYUSER_MENU_ADD_KPI_CARD"),isEnabled:function(t){return true;},handler:S.fnAddKPICardHandler};}}else if(L&&(L===c.Layers.vendor||L===c.Layers.customer_base)){s["AddCard"]={icon:"sap-icon://add",name:b.getText("OVP_KEYUSER_MENU_AddCard"),isEnabled:function(t){return true;},handler:S.fnAddNewCardHandler};}s["RemoveCard"]={icon:"sap-icon://delete",name:b.getText("OVP_KEYUSER_MENU_REMOVE_CARD"),isEnabled:function(t){var s=t.getComponentInstance().getComponentData().settings;return t.getId().indexOf(C._getLayerNamespace()+".")!==-1&&!s.cloneCard&&!s.newCard;},handler:S.fnRemoveCardHandler};return s;};return o;},true);
