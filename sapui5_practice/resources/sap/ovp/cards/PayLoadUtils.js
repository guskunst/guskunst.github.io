/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(['jquery.sap.global',"sap/ovp/cards/CommonUtils",'sap/ovp/cards/rta/SettingsDialogConstants'],function(q,C,S){"use strict";function g(i,j,k,J){return i+"_sap.ovp.cards."+j+"."+k+"."+J;}function c(V){return{"type":"XTIT","maxLength":40,"value":{"":V}};}function a(i,j,k){var J=i+"["+j+"]";if(k){J+="/"+k;}return J;}function s(j,M){var k=M._getCardsModel();for(var i=0;i<k.length;i++){if(k[i].id===j){return true;}}return false;}function b(i,j,k){var J={"propertyPath":i,"operation":j};if(k){J["propertyValue"]=k;}return J;}function f(j){delete j.id;delete j.dashboardLayout;delete j.settings.baseUrl;delete j.settings.cloneCard;delete j.settings.newCard;delete j["customer.settings"];delete j["customer_base.settings"];delete j["vendor.settings"];if(j.settings["staticContent"]){for(var i=0;i<j.settings["staticContent"].length;i++){delete j.settings["staticContent"][i].id;}}}function d(N,i,O,j){if(O){if(N===C._getLayerNamespace()+".settings"){O[j]={operation:"DELETE"};}}else{if(N===C._getLayerNamespace()+".settings"){P.aEntityPropertyChange.push(b(i,"UPSERT",{operation:"DELETE"}));}else{P.aEntityPropertyChange.push(b(i,"DELETE"));}}}function e(i){P.aEntityPropertyChange.push(b(C._getLayerNamespace()+".settings","UPSERT",i[C._getLayerNamespace()+".settings"]));}function h(i,j,k,V,O){var J=g(P.sApplicationId,P.sCardId,i,k),K=j+"/"+k;if(!P.oText){P.oText={};}P.oText[J]=c(V);if(O){O[k]="{{"+J+"}}";}else{P.aEntityPropertyChange.push(b(K,"UPSERT","{{"+J+"}}"));}}function l(N,j,T,O){var k=this._oCardManifestSettings,J=this._oOriginalCardManifestSettings;for(var i=0;i<T.length;i++){if((!J[T[i]]&&k[T[i]])||(J[T[i]]&&k[T[i]]&&(J[T[i]]!=k[T[i]]))){if(O){h(N,N,T[i],k[T[i]],j[N]);}else{h(N,N,T[i],k[T[i]]);}j.settings[T[i]]=k[T[i]];}else if(!k[T[i]]&&J[T[i]]){if(O){d(N,N+"/"+T[i],j[N],T[i]);}else{d(N,N+"/"+T[i]);}delete j.settings[T[i]];}}}function m(i,j,V,O){var k=i+"/"+j;if(O){O[j]=V;}else{P.aEntityPropertyChange.push(b(k,"UPSERT",V));}}function n(N,j,k,O){var J=this._oCardManifestSettings,K=this._oOriginalCardManifestSettings;for(var i=0;i<k.length;i++){if((!K[k[i]]&&J[k[i]])||(K[k[i]]&&J[k[i]]&&(K[k[i]]!=J[k[i]]))){if(O){m(N,k[i],J[k[i]],j[N]);}else{m(N,k[i],J[k[i]]);}j.settings[k[i]]=J[k[i]];}else if(!J[k[i]]&&K[k[i]]){if(O){d(N,N+"/"+k[i],j[N],k[i]);}else{d(N,N+"/"+k[i]);}delete j.settings[k[i]];}}}function o(N,i){var j=S.cardSettings["settings"],T=S.cardSettings["text"];if(N===C._getLayerNamespace()+".settings"){if(i[C._getLayerNamespace()+".settings"]){l.bind(this)(N,i,T,false);n.bind(this)(N,i,j,false);}else{i[C._getLayerNamespace()+".settings"]={};l.bind(this)(N,i,T,true);n.bind(this)(N,i,j,true);e(i);}}else{l.bind(this)(N,i,T,false);n.bind(this)(N,i,j,false);}}function p(N,k,J,T,K,O){var L=this._oCardManifestSettings[K];for(var i=0;i<L.length;i++){for(var j=0;j<T.length;j++){if(L[i][T[j]]){var M=a(N+"/"+K,i),Q=N+"."+K+"."+i;if(O){h(Q,M,T[j],L[i][T[j]],k[N][K][i]);}else{h(Q,M,T[j],L[i][T[j]],J[i]);}}}}if(!O){m(N,K,J);}}function r(j,T){var O=S.cardSettingsArrayLevel[T]["onlyTabLevelProps"],k=false;for(var i=0;O&&i<O.length;i++){if(O[i]===j){k=true;break;}}return k;}function t(N,j,T,k,J,O){var K=this._oCardManifestSettings,i;for(i=0;i<T.length;i++){if(K[T[i]]&&!r(T[i],J)){if(O){h(N,N,T[i],K[T[i]],j[N]);}else{h(N,N,T[i],K[T[i]]);}j.settings[T[i]]=K[T[i]];}}for(i=0;i<k.length;i++){if(K[k[i]]&&!r(k[i],J)){if(O){m(N,k[i],K[k[i]],j[N]);}else{m(N,k[i],K[k[i]]);}j.settings[k[i]]=K[k[i]];}}if(O){d(N,N+"/"+J,j[N],J);}else{d(N,N+"/"+J);}delete j.settings[J];}function u(N,j,k,T,J,K,O){var i;for(i=0;i<T.length;i++){if(j[N][T[i]]){if(O){d(N,N+"/"+T[i],j[N],T[i]);}else{d(N,N+"/"+T[i]);}delete j.settings[T[i]];}}for(i=0;i<J.length;i++){if(j[N][J[i]]){if(O){d(N,N+"/"+J[i],j[N],J[i]);}else{d(N,N+"/"+J[i]);}delete j.settings[J[i]];}}p.bind(this)(N,j,k,T,K,O);}function v(j,T){return q.map(q.extend(true,{},j),function(k){var J=S.cardSettingsArrayLevel[T]["text"],i,K=S.cardSettingsArrayLevel[T]["settings"],L={};for(i=0;i<J.length;i++){if(k[J[i]]){L[J[i]]=k[J[i]];}}for(i=0;i<K.length;i++){if(k[K[i]]||k[K[i]]===""){L[K[i]]=k[K[i]];}}return L;});}function w(j,k,T,O){var J=S.cardSettingsArrayLevel[T]["checkForRemoval"],i,K;for(i=0;i<J.length;i++){if(!k[0][J[i]]){K=j.indexOf(J[i]);if(O==="remove"){if(K>-1){j.splice(K,1);}}else if(O==="add"){if(K===-1){j.push(J[i]);}}}}return j;}function x(N,i,j,k,T,O){var J=S.cardSettingsArrayLevel[T]["text"],K=S.cardSettingsArrayLevel[T]["settings"],L=v(j,T);if(j&&k){i.settings[T]=v(j,T);if(N===C._getLayerNamespace()+".settings"){i[N][T]=v(j,T);}p.bind(this)(N,i,L,J,T,O);}else if(!j&&k){t.bind(this)(N,i,J,K,T,O);}else if(j&&!k){i.settings[T]=v(j,T);if(N===C._getLayerNamespace()+".settings"){i[N][T]=v(j,T);}K=w(K,L,T,"remove");u.bind(this)(N,i,L,J,K,T,O);K=w(K,L,T,"add");}}function y(N,i,O){var j=this._oCardManifestSettings["staticContent"],k=this._oOriginalCardManifestSettings["staticContent"],T=this._oCardManifestSettings["tabs"],J=this._oOriginalCardManifestSettings["tabs"];if(j||k){x.bind(this)(N,i,j,k,"staticContent",O);}else if(T||J){x.bind(this)(N,i,T,J,"tabs",O);}}function z(N,i){var j=S.cardSettingsForComplex["settings"],T=S.cardSettingsForComplex["text"];if(N===C._getLayerNamespace()+".settings"){if(i[C._getLayerNamespace()+".settings"]){l.bind(this)(N,i,T,false);n.bind(this)(N,i,j,false);y.bind(this)(N,i,false);}else{i[C._getLayerNamespace()+".settings"]={};l.bind(this)(N,i,T,true);n.bind(this)(N,i,j,true);y.bind(this)(N,i,true);e(i);}}else{l.bind(this)(N,i,T,false);n.bind(this)(N,i,j,false);y.bind(this)(N,i,false);}}function A(N,i){var j=this._oCardManifestSettings["staticContent"],O=this._oOriginalCardManifestSettings["staticContent"],T=this._oCardManifestSettings["tabs"],k=this._oOriginalCardManifestSettings["tabs"];if(j||O||T||k){z.bind(this)(N,i);}else{o.bind(this)(N,i);}}function B(i){var k=S.AllCardSettingsForKPICard,j,J=this._oCardManifestSettings,K={"model":C._getLayerNamespace()+".kpi_card_model_"+i.getTrimmedDataURIName(J.selectedKPI.ODataURI),"template":"sap.ovp.cards.charts.analytical","settings":{}};for(j=0;j<k.length;j++){if(J[k[j]]){K.settings[k[j]]=J[k[j]];}}return K;}function D(){var k=this._oCardManifestSettings["staticContent"],T=S.cardSettingsArrayLevel["staticContent"]["text"],i,j,J=S.cardSettingsArrayLevel["staticContent"]["settings"],K=this._oCardManifestSettings,L=S.cardSettingsForStaticLinkListCard,M={"template":"sap.ovp.cards.linklist","settings":{"staticContent":[]}};for(j=0;j<L.length;j++){if(K[L[j]]){M.settings[L[j]]=K[L[j]];}}for(j=0;j<k.length;j++){M.settings["staticContent"].push({});for(i=0;i<T.length;i++){if(k[j][T[i]]){M.settings["staticContent"][j][T[i]]=k[j][T[i]];}}for(i=0;i<J.length;i++){if(k[j][J[i]]){M.settings["staticContent"][j][J[i]]=k[j][J[i]];}}}return M;}function E(i){var k=S.NewCardSettings,J;var K=this._oCardManifestSettings;k.forEach(function(R){if(R.template===this._oCardManifestSettings.template){J=R;}}.bind(this));var L={"model":this._oCardManifestSettings.model,"template":J.template,"settings":{}};if(!this._oCardManifestSettings["tabs"]){var M=J.cardSettings;for(var j=0;j<M.length;j++){if(K[M[j]]){L.settings[M[j]]=K[M[j]];}}}else{var T=J.text;for(var j=0;j<T.length;j++){if(K[T[j]]){L.settings[T[j]]=K[T[j]];}}var N=this._oCardManifestSettings["tabs"],O=v(N,"tabs"),Q=this._oCardManifestSettings.defaultViewSelected;L.settings["tabs"]=O;L.settings.selectedKey=Q;}return L;}function F(J,K,L){var T,i,j,k,M,N=L.settings["staticContent"],O=L.settings["tabs"];var Q=S.cardSettingsWithText;for(i=0;i<Q.length;i++){var R;if(typeof Q[i]=="string"){if(L.settings[Q[i]]){if(!T){T={};}R=g(J,K,"settings",Q[i]);T[R]=c(L.settings[Q[i]]);L.settings[Q[i]]="{{"+R+"}}";}}else if(typeof Q[i]=="object"){if(Q[i].hasOwnProperty("staticContent")){if(N){for(j=0;j<N.length;j++){for(k=0;k<Q[i]["staticContent"].length;k++){M=Q[i]["staticContent"][k];if(N[j][M]){if(!T){T={};}R=g(J,K,"settings.staticContent."+j,M);T[R]=c(N[j][M]);L.settings["staticContent"][j][M]="{{"+R+"}}";}}}}}else if(Q[i].hasOwnProperty("tabs")){if(O){for(j=0;j<O.length;j++){for(k=0;k<Q[i]["tabs"].length;k++){M=Q[i]["tabs"][k];if(O[j][M]){if(!T){T={};}R=g(J,K,"settings.tabs."+j,M);T[R]=c(O[j][M]);L.settings["tabs"][j][M]="{{"+R+"}}";}}}}}}}return T;}function G(M,j,k){var J=false;for(var i=0;i<k.length;i++){if(k[i].id!==j&&k[i].model===M){J=true;break;}}return J;}function H(i,T,j,O,V){var k={};k['appDescriptorChange']={'parameters':i};if(T){k['appDescriptorChange']['texts']=T;}if(O){k['flexibilityChange']={"newAppDescriptor":j,"oldAppDescriptor":O};}else{k['flexibilityChange']=j;}if(V){k['viewSwitchChange']=V;}return k;}function I(j,k){var J={card:{}},K={},M=j.oMainComponent,L=M._getApplicationId(),N,O={};if(j.bAddNewCardFlag){N=E.bind(this)(j);}else if(j.bNewStaticLinkListCardFlag){N=D.bind(this)(j);}else if(j.bNewKPICardFlag){N=B.bind(this)(j);}var Q=C._getLayerNamespace()+k,i=1;while(s(Q+"_N"+i,M)){i++;}Q=Q+"_N"+i;f(N);K=q.extend(true,{},N);K.id=Q;if(this._oCardManifestSettings.selectedKPI){K.settings.selectedKPI=q.extend(true,{},this._oCardManifestSettings.selectedKPI);}O.oFlexCardManifest=K;O.oText=F(L,Q,N);J.card[Q]=N;O.oParameters=J;return O;}var P={sApplicationId:"",sCardId:"",aEntityPropertyChange:[],oText:undefined,getPayLoadForEditCard:function(i){var j=i.oAppDescriptor.id,k={"cardId":j},T,J,K=q.extend(true,{},i.oAppDescriptor),O=q.extend(true,{},i.oAppDescriptor),N,V;N=(j.lastIndexOf(C._getLayerNamespace()+".",0)===0)?"settings":C._getLayerNamespace()+".settings";P.sApplicationId=i.sApplicationId;P.sCardId=j;P.aEntityPropertyChange=[];P.oText=undefined;A.bind(this)(N,K);T=q.extend(true,{},P.oText);J=P.aEntityPropertyChange;if(J.length===1){k["entityPropertyChange"]=J[0];}else{k["entityPropertyChange"]=J;}if(this._oCardManifestSettings["tabs"]){var L=this._oCardManifestSettings.defaultViewSelected,M=this._oOriginalCardManifestSettings.selectedKey;M=(M&&M>0)?M:1;if(L&&L>0&&L!==M){V={cardId:j,selectedKey:L,oldKey:M};}K.settings.selectedKey=L;}return H(k,T,K,O,V);},getPayLoadForCloneCard:function(j){return new Promise(function(k,J){var K={card:{}},T,L={},M=j.getComponentInstance().getComponentData(),N=M.mainComponent,O=N._getApplicationId(),Q=q.extend(true,{},N._getCardFromManifest(M.cardId));var R=C._getLayerNamespace()+"."+Q.id,i=1;while(s(R+"_C"+i,N)){i++;}R=R+"_C"+i;f(Q);L=q.extend(true,{},Q);L.id=R;L.settings.title=L.settings.title+" "+i;Q.settings.title=Q.settings.title+" "+i;if(Q.settings.defaultSpan&&Q.settings.defaultSpan.showOnlyHeader){Q.settings.defaultSpan.rows=12;}T=F(O,R,Q);K.card[R]=Q;k(H(K,T,L));});},getPayLoadForNewStaticLinkListCard:function(i){var j=I.bind(this)(i,".newStaticLinkListCard");return H(j.oParameters,j.oText,j.oFlexCardManifest);},getPayLoadForNewKPICard:function(i){var j=I.bind(this)(i,".newKPICard"),k=i.oAppComponent,J=j.oFlexCardManifest,K=j.oParameters,L=J.model+"_ANNO",M=i.getDataSources(L),N=true,O=0;if(M[L]){if(M[L].uri!==this._oCardManifestSettings.selectedKPI.ModelURI){while(M[L+"_"+O]){O++;}L=L+"_"+O;}else{N=false;}}var Q=k.getModel(J.model);if(!Q){K["model"]={};K["model"][J.model]={dataSource:J.model,settings:{"defaultCountMode":sap.ui.model.odata.CountMode.None}};K["dataSource"]={};K["dataSource"][J.model]={uri:this._oCardManifestSettings.selectedKPI.ODataURI,type:"OData",settings:{annotations:[L],localUri:""}};if(N){K["dataSource"][L]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};J.settings["sAnnoKey"]=L;}}var R=H(K,j.oText,j.oFlexCardManifest);if(N&&Q){R["addODataAnnotation"]={'parameters':{"dataSourceId":J.model,"annotations":[L],"dataSource":{}}};R["addODataAnnotation"].parameters.dataSource[L]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};R['flexibilityChange'].settings["sAnnoKey"]=L;}return R;},getPayLoadForNewCard:function(i){var j=I.bind(this)(i,".newCard");return H(j.oParameters,j.oText,j.oFlexCardManifest);},getPayLoadForRemoveCard:function(i){var j={},k={},J=i.getComponentInstance().getComponentData(),K=J.cardId;j["cardId"]=K;k.id=i.getId();var L=H(j,null,k),M=J.mainComponent.getUIModel().getProperty("/cards");if(!G(J.modelName,K,M)&&!!J.modelName){L["removeDataSourceChange"]=[];var N=J.appComponent.getMetadata(),O=N.getManifestEntry("sap.ui5").models[J.modelName].dataSource,Q=N.getManifestEntry("sap.app").dataSources[O].settings.annotations;Q.forEach(function(R){L["removeDataSourceChange"].push({'parameters':{"dataSourceId":R}});});}return L;}};return P;},true);
