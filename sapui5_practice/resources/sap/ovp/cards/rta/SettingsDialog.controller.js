sap.ui.define(["jquery.sap.global","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/SettingsUtils","sap/ovp/cards/PayLoadUtils","sap/m/Text","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ovp/cards/rta/SettingsDialogConstants","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/ChangeReason","sap/m/Label","sap/ui/core/Icon","sap/m/Image","sap/m/Column","sap/m/ColumnListItem","sap/m/Table","sap/m/ListMode","sap/m/ToolbarSpacer","sap/m/SearchField","sap/ovp/cards/linklist/AnnotationHelper","sap/ovp/cards/AnnotationHelper","sap/m/Toolbar","sap/ui/core/IconPool","sap/m/IconTabBar","sap/m/IconTabFilter","sap/ui/core/mvc/ViewType","sap/m/Dialog","sap/m/Button","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ovp/app/resources","sap/ovp/app/OVPUtils"],function(q,C,J,O,s,P,T,V,S,M,F,a,b,L,I,c,d,e,f,g,h,k,l,m,n,o,p,r,t,D,B,u,v,w,x){"use strict";return C.extend("sap.ovp.cards.rta.SettingsDialog",{_oCardManifestSettings:{},_aRefreshNotRequired:S._aRefreshNotRequired,_aRefreshRequired:S._aRefreshRequired,_updateManifestProperties:S._updateManifestProperties,aVariantNames:S.aVariantNames,oOvpResourceBundle:w,onInit:function(){s.oSaveButton.attachPress(this.onSaveButtonPress,this);s.oResetButton.attachPress(this.onResetButton,this);s.oMessagePopOverButton.attachPress(this.handleMessagePopoverPress,this);},onAfterRendering:function(){s.dialogBox.addStyleClass("sapOvpSettingsDialogBox");this.setEnablePropertyForResetAndSaveButton(false);this._oCardManifestSettings=this.getView().getModel().getData();this._oOriginalCardManifestSettings=q.extend(true,{},this._oCardManifestSettings);var i=this.getView(),j=i.getModel();if(!this._oCardManifestSettings.addNewCard){var y=i.byId("dialogCard");if(!y.getVisible()){y=i.byId("dialogCardNoPreview");}y.getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";i.byId("dialogCardOverlay").getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";s.settingFormWidth(i,"calc(100% - "+(this._oCardManifestSettings.dialogBoxWidth+1)+"rem)");setTimeout(function(){var y=this.getView().byId("dialogCard");if(y.getVisible()){y.setBusy(false);}}.bind(this),2000);}if(this._oCardManifestSettings.staticContent){this.handleErrorHandling(j,"title","/staticContent");this.handleErrorHandling(j,"targetUri","/staticContent");}if(s.bNewKPICardFlag){var z=i.getModel();var A=i.byId("sapOvpKPITable").getBinding("items").getLength();z.setProperty("/NoOfKPIItem",A);z.setProperty("/NoKPI",A);}},validateInputField:function(E){var i=E.getSource();var j=i.getValue().trim().length;if(!j){i.setValue(i.getValue().trim());}if(!this._oCardManifestSettings.addNewCard){this.updateCard(E);}else{this.setEnablePropertyForResetAndSaveButton(true);}},addView:function(E){this._oCardManifestSettings.showViewSwitchButton=true;this.setEnablePropertyForResetAndSaveButton(true);var i,j=this._oCardManifestSettings,y=this.getView().getModel();if(!j.addNewCard){if(j.dataPointAnnotationPath&&j.dataPoint&&j.dataPoint.length){i=j.dataPoint[0].value;}}if(j.tabs&&j.tabs.length){j.newViewCounter++;if(!j.addNewCard){if(j.template==="sap.ovp.cards.charts.analytical"||j.template==="sap.ovp.cards.charts.smart.chart"){j.tabs.push({chartAnnotationPath:j.chart[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}else{j.tabs.push({annotationPath:j.lineItem[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}}else{j.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}var z=j.tabs.length;j.aViews.push({text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter),key:z,isLaterAddedView:true,isViewResetEnabled:false});if(!j.addNewCard){var A=j.defaultViewSelected;if(j.tabs[A-1].entitySet){j.tabs[z-1].entitySet=j.allEntitySet[0].value;}}this.selectViewSwitch(E,z);}else{j.tabs=[{}];S.tabFields.forEach(function(G){if(!j.addNewCard){if(G!=='entitySet'){j.tabs[0][G]=j[G];}}else{j.tabs[0][G]=j[G];}});j.tabs[0].value=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1");if(!j.addNewCard){if(j.template==="sap.ovp.cards.charts.analytical"||j.template==="sap.ovp.cards.charts.smart.chart"){j.tabs.push({chartAnnotationPath:j.chart[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}else{j.tabs.push({annotationPath:j.lineItem[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}}else{j.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}j.selectedKey=1;j.defaultViewSelected=1;j.aViews=[{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_MAIN_VIEW"),key:0,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1 ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")"),key:1,initialSelectedKey:1,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2"),key:2,isLaterAddedView:true,isViewResetEnabled:false}];j.newViewCounter=2;this.selectViewSwitch(E,1);}this.handleErrorHandling(y,"value","/tabs");},deleteView:function(E){this.setEnablePropertyForResetAndSaveButton(true);var i=this._oCardManifestSettings,j=parseInt(i.selectedKey,10),y=this.getView().getModel();i.tabs.splice(j-1,1);i.aViews.splice(j,1);if(j===i.defaultViewSelected){i.defaultViewSelected=1;i.aViews[j].text=i.aViews[j].text+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}i.aViews.forEach(function(z,A){if(A>=j){z.key--;}});this.handleErrorHandling(y,"value","/tabs");if(i.tabs.length==1){S.tabFields.forEach(function(z){var A=i.tabs[0][z];if(z!=='entitySet'||(z==='entitySet'&&A)){i[z]=A;}});delete i.selectedKey;delete i.defaultViewSelected;delete i.tabs;delete i.aViews;i.aViews=[{text:this.oOvpResourceBundle.getText("OVP_KEYUSER_SHOWS_DIFFERENT_VIEWS"),key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];s.addManifestSettings(i);s.setVisibilityForFormElements(i);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!i.addNewCard){this._fCardWithRefresh();}}else{i.selectedKey=1;this.selectViewSwitch(E,i.selectedKey);}},resetView:function(){var i=this._oCardManifestSettings,j=this.getView().getModel(),y=parseInt(i.selectedKey,10),z=i.aViews[y],A=i.defaultViewSelected;if(!z.isLaterAddedView){var E=i.dataPointAnnotationPath?true:false,G=this._oOriginalCardManifestSettings.dataPointAnnotationPath?true:false;if(y){var H=i.aViews[y].initialSelectedKey;S.tabFields.forEach(function(N){if(N!=="dataPointAnnotationPath"||E){if(this._oOriginalCardManifestSettings.tabs&&this._oOriginalCardManifestSettings.tabs.length){var Q=this._oOriginalCardManifestSettings.tabs[H-1][N];if(N!=='entitySet'||(N==='entitySet'&&Q)){i[N]=Q;i.tabs[y-1][N]=i[N];}}else{if(N!=='entitySet'){i[N]=this._oOriginalCardManifestSettings[N];i.tabs[y-1][N]=i[N];}}}}.bind(this));if(!this._oOriginalCardManifestSettings.tabs||!this._oOriginalCardManifestSettings.tabs.length){i.newViewCounter++;i.tabs[y-1].value=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter);}if(y===i.defaultViewSelected){i.aViews[y].text=i.tabs[y-1].value+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}else{i.aViews[y].text=i.tabs[y-1].value;}}else{S.mainFields.forEach(function(N){i[N]=this._oOriginalCardManifestSettings[N];}.bind(this));if(E!==G){if(G){i.tabs.forEach(function(N){if(N.prevDataPointAnnotationPath){N.dataPointAnnotationPath=N.prevDataPointAnnotationPath;}else{N.dataPointAnnotationPath=i.dataPoint[0].value;}});i.dataPointAnnotationPath=i.tabs[A].dataPointAnnotationPath;}else{i.tabs.forEach(function(N){N.prevDataPointAnnotationPath=N.dataPointAnnotationPath;N.dataPointAnnotationPath=undefined;});}}}}else{var K;if(i.dataPointAnnotationPath){K=i.dataPoint[0].value;}i.newViewCounter++;if(i.template==="sap.ovp.cards.charts.analytical"||i.template==="sap.ovp.cards.charts.smart.chart"){i.tabs[y-1]={chartAnnotationPath:i.chart[0].value,dataPointAnnotationPath:K,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter)};}else{i.tabs[y-1]={annotationPath:i.lineItem[0].value,dataPointAnnotationPath:K,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter)};}if(y===i.defaultViewSelected){i.aViews[y].text=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")");}else{i.aViews[y].text=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter);}S.tabFields.forEach(function(N){var Q=i.tabs[y-1][N];if(N!=='entitySet'||(N==='entitySet'&&Q)){i[N]=Q;}});}this.handleErrorHandling(j,"value","/tabs");i.isViewResetEnabled=false;i.aViews[y].isViewResetEnabled=false;s.addManifestSettings(i);s.setVisibilityForFormElements(i);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!i.addNewCard){this._fCardWithRefresh();}},selectViewSwitch:function(E,i){var j=this._oCardManifestSettings,y=this.getView().getModel();if(!i){i=E.getSource().getSelectedIndex();}if(this.defaultViewSwitch){this.defaultViewSwitch.setEnabled(true);}this.setEnablePropertyForResetAndSaveButton(true);var z=j.metaModel,A,G=j.defaultViewSelected;if(!i){j.selectedKey=i;j.mainViewSelected=true;j.isViewResetEnabled=j.aViews[i].isViewResetEnabled;S.tabFields.forEach(function(N){var Q=j.tabs[G-1][N];if(N!=='entitySet'||(N==='entitySet'&&Q)){j[N]=Q;}});this.handleErrorHandling(y,"value","/tabs");if(j.tabs[G-1].entitySet){A=z.getODataEntitySet(j.tabs[G-1].entitySet);j.entityType=z.getODataEntityType(A.entityType);this.resetSupportingObjectsOnEntitySetChange(j,G);}s.addManifestSettings(j);s.setVisibilityForFormElements(j);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!j.addNewCard){this._fCardWithRefresh();}}else{j.mainViewSelected=false;j.isViewResetEnabled=j.aViews[i].isViewResetEnabled;if(!j.addNewCard){var H=this.getView().byId("dialogCard");if(H.getVisible()){var R=H.getComponentInstance().getRootControl();var K=R.getController();K.changeSelection(i,true,j);this.handleErrorHandling(y,"value","/tabs");if(j.tabs[i-1].entitySet){A=z.getODataEntitySet(j.tabs[i-1].entitySet);j.entityType=z.getODataEntityType(A.entityType);this.resetSupportingObjectsOnEntitySetChange(j,G);}s.addManifestSettings(j);s.setVisibilityForFormElements(j);S.tabFields.forEach(function(N){var Q=j.tabs[i-1][N];if(N!=='entitySet'||(N==='entitySet'&&Q)){j[N]=Q;}});if(!!j.kpiAnnotationPath){this.setAnnotationPathInModel(j,"sapOvpSettingsKPIAnnotation",j.kpiAnnotationPath);}if(!!j.selectionPresentationAnnotationPath){this.setAnnotationPathInModel(j,"sapOvpSettingsFilterAndPresentedBy",j.selectionPresentationAnnotationPath);}this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();}}else{if(!!j.tabs[i-1].entitySet){A=z.getODataEntitySet(j.tabs[i-1].entitySet);j.entityType=z.getODataEntityType(A.entityType);s.addManifestSettings(j);}this.aVariantNames.forEach(function(N){if(this._oCardManifestSettings[N.sPath]){this._oCardManifestSettings[N.sPath]=[];}}.bind(this));this.resetSupportingObjectsOnEntitySetChange(j,G);j.selectedKey=i;S.tabFields.forEach(function(N){var Q=j.tabs[i-1][N];j[N]=Q;});s.setVisibilityForFormElements(j);this.getView().byId("sapOVPEntitySetList").setValue(j.tabs[i-1].entitySet);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh();}}},resetSupportingObjectsOnEntitySetChange:function(i,j){i=s.addSupportingObjects(i);var y=i.defaultViewSelected;if(y){i.aViews[y].text=i.tabs[y-1].value;}i.aViews[j].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";i.defaultViewSelected=j;},setAnnotationPathInModel:function(i,j,y){if(i.entityType[y]){this.setVariant(i,y);}if(j==="sapOvpSettingsKPIAnnotation"){s.addKPINavApplicationName(i);}},setCurrentActivePageForCarouselCard:function(i){var j=this.getView().byId("dialogCard");if(j.getVisible()){var y=j.getComponentInstance(),R=y.getRootControl(),z=R.byId("pictureCarousel");if(z){var A=z.getPages(),E=A[i];z.setActivePage(E);}}},onSelectionChange:function(E){var j=E.getSource(),y=j.getModel(),z=y.getData().staticContent,A=j.getSelectedItem(),G=A.getBindingContext().getObject(),H=j.getModel("visibility");for(var i=0;i<z.length;i++){if(z[i].id===G.id){H.setProperty("/moveToTheTop",!(z.length===1||i===0));H.setProperty("/moveUp",!(z.length===1||i===0));H.setProperty("/moveDown",!(z.length===1||i===(z.length-1)));H.setProperty("/moveToTheBottom",!(z.length===1||i===(z.length-1)));H.setProperty("/delete",true);y.setProperty("/selectedItemIndex",i);H.refresh(true);if(E.getParameter("listItem")){this.setCurrentActivePageForCarouselCard(i);}break;}}},handleErrorForProperty:function(i,j,y){i.firePropertyChange({context:i.getContext(y?y:"/"),path:j,value:i.getProperty(y?(y+"/"+j):j),reason:b.Change});},handleErrorHandling:function(j,y,z){var A=j.getProperty(z);j.firePropertyChange({context:j.getContext(z),path:z+","+y,value:j.getProperty(z),reason:b.Change});for(var i=0;i<A.length;i++){var E=z+"/"+i;j.firePropertyChange({context:j.getContext(E),path:y,value:j.getProperty(E+"/"+y),reason:b.Change});}},setEnablePropertyForResetAndSaveButton:function(E){s.enableResetButton(E);s.enableSaveButton(E);},getValueInRemString:function(i){return i+"rem";},_getSelectedItemIndex:function(i){return i.getProperty("/selectedItemIndex");},_getLastItemIndex:function(i){return this._getStaticContentArray(i).length-1;},_getStaticContentArray:function(i){return i.getProperty("/staticContent");},_setStaticContentArray:function(i,j){i.setProperty("/staticContent",j);},_setSelectedItemAndScrollToElement:function(i,H){var j=this.getView(),y=j.byId("sapOvpStaticLinkListLineItem"),z=j.byId("scrollContainer"),A=j.getModel();this.handleErrorHandling(A,"title","/staticContent");this.handleErrorHandling(A,"targetUri","/staticContent");var E=y.getItems()[i];if(H){this._oList=y;this._oItem=E;this._oScrollContainer=z;var G={onAfterRendering:function(K){this._oList.removeEventDelegate(this._oDelegateOnAfter);this._oScrollContainer.scrollToElement(this._oItem);delete this._oDelegateOnAfter;delete this._oList;delete this._oScrollContainer;delete this._oItem;}};this._oDelegateOnAfter=G;y.addEventDelegate(G,this);}else{z.scrollToElement(E);}y.setSelectedItem(E);y.fireSelectionChange();},_arrangeStaticContent:function(i,j,y){var z=this._getStaticContentArray(i);z.splice(y,0,z.splice(j,1)[0]);this._setStaticContentArray(i,z);this._setSelectedItemAndScrollToElement(y);},getIndexFromIdForStaticLinkList:function(i){var j=i.split("-");return j[j.length-1];},_getImageData:function(){var i=[];i.push({"Name":"AW.png","Image":l.formUrl(this.getView().getModel().getProperty("/baseUrl"),"img/AW.png")});return i;},_getIconData:function(j){var y=o.getIconNames(),z=[];if(j){var N=j.split("://")[1],A=y.indexOf(N);y.splice(A,1);z.push({"Name":N,"Icon":o.getIconURI(N)});}for(var i=0;i<y.length;i++){z.push({"Name":y[i],"Icon":o.getIconURI(y[i])});}return z;},_getLinkListItemId:function(i,j){return i.getProperty("/staticContent/"+j+"/index");},_makeLinkListItemId:function(i){return"linkListItem--"+i;},_makeLinkListItemIndex:function(i){return"Index--"+i;},getIconAndImageDataModel:function(i){var j=this._getIconData(i),y=this._getImageData();return new J({"Icons":j,"Images":y,"NoOfIcons":j.length,"NoOfImages":y.length});},destroyTemplatesAndObjects:function(){var i=this.getView();var j=i.byId("tableFilterImage");if(j){j.destroy();}var y=i.byId("tableFilter");if(y){y.destroy();}var z=i.byId("tableFilterLinks");if(z){z.destroy();}delete this._oEvent;delete this._iCurrentRow;delete this._oModel;delete this._oVisibilityModel;delete this._oIconsDialogContentView;delete this._oLinksDialogContentView;delete this._oLineItemDialogContentView;delete this._oKPIItemDialogContentView;},onExternalUrlChange:function(E){this.setEnablePropertyForResetAndSaveButton(true);},onLinkSourceChange:function(E){var i=E.getSource(),j=i.getModel(),y=i.getModel("visibility"),z=this.getIndexFromIdForStaticLinkList(i.getId()),A=E.getParameter("selectedIndex"),G=y.getProperty("/staticLink"),H=y.getProperty("/links"),K=this._getLinkListItemId(j,parseInt(z,10));if(A===0){G[K]=false;H[K]=true;j.setProperty("/staticContent/"+z+"/targetUri",undefined);}else{G[K]=true;H[K]=false;j.setProperty("/staticContent/"+z+"/semanticObject",undefined);j.setProperty("/staticContent/"+z+"/action",undefined);j.setProperty("/staticContent/"+z+"/targetUri","");}y.setProperty("/staticLink",G);y.setProperty("/links",H);y.refresh(true);j.refresh(true);this.handleErrorForProperty(j,"targetUri","/staticContent/"+z);this.setEnablePropertyForResetAndSaveButton(true);},onRemoveVisualPress:function(E){var i=E.getSource(),j=i.getModel(),y=i.getModel("visibility"),z=this.getIndexFromIdForStaticLinkList(i.getId()),A=this._getLinkListItemId(j,parseInt(z,10)),R=y.getProperty("/removeVisual");R[A]=false;y.setProperty("/removeVisual",R);y.refresh(true);j.setProperty("/staticContent/"+z+"/imageUri",undefined);j.refresh(true);this.updateCard(E,"sapOvpSettingsStaticLinkListRemoveVisual");},createValueHelpDialogForInternalUrl:function(E){var i=E.getSource(),j=i.getModel(),y=i.getModel("staticCardProperties"),z=i.getModel("visibility"),A=this.getIndexFromIdForStaticLinkList(i.getId());this.attachBrowserHeightChangeHandler();this._oEvent=q.extend({},E);this._iCurrentRow=A;this._oModel=j;this._oVisibilityModel=z;var G=new B("linksCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.linksDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_APPLICATION_DIALOG"),buttons:[G]}).addStyleClass("sapOvpSettingsDialogBox");y.setProperty("/densityStyle",this.getDensityStyle());y.setProperty("/NoOfLinks",y.getProperty("/links").length);var H=new sap.ui.view("linksDialogContent",{viewName:"sap.ovp.cards.rta.SelectLinks",type:t.XML,preprocessors:{xml:{bindingContexts:{tableRows:y.createBindingContext("/")},models:{tableRows:y}}}});H.setModel(y);H.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.linksDialog.addContent(H);H.loaded().then(function(K){this._oLinksDialogContentView=K;K.getController().updateLinkPath=function(N){var Q=N.slice(1).split("-"),R=Q[0],U=Q[1];this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/semanticObject",R);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/action",U);this._oModel.refresh(true);this.setEnablePropertyForResetAndSaveButton(true);this.cleanAndCloseDialog(G);}.bind(this);G.attachPress(function(){this.cleanAndCloseDialog(G);}.bind(this));this.linksDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},onChangeVisualPress:function(E){var i=E.getSource(),j=i.getModel(),y=i.getModel("visibility"),z=this.getIndexFromIdForStaticLinkList(i.getId()),A=j.getProperty("/staticContent/"+z+"/imageUri"),N=l.isImageUrlStaticData(A);this.attachBrowserHeightChangeHandler();this._oEvent=q.extend({},E);this._iCurrentRow=z;this._oModel=j;this._oVisibilityModel=y;var G=new B("iconsCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.iconsDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_VISUAL_DIALOG"),buttons:[G]}).addStyleClass("sapOvpSettingsDialogBox");var R=(N)?this.getIconAndImageDataModel():this.getIconAndImageDataModel(A);R.setProperty("/densityStyle",this.getDensityStyle());var H=new sap.ui.view("iconsDialogContent",{viewName:"sap.ovp.cards.rta.SelectIcons",type:t.XML,preprocessors:{xml:{bindingContexts:{tableRows:R.createBindingContext("/")},models:{tableRows:R}}}});R.setProperty("/tableName","IconTable");H.setModel(R);H.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.iconsDialog.addContent(H);H.loaded().then(function(K){this._oIconsDialogContentView=K;K.getController().updateIconPath=function(U){var Q=this._getLinkListItemId(this._oModel,parseInt(this._iCurrentRow,10)),W=this._oVisibilityModel.getProperty("/removeVisual");W[Q]=true;this._oVisibilityModel.setProperty("/removeVisual",W);this._oVisibilityModel.refresh(true);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/imageUri",U);this._oModel.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListChangeVisual");this.cleanAndCloseDialog(G);}.bind(this);G.attachPress(function(){this.cleanAndCloseDialog(G);}.bind(this));this.iconsDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},getDensityStyle:function(){if(!v.support.touch){return"compact";}else{return"cozy";}},cleanAndCloseDialog:function(i){if(this._oIconsDialogContentView){this._oIconsDialogContentView.destroy();}if(this._oLinksDialogContentView){this._oLinksDialogContentView.destroy();}if(this._oLineItemDialogContentView){this._oLineItemDialogContentView.destroy();}if(this._oKPIItemDialogContentView){this._oKPIItemDialogContentView.destroy();}this.destroyTemplatesAndObjects();if(this.iconsDialog){this.iconsDialog.close();}if(this.linksDialog){this.linksDialog.close();}if(this.lineItemDialog){this.lineItemDialog.close();}if(this.KPIItemDialog){this.KPIItemDialog.close();}i.destroy();this.detachBrowserHeightChangeHandler();},attachBrowserHeightChangeHandler:function(){v.resize.attachHandler(this.browserHeightChange,this);},detachBrowserHeightChangeHandler:function(){v.resize.detachHandler(this.browserHeightChange,this);},browserHeightChange:function(i){var j,y,z;if(this.iconsDialog&&this._oIconsDialogContentView){j=this.iconsDialog;y=this._oIconsDialogContentView;z="iconsScrollContainer";}else if(this.linksDialog&&this._oLinksDialogContentView){j=this.linksDialog;y=this._oLinksDialogContentView;z="linksScrollContainer";}else if(this.lineItemDialog&&this._oLineItemDialogContentView){j=this.lineItemDialog;y=this._oLineItemDialogContentView;z="lineItemScrollContainer";}else if(this.KPIItemDialog&&this._oKPIItemDialogContentView){j=this.KPIItemDialog;y=this._oKPIItemDialogContentView;z="KPIItemScrollContainer";}if(j&&y&&z){var A=j.getDomRef(),E=(i?(i.height*93)/100:s.dialogBox.getDomRef().getBoundingClientRect().height),G=A.getBoundingClientRect().height,H=Math.max(E,G)-(u.getPixelPerRem()*9),K=y.byId(z);K.setHeight(H+"px");}},handleMessagePopoverPress:function(E){s.oMessagePopOver.openBy(E.getSource());},onShowMorePress:function(E){var i=E.getSource(),j=i.getModel(),y=i.getModel("visibility"),z=this.getIndexFromIdForStaticLinkList(i.getId()),A=this._getLinkListItemId(j,parseInt(z,10)),G=y.getProperty("/showMore/"+A);if(G){y.setProperty("/showMore/"+A,false);}else{y.setProperty("/showMore/"+A,true);}y.refresh(true);},onPressDelete:function(E){this._oEvent=q.extend({},E);M.confirm(this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_INFORMATION_MESSAGE_INFO"),{actions:[M.Action.OK,M.Action.CANCEL],icon:M.Icon.INFORMATION,title:this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_TITLE_INFO"),initialFocus:M.Action.CANCEL,onClose:function(A){if(A==="OK"){var i=this._oEvent.getSource(),j=i.getModel("visibility"),y=i.getModel(),z=this._getStaticContentArray(y),G=this._getSelectedItemIndex(y),H=this._getLinkListItemId(y,G),K=j.getProperty("/staticLink"),N=j.getProperty("/links"),R=j.getProperty("/removeVisual"),Q=j.getProperty("/showMore");delete K[H];delete N[H];delete R[H];delete Q[H];j.setProperty("/staticLink",K);j.setProperty("/links",N);j.setProperty("/removeVisual",R);j.setProperty("/showMore",Q);z.splice(G,1);this._setStaticContentArray(y,z);y.refresh(true);if(z.length>0){this._setSelectedItemAndScrollToElement(Math.min(parseInt(G,10),z.length-1),true);}if(z.length<=1){j.setProperty("/delete",false);}j.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListDelete");}delete this._oEvent;}.bind(this)});},onPressAdd:function(E){var i=E.getSource(),j=i.getModel("visibility"),y=i.getModel(),z=this._getStaticContentArray(y),A=y.getProperty("/lineItemIdCounter"),G=this._makeLinkListItemId(A+1),H=this._makeLinkListItemIndex(A+1),K=j.getProperty("/staticLink"),N=j.getProperty("/links"),R=j.getProperty("/removeVisual"),Q=j.getProperty("/showMore");y.setProperty("/lineItemIdCounter",A+1);z.unshift({"id":G,"index":H,"title":"Default Title","subTitle":"Default SubTitle","imageUri":"","imageAltText":"","targetUri":"","openInNewWindow":""});K[H]=true;N[H]=false;R[H]=false;Q[H]=false;j.setProperty("/staticLink",K);j.setProperty("/links",N);j.setProperty("/removeVisual",R);j.setProperty("/showMore",Q);j.refresh(true);this._setStaticContentArray(y,z);y.refresh(true);this._setSelectedItemAndScrollToElement(0);this.updateCard(E,"sapOvpSettingsStaticLinkListAdd");},onPressMoveToTheTop:function(E){var i=E.getSource().getModel();this._arrangeStaticContent(i,this._getSelectedItemIndex(i),0);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveUp:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i);this._arrangeStaticContent(i,j,j-1);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveDown:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i);this._arrangeStaticContent(i,j,j+1);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveToTheBottom:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i),y=this._getLastItemIndex(i);this._arrangeStaticContent(i,j,y);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onResetButton:function(){this._oCardManifestSettings=q.extend(true,{},this._oOriginalCardManifestSettings);var i=this.getView().getModel();i.setProperty("/",this._oCardManifestSettings);s.setVisibilityForFormElements(this._oCardManifestSettings);this.getView().getModel("visibility").refresh();if(this._oCardManifestSettings.layoutDetail==="resizable"){if(this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(false);}else if(!this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(true);}}s.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);if(!this._oCardManifestSettings.addNewCard){this._fCardWithRefresh();}},validateComboBox:function(j){var y=s.oMessagePopOver.getModel(),z=y.getProperty("/Messages"),A=y.getProperty("/Counter/All"),E=y.getProperty("/Counter/Error");if(j.addKPIHeaderCheckBox&&!j.dataPointAnnotationPath){var G=w.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT");this.bError=true;var H=true;for(var i=0;i<z.length;i++){if(z[i].fieldName===x.Annotations.dataPoint){H=false;}}if(H){z.push({"type":"Error","title":G,"fieldName":x.Annotations.dataPoint,"counter":E+1});A++;E++;this.getView().byId("sapOvpDataPoint").setValueState("Error");}}else{this.bError=false;for(var i=0;i<z.length;i++){if(z[i].fieldName===x.Annotations.dataPoint){z.splice(i,1);A--;E--;i--;}}this.getView().byId("sapOvpDataPoint").setValueState("None");}y.setProperty("/Messages",z);y.setProperty("/Counter/All",A);y.setProperty("/Counter/Error",E);y.refresh(true);},onSaveButtonPress:function(){if(this._oCardManifestSettings.addNewCard){this.bError=false;this.validateComboBox.bind(this)(this._oCardManifestSettings);}var j=this._oCardManifestSettings.aAllStaticParameters;if(j){var y={};for(var i=0;i<j.length;i++){y[j[i].key]=j[i].value;}this._oCardManifestSettings.staticParameters=y;}if(s.bError||this.bError){s.oMessagePopOverButton.firePress();}else{this.createAndSubmitChange.bind(this)();}},onResizingChange:function(E){var i=E.getParameter("state");this._oCardManifestSettings.stopResizing=!i;this.updateCard(E);},onNumberOfRowsChanged:function(E){var R=+this._oCardManifestSettings.defaultSpan.rows;this._oCardManifestSettings.defaultSpan.rows=R;this._oCardManifestSettings.defaultSpan.showOnlyHeader=(R===0);this._oCardManifestSettings.cardLayout.showOnlyHeader=(R===0);var i=["sap.ovp.cards.list","sap.ovp.cards.table"];if(i.indexOf(this._oCardManifestSettings.template)!==-1){this._oCardManifestSettings.cardLayout.noOfItems=R;}else{this._oCardManifestSettings.cardLayout.rowSpan=R;}this.updateCard(E);},onNumberOfColumnsChanged:function(E){this._oCardManifestSettings.defaultSpan.cols=+this._oCardManifestSettings.defaultSpan.cols;this.updateCard(E);},setBusy:function(i){if(i){this.getView().addStyleClass("dialogContainerOverlay");var j=this.getView().byId("dialogCard");if(j.getVisible()&&j.getComponentInstance()){j.getComponentInstance().getRootControl().setBusy(i);}}else{this.getView().removeStyleClass("dialogContainerOverlay");setTimeout(function(){var j=this.getView().byId("dialogCard");if(j.getVisible()&&j.getComponentInstance()){j.getComponentInstance().getRootControl().setBusy(i);}}.bind(this),2000);}},_fCardWithoutRefresh:function(E,i){var j=this.getView(),y=this._oCardManifestSettings,z=j.byId("dialogCard").getComponentInstance(),R=z.getRootControl(),A=R.getController(),G=A.getCardPropertiesModel(),H,K,N=false,Q;if(y.tabs&&y.tabs.length){N=true;Q=parseInt(y.selectedKey,10);}if(i.formElementId==="sapOvpSettingsLineItemTitle"||i.formElementId==="sapOvpSettingsLineItemSubTitle"){H=R.byId(i.cardElementId+"--"+j.getModel().getProperty("/lineItemId"));}else{H=R.byId(i.cardElementId);if(!H){this._fCardWithRefresh(E,i.cardElementId);}}switch(i.formElementId){case"sapOvpSettingsLineItemTitle":case"sapOvpSettingsLineItemSubTitle":case"sapOvpSettingsTitle":case"sapOvpSettingsValueSelectionInfo":if(H){H.setText(E.getSource().getValue());}break;case"sapOvpSettingsSubTitle":G.setProperty("/subTitle",E.getSource().getValue());A._setSubTitleWithUnitOfMeasure();break;case"sapOvpSettingsViewName":var U=y.viewName;K=j.getModel();H.getItems()[Q-1].setText(U);y.tabs[Q-1].value=U;if(y.defaultViewSelected===Q){U=U+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}y.aViews[Q].text=U;K.refresh();break;case"sapOvpDefaultViewSwitch":if(E.getSource().getState()){var W=y.defaultViewSelected;K=j.getModel();y.defaultViewSelected=Q;y.aViews[W].text=y.tabs[W-1].value;y.aViews[Q].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";K.refresh();this.defaultViewSwitch=E.getSource();this.defaultViewSwitch.setEnabled(false);}break;case"sapOvpSettingsIdentification":if(N){y.tabs[Q-1][i.updateProperty]=y[i.updateProperty];}break;case"sapOvpSettingsKPIHeaderSwitch":var X=j.getModel("visibility"),Y=X.getData();Y.dataPoint=false;Y.valueSelectionInfo=false;if(N){y.tabs.forEach(function($){$.prevDataPointAnnotationPath=$.dataPointAnnotationPath;$.dataPointAnnotationPath=undefined;});}else{var Z=y.dataPointAnnotationPath;if(Z){y.prevDataPointAnnotationPath=Z;}y.dataPointAnnotationPath=undefined;}X.refresh(true);H.destroy();break;default:break;}},_fCardWithRefresh:function(E,i){var j,y,z,A,G,H=this._oCardManifestSettings,K=this.getView(),N=K.byId("dialogCard"),Q=(!N.getComponentInstance())?undefined:N.getComponentInstance().getComponentData(),R=(!Q)?"Dialog":Q.cardId,U=(!Q)?undefined:Q.manifest.cards[R].model,W={cards:{}},X=false,Y;if(H.tabs&&H.tabs.length){X=true;Y=parseInt(H.selectedKey,10);}switch(i){case"subTitleSwitch":z=this.getView();A=z.getModel("visibility");if(E.getSource().getState()){if(X){y=H.defaultViewSelected;H.tabs.forEach(function(e1){j=e1.prevDynamicSubtitleAnnotationPath;if(j){e1.dynamicSubtitleAnnotationPath=j;}else{e1.dynamicSubtitleAnnotationPath=H.dynamicSubTitle[0].value;}});H.dynamicSubtitleAnnotationPath=H.tabs[y-1].dynamicSubtitleAnnotationPath;}else{j=H.prevDynamicSubtitleAnnotationPath;if(j){H.dynamicSubtitleAnnotationPath=j;}else{H.dynamicSubtitleAnnotationPath=H.dynamicSubTitle[0].value;}}K.byId("sapOvpSettingsDynamicSubTitle").setSelectedKey(H.dynamicSubtitleAnnotationPath);}else{if(X){H.tabs.forEach(function(e1){e1.prevDynamicSubtitleAnnotationPath=e1.dynamicSubtitleAnnotationPath;e1.dynamicSubtitleAnnotationPath=undefined;});H.dynamicSubtitleAnnotationPath=undefined;}else{var Z=H.dynamicSubtitleAnnotationPath;if(Z){H.prevDynamicSubtitleAnnotationPath=Z;}H.dynamicSubtitleAnnotationPath=undefined;}}A.setProperty("/subTitle",s.getVisibilityOfElement(H,"subTitle",X));A.setProperty("/dynamicSubTitle",s.getVisibilityOfElement(H,"dynamicSubTitle",X)&&!!H["dynamicSubTitle"]&&!!H["dynamicSubTitle"].length);A.refresh(true);break;case"kpiHeader":z=this.getView();A=z.getModel("visibility");G=A.getData();G.valueSelectionInfo=true;G.dataPoint=true;if(H.tabs&&H.tabs.length){G.dataPoint=s.getVisibilityOfElement(H,"dataPoint",true);}if(!H.valueSelectionInfo){H.valueSelectionInfo=" ";}if(X){y=H.defaultViewSelected;H.tabs.forEach(function(e1){j=e1.prevDataPointAnnotationPath;if(j){e1.dataPointAnnotationPath=j;}else{e1.dataPointAnnotationPath=H.dataPoint[0].value;}});H.dataPointAnnotationPath=H.tabs[y-1].dataPointAnnotationPath;}else{j=H.prevDataPointAnnotationPath;if(j){H.dataPointAnnotationPath=j;}else{H.dataPointAnnotationPath=H.dataPoint[0].value;}}A.refresh(true);break;case"listType":H[i]=(E.getSource().getState())?"extended":"condensed";break;case"listFlavor":H[i]=(E.getSource().getState())?"bar":"";break;case"entitySet":if(X){H.tabs[Y-1][i]=H[i];S.resetTabFields.forEach(function(e1){delete H.tabs[Y-1][e1];delete H[e1];});var $=H.metaModel,_=$.getODataEntitySet(H.tabs[Y-1].entitySet),a1=H.defaultViewSelected;H.entityType=$.getODataEntityType(_.entityType);this.resetSupportingObjectsOnEntitySetChange(H,a1);}break;case"kpiAnnotationPath":if(X){H.tabs[Y-1][i]=H[i];}var b1=K.byId("sapOvpSettingsKPIAnnotation").getSelectedKey();if(H.entityType[b1]){this.setVariant(H,b1);}s.addKPINavApplicationName(H);this.getView().getModel().refresh(true);break;case"selectionPresentationAnnotationPath":if(X){H.tabs[Y-1][i]=H[i];}var b1=K.byId("sapOvpSettingsFilterAndPresentedBy").getSelectedKey();if(H.entityType[b1]){this.setVariant(H,b1);}this.getView().getModel().refresh(true);break;case"listFlavorForLinkList":case"annotationPath":case"chartAnnotationPath":case"presentationAnnotationPath":case"selectionAnnotationPath":case"dynamicSubtitleAnnotationPath":case"dataPointAnnotationPath":if(X){H.tabs[Y-1][i]=H[i];}break;case"noOfRows":case"ovpHeaderTitle":case"add":case"removeVisual":case"changeVisual":case"sort":case"delete":break;default:break;}W.cards[R]={settings:H};if(s.bNewKPICardFlag){W.cards[R].template=H.template;}else{W.cards[R].template=Q.template;}if(s.bNewKPICardFlag){if(U&&K.getModel(U)){K.getModel(U).destroy();K.setModel(null,U);}var c1=this._oCardManifestSettings.selectedKPI,d1=new sap.ui.model.odata.v2.ODataModel(c1.ODataURI,{'annotationURI':c1.ModelURI,'defaultCountMode':sap.ui.model.odata.CountMode.None});U=u._getLayerNamespace()+".kpi_card_model_"+s.getTrimmedDataURIName(c1.ODataURI);K.setModel(d1,U);}if(!!U){W.cards[R].model=U;}if(s.bNewKPICardFlag){d1.getMetaModel().loaded().then(function(){var e1=O.createCardComponent(K,W,"dialogCard");e1.then(function(){K.setBusy(false);this.setBusy(false);}.bind(this)).catch(function(){s.setErrorMessage(W.cards[R].settings,"OVP_KEYUSER_ANNOTATION_FAILURE");s.createErrorCard(K,W,R);});}.bind(this),function(e1){q.sap.log.error(e1);this.setBusy(false);K.setBusy(false);}.bind(this));d1.attachMetadataFailed(function(){s.setErrorMessage(W.cards[R].settings,"OVP_KEYUSER_METADATA_FAILURE");s.createErrorCard(K,W,R);});}else{this.createCard(K,W);}},setVariant:function(i,j){var y=i.entityType[j];var z=y.SelectionVariant&&y.SelectionVariant.Path;if(/^@/.test(z)){z=z.slice(1);}i.selectionAnnotationPath=z;var A;if(j.indexOf(".KPI")!==-1){A=y.Detail&&y.Detail.DefaultPresentationVariant&&y.Detail.DefaultPresentationVariant.Path;}else if(j.indexOf(".SelectionPresentationVariant")!==-1){A=y.PresentationVariant&&y.PresentationVariant.Path;}if(/^@/.test(A)){A=A.slice(1);}i.presentationAnnotationPath=A;var E=i.entityType[i.presentationAnnotationPath]&&i.entityType[i.presentationAnnotationPath].Visualizations;for(var G=0;G<E.length;G++){var H=E[G].AnnotationPath;if(H){if(/^@/.test(H)){H=H.slice(1);}if(/.Chart/.test(H)){i.chartAnnotationPath=H;break;}}}},createCard:function(i,j){this.setBusy(true);var y=O.createCardComponent(i,j,"dialogCard");y.then(function(){this.setBusy(false);var z=this.getView().byId("sapOvpStaticLinkListLineItem");if(z){var A=z.getSelectedItem();if(A){var E=A.getId(),G=this.getIndexFromIdForStaticLinkList(E);this.setCurrentActivePageForCarouselCard(G);}}}.bind(this));y.catch(function(){this.setBusy(false);}.bind(this));},updateCard:function(E,y){var z=this._oCardManifestSettings,A=this.getView().byId("dialogCard");this.setEnablePropertyForResetAndSaveButton(true);if(A.getVisible()){if(z.tabs&&z.tabs.length){var G=parseInt(z.selectedKey,10);z.isViewResetEnabled=true;z.aViews[G].isViewResetEnabled=true;}var H=E.getSource(),K=(y)?y:H.getId(),N=false;if(K.indexOf("sapOvpStaticLinkListLineItem")!==-1){var Q=H.getModel(),R=Q.getData().staticContent,U=this.getIndexFromIdForStaticLinkList(K);this.setCurrentActivePageForCarouselCard(U);Q.setProperty("/lineItemId",R[U].id);if(K.indexOf("sapOvpSettingsLineItemTitle")!==-1){K="sapOvpSettingsLineItemTitle";}else if(K.indexOf("sapOvpSettingsLineItemSubTitle")!==-1){K="sapOvpSettingsLineItemSubTitle";}}for(var i=0;i<this._aRefreshNotRequired.length;i++){if(K.indexOf(this._aRefreshNotRequired[i].formElementId)>-1){if(this._aRefreshNotRequired[i].isKpiSwitch&&E.getSource().getState()){break;}this._fCardWithoutRefresh(E,this._aRefreshNotRequired[i]);N=true;break;}}if(!N){for(var j=0;j<this._aRefreshRequired.length;j++){if(K.indexOf(this._aRefreshRequired[j].formElementId)>-1){this.setBusy(true);this._fCardWithRefresh(E,this._aRefreshRequired[j].updateProperty);break;}}}}},onExit:function(){s.oSaveButton.detachPress(this.onSaveButtonPress,this);s.oResetButton.detachPress(this.onResetButton,this);s.oMessagePopOverButton.detachPress(this.handleMessagePopoverPress,this);},getListItems:function(){var i=[],j=this._oCardManifestSettings,y=this.getView(),z=y.byId("dialogCard"),A=z.getComponentInstance().getComponentData(),E=j.entityType.$path+"/"+j.annotationPath,G=A.model.getMetaModel(),H=G.getContext(G.resolve(E,this.oView.getBindingContext()));var K=2,N=1,Q=0;if(j.listFlavor==="bar"){K=1;N=2;}if(j.listType&&j.listType.toLowerCase()==="extended"){K=6;N=3;Q=3;if(j.listFlavor==="bar"){K=5;}}else if(j.contentFragment==="sap.ovp.cards.table.Table"){K=3;N=1;Q=1;}j.lineItem.forEach(function(R){var U=m.getSortedDataPoints(H,R.fields),W=m.getSortedDataFields(H,R.fields),X=[],Y=[],Z=s.getQualifier(R.value);U.forEach(function(b1){if(b1.Title){Y.push(s.checkForEmptyString(b1.Title.String,""));}else{Y.push(w.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[Z]));}});W.forEach(function(b1){if(b1.Label){X.push(b1.Label.String);}else{X.push(w.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[Z]));}});var $=Math.min(Y.length,N),_=Math.min(Q,$),a1=X.slice(0,K-_).concat(Y.slice(0,$));a1.map(function(b1){return b1.charAt(0).toUpperCase()+b1.substr(1);});i.push({Value:R.value,Label:R.name,VisibleFields:a1.toString()});});return i;},onSearch:function(E){var i=this.getView(),j=i.getModel(),y;this._filterTable(E,["GroupTitle","KPITitle","GroupID","KPIID","KPIQualifier"],"sapOvpKPITable");y=i.byId("sapOvpKPITable").getBinding("items").getLength();j.setProperty("/NoOfKPIItem",y);j.refresh(true);},_filterTable:function(E,j,y){var Q=E.getParameter("query"),G=null,z=[];for(var i=0;i<j.length;i++){z.push(new F(j[i],a.Contains,Q));}if(Q){G=new F(z,false);}this.getView().byId(y).getBinding("items").filter(G,"Application");},onItemPress:function(E){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);var i=E.getSource(),j=i.getBindingContext(),K=j.getObject();this.getView().byId("sapOvpSettingsTitle").setValue(K.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(K.KPITitle);this.onKPIUpdate(K);this.updateCard(E,"sapOvpSettingsNewKPICard");},onKPIUpdate:function(K){this._oCardManifestSettings.entitySet=K.ODataEntityset;this._oCardManifestSettings.kpiAnnotationPath="com.sap.vocabularies.UI.v1.KPI#"+K.KPIQualifier;this._oCardManifestSettings.title=K.GroupTitle;this._oCardManifestSettings.subTitle=K.KPITitle;this._oCardManifestSettings.template="sap.ovp.cards.charts.analytical";this._oCardManifestSettings.selectedKPI=K;},onSeePress:function(){this.attachBrowserHeightChangeHandler();var i=new B("KPIItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.KPIItemDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_KPI_DIALOG_TITLE"),buttons:[i]}).addStyleClass("sapOvpSettingsDialogBox");var R=new J({"KPIItem":this._oCardManifestSettings.KPIData});R.setProperty("/densityStyle",this.getDensityStyle());R.setProperty("/NoOfKPIItem",R.getProperty("/KPIItem").length);var K=new sap.ui.view("KPIItemDialogContent",{viewName:"sap.ovp.cards.rta.SelectKPI",type:t.XML,preprocessors:{xml:{bindingContexts:{tableRows:R.createBindingContext("/")},models:{tableRows:R}}}});K.setModel(R);K.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.KPIItemDialog.addContent(K);K.loaded().then(function(j){this._oKPIItemDialogContentView=j;j.getController().updateKPIItemPath=function(y,E){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);this.getView().byId("sapOvpSettingsTitle").setValue(y.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(y.KPITitle);this.onKPIUpdate(y);this.updateCard(E,"sapOvpSettingsNewKPICard");this.cleanAndCloseDialog(i);}.bind(this);i.attachPress(function(){this.cleanAndCloseDialog(i);}.bind(this));this.KPIItemDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},openLineItemValueHelpDialog:function(E){this.attachBrowserHeightChangeHandler();this._oEvent=q.extend({},E);var i=new B("lineItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.lineItemDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LINEITEM_ANNO"),buttons:[i]}).addStyleClass("sapOvpSettingsDialogBox");var R=new J({"lineItem":this.getListItems()});R.setProperty("/densityStyle",this.getDensityStyle());R.setProperty("/NoOfLineItem",R.getProperty("/lineItem").length);var j=new sap.ui.view("lineItemDialogContent",{viewName:"sap.ovp.cards.rta.SelectLineItem",type:t.XML,preprocessors:{xml:{bindingContexts:{tableRows:R.createBindingContext("/")},models:{tableRows:R}}}});j.setModel(R);j.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.lineItemDialog.addContent(j);j.loaded().then(function(y){this._oLineItemDialogContentView=y;y.getController().updateLineItemPath=function(z){var A=z.Value,G=this._oCardManifestSettings,H;if(G.tabs&&G.tabs.length){H=parseInt(G.selectedKey,10);}G.lineItemQualifier=s.getQualifier(A);G.annotationPath=A;if(G.tabs&&G.tabs.length){G.tabs[H-1].annotationPath=G.annotationPath;}this.getView().byId("sapOvpSettingsLineItem").setValue(z.Label);this._fCardWithRefresh(this._oEvent,"annotationPath");this.setEnablePropertyForResetAndSaveButton(true);if(G.tabs&&G.tabs.length){G.isViewResetEnabled=true;G.aViews[H].isViewResetEnabled=true;}this.cleanAndCloseDialog(i);}.bind(this);i.attachPress(function(){this.cleanAndCloseDialog(i);}.bind(this));this.lineItemDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},createAndSubmitChange:function(){var i;if(s.bNewStaticLinkListCardFlag){i=P.getPayLoadForNewStaticLinkListCard.bind(this)(s);}else if(s.bNewKPICardFlag){i=P.getPayLoadForNewKPICard.bind(this)(s);}else if(s.bAddNewCardFlag){i=P.getPayLoadForNewCard.bind(this)(s);}else{i=P.getPayLoadForEditCard.bind(this)(s);}this.settingsResolve(i);s.dialogBox.close();},setMandatoryFieldState:function(i,j){j.setProperty("/dataPoint",i);j.setProperty("/valueSelectionInfo",i);j.setProperty("/requiredSubTitle",i);},EnableKPIHeaderFields:function(i){var j=this.getView().getModel("visibility");if(!i){this.setMandatoryFieldState(false,j);j.setProperty("/subTitleValueState","None");j.setProperty("/subTitleValueStateText","");}else{this.setMandatoryFieldState(true,j);if(this.getView().byId("sapOvpCardSubTitle").getValue()===""){j.setProperty("/subTitleValueState","Error");j.setProperty("/subTitleValueStateText",this.oOvpResourceBundle.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE"));}}},onCardTypeSelected:function(E){var i=E.getParameters().id;this._oCardManifestSettings.template=E.getSource().getSelectedKey();this.getView().byId("sapOVPAddKpiCheckBoxID").setSelected(false);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this._oCardManifestSettings.addKPIHeaderCheckBox=false;this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.resetPropertiesVisibility(i,this._oCardManifestSettings);},onDatasourceComboboxChanged:function(E){var j=E.getParameters().id;this._oCardManifestSettings.model=E.getParameters().value;this._oCardManifestSettings.allEntitySet="";var y=this._oCardManifestSettings.datasources;for(var i=0;i<y.length;i++){if(y[i].name===this._oCardManifestSettings.model){this._oCardManifestSettings.metaModel=y[i].getMetaModel();}}s.addSupportingObjects(this._oCardManifestSettings);this.resetPropertiesVisibility(j,this._oCardManifestSettings);},onEntitySetChanged:function(E,j){var y=this._oCardManifestSettings.metaModel.getObject('/dataServices/schema')[0].entityType;this.aVariantNames.forEach(function(z){if(this._oCardManifestSettings[z.sPath]){this._oCardManifestSettings[z.sPath]=[];}}.bind(this));for(var i in y){if(y[i].name===E){this._oCardManifestSettings.entityType=y[i];break;}}s.addSupportingObjects(this._oCardManifestSettings);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);},addStaticParameterRow:function(){var i=this.getView().getModel();var j=i.getProperty("/aAllStaticParameters");if(j&&j.length){j.push({key:"",value:""});}else{j=[];j.push({key:"",value:""});}i.setProperty("/aAllStaticParameters",j);},addActionRow:function(){var i=this.getView().getModel();var j=i.getProperty("/objectStreamCardsSettings/customActions");if(j&&j.length){j.push({text:"",press:"",position:""});}else{j=[];j.push({text:"",press:"",position:""});}i.setProperty("/objectStreamCardsSettings/customActions",j);},onParameterDelete:function(E){var i=this.getView().getModel();var j=i.getProperty("/aAllStaticParameters");var y=E.getSource().getBindingContext().getObject()&&E.getSource().getBindingContext().getObject()["key"];j=j.filter(function(z){return z["key"]!=y;});i.setProperty("/aAllStaticParameters",j);if(!q.sap.equal(this._oCardManifestSettings.staticParameters,this._oOriginalCardManifestSettings.staticParameters)){this.setEnablePropertyForResetAndSaveButton(true);}this.getView().getModel().refresh();},onActionDelete:function(E){var i=this.getView().getModel();var j=i.getProperty("/objectStreamCardsSettings/customActions");var y=E.getSource().getBindingContext().getObject()&&E.getSource().getBindingContext().getObject()["text"];j=j.filter(function(z){return z["text"]!=y;});i.setProperty("/objectStreamCardsSettings/customActions",j);if(!q.sap.equal(this._oCardManifestSettings.objectStreamCardsSettings,this._oOriginalCardManifestSettings.objectStreamCardsSettings)){this.setEnablePropertyForResetAndSaveButton(true);}},updateProperty:function(E){var j=E.getSource().getId();var y=false,z;if(this._oCardManifestSettings.tabs&&this._oCardManifestSettings.tabs.length){y=true;z=parseInt(this._oCardManifestSettings.selectedKey,10);this._oCardManifestSettings.isViewResetEnabled=true;this._oCardManifestSettings.aViews[z].isViewResetEnabled=true;}for(var i=0;i<this._updateManifestProperties.length;i++){if(j.indexOf(this._updateManifestProperties[i].formElementId)>-1){var A=this._updateManifestProperties[i].formElement;switch(A){case"entitySet":var G=E.getSource().getSelectedKey();if(!y){this._oCardManifestSettings["entitySet"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[z-1]["entitySet"]=E.getParameter("value");}this.onEntitySetChanged(G,j);break;case"identificationAnnotationPath":if(!y){this._oCardManifestSettings["identificationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[z-1]["identificationAnnotationPath"]=E.getParameter("value");}break;case"selectionPresentationAnnotationPath":if(!y){this._oCardManifestSettings["selectionPresentationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[z-1]["selectionPresentationAnnotationPath"]=E.getParameter("value");}break;case"selectionAnnotationPath":if(!y){this._oCardManifestSettings["selectionAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[z-1]["selectionAnnotationPath"]=E.getParameter("value");}break;case"presentationAnnotationPath":if(!y){this._oCardManifestSettings["presentationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[z-1]["presentationAnnotationPath"]=E.getParameter("value");}break;case"annotationPath":if(!y){this._oCardManifestSettings["annotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[z-1]["annotationPath"]=E.getParameter("value");}break;case"listType":this._oCardManifestSettings.listType=E.getSource().getSelectedKey();break;case"listFlavor":this._oCardManifestSettings.listFlavor=E.getSource().getSelectedKey();break;case"KPICheckBox":this._oCardManifestSettings.addKPIHeaderCheckBox=E.getParameter("selected");this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);break;case"dataPointAnnotationPath":if(!y){this._oCardManifestSettings["dataPointAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[z-1]["dataPointAnnotationPath"]=E.getParameter("value");}this.validateComboBox(this._oCardManifestSettings);break;case"addODataSelectCheckBox":this._oCardManifestSettings.addODataSelectCheckBox=E.getParameter("selected");break;case"requireAppAuthorization":this._oCardManifestSettings.requireAppAuthorization=E.getParameter("value");break;case"kpiAnnotationPath":if(!y){this._oCardManifestSettings["kpiAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[z-1]["kpiAnnotationPath"]=E.getParameter("value");}this._oCardManifestSettings.kpiAnnotationPath=E.getParameter("value");break;case"navigationPath":this._oCardManifestSettings.navigationPath=E.getParameter("value");break;case"title":var H=E.getParameter("value");if(H.trim().length){this.setEnablePropertyForResetAndSaveButton(true);}else{this.setEnablePropertyForResetAndSaveButton(false);}break;case"subTitle":var H=E.getParameter("value");var K=this.getView().getModel("visibility"),N=K.getData();if(N.requiredSubTitle&&H===""){K.setProperty("/subTitleValueState","Error");K.setProperty("/subTitleValueStateText",this.oOvpResourceBundle.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE"));}else{K.setProperty("/subTitleValueState","None");K.setProperty("/subTitleValueStateText","");}break;default:break;}}}},resetTextFields:function(i){i.title=this._oOriginalCardManifestSettings.title;i.subTitle=this._oOriginalCardManifestSettings.subTitle;i.valueSelectionInfo=this._oOriginalCardManifestSettings.valueSelectionInfo;},resetPropertiesVisibility:function(E,i){if(E.indexOf("sapOVPDataSource")!==-1){this._updateManifestProperties.forEach(function(y){if(!E.includes(y.formElementId)){if(y.formElementId.includes("sapOVPAddODataSelect")){i[y.formElement]=false;}else{i[y.formElement]="";}}});this.resetTextFields(i);}else if(E.indexOf("sapOVPCardType")!==-1){this._updateManifestProperties.forEach(function(y){if(!(y.formElementId.includes("sapOVPDataSource")||y.formElementId.includes("sapOVPCardType"))){if(y.formElementId.includes("sapOVPAddODataSelect")){i[y.formElement]=false;}else{i[y.formElement]="";}}});this.resetTextFields(i);}else if(E.indexOf("sapOVPEntitySetList")!==-1){var j=this.getView().getModel("visibility").getData().showViewSwitch;this._updateManifestProperties.forEach(function(y){if(!(y.formElementId.includes("sapOVPDataSource")||y.formElementId.includes("sapOVPCardType")||y.formElementId.includes("sapOVPEntitySetList"))){if(y.formElementId.includes("sapOVPAddODataSelect")){i[y.formElement]=false;}else{if(!j){i[y.formElement]="";}else{S.tabFields.forEach(function(z){if(z!=='entitySet'&&z!=='value'){i[z]="";}});}}}});if(!j){this.resetTextFields(i);}}this.setEnablePropertyForResetAndSaveButton(false);s.setVisibilityForFormElements(i);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh();}});});
