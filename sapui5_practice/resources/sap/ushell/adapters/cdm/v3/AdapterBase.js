// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/adapters/cdm/v3/_LaunchPage/readCatalogs","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/m/GenericTile","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/Version","sap/base/Log"],function(r,R,o,G,C,u,a,e,n,b,U,c,V,L){"use strict";var l=jQuery.sap.log.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter");var d=jQuery.sap.log.Level;var S="sap.ushell.components.tiles.cdm.applauncher";var D="sap.ushell.components.tiles.cdm.applauncherdynamic";function A(f,p,g){this.oAdapterConfiguration=g;this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.TileType={Tile:"tile",Link:"link",Card:"card"};}A.prototype.getGroups=function(){var f=new jQuery.Deferred();this._ensureLoaded().done(function(g){U.setPerformanceMark("FLP - homepage groups processed");f.resolve(g);}).fail(function(){f.resolve([]);});return f.promise();};A.prototype._ensureLoaded=function(){var t=this,f;if(this._ensureLoadedDeferred){return this._ensureLoadedDeferred.promise();}f=new jQuery.Deferred();this._ensureLoadedDeferred=f;this._getSiteData().done(function(s){if(!t.isSiteSupported(s)){throw new Error("Invalid CDM site version: Check the configuration of the launchpage adapter and the version of the FLP site");}var i=[];var g=r.getGroupsArrayFromSite(s);g=t._addDefaultGroup(g,s);g.forEach(function(h){i=t._ensureGroupItemsResolved(h,s).concat(i);});t._allPromisesDone(i).done(function(){t._ensureLoadedDeferred.resolve(g);delete t._ensureLoadedDeferred;t._logTileResolutionFailures(t._mFailedResolvedTiles);});}).fail(function(E){l.error("Delivering hompage groups failed - "+E);t._ensureLoadedDeferred.resolve([]);delete t._ensureLoadedDeferred;});return f.promise();};A.prototype._ensureGroupItemsResolved=function(g,s){var p=[],f,h;if(g.payload&&g.payload.tiles){f=this._ensureGroupTilesResolved(g.payload.tiles,s);Array.prototype.push.apply(p,f);}if(g.payload&&g.payload.links){h=this._ensureGroupLinksResolved(g.payload.links,s);Array.prototype.push.apply(p,h);}return p;};A.prototype._ensureGroupTilesResolved=function(g,s){return(g||[]).map(function(t,i){return this._resolveGroupTile(t,s).then(function(f){f.isLink=false;return f;});},this);};A.prototype._ensureGroupLinksResolved=function(g,s){return(g||[]).map(function(f){return this._resolveGroupTile(f,s).then(function(h){h.isLink=true;return h;});},this);};A.prototype._resolveGroupTile=function(t,s){var m=this._mResolvedTiles;var f=this._mFailedResolvedTiles;var g;function h(j){m[t.id]=j;if(f[t.id]){delete f[t.id];}return j;}function i(t){var T=t.target;return T&&T.semanticObject==="Shell"&&T.action==="launchURL";}if(m[t.id]){return(new jQuery.Deferred()).resolve(m[t.id]).promise();}if(t.target&&t.target.url){g=jQuery.when(this._getTileForUrl(t));}else if(t.isBookmark){g=this._resolveTileByIntent(t,s);}else if(i(t)){g=this._resolveTileByIntent(t,s);}else{g=this._resolveTileByVizId(t,s);}g.done(function(j){h(j);}).fail(function(F){f[t.id]=F;});return g;};A.prototype._resolveTileByVizId=function(t,s){var v,f,g,h,i,j,I,m,N,k,H,O,E;function p(B,M){return new jQuery.Deferred().reject({logLevel:B,message:M}).promise();}if(!jQuery.isPlainObject(s)){return p(d.ERROR,"Cannot resolve tile: oSite must be an object");}if(!jQuery.isPlainObject(t)){return p(d.ERROR,"Cannot resolve tile: oTile must be an object");}f=t.vizId;if(!f){return p(d.ERROR,"Cannot resolve tile '"+t.id+"': vizId must be specified");}v=o.get(s,f);if(!v){return p(d.ERROR,"Cannot resolve tile '"+t.id+"': no visualization found for vizId '"+f+"'");}h=o.getTypeId(v);g=o.getType(s,h);if(!g){return p(d.ERROR,"Cannot resolve tile '"+t.id+"': no visualization type found for vizTypeId '"+h+"'");}i=o.getAppId(v);if(i){j=o.getAppDescriptor(s,i);if(!j){return p(d.INFO,"Tile '"+t.id+"' filtered from result: no app descriptor found for appId '"+i+"' (dangling app reference)");}I=r.getInbound(j,o.getTarget(v).inboundId);if(!I){return p(d.ERROR,"Cannot resolve tile '"+t.id+"': app '"+i+"' has no navigation inbound");}m=c.mapOne(I.key,I.inbound,j,v,g,s);var q=m.resolutionResult.applicationType,w=m.resolutionResult.additionalInformation,x=a.last("/core/navigation/enableInPlaceForClassicUIs"),y=x?x[q]:false;N=n.computeNavigationModeForHomepageTiles(q,w,y);O=o.getOutbound(v,I.inbound);H=this._toHashFromOutbound(O);}else{var z=o.getConfig(v);if(!z){return p(d.INFO,"Tile '"+t.id+"' filtered from result: Neither target app nor configuration given in visualization '"+f+"'");}m=c.mapOne(undefined,undefined,undefined,v,g,s);if(o.startsExternalUrl(v)){E=U.getMember(z,"sap|flp.target.url");}}k=m.tileResolutionResult;k.navigationMode=N;k.isLink=false;if(!this._isFormFactorSupported(k)){return p(d.INFO,"Tile '"+t.id+"' filtered from result: form factor not supported");}return jQuery.when({tileResolutionResult:k,tileIntent:E||H});};A.prototype._isFormFactorSupported=function(f){var s=U.getFormFactor();return r.supportsFormFactor(f,s);};A.prototype._getFirstInbound=function(f){var F=Object.keys(f["sap.app"].crossNavigation.inbounds).shift(),i=f["sap.app"].crossNavigation.inbounds[F];return{key:F,inbound:i};};A.prototype._resolveTileByIntent=function(t){var h=this._prepareTileHash(t);return this._getTileFromHash(h);};A.prototype._allPromisesDone=function(p){var f=new jQuery.Deferred(),g;if(p.length===0){f.resolve([]);}else{var N=p.map(function(P){g=new jQuery.Deferred();P.always(g.resolve.bind(g));return g.promise();});jQuery.when.apply(this,N).done(function(){var h=Array.prototype.slice.call(arguments);f.resolve(h);});}return f.promise();};A.prototype._logTileResolutionFailures=function(f){var m={};if(!f){return;}Object.keys(d).filter(function(s){var i=d[s];return i>=d.FATAL&&i<=d.ALL;}).forEach(function(s){m[d[s]]="";});Object.keys(f).forEach(function(F){var g=f[F];if(g.logLevel){m[g.logLevel]=m[g.logLevel].concat(g.message).concat("\n");}});if(m[d.FATAL]){l.fatal(m[d.FATAL]);}if(m[d.ERROR]){l.error(m[d.ERROR]);}if(m[d.WARNING]){l.warning(m[d.WARNING]);}if(m[d.INFO]){l.info(m[d.INFO]);}if(m[d.DEBUG]){l.debug(m[d.DEBUG]);}if(m[d.TRACE]){l.trace(m[d.TRACE]);}};A.prototype._isValidTitle=function(t){return typeof t==="string"&&t;};A.prototype._isGroupPreset=function(g){return r.isGroupPreset(g);};A.prototype._isGroupLocked=function(g){return r.isGroupLocked(g);};A.prototype.getGroupTitle=function(g){return r.getGroupTitle(g);};A.prototype.getGroupId=function(g){return r.getGroupId(g);};A.prototype.isGroupVisible=function(g){return r.isGroupVisible(g);};A.prototype.getTileTitle=function(t){return r.getTileTitle(this._mResolvedTiles,t);};A.prototype.getTileSubtitle=function(t){return r.getTileSubtitle(this._mResolvedTiles,t);};A.prototype.getTileIcon=function(t){return r.getTileIcon(this._mResolvedTiles,t);};A.prototype.getTileInfo=function(t){return r.getTileInfo(this._mResolvedTiles,t);};A.prototype.getTileIndicatorDataSource=function(t){var f=this._mResolvedTiles[t.id],g={},h;if(t.indicatorDataSource){g.indicatorDataSource=U.clone(t.indicatorDataSource);if(t.dataSource){g.dataSource=U.clone(t.dataSource);}return g;}if(!f){return g;}h=f.tileResolutionResult;if(h.indicatorDataSource){g.indicatorDataSource=U.clone(h.indicatorDataSource);if(h.indicatorDataSource.hasOwnProperty("dataSource")){var s=h.indicatorDataSource.dataSource,i=h.dataSources;if(i&&i.hasOwnProperty(s)){g.dataSource=U.clone(i[s]);}else{jQuery.sap.log.warning("datasource referenced but not found for tile: "+f.tileIntent);}}if(U.getMember(h,"runtimeInformation.componentProperties.url")){var p=U.getMember(g,"indicatorDataSource.path");var j=U.getMember(g,"dataSource.uri");var k=U.getMember(h,"runtimeInformation.componentProperties.url");var T=u(p,j,k,this.getWindowLocationHref());if(!T.error){if(p){g.indicatorDataSource.path=T.uri;}if(j){g.dataSource.uri=T.uriParent;}}}}return g;};A.prototype.getWindowLocationHref=function(){return window.location.href;};A.prototype.isGroupRemovable=function(g){return!this._isGroupPreset(g);};A.prototype.isGroupLocked=function(g){return this._isGroupLocked(g);};A.prototype.getGroupTiles=function(g){return r.getGroupTiles(g).concat(r.getGroupLinks(g));};A.prototype.getTileType=function(i){if(r.isLink(this._mResolvedTiles,i)){return this.TileType.Link;}if(r.isCard(this._mResolvedTiles,i)){return this.TileType.Card;}return this.TileType.Tile;};A.prototype.getTileId=function(t){return r.getTileId(t);};A.prototype.getTileSize=function(t){return r.getTileSize(this._mResolvedTiles,t)||"1x1";};A.prototype.getTileTarget=function(t){var T=r.getTileId(t),f=this._mResolvedTiles[T];if(t.target&&t.target.url){return t.target.url;}if(f){return f.tileIntent;}jQuery.sap.log.warning("Could not find a target for Tile with id '"+T+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};A.prototype.isTileIntentSupported=function(t){return(this._mFailedResolvedTiles[t.id]===undefined);};A.prototype.setTileVisible=function(t,N){var f=this._mResolvedTiles[t.id];if(f){if(f.tileComponent){this._notifyTileAboutVisibility(f.tileComponent,N,f.visibility);}f.visibility=N;}};A.prototype.getCardManifest=function(g){var f,h=this._mResolvedTiles[g.id];f=h.tileResolutionResult;return f.tileComponentLoadInfo;};A.prototype._getTileUiComponentContainerSync=function(t,f,i){var g=this,h,T,N,j,k={};if(i===true){T=g._createTileComponentData(t,true,f);}else{T=g._createTileComponentData(t,false,f);}h=f.tileResolutionResult;if(f.isLink){N=h.navigationMode;return g._createLinkInstance(t,i,N,G,b);}if(typeof h.tileComponentLoadInfo==="object"&&h.tileComponentLoadInfo!==null){k=h.tileComponentLoadInfo.componentProperties||{};k.name=h.tileComponentLoadInfo.componentName;}k.componentData=T;if(k.manifest){k.componentData.properties=k.componentData.properties||{};k.componentData.properties.manifest=k.manifest;}if(k.name){k.async=false;var m;try{j=sap.ui.component(k);}catch(E){jQuery.sap.log.error(E.message+"\n-- An error occurred while instantiating "+"the tile component for "+k.name,E.stack?E.stack:"","sap.ushell.adapters.cdm.LaunchPageAdapter");return null;}m=new sap.ui.core.ComponentContainer({component:j,height:"100%"});if(!i){g._mResolvedTiles[t.id].tileComponent=j;}return m;}return null;};A.prototype._getTileUiComponentContainer=function(t,f,i){var g=this,h,T,N,j,k,I,m=new jQuery.Deferred();var p=sap.ushell.Container.getService("Ui5ComponentLoader");if(i===true){T=g._createTileComponentData(t,true,f);}else{T=g._createTileComponentData(t,false,f);}h=f.tileResolutionResult;if(f.isLink){N=h.navigationMode;m.resolve(g._createLinkInstance(t,i,N,G,b));return m.promise();}var q=this._createTileComponentProperties(T,h.tileComponentLoadInfo);if(!q.name){return m.reject("Cannot find name of tile component for tile with id: '"+t.id+"'").promise();}if(q.manifest){T.properties=T.properties||{};T.properties.manifest=q.manifest;}I=this.isCustomTile(q.name);var s=function(v){var f;j=v.componentHandle.getInstance();k=new C({component:j,height:"100%"});if(!i){f=g._mResolvedTiles[t.id];f.tileComponent=j;if(typeof f.visibility==="boolean"){g._notifyTileAboutVisibility(j,f.visibility);}}return k;};var _=function(){return p.createComponent({loadCoreExt:I,loadDefaultDependencies:false,componentData:T,url:q.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:q,ui5ComponentName:q.name},{},[]).then(s);};if(I){e.once("CoreResourcesComplementLoaded").do(function(){_().then(function(k){m.resolve(k);}).fail(function(E){m.reject(E);});});}else{_().then(function(k){m.resolve(k);}).fail(function(E){m.reject(E);});}return m.promise();};A.prototype._createTileComponentProperties=function(t,T){var f={};if(!T){return f;}if(jQuery.isEmptyObject(T)){if(t.properties.indicatorDataSource&&t.properties.indicatorDataSource.path){f.name=D;}else{f.name=S;}}else{f=T.componentProperties||{};f.name=T.componentName;}return f;};A.prototype.getTileView=function(g){var t=this;return new jQuery.Deferred(function(f){return t._getTileView(g,false).then(function(T){f.resolve(T);},function(s){var E="Tile with ID '"+g.id+"' could not be initialized"+(s?":\n"+s:".");jQuery.sap.log.error(E,null,g.tileType);f.reject(E);});}).promise();};A.prototype._getTileView=function(g){var f,E,h=new jQuery.Deferred();if(typeof g!=="object"||!g.id){E="Invalid input parameter passed to _getTileView: "+g;jQuery.sap.log.error(E);return h.reject(E).promise();}f=this._mResolvedTiles[g.id];if(f){return this._getTileUiComponentContainer(g,f,false);}E="No resolved tile found for tile ID: "+g.id;jQuery.sap.log.error(E);return h.reject(E).promise();};A.prototype._createTileComponentData=function(t,i,f){var T=i?this.getCatalogTileTitle(t):this.getTileTitle(t),s=i?this.getCatalogTilePreviewSubtitle(t):this.getTileSubtitle(t),I=i?this.getCatalogTilePreviewIcon(t):this.getTileIcon(t),g=i?this.getCatalogTilePreviewInfo(t):this.getTileInfo(t),h=i?this.getCatalogTileTargetURL(t):this.getTileTarget(t),j=this.getTileIndicatorDataSource(t),k={properties:{},startupParameters:{}};if(f.tileResolutionResult.isCustomTile===true&&f.tileResolutionResult.startupParameters){k.startupParameters=f.tileResolutionResult.startupParameters;}if(T){k.properties.title=T;}if(g){k.properties.info=g;}if(s){k.properties.subtitle=s;}if(I){k.properties.icon=I;}if(h){k.properties.targetURL=h;}if(j.indicatorDataSource){k.properties.indicatorDataSource=j.indicatorDataSource;if(j.dataSource){k.properties.dataSource=j.dataSource;}}if(f.tileResolutionResult){k.properties.navigationMode=f.tileResolutionResult.navigationMode;}return k;};A.prototype._isGroupTile=function(t){return r.isGroupTile(t);};A.prototype._isCatalogTile=function(t){return!!(t&&t.isCatalogTile);};A.prototype._isFailedGroupTile=function(t){return!!(t&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[r.getTileId(t)]);};A.prototype.getCatalogTileId=function(g){if(this._isGroupTile(g)){if(this._isFailedGroupTile(g)){return undefined;}if(g.isBookmark&&jQuery.sap.getObject("target.url",undefined,g)){return g.target.url;}return g.vizId||(g.target&&g.target.url);}if(this._isCatalogTile(g)){return g.id;}return undefined;};A.prototype.getCatalogTileTargetURL=function(g){if(!g){throw new Error("The given tile is falsy");}if(this._isCatalogTile(g)){if(g.tileResolutionResult&&g.tileResolutionResult.isCustomTile){if(!g.tileResolutionResult.targetOutbound){return"";}return this._toHashFromOutbound(g.tileResolutionResult.targetOutbound);}return g.tileIntent||"";}return this.getTileTarget(g);};A.prototype.isGroupFeatured=function(g){return!!g.isFeatured;};A.prototype._getMember=function(O,s){return U.getMember(O,s);};A.prototype.getCdmVersionsSupported=function(){return{"min":V("3.0.0"),"max":V("3.0.0")};};A.prototype.isSiteSupported=function(s){if(!s._version||V(s._version).compareTo(this.getCdmVersionsSupported().min)<0||V(s._version).compareTo(this.getCdmVersionsSupported().max)>0){L.fatal("Invalid CDM site version: Only version 3.0.0 is supported");return false;}return true;};return A;},true);
