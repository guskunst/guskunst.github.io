// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/resources","sap/ui/model/resource/ResourceModel","sap/m/GenericTile","sap/m/ImageContent","sap/m/TileContent","sap/m/NumericContent","sap/m/library","sap/ui/core/ComponentContainer","sap/ui/thirdparty/datajs"],function(r,R,G,I,T,N,m,C,O){"use strict";var a=m.GenericTileMode;var L=function(u,p,A){var c=jQuery.extend(true,[],A.config.groups),b=A.config.catalogs||[],f=0,g=10,M=10,d=10,h,j,k,l;var o={};for(k=0;k<c.length;k++){if(c[k].isDefaultGroup===true){l=c[k];break;}}if(!l&&c.length>0){l=c[0];l.isDefaultGroup=true;}this.translationBundle=r.i18n;this.TileType={Tile:"tile",Link:"link",Card:"card"};if(!h&&A.config.pathToLocalizedContentResources){h=new R({bundleUrl:A.config.pathToLocalizedContentResources,bundleLocale:sap.ui.getCore().getConfiguration().getLanguage()});j=h.getResourceBundle();}function _(K){if(j){return j.getText(K);}return K;}jQuery.each(b,function(i,e){if(j){e.title=_(e.title);}jQuery.each(e.tiles,function(i,n){n.getTitle=function(){return n.title;};});});jQuery.each(c,function(i,e){if(j){e.title=_(e.title);}jQuery.each(e.tiles,function(i,n){y(n,true);});});function q(){return(100*Math.random())<f;}function s(){return(100*Math.random())<g;}function t(){return M+d*Math.random();}function v(e,i){var n;for(n=0;n<e.tiles.length;n=n+1){if(i.id===e.tiles[n].id){return n;}}return-1;}function w(e,i){var n;for(n=0;n<e.length;n=n+1){if(i.id===e[n].id){return n;}}return-1;}function x(e){var D=jQuery.Deferred();window.setTimeout(function(){D.resolve(e);},t());return D.promise();}function y(e,n){if(e.tileType!=="sap.ushell.ui.tile.DynamicTile"||!e.properties||!e.properties.serviceUrl){return;}if(e.intervalTimer){window.clearInterval(e.intervalTimer);e.intervalTimer=undefined;}if(n){var i=e.serviceRefreshInterval;if(i){i=i*1000;}else{i=10000;}e.intervalTimer=window.setInterval(function(){O.read(e.properties.serviceUrl+"?id="+e.id+"&t="+new Date().getTime(),function(){jQuery.sap.log.debug("Dynamic tile service call succeed for tile "+e.id);},function(z){jQuery.sap.log.debug("Dynamic tile service call failed for tile "+e.id+", error message:"+z);});},i);}}this.getGroups=function(){var D=jQuery.Deferred();window.setTimeout(function(){D.resolve(c.slice(0));},t());return D.promise();};this.getDefaultGroup=function(){var D=new jQuery.Deferred();D.resolve(l);return D.promise();};this.addGroup=function(e){var D=jQuery.Deferred(),F=q(),i=this;window.setTimeout(function(){if(!F){var n={id:"group_"+c.length,title:e,tiles:[]};c.push(n);D.resolve(n);}else{i.getGroups().done(function(E){D.reject(E);}).fail(function(){D.reject();});}},t());return D.promise();};this.getGroupTitle=function(e){return e.title;};this.setGroupTitle=function(e,n){var D=jQuery.Deferred(),F=q();window.setTimeout(function(){if(!F){e.title=n;D.resolve();}else{x(e).done(function(E){D.reject(E.title);}).fail(function(){D.reject();});}},t());return D.promise();};this.getGroupId=function(e){return e.id;};this.hideGroups=function(H){if(H&&c){for(var i=0;i<c.length;i++){if(H.indexOf(c[i].id)!=-1){c[i].isVisible=false;}else{c[i].isVisible=true;}}}return jQuery.Deferred().resolve();};this.isGroupVisible=function(e){return e&&(e.isVisible===undefined?true:e.isVisible);};this.moveGroup=function(e,n){var D=jQuery.Deferred(),F=q(),i=this;window.setTimeout(function(){if(!F){c.splice(n,0,c.splice(w(c,e),1)[0]);D.resolve();}else{i.getGroups().done(function(E){D.reject(E);}).fail(function(){D.reject();});}},t());return D.promise();};this.removeGroup=function(e){var D=jQuery.Deferred(),F=q(),i=this;window.setTimeout(function(){if(!F){c.splice(w(c,e),1);jQuery.each(e.tiles,function(n,z){y(z,false);});D.resolve();}else{i.getGroups().done(function(E){D.reject(E);}).fail(function(){D.reject();});}},t());return D.promise();};this.resetGroup=function(e){var D=jQuery.Deferred(),F=q(),i=this;window.setTimeout(function(){if(!F){jQuery.each(e.tiles,function(n,z){y(z,false);});e=jQuery.extend(true,{},A.config.groups[w(A.config.groups,e)]);c.splice(w(c,e),1,e);jQuery.each(e.tiles,function(n,z){y(z,true);});D.resolve(e);}else{i.getGroups().done(function(E){D.reject(E);}).fail(function(){D.reject();});}},t());return D.promise();};this.isGroupRemovable=function(e){return e&&!e.isPreset;};this.isGroupLocked=function(e){return e.isGroupLocked;};this.isGroupFeatured=function(e){return e.isFeatured;};this.getGroupTiles=function(e){return e.tiles;};this.getLinkTiles=function(e){return e.links;};this.getTileTitle=function(e){return e.title;};this.getTileType=function(e){if(e.isLink){return this.TileType.Link;}if(e.isCard){return this.TileType.Card;}return this.TileType.Tile;};this.getTileId=function(e){return e.id;};this.getTileSize=function(e){return e.size;};this.getTileTarget=function(e){var U;if(e.properties){U=e.properties.href||e.properties.targetURL;}return e.target_url||U||"";};this.isTileIntentSupported=function(e){if(e&&e.formFactor){var i=e.formFactor;var S=sap.ui.Device.system;var n;if(S.desktop){n="Desktop";}else if(S.tablet){n="Tablet";}else if(S.phone){n="Phone";}if(i.indexOf(n)===-1){return false;}}return true;};this.isLinkPersonalizationSupported=function(e){if(e){return e.isLinkPersonalizationSupported;}return true;};this.getTileView=function(e){var D=jQuery.Deferred(),F=q(),i=this;if(s()){window.setTimeout(function(){if(!F){i._getTileView(e).done(function(n){D.resolve(n);});}else{D.reject();}},t());}else if(!F){i._getTileView(e).done(function(n){D.resolve(n);});}else{D.reject();}return D.promise();};this._getTileView=function(i){var E="unknown error",n,z,B=this.getTileType(i)==="link",D=jQuery.Deferred(),F=this;this._translateTileProperties(i);if(i.namespace&&i.path&&i.moduleType){jQuery.sap.registerModulePath(i.namespace,i.path);if(i.moduleType==="UIComponent"){n=new C({component:sap.ui.getCore().createComponent({componentData:{properties:i.properties},name:i.moduleName}),height:"100%",width:"100%"});}else{n=sap.ui.view({viewName:i.moduleName,type:sap.ui.core.mvc.ViewType[i.moduleType],viewData:{properties:i.properties},height:"100%"});}D.resolve(n);return D.promise();}else if(i.tileType){z=B?"Link":i.tileType;if(z){var H=i.properties.targetURL||i.properties.href;try{if(H){delete i.properties.targetURL;this._createTileInstance(i,z).done(function(J){n=J;if(typeof(n.setTargetURL)==="function"){n.setTargetURL(H);}i.properties.targetURL=H;F._handleTilePress(n);F._applyDynamicTileIfoState(n);D.resolve(n);});return D.promise();}else{this._createTileInstance(i,z).done(function(J){n=J;F._handleTilePress(n);F._applyDynamicTileIfoState(n);D.resolve(n);});return D.promise();}}catch(e){D.resolve(new G({header:e&&(e.name+": "+e.message)||this.translationBundle.getText("failedTileCreationMsg"),frameType:this._parseTileSizeToGenericTileFormat(i.size)}));return D.promise();}}else{E="TileType: "+i.tileType+" not found!";}}else{E="No TileType defined!";}D.resolve(new G({header:E,frameType:this._parseTileSizeToGenericTileFormat(i.size)}));return D.promise();};this._getCatalogTileViewAsync=function(i){var D=new jQuery.Deferred(),n=this,z,E="unknown error",B,F,H=this.getTileType(i)==="link";this._translateTileProperties(i);if(i.namespace&&i.path&&i.moduleType){jQuery.sap.registerModulePath(i.namespace,i.path);if(i.moduleType==="UIComponent"){B=new C({component:sap.ui.getCore().createComponent({componentData:{properties:i.properties},name:i.moduleName}),height:"100%",width:"100%"});}else{B=sap.ui.view({viewName:i.moduleName,type:sap.ui.core.mvc.ViewType[i.moduleType],viewData:{properties:i.properties},height:"100%"});}D.resolve(B);return D.promise();}else if(i.tileType){F=H?"Link":i.tileType;if(F){var J=i.properties.targetURL||i.properties.href;try{if(J){delete i.properties.targetURL;z=this._createCatalogTileInstanceAsync(i,F);z.done(function(K){if(typeof(K.setTargetURL)==="function"){B.setTargetURL(J);}i.properties.targetURL=J;n._handleTilePress(K);n._applyDynamicTileIfoState(K);D.resolve(K);});}else{z=this._createCatalogTileInstanceAsync(i,F);z.done(function(K){n._handleTilePress(K);n._applyDynamicTileIfoState(K);D.resolve(K);});}}catch(e){D.resolve(new G({header:e&&(e.name+": "+e.message)||this.translationBundle.getText("failedTileCreationMsg"),frameType:this._parseTileSizeToGenericTileFormat(i.size)}));}}else{E="TileType: "+i.tileType+" not found!";}return D.promise();}E="No TileType defined!";D.resolve(new G({header:E,frameType:this._parseTileSizeToGenericTileFormat(i.size)}));return D.promise();};this._getCatalogTileView=function(i){var E="unknown error",n,z,B=this.getTileType(i)==="link";this._translateTileProperties(i);if(i.namespace&&i.path&&i.moduleType){jQuery.sap.registerModulePath(i.namespace,i.path);if(i.moduleType==="UIComponent"){n=new C({component:sap.ui.getCore().createComponent({componentData:{properties:i.properties},name:i.moduleName}),height:"100%",width:"100%"});}else{n=sap.ui.view({viewName:i.moduleName,type:sap.ui.core.mvc.ViewType[i.moduleType],viewData:{properties:i.properties},height:"100%"});}return n;}else if(i.tileType){z=B?"Link":i.tileType;if(z){var D=i.properties.targetURL||i.properties.href;try{if(D){delete i.properties.targetURL;n=this._createCatalogTileInstance(i,z);if(typeof(n.setTargetURL)==="function"){n.setTargetURL(D);}i.properties.targetURL=D;}else{n=this._createCatalogTileInstance(i,z);}this._handleTilePress(n);this._applyDynamicTileIfoState(n);return n;}catch(e){return new G({header:e&&(e.name+": "+e.message)||this.translationBundle.getText("failedTileCreationMsg"),frameType:this._parseTileSizeToGenericTileFormat(i.size)});}}else{E="TileType: "+i.tileType+" not found!";}}else{E="No TileType defined!";}return new G({header:E,frameType:this._parseTileSizeToGenericTileFormat(i.size)});};this._createTileInstance=function(e,i){var n,D=jQuery.Deferred(),z=this._getImageContent({src:e.properties.icon});z.addStyleClass("sapUshellFullWidth");switch(i){case"sap.ushell.ui.tile.DynamicTile":n=new G({header:e.properties.title,subheader:e.properties.subtitle,frameType:this._parseTileSizeToGenericTileFormat(e.size),tileContent:new T({frameType:this._parseTileSizeToGenericTileFormat(e.size),footer:e.properties.info,unit:e.properties.numberUnit,content:new N({scale:e.properties.numberFactor,value:e.properties.numberValue,truncateValueTo:5,indicator:e.properties.stateArrow,valueColor:this._parseTileValueColor(e.properties.numberState),icon:e.properties.icon,width:"100%"})}),press:this._genericTilePressHandler.bind(this,e)});o[e.id]=n;D.resolve(n);break;case"sap.ushell.ui.tile.StaticTile":n=new G({mode:this._parseTileModeToGenericTileFormat(e.mode),header:e.properties.title,subheader:e.properties.subtitle,frameType:this._parseTileSizeToGenericTileFormat(e.size),tileContent:new T({frameType:this._parseTileSizeToGenericTileFormat(e.size),footer:e.properties.info,content:z}),press:this._genericTilePressHandler.bind(this,e)});o[e.id]=n;D.resolve(n);break;case"Link":n=new G({mode:a.LineMode,subheader:e.properties.subtitle,header:e.properties.title,press:function(E){this._genericTilePressHandler(e,E);}.bind(this)});o[e.id]=n;D.resolve(n);break;default:var B=e.tileType.replace(/\./g,"/");sap.ui.require([B],function(){var E=jQuery.sap.getObject(e.tileType);n=new E(e.properties||{});o[e.id]=n;D.resolve(n);});}return D.promise();};this.getCardManifest=function(e){var i=JSON.parse(JSON.stringify(e.manifest));return i;};this._createCatalogTileInstanceAsync=function(e,i){var D=new jQuery.Deferred(),n,z=this._getImageContent({src:e.properties.icon});z.addStyleClass("sapUshellFullWidth");switch(i){case"sap.ushell.ui.tile.DynamicTile":n=new G({header:e.properties.title,subheader:e.properties.subtitle,frameType:this._parseTileSizeToGenericTileFormat(e.size),tileContent:new T({frameType:this._parseTileSizeToGenericTileFormat(e.size),footer:e.properties.info,unit:e.properties.numberUnit,content:new N({scale:e.properties.numberFactor,value:e.properties.numberValue,truncateValueTo:5,indicator:e.properties.stateArrow,valueColor:this._parseTileValueColor(e.properties.numberState),icon:e.properties.icon,width:"100%"})}),press:function(E){this._genericTilePressHandler(e,E);}.bind(this)});break;case"sap.ushell.ui.tile.StaticTile":n=new G({header:e.properties.title,subheader:e.properties.subtitle,frameType:this._parseTileSizeToGenericTileFormat(e.size),tileContent:new T({frameType:this._parseTileSizeToGenericTileFormat(e.size),footer:e.properties.info,content:z}),press:function(E){this._genericTilePressHandler(e,E);}.bind(this)});break;case"Link":n=new G({mode:a.LineMode,subheader:e.properties.subtitle,header:e.properties.title,press:function(E){this._genericTilePressHandler(e,E);}.bind(this)});break;default:i=e.tileType&&e.tileType.replace(/\./g,"/");sap.ui.require([i],function(B){n=new B(e.properties||{});D.resolve(n);});}D.resolve(n);return D.promise();};this._createCatalogTileInstance=function(e,i){var n,z,B,D=this._getImageContent({src:e.properties.icon});D.addStyleClass("sapUshellFullWidth");switch(i){case"sap.ushell.ui.tile.DynamicTile":n=new G({header:e.properties.title,subheader:e.properties.subtitle,frameType:this._parseTileSizeToGenericTileFormat(e.size),tileContent:new T({frameType:this._parseTileSizeToGenericTileFormat(e.size),footer:e.properties.info,unit:e.properties.numberUnit,content:new N({scale:e.properties.numberFactor,value:e.properties.numberValue,truncateValueTo:5,indicator:e.properties.stateArrow,valueColor:this._parseTileValueColor(e.properties.numberState),icon:e.properties.icon,width:"100%"})}),press:function(E){this._genericTilePressHandler(e,E);}.bind(this)});break;case"sap.ushell.ui.tile.StaticTile":n=new G({header:e.properties.title,subheader:e.properties.subtitle,frameType:this._parseTileSizeToGenericTileFormat(e.size),tileContent:new T({frameType:this._parseTileSizeToGenericTileFormat(e.size),footer:e.properties.info,content:D}),press:function(E){this._genericTilePressHandler(e,E);}.bind(this)});break;case"Link":n=new G({mode:a.LineMode,subheader:e.properties.subtitle,header:e.properties.title,press:function(E){this._genericTilePressHandler(e,E);}.bind(this)});break;default:z=e.tileType.replace(/\./g,"/");B=sap.ui.require(z);if(!B){if(!jQuery.sap.getObject(e.tileType)){jQuery.sap.require(e.tileType);}B=jQuery.sap.getObject(e.tileType);}n=new B(e.properties||{});}return n;};this._genericTilePressHandler=function(e,E){var i={},n=sap.ushell.Container.getRenderer("fiori2");if(E.getSource().getScope&&E.getSource().getScope()==="Display"){if(e.properties.targetURL){if(e.properties.targetURL[0]==="#"){hasher.setHash(e.properties.targetURL);}else{i.title=e.properties.title;i.appType="App";i.url=e.properties.targetURL;i.appId=e.properties.targetURL;n.logRecentActivity(i);window.open(e.properties.targetURL,"_blank");}}}};this._parseTileSizeToGenericTileFormat=function(e){return e==="1x2"?"TwoByOne":"OneByOne";};this._parseTileModeToGenericTileFormat=function(e){return e==="HeaderMode"?a.HeaderMode:a.ContentMode;};this._parseTileValueColor=function(e){var i=e;switch(e){case"Positive":i="Good";break;case"Negative":i="Critical";break;}return i;};this._applyDynamicTileIfoState=function(e){var i=e.onAfterRendering;e.onAfterRendering=function(){if(i){i.apply(this,arguments);}var n=this.getModel(),D,z,B;if(!n){return;}D=n.getProperty("/data/display_info_state");z=this.getDomRef();B=z.getElementsByClassName("sapMTileCntFtrTxt")[0];switch(D){case"Negative":B.classList.add("sapUshellTileFooterInfoNegative");break;case"Neutral":B.classList.add("sapUshellTileFooterInfoNeutral");break;case"Positive":B.classList.add("sapUshellTileFooterInfoPositive");break;case"Critical":B.classList.add("sapUshellTileFooterInfoCritical");break;default:return;}};};this._handleTilePress=function(e){if(typeof e.attachPress==="function"){e.attachPress(function(){if(typeof e.getTargetURL==="function"){var i=e.getTargetURL();if(i){if(i[0]==="#"){hasher.setHash(i);}else{window.open(i,"_blank");}}}});}};this._translateTileProperties=function(e){if(this.translationBundle&&j&&!e._isTranslated){var i=e.properties,n=e.keywords;i.title=_(i.title);i.subtitle=_(i.subtitle);i.info=_(i.info);if(n){for(var z=0;z<n.length;z++){n[z]=_(n[z]);}}e._isTranslated=true;}};this.refreshTile=function(){};this.setTileVisible=function(e,n){y(e,n);};this.addTile=function(e,i){if(!i){i=l;}var D=jQuery.Deferred(),F=q(),n=this;window.setTimeout(function(){if(!F){var z=jQuery.extend(true,{title:"A new tile was added",size:"1x1"},e,{id:"tile_0"+e.chipId});i.tiles.push(z);y(z,true);D.resolve(z);}else{n.getGroups().done(function(E){D.reject(E);}).fail(function(){D.reject();});}},t());return D.promise();};this.removeTile=function(e,i){var D=jQuery.Deferred(),F=q(),n=this;window.setTimeout(function(){if(!F){e.tiles.splice(v(e,i),1);y(i,false);D.resolve();}else{n.getGroups().done(function(E){D.reject(E);}).fail(function(){D.reject();});}},t());return D.promise();};this.moveTile=function(e,i,n,S,z,B){var D=jQuery.Deferred(),F=q(),E=this;window.setTimeout(function(){if(!F){if(z===undefined){z=S;}e.isLink=B?(B===E.TileType.Link):e.isLink;S.tiles.splice(i,1);z.tiles.splice(n,0,e);D.resolve(e);}else{E.getGroups().done(function(H){D.reject(H);}).fail(function(){D.reject();});}},t());return D.promise();};this.getTile=function(){var D=jQuery.Deferred();return D.promise();};this.getCatalogs=function(){var D=jQuery.Deferred();b.forEach(function(e){window.setTimeout(function(){D.notify(e);},300);});window.setTimeout(function(){D.resolve(b);},1500);return D.promise();};this.isCatalogsValid=function(){return true;};this.getCatalogError=function(){return;};this.getCatalogId=function(e){return e.id;};this.getCatalogTitle=function(e){return e.title;};this.getCatalogTiles=function(e){var D=jQuery.Deferred();window.setTimeout(function(){D.resolve(e.tiles);},t());return D.promise();};this.getCatalogTileId=function(e){if(e.chipId){return e.chipId;}else{return"UnknownCatalogTileId";}};this.getCatalogTileTitle=function(e){return e.title;};this.getCatalogTileSize=function(e){return e.size;};this.getCatalogTileViewControl=function(e){return this._getCatalogTileViewAsync(e);};this.getCatalogTileView=function(e){return this._getCatalogTileView(e);};this.getCatalogTileTargetURL=function(e){return(e.properties&&e.properties.targetURL)||null;};this.getCatalogTilePreviewTitle=function(e){return(e.properties&&e.properties.title)||null;};this.getCatalogTilePreviewSubtitle=function(e){return(e.properties&&e.properties.subtitle)||null;};this.getCatalogTilePreviewIcon=function(e){return(e.properties&&e.properties.icon)||null;};this.getCatalogTileKeywords=function(e){return jQuery.merge([],jQuery.grep(jQuery.merge([e.title,e.properties&&e.properties.subtitle,e.properties&&e.properties.info],(e&&e.keywords)||[]),function(n){return n!==""&&n;}));};this.getCatalogTileTags=function(e){return(e&&e.tags)||[];};this.addBookmark=function(P,e){var i=e||l,D=jQuery.Deferred(),F=q(),n=this,z=P.title,B=P.subtitle,E=P.info,H=P.url,J=this.isLinkPersonalizationSupported();window.setTimeout(function(){if(!F){var K={title:z,size:"1x1",chipId:"tile_0"+i.tiles.length,tileType:"sap.ushell.ui.tile.StaticTile",id:"tile_0"+i.tiles.length,isLinkPersonalizationSupported:J,keywords:[],properties:{icon:"sap-icon://time-entry-request",info:E,subtitle:B,title:z,targetURL:H}};i.tiles.push(K);y(K,true);D.resolve(K);}else{n.getGroups().done(function(Q){D.reject(Q);}).fail(function(){D.reject();});}},t());return D.promise();};this.updateBookmarks=function(U,P){var D=new jQuery.Deferred(),i=0,e=this.getGroups();e.done(function(n){n.forEach(function(z){z.tiles.forEach(function(B){if(B.properties&&B.properties.targetURL===U){for(var E in P){if(P.hasOwnProperty(E)){B.properties[E]=P[E];}}var F=o[B.id];if(F!==undefined){F.setHeader(B.properties.title);F.setSubheader(B.properties.subtitle);}i++;}});});D.resolve(i);});e.fail(function(){D.reject();});return D.promise();};this.deleteBookmarks=function(U){var D=jQuery.Deferred();var i=0;var e,n,z,B;for(z=0;z<c.length;z++){e=c[z];for(B=e.tiles.length-1;B>=0;B--){n=e.tiles[B];if(n.properties.targetURL===U){e.tiles.splice(B,1);i++;}}}D.resolve(i);return D.promise();};this.countBookmarks=function(U){var D=jQuery.Deferred();var i=0;var e,n,z,B;for(z=0;z<c.length;z++){e=c[z];for(B=0;B<e.tiles.length;B++){n=e.tiles[B];if(n.properties.targetURL===U){i++;}}}D.resolve(i);return D.promise();};this._getImageContent=function(D){return new I(D);};this.onCatalogTileAdded=function(){};this.getTileActions=function(e){return(e&&e.actions)||null;};};return L;},true);
