// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/EventHub","sap/ushell/utils","sap/ushell/utils/clone","sap/ushell/components/StateHelper","sap/ushell/components/_HeaderManager/PropertyStrategiesFactory",'sap/ui/core/theming/Parameters','sap/base/util/ObjectPath','sap/ui/Device'],function(C,E,u,c,S,g,T,O,D){"use strict";var h={application:{},centralAreaElement:null,headEndItems:[],headItems:[],headerVisible:true,showLogo:false,ShellAppTitleState:undefined,rootIntent:"",title:""};var H;var a;var B={"blank":{},"blank-home":{},"home":{"headItems":[]},"app":{"headItems":["backBtn","homeBtn"]},"minimal":{"headItems":["homeBtn"]},"standalone":{"headItems":["backBtn"]},"embedded":{"headItems":["backBtn","homeBtn"]},"embedded-home":{"headItems":[]},"headerless":{"headItems":["backBtn","homeBtn"],"headerVisible":false},"merged":{"headItems":["backBtn","homeBtn"]},"headerless-home":{"headerVisible":false},"merged-home":{},"lean":{"headItems":[]},"lean-home":{}};var d=[];function i(F,G){var I=F&&F.appState?F.appState:"home";H=s(F);a=G;f(D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD));_();p(I);}function b(){e();}function _(){var F=E.on("setHeaderCentralAreaElement").do(function(P){n({propertyName:"centralAreaElement",value:P.id,aStates:S.getPassStates(P.states),bCurrentState:!!P.currentState,bDoNotPropagate:!!P.bDoNotPropagate});});d.push(F);d.push(E.on("ShellFloatingContainerDockedIsResized").do(f));d.push(E.on("updateHeaderOverflowState").do(f));D.media.attachHandler(f,this,D.media.RANGESETS.SAP_STANDARD);}function e(){if(d){d.forEach(function(F){F.off();});}D.media.detachHandler(f,this,D.media.RANGESETS.SAP_STANDARD);}function f(P){v(P);k(P);}function v(P){var F,G=C.last("/core/shell/model/currentState/stateName"),I=G==='merged'||G==='headerless',J=C.last("/core/shell/model/currentViewPortState")==="LeftCenter",K=true;if(P&&P.name){F=P.name;}else{F=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name;}if(F==="Phone"&&!J||I){K=false;}n({propertyName:"showLogo",value:K,aStates:["home","app","blank","blank-home","minimal","lean"],bCurrentState:false,bDoNotPropagate:true});}function j(F,G){if(F&&F.appState==="embedded"){G.setLogo(sap.ui.resource('sap.ui.core','themes/base/img/1x1.gif'));return;}function I(K){var L=/url[\s]*\('?"?([^'")]*)'?"?\)/.exec(K);return L?L[1]:null;}function J(){var L=I(T.get("sapUiGlobalLogo"))||sap.ui.require.toUrl("sap/ushell")+'/themes/base/img/sap_55x27.png';if(G){G.setLogo(L);}}if(sap.ui.getCore().isThemeApplied()){J();}sap.ui.getCore().attachThemeChanged(J);}function k(P){var F=C.last("/core/shellHeader/headEndItems");var G={"Phone":true,"Tablet":true};delete G["Tablet"];if(F.length<2||(F.length===2&&F.indexOf("meAreaHeaderButton")!==-1)){return;}function I(){r(["endItemsOverflowBtn"],false,["home","app"]);var K=sap.ui.getCore().byId('headEndItemsOverflow');if(K){K.destroy();}}var J=(P&&P.name)||D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name;if(J in G){if(F.indexOf("endItemsOverflowBtn")===-1){l(["endItemsOverflowBtn"],false,["home","app"]);}else{I();window.setTimeout(function(){l(["endItemsOverflowBtn"],false,["home","app"]);});}}else{I();}}function l(I,F,G,J){n({propertyName:"headEndItems",value:I,aStates:G,bCurrentState:!!F,bDoNotPropagate:!!J});}function r(I,F,G){n({propertyName:"headEndItems",value:I,aStates:G,bCurrentState:!!F,action:"remove",bDoNotPropagate:false});}function m(F,G){var I={};Object.keys(F).forEach(function(J){var K=F[J];I[J]=Object.keys(K).reduce(function(L,M){L[M]=K[M];return L;},c(G));});return I;}function n(P){var F=P.propertyName,G=!P.bCurrentState?S.getAllStateToUpdate(P.aStates,P.bDoNotPropagate):[],I=C.last("/core/shellHeader"),J=C.last("/core/shell/model/currentState/stateName"),K=P.value,L;if(F.charAt(0)==="/"){F=F.substring(1);}L=g(F,P.action);if(!L){return;}if(!P.bCurrentState){H=t(H,F,L,G,K);}if(G.indexOf(J)>-1||P.bCurrentState){var M=O.get(F.split("/"),I),N=L.execute(M,K);if(M!==N){O.set(F.split("/"),N,I);x(F,I);}}if(P.bCurrentState){w(F,L,K);}}function o(F){var G;for(G in F){if(F.hasOwnProperty(G)){u.updateProperties(H[G],F[G]);}}}function p(F,G){var I=!G?H[F]:C.last("/core/shellHeader"),J,K;if(!I){throw new Error("the state ("+F+") does not exist");}if(a&&a.customShellState){J=a.customShellState.currentState;}if(G&&a.extendedShellStates[G]){K=a.extendedShellStates[G].customState.currentState;}C.emit("/core/shellHeader",q(I,J,K));}function q(F,G,I){var R={};Object.keys(F).forEach(function(P){var J=g(P),K;if(!J){R[P]=c(F[P]);return;}K=c(F[P]);if(I){K=J.execute(K,I[P]);}if(G){K=J.execute(K,G[P]);}R[P]=K;});return R;}function s(F){if(F){h.rootIntent="#"+F.rootIntent;}var G=m(B,h);function I(K,G){var L,M;for(L in G){if(L==="blank"||L==="blank-home"){continue;}if(K==="ActionModeBtn"&&L==="app"){continue;}if((K==="openCatalogBtn"||K==="userSettingsBtn")&&(L==="lean"||L==="lean-home")){continue;}if(K==="ContactSupportBtn"||K==="EndUserFeedbackBtn"){if(["home","app","minimal","standalone","embedded","embedded-home","lean"].indexOf(L)===-1){continue;}}M=G[L].headEndItems.indexOf(K);if(M===-1){G[L].headEndItems.push(K);}}}function J(K,G){var L;for(L in G){G[L].title=K;}}if(F){if(F.moveEditHomePageActionToShellHeader){I("ActionModeBtn",G);}if(F.moveContactSupportActionToShellHeader){I("ContactSupportBtn",G);}if(F.moveGiveFeedbackActionToShellHeader){I("EndUserFeedbackBtn",G);}if(F.moveAppFinderActionToShellHeader){I("openCatalogBtn",G);}if(F.moveUserSettingsActionToShellHeader){I("userSettingsBtn",G);}if(F.title){J(F.title,G);}}return G;}function t(F,P,G,I,J){if(I.length===0){return F;}var N=c(F);I.forEach(function(K){var L=N[K],M;if(L){M=G.execute(O.get(P.split("/"),L),J);O.set(P.split("/"),M,L);}});return N;}function w(P,F,G){var I,N;if(!a){return;}I=a.customShellState.currentState;N=F.execute(O.get(P.split("/"),I),G);O.set(P.split("/"),N,I);}function x(P,F){var R=P.split("/").shift();C.emit("/core/shellHeader/"+R,F[R]);}function y(F){var G;try{G=H[F];}catch(I){G=undefined;}return G;}function z(F,P){var G;try{G=y(F)[P];}catch(I){G=undefined;}return G;}function A(F){H=F;}return{init:i,destroy:b,updateStates:n,recalculateState:p,extendStates:o,initShellBarLogo:j,validateShowLogo:v,handleEndItemsOverflow:k,_resetBaseStates:A,_generateBaseHeaderState:m,_createInitialState:s,_getBaseState:y,_getBaseStateMember:z};},false);
