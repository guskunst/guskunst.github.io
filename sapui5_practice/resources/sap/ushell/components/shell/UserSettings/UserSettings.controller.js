// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/Device","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/ui/utils"],function(C,D,A,a,E,r,u){"use strict";var d;return C.extend("sap.ushell.components.shell.UserSettings",{onInit:function(){this.getView().byId("userSettingEntryList").addEventDelegate({onAfterRendering:this._listAfterRendering.bind(this)});this.getView().byId("userSettingsDialog").addEventDelegate({onkeydown:this._keyDown.bind(this)});this.getView().byId("settingsApp")._oDetailNav.setAutoFocus(false);d=E.on("openUserSettings").do(this.openUserSettings.bind(this));},onExit:function(){d.off();},openUserSettings:function(){this.getView().byId("userSettingsDialog").open();},_afterClose:function(){sap.ushell.Container.getUser().resetChangedProperties();},_createDetailPage:function(e,t,c){var o=new sap.m.ObjectHeader({title:t,backgroundDesign:sap.m.BackgroundDesign.Solid}).addStyleClass("sapUshellUserSettingDetailHeader");if(e==="userAccountEntry"){var U=sap.ushell.Container.getUser();if(U.getImage()){o.setIcon(a.last("/core/shell/model/userImage/personPlaceHolder"));}else{o.setIcon(sap.ui.core.IconPool.getIconURI("sap-icon://person-placeholder"));}U.attachOnSetImage(function(){var P=a.last("/core/shell/model/userImage/personPlaceHolder"),s=sap.ui.core.IconPool.getIconURI("sap-icon://person-placeholder");o.setIcon(P||s);});o.setTitle(sap.ushell.Container.getUser().getFullName());}var p=new sap.m.Page("detail"+c.getId(),{content:[o,c],showHeader:false}).addStyleClass("sapUsheUserSettingDetaildPage");p.addEventDelegate({onAfterRendering:this._handleNavButton.bind(this)});this.getView().byId("settingsApp").addDetailPage(p);return p.getId();},_createEntryContent:function(e){var t=this,p=new Promise(function(b,c){if(typeof e.contentFunc==="function"){e.contentFunc().always(function(f){if(f instanceof sap.ui.core.Control){b(t._createDetailPage(e.entryHelpID,e.title,f));}b("userSettingsErrorPage");});}else{var o;e.valueArgument().done(function(v){o=t._getKeyValueContent(e,v);}).fail(function(){o=t._getKeyValueContent(e);}).always(function(){b(t._createDetailPage(e.entryHelpID,e.title,o));});}});return p;},_dialogCancelButtonHandler:function(){var e=this.getView().getModel("entries").getData().entries||[];for(var i=0;i<e.length;i++){if(e[i]&&e[i].onCancel){e[i].onCancel();}}this._handleSettingsDialogClose();},_emitEntryOpened:function(e){var U=E.last("UserSettingsOpened")||{},p=e.split("/").pop();U[p]=true;E.emit("UserSettingsOpened",U);},_getEntryIcon:function(e,U){if(e==="sap-icon://account"&&U){return U;}return e||"sap-icon://action-settings";},_getEntryVisible:function(v,b,t){if(t===r.i18n.getText("userProfiling")){var p=this.getView().getModel("entries").getProperty("/profiling")||[],U=sap.ushell.Container.getService("UsageAnalytics");for(var i=p.length-1;i>=0;i--){if(p[i].entryHelpID==="usageAnalytics"){if(!U.systemEnabled()||!U.isSetUsageAnalyticsPermitted()){p.splice(i,1);}}}return p&&p.length>0;}if(v!==undefined){return v;}if(b!==undefined){return b;}return true;},_getKeyValueContent:function(e,s){var k=new sap.m.Label({text:e.title+":"}).addStyleClass("sapUshellUserSettingsDetailsKey");var v=new sap.m.Input({value:s||" ",editable:false}).addStyleClass("sapUshellUserSettingsDetailsValue");var b=new sap.m.FlexBox({alignItems:D.system.phone?"Start":"Center",wrap:D.system.phone?"Wrap":"NoWrap",direction:D.system.phone?"Column":"Row",items:[k,v]});return b;},_handleNavButton:function(){var s=this.getView().byId("settingsApp"),n=this.getView().byId("userSettingsNavBackButton");n.setVisible(!s.isMasterShown());},_handleSettingsDialogClose:function(){this.getView().byId("settingsApp").toMaster("sapFlpUserSettings-View--userSettingMaster");this.getView().byId("userSettingEntryList").removeSelections(true);this.getView().byId("userSettingsDialog").close();window.document.getElementById("meAreaHeaderButton").focus();},_handleSettingsSave:function(){var s=A.getElementsModel().getModel();var i=s.getProperty("/userPreferences/isDetailedEntryMode");if(i){s.setProperty("/userPreferences/activeEntryPath",null);}u.saveUserPreferenceEntries(s.getProperty("/userPreferences/entries")).done(function(){sap.ui.require(["sap/m/MessageToast"],function(M){var m=r.i18n.getText("savedChanges");M.show(m,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});});}).fail(function(f){sap.ui.require(["sap/m/MessageBox"],function(M){var e;var b="";if(f.length===1){e=r.i18n.getText("savingEntryError")+" ";}else{e=r.i18n.getText("savingEntriesError")+"\n";}f.forEach(function(o){e+=o.entry+"\n";b+="Entry: "+o.entry+" - Error message: "+o.message+"\n";});M.show(e,{icon:M.Icon.ERROR,title:r.i18n.getText("error"),actions:[M.Action.OK]});jQuery.sap.log.error("Failed to save the following entries",b,"sap.ushell.ui.footerbar.UserPreferencesButton");});});this._handleSettingsDialogClose();},_itemPress:function(e){this._toDetail(e.getSource().getSelectedItem(),e.getId());},_keyDown:function(e){if(e.keyCode===27){this._dialogCancelButtonHandler();}},_listAfterRendering:function(){var m=this.getView().byId("userSettingEntryList");var e=m.getItems();for(var i=0;i<e.length;i++){var p=e[i].getBindingContext("entries").getPath();this._setEntryValueResult(p);}if(!D.system.phone){var f=m.getItems()[0];if(f){m.setSelectedItem(f);this._toDetail(f,"select");f.getDomRef().focus();}}},_navBackButtonPressHandler:function(e){var s=this.getView().byId("settingsApp");if(D.system.phone){s.backDetail();this._handleNavButton();e.getSource().setPressed(false);}else if(s.isMasterShown()){s.hideMaster();e.getSource().setTooltip(r.i18n.getText("ToggleButtonShow"));e.getSource().setPressed(false);}else{s.showMaster();e.getSource().setTooltip(r.i18n.getText("ToggleButtonHide"));e.getSource().setPressed(true);}},_navToDetail:function(i,e,s){var S=this.getView().byId("settingsApp");S.toDetail(i);E.emit("UserPreferencesDetailNavigated",i);if(e==="select"&&!D.system.phone){var b=jQuery.sap.byId(i).firstFocusableDomRef();if(b){jQuery.sap.focus(b);}}if(S.getMode()==="ShowHideMode"){S.hideMaster();}this._handleNavButton();this._emitEntryOpened(s);},_setEntryValueResult:function(e){var m=this.getView().getModel("entries"),i=m.getProperty(e+"/editable"),v=m.getProperty(e+"/valueArgument"),V=m.getProperty(e+"/visible"),b=m.getProperty(e+"/defaultVisibility");if(typeof v==="function"){m.setProperty(e+"/valueResult",r.i18n.getText("genericLoading"));m.setProperty(e+"/editable",false);v().done(function(c){m.setProperty(e+"/editable",i);var f=true;if(c&&c.value!==undefined){f=!!c.value;}else if(V!==undefined){f=V;}else if(b!==undefined){f=b;}var s=" ";if(c!==undefined){if(typeof(c)==="object"){s=c.displayText;}else{s=c;}}m.setProperty(e+"/visible",f);m.setProperty(e+"/valueResult",s);}).fail(function(){m.setProperty(e+"/valueResult",r.i18n.getText("loadingErrorMessage"));});}else if(v){m.setProperty(e+"/valueResult",v);}else{m.setProperty(e+"/valueResult",r.i18n.getText("loadingErrorMessage"));}},_toDetail:function(s,e){var m=this.getView().getModel("entries"),b=s.getBindingContext("entries").getPath(),c=m.getProperty(b+"/contentResult");if(D.system.phone){s.setSelected(false);}if(c){this._navToDetail(c,e,b);}else{var t=this,o=m.getProperty(b);this._createEntryContent(o).then(function(n){m.setProperty(b+"/contentResult",n);t._navToDetail(n,e,b);});}}});},false);
