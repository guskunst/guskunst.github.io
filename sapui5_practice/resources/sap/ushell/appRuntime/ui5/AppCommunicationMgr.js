// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI"],function(A){"use strict";var C="sap.ushell.appRuntime.ui5.AppCommunicationMgr";var s,a=[],p=0;function b(){this.init=function(){var t=this;s=A.getHandlers();t.handleMessageEvent=b.prototype._handleMessageEvent.bind(null,t);addEventListener('message',t.handleMessageEvent);};this.destroy=function(){removeEventListener("message",this.handleMessageEvent);};this._handleMessageResponse=function(m){if(m.request_id&&a[m.request_id]){var r=a[m.request_id];if(m.status==="success"){r.resolve(m.body.result);}else{r.reject();}}};this._handleMessageRequest=function(c,m,M){var t=this,P=jQuery.sap.getObject("sap-ushell-config.services.PostMessage.config",0),S=M&&M.service,d,e,f,o,g;jQuery.sap.log.debug("App Runtime received post message request from origin '"+m.origin+"': "+JSON.stringify(M),null,C);if(!S){return;}if(P&&P.enabled===false){jQuery.sap.log.warning("App Runtime received message for "+e+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,C);this.sendResponseMessage(m,M,"error",{message:"feature disabled"});return;}if(!this._isTrustedPostMessageSource(c,m)){jQuery.sap.log.warning("App Runtime received message from untrusted origin '"+m.origin+"': "+JSON.stringify(m.data),null,C);this.sendResponseMessage(m,M,"error",{message:"Invalid request"});return;}if(S.indexOf(".")>0){d=S.split(".");f=d[d.length-1];e=S.substr(0,S.length-f.length-1);}else{this.sendResponseMessage(m,M,"error",{message:"Invalid service name: '"+S+"'"});return;}var h={oMessage:m,oMessageData:M,oContainer:c};try{o=s[e];g=o&&o.oInboundActions[f];if(g&&g.executeServiceCallFn){g.executeServiceCallFn(h).done(function(r){t.sendResponseMessage(m,M,"success",{result:r});}).fail(function(i){t.sendResponseMessage(m,M,"error",{message:i});});}else{this.sendResponseMessage(m,M,"error",{message:"Unknown service name: '"+M.service+"'"});}}catch(E){this.sendResponseMessage(m,M,"error",{message:E.message});}};this._getCFLPWindow=function(){return window.parent;};this._isTrustedPostMessageSource=function(c,m){var t=false,P=c._getCFLPWindow();if(P){t=(m.source===P);}return t;};this.sendResponseMessage=function(m,M,S,B){var r=JSON.stringify({type:"response",service:M.service,request_id:M.request_id,status:S,body:B});jQuery.sap.log.debug("Sending post message response to origin ' "+m.origin+"': "+r,null,C);if(typeof m.source!=="object"||m.source===null){jQuery.sap.log.debug("Cannot send response message to origin ' "+m.origin,"`source` member of request message is not an object",C);return;}m.source.postMessage(r,m.origin);};this._getTargetWindow=function(){return window.parent;};this.postMessage=function(m){var c,t=this._getTargetWindow();if(m){try{if("request"===m.type&&!m["request_id"]){m["request_id"]=this.getId();}c=JSON.stringify(m);t.postMessage(c,"*");}catch(e){jQuery.sap.log.error("Message '"+m+"' cannot be posted: "+e,"sap.ui5Isolation.AppCommunicationMgr");}}};this.sendMessageToOuterShell=function(m,P,r){var d=new jQuery.Deferred(),M={"type":"request","service":m,"body":(P||{}),"request_id":r};this.postMessage(M);a[M["request_id"]]=d;return d.promise();};this.getId=function(){return"SAPUI5_APPRUNTIME_MSGID_"+(++p);};}b.prototype._handleMessageEvent=function(c,m){if(m===undefined){return;}var M=m.data;if(typeof M==="string"){try{M=JSON.parse(m.data);}catch(e){jQuery.sap.log.debug("Message received from origin '"+m.origin+"' cannot be parsed: "+e,M,C);return;}}if(M.type==="request"){return c._handleMessageRequest(c,m,M);}else if(M.type==="response"){return c._handleMessageResponse(M);}};return new b();},false);
