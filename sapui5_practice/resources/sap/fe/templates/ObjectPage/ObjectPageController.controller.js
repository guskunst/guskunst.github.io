/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/fe/controllerextensions/Transaction","sap/fe/controllerextensions/Routing","sap/fe/controllerextensions/EditFlow","sap/ui/model/odata/v4/ODataListBinding"],function(C,T,R,E,O){"use strict";return C.extend("sap.fe.templates.ObjectPage.ObjectPageController",{transaction:T,routing:R,editFlow:E,onInit:function(){this.getView().setModel(this.transaction.getUIModel(),"ui");},onBeforeBinding:function(c,p){var u=this.getView().getModel('ui'),t=this._findTables(),f;for(var i=0;i<t.length;i++){f=t[i].getCreationRow();if(f){f.setBindingContext(null);}}if(p&&p.editable){u.setProperty('/editable','Editable');if(c===null){u.setProperty('/mode','Create');}else{this.transaction.getProgrammingModel(c).then(function(P){if(P==='Draft'){c.requestObject("IsActiveEntity").then(function(I){if(!I){u.setProperty('/editable','Editable');c.requestObject("HasActiveEntity").then(function(h){if(h){u.setProperty('/mode','Edit');}else{u.setProperty('/mode','Create');}});}});}else{u.setProperty('/mode','Create');}});}return;}else{if(c===null){u.setProperty('/mode','Create');}else{u.setProperty('/mode','Display');}u.setProperty('/editable','Display');}var o=this.byId("fe::op");var s=function(e){o.scrollToSection(o.getScrollingSectionId());o.detachModelContextChange(s);};o.attachModelContextChange(s);},onAfterBinding:function(b){var o=this.byId('fe::op'),t=this,m=b.getModel(),u=this.getView().getModel('ui'),a=this._findTables(),f;b=o.getBindingContext();function e(c,l){var F=c.getCreationRow(),A,d,g;if(F){f.then(function(){if(F.getVisible()){A=l.getContext().getPath()+'/'+l.getPath();d=m.bindList(A,null,[],[],{$$updateGroupId:"create"});g=d.create();F.setBindingContext(g);}});}}o._triggerVisibleSubSectionsEvents();function h(l,c){m.getBindingForReference(l).then(function(B){t.editFlow.handlePatchEvents(B);e(c,B);});}if(u.getProperty('/editable')==='Display'){f=this.transaction.getProgrammingModel(b).then(function(p){if(p==='Draft'){return b.requestObject("IsActiveEntity").then(function(i){if(!i){u.setProperty('/editable','Editable');return b.requestObject("HasActiveEntity").then(function(H){if(H){u.setProperty('/mode','Edit');}else{u.setProperty('/mode','Create');}});}});}});}else{f=Promise.resolve();}this.editFlow.handlePatchEvents(b).then(function(){var l;for(var i=0;i<a.length;i++){l=t.getView().getLocalId(a[i].getId());h(l,a[i]);}});},_findTables:function(){var o=this.byId('fe::op'),t=[];function f(p){for(var e=0;e<p.length;e++){var P=p[e].getAggregation('items')&&p[e].getAggregation('items')[0],c=P&&P.getAggregation('content');if(c&&c.isA('sap.ui.mdc.Table')){t.push(c);}}}var s=o.getSections();for(var a=0;a<s.length;a++){var S=s[a].getSubSections();for(var b=0;b<S.length;b++){f(S[b].getBlocks());f(S[b].getMoreBlocks());}}return t;},handlers:{onDataRequested:function(){var n=this.getView().getController().getOwnerComponent().getRootControl();n.setBusy(true);},onDataReceived:function(e){var s=e&&e.getParameter("error");var n=this.getView().getController().getOwnerComponent().getRootControl();n.setBusy(false);var t=this;if(s){sap.ui.getCore().getLibraryResourceBundle("sap.fe",true).then(function(r){t.routing.navigateToMessagePage(r.getText('SAPFE_DATA_RECEIVED_ERROR'),{title:r.getText('SAPFE_ERROR'),description:s,navContainer:n});});}}}});});
