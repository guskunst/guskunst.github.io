/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(['sap/ui/core/mvc/ControllerExtension','sap/fe/actions/messageHandling','sap/ui/core/XMLTemplateProcessor','sap/ui/core/util/XMLPreprocessor','sap/ui/core/Fragment','sap/fe/actions/sticky','sap/base/Log','sap/m/Text','sap/m/Button',"sap/m/Dialog"],function(C,m,X,a,F,s,L,T,B,D){'use strict';var f='sap.fe.controls.field.DraftPopOverAdminData',p=X.loadTemplate(f,'fragment');var E=C.extend('sap.fe.controllerextensions.EditFlow',{createDocument:function(l,P){var t=this;function h(o,c){if(c){var b=t.base.getView().getBindingContext();c.then(function(){t.requestSideEffects(o.getPath(),b);},function(n){if(n.created){n.created().then(function(){t.requestSideEffects(o.getPath(),b);});}});}}return new Promise(function(r,b){var g,c,o,M;P=P||{};if(typeof l==='object'){g=Promise.resolve(l);}else{g=t.base.getView().getModel().getBindingForReference(l);}g.then(function(d){o=d;M=o.getModel();var e=P.creationMode;if((!e||e==='NewPage')&&t.base.getView().getViewData()._creationMode==='Inplace'){e='Inline';}return t.base.transaction.getProgrammingModel(o).then(function(i){c=i;if(e&&e!=='NewPage'){return e;}else{switch(c){case'Draft':var j=M.getMetaModel(),k=o.getPath();if(!o.isRelative()&&j.getObject(k+'@com.sap.vocabularies.Common.v1.DraftRoot/NewAction')){return'Deferred';}return'Async';case'Sticky':return'Deferred';case'NonDraft':return'Sync';}}});}).then(function(d){var e;if(d!=='Deferred'){if(d==='CreationRow'){P.data=P.creationRow.getBindingContext().getObject();}if(d==='CreationRow'||d==='Inline'){P.keepTransientContextOnFailed=true;P.busyMode='Local';if(d==='CreationRow'){P.busyMode='None';}if(d==='Inline'){P.keepTransientContextOnFailed=false;}}e=t.base.transaction.createDocument(o,P);}switch(d){case'Deferred':t.base.routing.navigateToContext(o,{deferredContext:true,noHistoryEntry:P.noHistoryEntry,editable:true});break;case'Async':t.base.routing.navigateToContext(o,{asyncContext:e,noHistoryEntry:P.noHistoryEntry,editable:true});break;case'Sync':e.then(function(N){t.base.routing.navigateToContext(N,{noHistoryEntry:P.noHistoryEntry,editable:true,noHashChange:c==='Sticky'});});break;case'Inline':h(o,e);break;case'CreationRow':var i=P.creationRow,j=i.getBindingContext(),k=j.getBinding(),n;h(o,e);j.created().then(undefined,function(){L.trace("transient fast creation context deleted");});j.delete("$direct");n=k.create();i.setBindingContext(n);break;}if(e){e.then(function(N){if(N){t.base.routing.setDirtyState(N,true);if(c==='Sticky'){setTimeout(function(){t._handleStickyOn(N);},0);}}r();},b);}else{r();}});});},editDocument:function(c){var t=this;this.base.transaction.editDocument(c).then(function(n){t.base.transaction.getProgrammingModel(c).then(function(P){var N;if(P==='Sticky'){t._handleStickyOn(n);N=true;}if(n!==c){t.handleNewContext(n,true,N,true);}});});},saveDocument:function(c){var t=this;this.base.transaction.saveDocument(c).then(function(A){t.base.transaction.getProgrammingModel(c).then(function(P){var n;if(P==='Sticky'){var h=A.getModel().bindContext(A.getPath(),undefined,{$$groupId:'$auto'});A=h.getBoundContext();t._handleStickyOff(c);if(c.getPath()===A.getPath()){n=true;}}if(A!==c){t.handleNewContext(A,true,n,false);}});});},cancelDocument:function(c,P){var t=this;this.base.transaction.cancelDocument(c,P).then(function(A){t.base.transaction.getProgrammingModel(c).then(function(b){var n;if(b==='Sticky'){t._handleStickyOff(c);n=true;}if(!A){t.base.routing.setDirtyState(c,true);window.history.back();}else{t.handleNewContext(A,true,n,false);}});});},requestSideEffects:function(n,b){var M=this.base.getView().getModel().getMetaModel(),c='/'+M.getObject(M.getMetaPath(b.getPath()))['$Type'],A=M.getObject(c+'@'),S=Object.keys(A).filter(function(i){return i.indexOf('@com.sap.vocabularies.Common.v1.SideEffects')>-1;}),d=[],P,e=[],g=[],h,o;S.forEach(function(i){var j=A[i];if(j.SourceEntities){j.SourceEntities.forEach(function(k){if(k['$NavigationPropertyPath']===n){d.push(i);}});}if(j.SourceProperties&&d.indexOf(i)===-1){j.SourceProperties.forEach(function(k){if(d.indexOf(i)===-1&&(k['$PropertyPath'].indexOf(n+'/')===0)){d.push(i);}});}});d.forEach(function(i){var j=[],k=A[i],t=k.TargetProperties||[],l=k.TargetEntities||[];t=t.map(function(q){return q['$PropertyPath'];}).filter(function(q){return e.indexOf(q)<0;});t.forEach(function(q){var r=M.getObject(c+'/'+q+'@com.sap.vocabularies.Common.v1.Text');if(r&&r['$Path']){j.push(r['$Path']);}});l=l.map(function(q){return q['$NavigationPropertyPath'];}).filter(function(q){return g.indexOf(q)<0;});e=e.concat(t).concat(j);g=g.concat(l);});P=e.map(function(i){return{'$PropertyPath':i};}).concat(g.map(function(i){return{'$NavigationPropertyPath':i};}));if(P.length){h=b.getBinding().getDependentBindings();o=(h&&h[0].isPatchWithoutSideEffects()&&h[0].getBoundContext())||b;o.requestSideEffects(P);}},deleteDocument:function(c,P){var t=this,P=P||{};this.base.transaction.deleteDocument(c,P).then(function(){var b=t.base.getView().getBindingContext();var o=t.getView().byId(P.id);if(o&&o.isA('sap.ui.mdc.Table')){o.clearSelection();}if(b&&Array.isArray(c)){t.requestSideEffects(c[0].getBinding().getPath(),b);}if(!Array.isArray(c)){t.base.routing.setDirtyState(c,true);window.history.back();}});},applyDocument:function(){window.history.back();},_handleStickyOn:function(c){if(sap.ushell){sap.ushell.Container.setDirtyFlag(true);}var i=this.base.getView().getModel("sap.fe.i18n"),t=this;this.fnHandleSessionTimeout=function(){m.removeBoundTransitionMessages();m.removeUnboundTransitionMessages();var d=new D({title:'{sap.fe.i18n>OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}',state:'Warning',content:new T({text:'{sap.fe.i18n>OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}'}),beginButton:new B({text:'{sap.fe.i18n>SAPFE_OK}',type:'Emphasized',press:function(){t._handleStickyOff();window.history.back();}}),afterClose:function(){d.destroy();}});d.addStyleClass("sapUiContentPadding");d.setModel(i,'sap.fe.i18n');t.base.getView().addDependent(d);d.open();};this.base.getView().getModel().attachSessionTimeout(this.fnHandleSessionTimeout);if(!this.fnStickyDiscard){this.fnStickyDiscard=function(){s.discardDocument(c);};this.base.routing.attachOnAfterNavigation(this.fnStickyDiscard);}},_handleStickyOff:function(){if(sap.ushell){sap.ushell.Container.setDirtyFlag(false);}this.base.getView().getModel().detachSessionTimeout(this.fnHandleSessionTimeout);this.base.routing.detachOnAfterNavigation(this.fnStickyDiscard);this.fnStickyDiscard=null;},handleNewContext:function(c,n,N,e){this.base.routing.setDirtyState(c,true);this.base.routing.navigateToContext(c,{noHistoryEntry:n,noHashChange:N,editable:e});},onCallAction:function(A,P){var t=this,c;t.base.transaction.onCallAction(A,P).then(function(){if(P.contexts){c=Array.isArray(P.contexts)?P.contexts[0]:P.contexts;t.base.routing.setDirtyState(c,true);}});},formatDraftOwnerText:function(h,d,b,c,e,g){var i='',r=sap.ui.getCore().getLibraryResourceBundle('sap.fe');if(h){var u=b||d||e||c;if(g){i+=d?r.getText('DRAFTINFO_GENERIC_LOCKED_OBJECT_POPOVER_TEXT')+' ':r.getText('DRAFTINFO_LAST_CHANGE_USER_TEXT')+' ';}i+=u?r.getText('DRAFTINFO_OWNER',[u]):r.getText('DRAFTINFO_ANOTHER_USER');}return i;},formatDraftOwnerTextInline:function(h,d,b,c,e){return this.formatDraftOwnerText(h,d,c,b,e,false);},formatDraftOwnerTextInPopover:function(h,d,b,c,e){return this.formatDraftOwnerText(h,d,c,b,e,true);},onDraftLinkPressed:function(e,b){var t=this,o=e.getSource(),c=o.getBindingContext(),v=this.base.getView(),M=v.getModel().getMetaModel(),d=v.getController();if(!this._oPopover||!this._oPopover.oPopup){Promise.resolve(t._oFragment||a.process(p,{},{bindingContexts:{entitySet:M.createBindingContext("/"+b)},models:{entitySet:M}})).then(function(g){t._oFragment=g;return F.load({definition:g,controller:d});}).then(function(P){t._oPopover=P;v.addDependent(t._oPopover);t._oPopover.setBindingContext(c);t._oPopover.openBy(o);});}this._oPopover.setBindingContext(c);this._oPopover.openBy(o);},closeDraftAdminPopover:function(){this._oPopover.close();},handlePatchEvents:function(b){var u=this.base.getView().getModel('ui');u.setProperty('/draftStatus','Clear');var t=this;return t.base.transaction.getProgrammingModel(b).then(function(P){b=b.getBinding&&b.getBinding()||b;b.attachEvent('patchSent',function(){t.base.transaction.handleDocumentModifications();t.base.routing.setDirtyState(b.getBoundContext&&b.getBoundContext()||"",true);if(P==='Draft'){u.setProperty('/draftStatus','Saving');}});b.attachEvent('patchCompleted',function(e){if(P==='Draft'){u.setProperty('/draftStatus',e.getParameter('success')?'Saved':'Clear');}m.showUnboundMessages();});});},handleErrorOfTable:function(e){if(e.getParameter('error')){setTimeout(m.showUnboundMessages,0);}}});return E;});
