/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(['sap/ui/core/mvc/ControllerExtension','sap/fe/actions/draft','sap/fe/actions/nonDraft','sap/fe/actions/sticky','sap/fe/actions/operations','sap/fe/model/DraftModel',"sap/ui/model/json/JSONModel",'sap/fe/actions/messageHandling','sap/m/Popover','sap/m/VBox','sap/m/CheckBox','sap/m/Text','sap/m/Button','sap/m/MessageToast','sap/fe/factory/UI5ControlFactory'],function(C,d,n,s,o,D,J,m,P,V,a,T,B,M,U){'use strict';var i=false,c=false;function g(p){if(p&&p.getMetadata&&p.getMetadata().getName()==='sap.ui.base.Event'){p={};}return p||{};}var E=C.extend('sap.fe.controllerextensions.Transaction',{getProgrammingModel:function(b){var t=this,e=b.getModel(),f=b.getModel().getMetaModel().getMetaPath(b.getPath());if(!this.sProgrammingModel){return D.upgradeOnDemand(e).then(function(I){if(I){t.sProgrammingModel='Draft';}else{if(e.getMetaModel().getObject(f+'@com.sap.vocabularies.Session.v1.StickySessionSupported')){t.sProgrammingModel='Sticky';}else{t.sProgrammingModel='NonDraft';e.sUpdateGroupId="nondraft";}}return t.sProgrammingModel;});}else{return Promise.resolve(this.sProgrammingModel);}},getUIModel:function(){if(!this.uiModel){this.uiModel=new J({editable:'Display',busy:false,busyLocal:{},draftStatus:'Clear',mode:'Display'});}return this.uiModel;},isBusy:function(b,l){var u=this.getUIModel();return u.getProperty("/busy")||u.getProperty("/busyLocal/"+l);},busyHandler:function(b,l,O){var u;if(b==='Global'){u=this.getUIModel();u.setProperty("/busy",O);}else if(b==='Local'){u=this.getUIModel();u.setProperty("/busyLocal/"+l,O);}},busyOn:function(b,l){this.busyHandler(b,l,true);},busyOff:function(b,l){this.busyHandler(b,l,false);},fnCreateDocument:function(l,S,p){var b=l.getModel(),e=b.getMetaModel(),f=e.getMetaPath(l.getPath()),N=!l.isRelative()&&(e.getObject(f+'@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction')||e.getObject(f+'@com.sap.vocabularies.Common.v1.DraftRoot/NewAction')),h,r=sap.ui.getCore().getLibraryResourceBundle("sap.fe");if(N){return this.onCallAction(N,{contexts:l.getHeaderContext(),showActionParameterDialog:true,label:r.getText("SAPFE_ACTION_CREATE"),bindingParameters:{$$patchWithoutSideEffects:true},parentControl:p.parentControl,bIsCreateAction:true});}else{var j=sap.ui.getCore().getMessageManager().getMessageModel().bindList('');var A=function(){var k=j.getModel().getData()||[];if(k.length){setTimeout(function(){j.detachChange(A);h.delete();},0);}};j.attachChange(A);h=l.create(null,S,p.createAtEnd);return h.created().then(function(){j.detachChange(A);return h;});}},createDocument:function(l,p){var N,t=this,S,b;p=g(p);if(!l){return Promise.reject("Binding required for new document creation");}if(p.busyMode==='Local'){b=l.sId;}if(this.isBusy(p.busyMode,b)){return Promise.reject("Action can only be called once at a time");}return this.getProgrammingModel(l).then(function(e){S=!p.refreshList;switch(e){case'Draft':case'Sticky':if(!p.parentControl){p.parentControl=t.base.getView();}if(p.busyHandling){t.busyOn(p.busyMode,b);}return t.fnCreateDocument(l,S,p).then(function(r){c=true;N=r.response||r;if(p.busyHandling){t.busyOff(p.busyMode,b);}if(r.bConsiderDocumentModified){t.handleDocumentModifications();}return m.showUnboundMessages().then(function(){return N;});});case'NonDraft':N=l.create(null,S);c=true;return N;}}).catch(function(e){if(p.busyHandling){t.busyOff(p.busyMode,b);}return m.showUnboundMessages().then(function(){return Promise.reject(e);});});},deleteDocument:function(v,p){var u=this.getUIModel(),r,R,b=[],e=false,f=false,h=false,j;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}var l=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),k,q={title:l.getText("OBJECT_PAGE_DELETE")};u.setProperty("/busy",true);if(p){if(!p.numberOfSelectedContexts){p=g(p);if(p.title){if(p.description){k=[p.title,p.description];q.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO",k);}else{q.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");}}else{q.text=l.getText("OBJECT_PAGE_CONFIRM_GENERIC_DELETE");}b=v;}else{q={title:l.getText("OBJECT_PAGE_DELETE")};if(p.numberOfSelectedContexts===1&&p.numberOfSelectedContexts===v.length){b=v;q.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");}else if(p.numberOfSelectedContexts===1&&p.unSavedContexts.length===1){b=p.unSavedContexts;var L=b[0].getObject()["DraftAdministrativeData"]?b[0].getObject()["DraftAdministrativeData"]["LastChangedByUserDescription"]:"";k=[L];q.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",k);}else if(p.numberOfSelectedContexts===p.unSavedContexts.length){b=p.unSavedContexts;q.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS");}else if(p.numberOfSelectedContexts===v.concat(p.unSavedContexts.concat(p.lockedContexts)).length){b=v.concat(p.unSavedContexts);q.text=b.length===1?l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR"):l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL");}else{b=v.concat(p.unSavedContexts);h=true;q.text=b.length===1?l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL"):l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");q.nonDeletableText=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",[(p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length),p.numberOfSelectedContexts]);}if(p.lockedContexts.length>0){f=true;q.nonDeletableText=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",[p.lockedContexts.length,p.numberOfSelectedContexts]);}if(p.unSavedContexts.length>0&&p.unSavedContexts.length!==p.numberOfSelectedContexts){if((h||f)&&b.length===p.unSavedContexts.length){e=false;b=p.unSavedContexts;if(p.unSavedContexts.length===1){q.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR");}else{q.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL");}}else{if(p.unSavedContexts.length===1){q.checkBoxText=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR");}else{q.checkBoxText=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL");}e=true;}}if(h&&f){q.nonDeletableText=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED_AND_NON_DELETABLE",[(p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length-p.lockedContexts.length),p.lockedContexts.length,p.numberOfSelectedContexts]);}}}var t=new V({items:[new T({text:q.nonDeletableText,visible:f||h}),new T({text:q.text}),new a({text:q.checkBoxText,selected:true,select:function(y){var z=y.getSource().getSelected();if(z){b=v.concat(p.unSavedContexts);j=true;}else{b=v;j=false;}},visible:e})]});var w=p.numberOfSelectedContexts?l.getText("OBJECT_PAGE_DELETE_DIALOG",[p.numberOfSelectedContexts]):l.getText("OBJECT_PAGE_DELETE");var x=new U.getDialogControl({title:w,state:'Warning',content:[t],beginButton:new B({text:l.getText("OBJECT_PAGE_DELETE"),type:"Emphasized",press:function(){u.setProperty("/busy",true);var y=Array.isArray(b)?b:[b];x.close();return Promise.all(y.map(function(z){z.delete().then(function(){u.setProperty("/busy",false);if(u.getProperty("/$contexts/"+p.id+"/deleteEnabled")!=undefined){if(e===true&&j===false){u.setProperty("/$contexts/"+p.id+"/deleteEnabled",true);var A=Object.assign(u.getProperty("/$contexts/"+p.id),{});A.selectedContexts=A.selectedContexts.filter(function(F){return A.deletableContexts.indexOf(F)===-1;});A.deletableContexts=[];A.numberOfSelectedContexts=A.selectedContexts.length;u.setProperty("/$contexts/"+p.id,A);}else{u.setProperty("/$contexts/"+p.id+"/deleteEnabled",false);}}y.length===1?M.show(l.getText("OBJECT_PAGE_DELETE_TOAST_SINGULAR")):M.show(l.getText("OBJECT_PAGE_DELETE_TOAST_PLURAL"));m.removeBoundTransitionMessages();return m.showUnboundMessages().then(R);}).catch(function(A){u.setProperty("/busy",false);return m.showUnboundMessages().then(r);});}));}}),endButton:new B({text:l.getText("OBJECT_PAGE_CANCEL"),press:function(){u.setProperty("/busy",false);x.close();}}),afterClose:function(){x.destroy();}});x.addStyleClass("sapUiContentPadding");u.setProperty("/busy",false);x.open();return new Promise(function(y,z){r=z;R=y;});},editDocument:function(b){var t=this;var u=this.getUIModel();if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!b){return Promise.reject(new Error('Binding context to active document is required'));}return this.getProgrammingModel(b).then(function(p){switch(p){case'Draft':t.activeContext=b;u.setProperty("/busy",true);return d.createDraftFromActiveDocument(b,{bPreserveChanges:true});case'NonDraft':return b;case'Sticky':u.setProperty("/busy",true);return s.editDocumentInStickySession(b);}}).then(function(N){u.setProperty("/editable",'Editable');u.setProperty("/busy",false);c=false;return m.showUnboundMessages().then(function(){return N;});}).catch(function(e){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(e);});});},updateDocument:function(){return Promise.resolve();},cancelDocument:function(b,p){var t=this,u=t.getUIModel(),e;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!b){return Promise.reject("No context exists. Pass a meaningful context");}var p=g(p),f=b,h=p.cancelButton,j=f.getModel(),k;return this.getProgrammingModel(b).then(function(l){e=l;if(l==="Draft"){var q=j.bindContext(f.getPath()+'/DraftAdministrativeData').getBoundContext();if(!i){u.setProperty("/busy",true);return q.requestObject().then(function(r){u.setProperty("/busy",false);i=!(r.CreationDateTime===r.LastChangeDateTime);});}}else if(l==="NonDraft"){i=f.hasPendingChanges();}}).then(function(){return t._showDiscardPopover(h,i);}).then(function(){u.setProperty("/busy",true);switch(e){case'Draft':if(!f.getObject('HasActiveEntity')){f.delete();return false;}else{var A=t.activeContext||j.bindContext(f.getPath()+'/SiblingEntity').getBoundContext();return A.requestCanonicalPath().then(function(l){k=l;f.delete();}).then(function(){if(A.getPath()!==k){A=j.bindContext(k).getBoundContext();}return A;});}break;case'Sticky':return s.discardDocument(b).then(function(b){b=c?false:b;if(b){b.refresh();}return b;});case'NonDraft':if(f===b&&i){b.getBinding().resetChanges();}break;}}).then(function(l){i=false;u.setProperty("/editable",'Display');u.setProperty("/busy",false);m.removeBoundTransitionMessages();return m.showUnboundMessages().then(function(){return l;});}).catch(function(l){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(l);});});},saveDocument:function(b){var u=this.getUIModel(),e;var l=sap.ui.getCore().getLibraryResourceBundle("sap.fe");if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!b){return Promise.reject(new Error('Binding context to draft document is required'));}u.setProperty("/busy",true);m.removeBoundTransitionMessages();return this.getProgrammingModel(b).then(function(p){switch(p){case'Draft':return d.activateDocument(b);case'Sticky':return s.activateDocument(b);case'NonDraft':e=b.getModel();e.submitBatch(e.getUpdateGroupId());return b;}}).then(function(A){i=false;u.setProperty("/editable",'Display');u.setProperty("/busy",false);M.show(l.getText("OBJECT_SAVED"));return m.showUnboundMessages().then(function(){return A;});}).catch(function(f){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(f);});});},onCallAction:function(A,p){p=g(p);var u=this.getUIModel(),t=this,b,e,f,N;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!A){return Promise.reject("Provide name of action to be executed");}N=A.split("/")[1];A=N||A;if(p.contexts){b=Array.isArray(p.contexts)?p.contexts[0]:p.contexts;e=b.getModel();}if(p.model){e=p.model;}if(!e){Promise.reject("Pass a context for a bound action or pass the model for an unbound action");}var h=t._getBindingParameters(A,e);if(b&&e){f=o.callBoundAction(A,p.contexts,e,{invocationGrouping:p.invocationGrouping,label:p.label,showActionParameterDialog:true,bindingParameters:h,onSubmitted:function(){u.setProperty("/busy",true);},parentControl:p.parentControl,bIsCreateAction:p.bIsCreateAction});}else{f=o.callActionImport(A,e,{label:p.label,showActionParameterDialog:true,bindingParameters:h,onSubmitted:function(){u.setProperty("/busy",true);},parentControl:p.parentControl});}return f.then(function(r){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return r;});}).catch(function(j){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(j);});});},_getBindingParameters:function(A,b){var e=b.getMetaModel(),S=e.getObject("/"+A+'@com.sap.vocabularies.Common.v1.SideEffects');if(!S){return;}var p={},t=S.TargetProperties,f=S.TargetEntities;if(Array.isArray(t)&&t.length){p['$select']="";t.forEach(function(h){var j=h['$PropertyPath'];if(j.indexOf('_it/')!==0){p['$select']+=(j+',');}else{p['$expand']=p['$expand']||"";p['$expand']+=(j.slice(4)+',');}});p['$select']=p['$select'].slice(0,-1);p['$expand']=p['$expand']?p['$expand'].slice(0,-1):undefined;}if(Array.isArray(f)&&f.length){}return p;},_showDiscardPopover:function(b,i){var t=this,r=sap.ui.getCore().getLibraryResourceBundle("sap.fe");t._bContinueDiscard=false;return new Promise(function(e,f){if(!b){f("Cancel button not found");}if(i){var O=function(){b.setEnabled(true);if(t._bContinueDiscard){e();}else{f("Discard operation was rejected. Document has not been discarded");}t._oPopover.detachAfterClose(O);};if(!t._oPopover){t._oPopover=new P({showHeader:false,placement:"Top",content:[new V({items:[new T({text:r.getText("SAPFE_DRAFT_DISCARD_MESSAGE")}),new B({text:r.getText("SAPFE_DRAFT_DISCARD_BUTTON"),width:"100%",press:function(){t._bContinueDiscard=true;t._oPopover.close();}})]})],beforeOpen:function(){b.setEnabled(false);}});t._oPopover.addStyleClass("sapUiContentPadding");}t._oPopover.attachAfterClose(O);t._oPopover.openBy(b);}else{e();}});},handleDocumentModifications:function(){i=true;}});return E;});
