/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/Device','sap/ui/base/EventProvider','sap/ui/core/InvisibleText','sap/ui/core/ListItem','sap/ui/core/ResizeHandler','sap/ui/core/ValueStateSupport','sap/m/library','sap/ui/core/library','sap/m/Bar','sap/m/Button','sap/m/ColumnListItem','sap/m/GroupHeaderListItem','sap/ui/core/SeparatorItem','sap/m/Dialog','sap/m/DisplayListItem','sap/m/List','sap/m/Popover','sap/m/StandardListItem','sap/m/Table','sap/m/Title','sap/m/Text',"sap/base/security/encodeXML","sap/ui/events/KeyCodes"],function(D,E,I,L,R,V,l,c,B,a,C,G,S,b,d,e,P,f,T,g,h,j,K){"use strict";var k=l.ListMode;var m=l.PlacementType;var n=l.ListType;var o=l.ListSeparators;var p="sapMSuggestionsPopover";var q=c.ValueState;var r=E.extend("sap.m.SuggestionsPopover",{constructor:function(i){E.apply(this,arguments);this._oInput=i;this._bUseDialog=D.system.phone;this._iPopupListSelectedIndex=-1;this._sPopoverContentWidth=null;this._bEnableHighlighting=true;this._bIsInputIncrementalType=false;this._bAutocompleteEnabled=false;this._sTypedInValue='';this._sOldValueState=q.None;this._oInput.addEventDelegate({onsapup:function(s){this._onsaparrowkey(s,"up",1);},onsapdown:function(s){this._onsaparrowkey(s,"down",1);},onsappageup:function(s){this._onsaparrowkey(s,"up",5);},onsappagedown:function(s){this._onsaparrowkey(s,"down",5);},onsaphome:function(s){if(this._oList){this._onsaparrowkey(s,"up",this._oList.getItems().length);}},onsapend:function(s){if(this._oList){this._onsaparrowkey(s,"down",this._oList.getItems().length);}},onsapright:this._onsapright},this);},destroy:function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}if(this._oList){this._oList.destroy();this._oList=null;}if(this._oSuggestionTable){this._oSuggestionTable.destroy();this._oSuggestionTable=null;}this._oProposedItem=null;this._oInputDelegate=null;}});r.M_EVENTS={SELECTION_CHANGE:"selectionChange"};r._wordStartsWithValue=function(t,v){var i;while(t){if(typeof v==="string"&&v!==""&&t.toLowerCase().startsWith(v.toLowerCase())){return true;}i=t.indexOf(' ');if(i==-1){break;}t=t.substring(i+1);}return false;};r._DEFAULTFILTER=function(v,i){if(i instanceof L&&r._wordStartsWithValue(i.getAdditionalText(),v)){return true;}return r._wordStartsWithValue(i.getText(),v);};r._DEFAULTFILTER_TABULAR=function(v,s){var t=s.getCells(),i=0;for(;i<t.length;i++){if(t[i].getText){if(r._wordStartsWithValue(t[i].getText(),v)){return true;}}}return false;};r._DEFAULTRESULT_TABULAR=function(s){var t=s.getCells(),i=0;for(;i<t.length;i++){if(t[i].getText){return t[i].getText();}}return"";};r.prototype.isOpen=function(){return this._oPopover&&this._oPopover.isOpen();};r.prototype._createSuggestionPopup=function(){var i=this._oInput,M=i._oRb;this._oPopover=!this._bUseDialog?(new P(i.getId()+"-popup",{showArrow:false,showHeader:true,placement:m.Vertical,initialFocus:i,horizontalScrolling:true})):(new b(i.getId()+"-popup",{beginButton:new a(i.getId()+"-popup-closeButton",{text:M.getText("SUGGESTIONSPOPOVER_CLOSE_BUTTON")}),stretch:true,customHeader:new B(i.getId()+"-popup-header",{contentMiddle:this._oPopupInput}),horizontalScrolling:false,initialFocus:this._oPopupInput}));this._registerAutocomplete();this._oPopover.addStyleClass(p);this._oPopover.addAriaLabelledBy(I.getStaticId("sap.m","INPUT_AVALIABLE_VALUES"));if(!this._bUseDialog){this._overwritePopover();}if(this._oList){this._oPopover.addContent(this._oList);}};r.prototype._createSuggestionPopupContent=function(t,i){var s=this._oInput;if(!i&&!t){this._oList=new e(s.getId()+"-popup-list",{showNoData:false,mode:k.SingleSelectMaster,rememberSelections:false,showSeparators:o.None});this._oList.addEventDelegate({onAfterRendering:function(){if(!this._bEnableHighlighting){return;}this._highlightListText(s.getValue());}.bind(this)});}else{this._oList=this._getSuggestionsTable();}if(this._oPopover){if(this._bUseDialog){this._oPopover.addAggregation("content",this._oList,true);var u=this._oPopover.$("scrollCont")[0];if(u){var v=sap.ui.getCore().createRenderManager();v.renderControl(this._oList);v.flush(u);v.destroy();}}else{this._oPopover.addContent(this._oList);}}};r.prototype._destroySuggestionPopup=function(){if(this._oPopover){if(this._oList instanceof T){this._oPopover.removeAllContent();}this._oPopover.destroy();this._oPopover=null;}if(this._oList instanceof e){this._oList.destroy();this._oList=null;}this._getInput().removeEventDelegate(this._oInputDelegate,this);};r.prototype._overwritePopover=function(){var i=this._oInput;this._oPopover.open=function(){this.openBy(i,false,true);};this._oPopover.oPopup.setAnimations(function($,s,O){O();},function($,s,t){t();});};r.prototype._resizePopup=function(){var i=this._oInput;if(this._oList&&this._oPopover){if(this._sPopoverContentWidth){this._oPopover.setContentWidth(this._sPopoverContentWidth);}else{this._oPopover.setContentWidth((i.$().outerWidth())+"px");}setTimeout(function(){if(this._oPopover&&this._oPopover.isOpen()&&this._oPopover.$().outerWidth()<i.$().outerWidth()){this._oPopover.setContentWidth((i.$().outerWidth())+"px");}}.bind(this),0);}};r.prototype._registerResize=function(){if(!this._bUseDialog){this._sPopupResizeHandler=R.register(this._oInput,this._resizePopup.bind(this));}};r.prototype._deregisterResize=function(){if(this._sPopupResizeHandler){this._sPopupResizeHandler=R.deregister(this._sPopupResizeHandler);}};r.prototype._onsaparrowkey=function(i,s,t){var u=this._oInput,v,w=u.$("inner");if(i.isMarked()){return;}if(i.isMarked()){return;}if(!u.getEnabled()||!u.getEditable()){return;}if(s!=="up"&&s!=="down"){return;}if(this._bIsInputIncrementalType){i.setMarked();}if(!this._oPopover||!this._oPopover.isOpen()){return;}i.preventDefault();i.stopPropagation();var F=false,x=this._oList,y=x.getItems(),z=this._iPopupListSelectedIndex,N,O=z;if(s==="up"&&z===0){return;}if(s=="down"&&z===y.length-1){return;}var A;if(t>1){if(s=="down"&&z+t>=y.length){s="up";t=1;y[z].setSelected(false);A=z;z=y.length-1;F=true;}else if(s=="up"&&z-t<0){s="down";t=1;y[z].setSelected(false);A=z;z=0;F=true;}}if(z===-1){z=0;if(this._isSuggestionItemSelectable(y[z])){O=z;F=true;}else{s="down";}}if(s==="down"){while(z<y.length-1&&(!F||!this._isSuggestionItemSelectable(y[z]))){y[z].setSelected(false);z=z+t;F=true;t=1;if(A===z){break;}}}else{while(z>0&&(!F||!y[z].getVisible()||!this._isSuggestionItemSelectable(y[z]))){y[z].setSelected(false);z=z-t;F=true;t=1;if(A===z){break;}}}if(!this._isSuggestionItemSelectable(y[z])){if(O>=0){y[O].setSelected(true).updateAccessibilityState();w.attr("aria-activedescendant",y[O].getId());}return;}else{v=y[z];v.setSelected(true).updateAccessibilityState();if(v.isA("sap.m.GroupHeaderListItem")){w.removeAttr("aria-activedescendant");}else{w.attr("aria-activedescendant",y[z].getId());}}if(D.system.desktop){this._scrollToItem(z);}this._oLastSelectedHeader&&this._oLastSelectedHeader.removeStyleClass("sapMInputFocusedHeaderGroup");if(C&&y[z]instanceof C){N=u._getInputValue(u._fnRowResultFilter(y[z]));}else{if(y[z].isA("sap.m.GroupHeaderListItem")){N="";y[z].addStyleClass("sapMInputFocusedHeaderGroup");this._oLastSelectedHeader=y[z];}else if(y[z]instanceof d){N=u._getInputValue(y[z].getLabel());}else{N=u._getInputValue(y[z].getTitle());}}this._iPopupListSelectedIndex=z;this._bSuggestionItemChanged=true;this.fireEvent(r.M_EVENTS.SELECTION_CHANGE,{newValue:N});};r.prototype._isSuggestionItemSelectable=function(i){var s=this._hasTabularSuggestions()||i.getType()!==n.Inactive||i.isA("sap.m.GroupHeaderListItem");return i.getVisible()&&s;};r.prototype._hasTabularSuggestions=function(){if(!this._oSuggestionTable){return;}return!!(this._oSuggestionTable.getColumns()&&this._oSuggestionTable.getColumns().length);};r.prototype._scrollToItem=function(i){var s=this._oPopover,t=this._oList,u,v,w,x,y;if(!(s instanceof P)||!t){return;}u=s.getScrollDelegate();if(!u){return;}var z=t.getItems()[i],A=z&&z.getDomRef();if(!A){return;}v=s.getDomRef("cont").getBoundingClientRect();w=A.getBoundingClientRect();x=v.top-w.top;y=w.bottom-v.bottom;if(x>0){u.scrollTo(u._scrollX,Math.max(u._scrollY-x,0));}else if(y>0){u.scrollTo(u._scrollX,u._scrollY+y);}};r.prototype._getSuggestionsTable=function(){var i=this._oInput;if(i._bIsBeingDestroyed){return this._oSuggestionTable;}if(!this._oSuggestionTable){this._oSuggestionTable=new T(i.getId()+"-popup-table",{mode:k.SingleSelectMaster,showNoData:false,showSeparators:o.None,width:"100%",enableBusyIndicator:false,rememberSelections:false,selectionChange:function(s){if(D.system.desktop){i.focus();}this._bSuggestionItemTapped=true;var t=s.getParameter("listItem");i.setSelectionRow(t,true);}.bind(this)});this._oSuggestionTable.addEventDelegate({onAfterRendering:function(){if(!i.getEnableSuggestionsHighlighting()){return;}this._highlightTableText(i.getValue());}.bind(this)});if(this._bUseDialog){this._oSuggestionTable.addStyleClass("sapMInputSuggestionTableHidden");}this._oSuggestionTable.updateItems=function(){T.prototype.updateItems.apply(i,arguments);i._refreshItemsDelayed();return i;};}i._oSuggestionTable=this._oSuggestionTable;return this._oSuggestionTable;};r.prototype._createHighlightedText=function(i){var t=i.innerText,v=(this._sTypedInValue||this._oInput.getValue()).toLowerCase(),s=v.length,u=t.toLowerCase(),w,x='';if(!r._wordStartsWithValue(t,v)){return j(t);}var y=u.indexOf(v);if(y>0){y=u.indexOf(' '+v)+1;}if(y>-1){x+=j(t.substring(0,y));w=t.substring(y,y+s);x+='<span class="sapMInputHighlight">'+j(w)+'</span>';x+=j(t.substring(y+s));}else{x=j(t);}return x;};r.prototype._highlightListText=function(){if(!this._bEnableHighlighting){return;}var i,s,t=this._oList.$().find('.sapMDLILabel, .sapMSLITitleOnly, .sapMDLIValue');for(i=0;i<t.length;i++){s=t[i];s.innerHTML=this._createHighlightedText(s);}};r.prototype._highlightTableText=function(){if(!this._bEnableHighlighting){return;}var i,s,t=this._oSuggestionTable.$().find('tbody .sapMLabel');for(i=0;i<t.length;i++){s=t[i];s.innerHTML=this._createHighlightedText(s);}};r.prototype._registerAutocomplete=function(){var i=this._oPopover,u=this._getInput(),U=this._bUseDialog;if(U){i.addEventDelegate({ontap:function(){if(!this._bSuggestionItemTapped&&this._sProposedItemText){u.setValue(this._sProposedItemText);this._sProposedItemText=null;}}},this);}else{i.attachAfterOpen(this._handleTypeAhead,this);}i.attachAfterClose(this._finalizeAutocomplete,this);this._oInputDelegate={onkeydown:function(s){this._bDoTypeAhead=this._bAutocompleteEnabled&&(s.which!==K.BACKSPACE)&&(s.which!==K.DELETE);},oninput:this._handleTypeAhead};u.addEventDelegate(this._oInputDelegate,this);};r.prototype._handleTypeAhead=function(){var s=this._getInput(),v=s.getValue();this._oProposedItem=null;this._sTypedInValue=v;if(!this._bDoTypeAhead||v===""){return;}if(!this._oPopover.isOpen()||v.length<this._oInput.getStartSuggestion()){return;}if(document.activeElement!==s.getFocusDomRef()){return;}var t=v.toLowerCase(),u=this._hasTabularSuggestions(),w=u?this._oInput.getSuggestionRows():this._oInput.getSuggestionItems(),x,N,y,i;w=w.filter(function(z){return!(z.isA("sap.ui.core.SeparatorItem")||z.isA("sap.m.GroupHeaderListItem"));});x=w.length;for(i=0;i<x;i++){y=u?this._oInput._fnRowResultFilter(w[i]):w[i].getText();if(y.toLowerCase().startsWith(t)){this._oProposedItem=w[i];N=y;break;}}this._sProposedItemText=N;if(N){N=this._formatTypedAheadValue(N);s.updateDomValue(N);if(D.system.desktop){s.selectText(v.length,N.length);}else{setTimeout(function(){s.selectText(v.length,N.length);},0);}}};r.prototype._getInput=function(){return this._bUseDialog?this._oPopupInput:this._oInput;};r.prototype._finalizeAutocomplete=function(){if(!this._bAutocompleteEnabled){return;}if(!this._bSuggestionItemTapped&&!this._bSuggestionItemChanged&&this._oProposedItem){if(this._hasTabularSuggestions()){this._oInput.setSelectionRow(this._oProposedItem,true);}else{this._oInput.setSelectionItem(this._oProposedItem,true);}}if(this._oProposedItem&&document.activeElement===this._oInput.getFocusDomRef()){var i=this._oInput.getValue().length;this._oInput.selectText(i,i);}this._oProposedItem=null;this._sProposedItemText=null;this._sTypedInValue='';this._bSuggestionItemTapped=false;this._bSuggestionItemChanged=false;};r.prototype._formatTypedAheadValue=function(N){return this._sTypedInValue.concat(N.substring(this._sTypedInValue.length,N.length));};r.prototype._onsapright=function(){var i=this._oInput,v=i.getValue();if(!this._bAutocompleteEnabled){return;}if(this._sTypedInValue!==v){this._sTypedInValue=v;i.fireLiveChange({value:v,newValue:v});}};r.prototype.updateValueState=function(v,s,i){var t=i&&v!==q.None;this._showValueStateText(t);s=s||V.getAdditionalText(v);this._setValueStateText(s);this._alignValueStateStyles(v);return this;};r.prototype._getPickerValueStateText=function(){var i=this._oPopover;if(!this._oPickerValueStateText){this._oPickerValueStateText=new h({width:"100%"});i.insertContent(this._oPickerValueStateText,0);}return this._oPickerValueStateText;};r.prototype._showValueStateText=function(s){var i;if(this._bUseDialog){if(this._oPickerValueStateText){this._oPickerValueStateText.setVisible(s);}}else{i=this._getPickerCustomHeader();if(i){i.setVisible(s);}}};r.prototype._setValueStateText=function(t){var H;if(this._bUseDialog){this._oPickerValueStateText=this._getPickerValueStateText();this._oPickerValueStateText.setText(t);}else{H=this._getPickerCustomHeader();if(H){H.getContentLeft()[0].setText(t);}}};r.prototype._getPickerCustomHeader=function(){var i,s,t=this._oPopover,u=p+"Title";if(!t){return null;}if(t.getCustomHeader()){return t.getCustomHeader();}i=new g({textAlign:"Left"}).addStyleClass(u);s=new B({visible:false,contentLeft:i});t.setCustomHeader(s);return s;};r.prototype._alignValueStateStyles=function(v){var s=p+"ValueState",O=p+this._sOldValueState+"State",i=p+v+"State",t;if(this._bUseDialog&&this._oPickerValueStateText){this._oPickerValueStateText.addStyleClass(s);this._oPickerValueStateText.removeStyleClass(O);this._oPickerValueStateText.addStyleClass(i);}else{t=this._getPickerCustomHeader();if(t){t.addStyleClass(s);t.removeStyleClass(O);t.addStyleClass(i);}}this._sOldValueState=v;};return r;});
