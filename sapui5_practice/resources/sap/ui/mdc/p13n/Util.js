/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/model/json/JSONModel',"sap/base/util/array/diff","sap/m/Button"],function(J,d,B){"use strict";var i=jQuery.sap.getUriParameters().get("P13nModal")==="true";var U={showP13nChart:function(s,b,D,c,a){this.sP13nType="Chart";sap.ui.require(["sap/ui/mdc/p13n/ChartItemPanel"],function(C){this._showDialog(s,b,D,c,a,C);}.bind(this));},showP13nColumns:function(s,b,D,c,a){this.sP13nType="Column";sap.ui.require(["sap/ui/mdc/p13n/SelectionPanel"],function(S){this._showDialog(s,b,D,c,a,S);}.bind(this));},showP13nSort:function(s,b,D,c,a){this.sP13nType="Sort";sap.ui.require(["sap/ui/mdc/p13n/SortPanel"],function(S){this._showDialog(s,b,D,c,a,S);}.bind(this));},_showDialog:function(s,o,D,c,A,P){return new Promise(function(r,e){sap.ui.require(i?['sap/m/Dialog']:['sap/m/ResponsivePopover'],function(C){o.items.sort(function(a,b){if(a.label<b.label){return-1;}else if(a.label>b.label){return 1;}else{return 0;}});var I=o.items.filter(function(m){return!this._getArrayElementByKey(m.name,D.items);}.bind(this));Object.assign(D,{items:D.items.concat(I)});this.oJSONModelRuntime=new J(D);this.oControl=c;var t=this._getPanelTitle(this.sP13nType);this.fnHandleChange=function(a){U.handleUserChanges(a,c).then(A);};var p=new P({change:i?function(){}:this._registerChangeEvent.bind(this)});p.setModel(this.oJSONModelRuntime);var f=this._createDialog(C,p,i,this.oJSONModelRuntime,c,t,this.fnHandleChange);c.addDependent(f);if(i){f.open();}else{f.openBy(s);}}.bind(this));}.bind(this));},_registerChangeEvent:function(){var c=[];switch(this.sP13nType){case"Sort":c=this._registerSortEvent();break;case"Column":c=this._registerColumnEvent();break;case"Chart":c=this._registerChartEvent();break;}this.fnHandleChange(c);},_registerChartEvent:function(){var c=[],s;var e=this._getChartData(this.oControl),S=[];this.oJSONModelRuntime.getData().items.forEach(function(I){if(!I.visible){return;}var o={id:I.id,name:I.name,label:I.label,kind:I.kind,role:I.role,aggregationMethod:I.aggregationMethod,propertyPath:I.propertyPath};S.push(o);});s=function(o){return o.name+o.role;};c=this._processResult(e,S,s,this.oControl,"removeItem","addItem");return c;},_registerColumnEvent:function(){var c=[],s;var e=this._getColumnsData(this.oControl),S=[];this.oJSONModelRuntime.getData().items.forEach(function(C){if(!C.visible){return;}var o={name:C.name,label:C.label};S.push(o);});s=function(o){return o.name;};c=this._processResult(e,S,s,this.oControl,"removeColumn","addColumn");return c;},_registerSortEvent:function(){var c=[],s;var e=this._getSortData(this.oControl),S=[];this.oJSONModelRuntime.getData().items.forEach(function(o){if(!o.selected){return;}var a={name:o.name,sortOrder:o.sortOrder};S.push(a);});s=function(o){return o.name+o.sortOrder;};c=this._processResult(e,S,s,this.oControl,"removeSort","addSort");return c;},_createDialog:function(C,p,i,j,c,m,f){var o;var D=jQuery.extend(true,{},j.getProperty("/"));var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");if(!i){o=new C({title:r.getText(m),horizontalScrolling:false,verticalScrolling:true,contentWidth:"25rem",resizable:true,placement:"HorizontalPreferredRight",content:p,afterClose:function(){o.destroy();f([]);}});}else{o=new C({title:r.getText(m),horizontalScrolling:false,verticalScrolling:true,contentWidth:"40rem",contentHeight:"55rem",draggable:true,resizable:true,stretch:"{device>/system/phone}",content:p,buttons:[new B({text:r.getText("p13nDialog.OK"),type:"Emphasized",press:function(){this._registerChangeEvent();o.close();o.destroy();}.bind(this)}),new B({text:r.getText("p13nDialog.CANCEL"),press:function(){o.close();o.destroy();j.setProperty("/",jQuery.extend(true,{},D));f([]);}})]});}o.addStyleClass("sapUiMdcPersonalizationDialog");o.toggleStyleClass("sapUiSizeCompact",!!jQuery(c.getDomRef()).closest(".sapUiSizeCompact").length);return o;},_processResult:function(e,c,s,C,r,I){var R=d(e,c,s);var m=function(f,A){return A.filter(function(E){return E&&(E.name===f.name);})[0];};var a=[];var p=e.slice(0);R.forEach(function(o){if(o.type==="delete"&&p[o.index]===undefined){p.splice(o.index,1);return;}var E;if(o.type==="insert"){E=m(c[o.index],p);if(E){E.index=p.indexOf(E);p.splice(E.index,1,undefined);a.push({selectorControl:C,changeSpecificData:{changeType:r,content:E}});}}var P=o.type==="delete"?p[o.index]:c[o.index];P.index=o.index;if(o.type==="delete"){p.splice(P.index,1);}else{p.splice(P.index,0,P);}a.push({selectorControl:C,changeSpecificData:{changeType:o.type==="delete"?r:I,content:P}});});return a;},_getArrayElementByKey:function(k,a){var e=a.filter(function(E){return E.name!==undefined&&E.name===k;});return e.length?e[0]:null;},_getSortData:function(c){var f=c.data("$p13nSort"),v,s=[];if(typeof f==="string"){f=f.replace(/\\{/g,"{");v=JSON.parse(f);}if(v){s=v;}return s;},_getColumnsData:function(c){var p=[],l;if(c){c.getColumns().forEach(function(C){l=C&&C.getDataProperties()[0];if(l){p.push({name:l,id:C.getId(),label:C.getHeader()});}});}return p;},_getChartData:function(c){var p=[];c.getItems().forEach(function(I){p.push({id:I.sId,name:I.mProperties.key,label:I.mProperties.label,role:I.mProperties.role});});return p;},_getPanelTitle:function(p){var t;switch(p){case"Sort":t="sort.PERSONALIZATION_DIALOG_TITLE";break;case"Column":t="fieldsui.SELECTED_FIELDS";break;case"Chart":t="chart.PERSONALIZATION_DIALOG_TITLE";break;}return t;},handleUserChanges:function(c,C){return new Promise(function(r,a){sap.ui.require(["sap/ui/fl/ControlPersonalizationAPI"],function(b){b.addPersonalizationChanges({controlChanges:c}).then(function(D){r(D);});});});}};return U;});
