/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/XMLComposite','sap/ui/mdc/library','sap/m/HBox','sap/m/VBox','sap/m/Text','sap/m/Image','sap/m/Link','./ILinkHandler','sap/ui/comp/personalization/Controller','sap/ui/comp/personalization/SelectionWrapper','sap/ui/comp/personalization/ColumnWrapper','sap/ui/core/CustomData','sap/base/Log','sap/m/SelectDialog','sap/m/StandardListItem','./SelectionDialog','./SelectionDialogItem','sap/ui/model/json/JSONModel','sap/ui/model/BindingMode','sap/ui/base/ManagedObjectObserver','sap/ui/mdc/flexibility/PanelItem.flexibility','sap/ui/mdc/flexibility/Panel.flexibility'],function(X,m,H,V,T,I,L,a,C,S,b,c,d,e,f,g,h,J,B,M,P,i){"use strict";var j=X.extend("sap.ui.mdc.base.info.Panel",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/base/info/Panel.designtime",defaultAggregation:"items",properties:{enablePersonalization:{type:"boolean",defaultValue:true,invalidate:true},metadataHelperPath:{type:"string"}},aggregations:{items:{type:"sap.ui.mdc.base.info.PanelItem",multiple:true,singularName:"item"},additionalContent:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--idSectionAdditionalContent",aggregation:"items"}}},events:{beforeSelectionDialogOpen:{},afterSelectionDialogClose:{}}}});j.prototype.init=function(){X.prototype.init.call(this);var o=new J({countMainItems:0,countNonMainItemsWithIcon:0,countNonMainItemsWithoutIcon:0,showResetEnabled:false,runtimeItems:[]});o.setDefaultBindingMode(B.TwoWay);o.setSizeLimit(1000);this.setModel(o,"$sapuimdcbaseinfoPanel");this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["enablePersonalization"],aggregations:["items"]});};j.prototype.exit=function(o){if(this._oObserver){this._oObserver.disconnect();this._oObserver=null;}};j.prototype.onPressLinkPersonalization=function(){this.openSelectionDialog(false,true,undefined);};j.prototype.openSelectionDialog=function(F,s,k){return sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){sap.ui.require(['sap/ui/fl/FlexControllerFactory','sap/ui/fl/ControlPersonalizationAPI','sap/ui/fl/Utils',this.getMetadataHelperPath()||"sap/ui/mdc/base/info/ContentHandler"],function(l,n,U,o){if(!U.getAppComponentForControl(this)){d.error("No AppComponent fount for control "+this+". Without AppComponent the personalization is not available.");return Promise.resolve();}return l.createForControl(this).waitForChangesToBeApplied(this).then(function(){return new Promise(function(r){var A=o.retrieveAllMetadata(this).filter(function(w){return w.isMain!==true;});if(!A.length){A=jQuery.extend(true,[],this._getInternalModel().getProperty("/runtimeItems")).filter(function(w){return w.isMain!==true;});}var p=A.some(function(w){return!!w.icon;});var q=jQuery.extend(true,[],this._getInternalModel().getProperty("/runtimeItems")).filter(function(w){return w.isMain!==true;});var t=function(v){v.close();v.destroy();this.fireAfterSelectionDialogClose();}.bind(this);var R=[];var u=function(w,x){R.push({id:w,visible:x});};this.fireBeforeSelectionDialogOpen();var v=new g({showItemAsLink:!F,showReset:false,items:A.map(function(w){var x=j._getItemById(w.id,q);var y=w.icon;if(p&&!y){y="sap-icon://chain-link";}return new h({key:w.id,text:w.text,description:w.description,href:w.href,target:w.target,icon:y,visible:x?x.visible:false});}),visibilityChanged:function(E){var w=U.getViewForControl(this);var x=w.createId(E.getParameter("key"));u(x,E.getParameter("visible"));}.bind(this),ok:function(){t(v);var w=U.getAppComponentForControl(this);var x=i.createChanges(this,w,R);var y=[];n.addPersonalizationChanges({controlChanges:x,ignoreVariantManagement:true}).then(function(z){y=y.concat(z);var D=P.createChanges(R);return n.addPersonalizationChanges({controlChanges:D,ignoreVariantManagement:true});}).then(function(z){y=y.concat(z);return n.saveChanges(y,w);}).then(function(){return r(true);});}.bind(this),cancel:function(){t(v);return r(true);},reset:function(){}});if(k){v.addStyleClass(k);}jQuery.sap.syncStyleClass("sapUiSizeCompact",this,v);v.setModel(this._getInternalModel(),"$selectionDialog");this.addDependent(v);v.open();}.bind(this));}.bind(this));}.bind(this));}.bind(this));};j._getArrayElementById=function(s,A){var E=A.filter(function(o){return o.id!==undefined&&o.id===s;});return E.length?E[0]:null;};j._getItemById=function(s,A){return A.filter(function(o){return o.id===s;})[0];};j._getDiffToBase=function(k,l){if(!l||!k||k.length!==l.length){return false;}return l.filter(function(o){var n=j._getItemById(o.id,k);return o.id!==n.id||o.visible!==n.visible;});};j._convertSelectionDialogItems2MItems=function(s){return s.map(function(o){return{id:o.getKey(),visible:o.getVisible()};});};j._getUnion=function(k,l){if(!l){return jQuery.extend(true,[],k);}var u=jQuery.extend(true,[],l);k.forEach(function(o){var n=j._getItemById(o.id,u);if(!n){u.push(o);return;}if(n.visible===undefined&&o.visible!==undefined){n.visible=o.visible;}});return u;};j.prototype._getInternalModel=function(){return this.getModel("$sapuimdcbaseinfoPanel");};j.prototype._propagateDefaultIcon=function(s){if(!s){return;}var o=this._getInternalModel();o.getProperty("/runtimeItems").forEach(function(k,l){if(k.isMain===true||!!k.icon){return;}o.setProperty("/runtimeItems/"+l+"/icon","sap-icon://chain-link");});};function _(o){var k=this._getInternalModel();if(o.object.isA("sap.ui.mdc.base.info.Panel")){switch(o.name){case"items":var l=o.child?[o.child]:o.children;l.forEach(function(p){switch(o.mutation){case"insert":k.setProperty("/countMainItems",p.getIsMain()?k.getProperty("/countMainItems")+1:k.getProperty("/countMainItems"));if(!p.getIsMain()){k.setProperty("/countNonMainItemsWithIcon",p.getIcon()?k.getProperty("/countNonMainItemsWithIcon")+1:k.getProperty("/countNonMainItemsWithIcon"));k.setProperty("/countNonMainItemsWithoutIcon",p.getIcon()?k.getProperty("/countNonMainItemsWithoutIcon"):k.getProperty("/countNonMainItemsWithoutIcon")+1);}var r=k.getProperty("/runtimeItems/");r.splice(this.indexOfItem(p),0,p.getJson());k.setProperty("/runtimeItems",r);this._propagateDefaultIcon(k.getProperty("/countNonMainItemsWithIcon")>0&&k.getProperty("/countNonMainItemsWithoutIcon")>0);this._oObserver.observe(p,{properties:["visible"]});break;case"remove":this._oObserver.unobserve(p);d.error("Deletion of items is not supported yet");break;default:d.error("Mutation '"+o.mutation+"' is not supported yet.");}},this);break;case"enablePersonalization":this.byId("idSectionPersonalizationButton").setVisible(o.current);break;default:d.error("The property or aggregation '"+o.name+"' has not been registered.");}}else if(o.object.isA("sap.ui.mdc.base.info.PanelItem")){switch(o.name){case"visible":var p=o.object;k.setProperty("/runtimeItems/"+this.indexOfItem(p)+"/visible",p.getVisible());break;default:d.error("The '"+o.name+"' of PanelItem is not supported yet.");}}}return j;},true);
