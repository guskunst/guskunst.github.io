/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/m/library","sap/m/List","sap/m/Popover","sap/m/StandardListItem",'sap/m/MultiInput','sap/m/MultiComboBox','sap/m/Token','sap/m/Tokenizer','sap/ui/comp/smartfield/SmartField','sap/ui/comp/odata/MetadataAnalyser',"sap/ui/model/ParseException","sap/ui/model/ValidateException",'sap/ui/model/BindingMode','sap/ui/comp/odata/ODataType','sap/ui/comp/providers/ValueHelpProvider',"sap/ui/comp/util/FormatUtil","sap/ui/core/format/DateFormat","sap/ui/comp/smartfilterbar/FilterProvider","sap/base/Log","sap/ui/comp/library","sap/ui/core/library","sap/ui/core/ResizeHandler"],function(M,L,P,S,a,b,T,c,d,e,f,V,B,O,g,F,D,h,j,l,k,R){"use strict";var m=l.valuehelpdialog.ValueHelpRangeOperation;var n=l.smartfilterbar.DisplayBehaviour;var o=k.ValueState;var p=M.PlacementType;var I="-mInput";var s="-mInputTokenizer";var q=d.extend("sap.ui.comp.smartmultiinput.SmartMultiInput",{metadata:{library:"sap.ui.comp",properties:{supportRanges:{type:"boolean",defaultValue:false},supportMultiSelect:{type:"boolean",defaultValue:true}},events:{beforeCreate:{allowPreventDefault:true,parameters:{oData:{type:"object"},mParameters:{type:"object"}}},beforeRemove:{allowPreventDefault:true,parameters:{mParameters:{type:"object"}}},tokenUpdate:{parameters:{type:{type:"string"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},selectionChange:{parameters:{changedItem:{type:"sap.ui.core.Item"},selected:{type:"boolean"}}}}},renderer:function(i,C){d.getMetadata().getRenderer().render(i,C);}});q.prototype.getTokens=function(){if(this._isReadMode()&&this._oTokenizer){return this._oTokenizer.getTokens();}else if(this._oMultiComboBox){return this._oMultiComboBox._oTokenizer.getTokens();}else if(this._oMultiInput){return this._oMultiInput.getTokens();}};q.prototype.getValue=function(){return this.getTokens();};q.prototype._createMultiInput=function(){var A=this._createAttributes();A.autocomplete=false;this._oMultiInput=new a(this.getId()+I,A);this._oMultiInput.attachChange(function(E){this._validateValueOnChange(E.getParameter("value"));},this);this._oMultiInput.attachSuggestionItemSelected(function(E){this._validateValueOnChange(E.getSource().getValue());},this);if(this.getBindingContext()){this._bindMultiInput();}this._oMultiInput.attachTokenUpdate(function(E){var t=E.getParameters();delete t.id;this.fireTokenUpdate(t);},this);var i={control:this._oMultiInput,onCreate:"_onMultiInputCreate",params:{type:{type:this._getType(),property:this._oFactory._oMetaData.property}}};this._initMultiInputValueHelp(i);return i;};q.prototype._createMultiComboBox=function(){var A=this._createAttributes();this._oMultiComboBox=new b(this.getId()+"mComboBox",A);if(this.getBindingContext()){this._bindMultiComboBox();}else{this._oMultiInput=this._oMultiComboBox._oTokenizer;this._oMultiComboBox.attachSelectionChange(function(E){var t=E.getParameters();delete t.id;this.fireSelectionChange(t);},this);}var i={control:this._oMultiComboBox,onCreate:"_onCreate",params:{type:{type:this._getType(),property:this._oFactory._oMetaData.property},valuehelp:{annotation:this._getValueListAnnotation(),aggregation:"items",noDialog:true,noTypeAhead:true}}};return i;};q.prototype._createAttributes=function(){var N={width:true,textAlign:true,placeholder:true,tooltip:true,name:true,valueState:true,valueStateText:true};var A=this._oFactory.createAttributes(null,this._oFactory._oMetaData.property,N,{event:"change",parameter:"value"});return A;};function r(C){var t=C.getParameter("tokens"),u,K,i=0,v=[],w=null,x;this._onCancel();if(this.oControl instanceof sap.m.MultiInput){this.oControl.setValue("");var y=this.oControl.getTokens();var A=[];var z=[];var N=[];y.forEach(function(E){var G=t.some(function(H){return E.getKey()===H.getKey();});if(!G){z.push(E);}else{N.push(E);}});t.forEach(function(E){var G=y.some(function(H){return H.getKey()===E.getKey();});if(!G){A.push(E);N.push(E);}});this.oControl.setTokens(N);this.oControl.fireTokenUpdate({type:"tokensChanged",removedTokens:z,addedTokens:A});i=t.length;while(i--){w=t[i].data("row");if(w){v.push(w);}}}else{if(t[0]){if(this.bIsSingleIntervalRange){u=t[0].data("range");if(u){if(this._sType==="datetime"){x=D.getDateTimeInstance(Object.assign({},this._oDateFormatSettings,{UTC:false}));if(typeof u.value1==="string"){u.value1=new Date(u.value1);}if(u.operation==="BT"){if(typeof u.value2==="string"){u.value2=new Date(u.value2);}K=x.format(u.value1)+"-"+x.format(u.value2);}else{K=x.format(u.value1);}}else{if(u.operation==="BT"){K=u.value1+"-"+u.value2;}else{K=u.value1;}}}}else{K=t[0].getKey();}w=t[0].data("row");if(w){v.push(w);}}this.oControl.setValue(K);this.oControl.fireChange({value:K,validated:true});}this._calculateAndSetFilterOutputData(v);}q.prototype._initMultiInputValueHelp=function(i){var t=this._getFilterType(this._oFactory._oMetaData.property.property),u={},v=this._getDateFormatSettings(),w;this._oFactory._getValueHelpDialogTitle(u);if(this._getValueListAnnotation()){i.params.valuehelp={annotation:this._getValueListAnnotation(),aggregation:"suggestionRows",noDialog:false,noTypeAhead:false,supportMultiSelect:this.getSupportMultiSelect(),supportRanges:this.getBindingContext()?false:this.getSupportRanges(),type:t,displayBehaviour:this._getDisplayBehaviour()};}else if(this.getSupportRanges()&&!this.getBindingContext()){w=new g({fieldName:this._getPropertyName(),preventInitialDataFetchInValueHelpDialog:true,model:this.getModel(),control:this._oMultiInput,title:u.dialogtitle,supportMultiSelect:this.getSupportMultiSelect(),supportRanges:true,type:t,dateFormatSettings:v,isUnrestrictedFilter:this._isTimeType(t),displayBehaviour:this._getDisplayBehaviour()});w._onOK=r;this._oMultiInput.addValidator(this._validateToken.bind(this));}else{this._oMultiInput.setShowValueHelp(false);this._oMultiInput.addValidator(this._validateToken.bind(this));}};q.prototype._bindMultiInput=function(){var i=this.getBinding("value").getBindingMode();switch(i){case B.OneTime:this._bindMultiInputOneTime();break;case B.OneWay:this._bindMultiInputOneWay();break;case B.TwoWay:default:this._bindMultiInputTwoWay();}};q.prototype._bindMultiInputOneTime=function(){var t=this;this._readNavigationPropertySet().then(function(i){i.results.forEach(function(u){var K=u[t._getPropertyName()];var v=t._getDescriptionFieldName();var w=v?u[v]:"";t._oMultiInput.addToken(t._createToken(K,w));});});};q.prototype._bindMultiInputOneWay=function(){this._bindMultiInputTokens();};q.prototype._bindMultiInputTwoWay=function(){this._bindMultiInputTokens();this._oMultiInput.attachTokenUpdate(function(E){E.getParameter("addedTokens").forEach(this._addToken.bind(this));E.getParameter("removedTokens").forEach(this._removeToken.bind(this));},this);};q.prototype._bindMultiInputTokens=function(){var N=this._getNavigationPath();this._oMultiInput.bindAggregation("tokens",{path:N,factory:this._tokensFactory.bind(this)});};q.prototype._bindMultiComboBox=function(){var i=this.getBinding("value").getBindingMode();switch(i){case B.OneTime:this._bindMultiComboBoxOneTime();break;case B.OneWay:this._bindMultiComboBoxOneWay();break;case B.TwoWay:default:this._bindMultiComboBoxTwoWay();}};q.prototype._bindMultiComboBoxOneTime=function(){var t=this;this._readNavigationPropertySet().then(function(i){var K=i.results.map(function(u){return u[t._getPropertyName()];});t._oMultiComboBox.setSelectedKeys(K);});};q.prototype._bindMultiComboBoxOneWay=function(){this._createAndAttachHelperMultiInput();};q.prototype._bindMultiComboBoxTwoWay=function(){this._createAndAttachHelperMultiInput();this._oMultiComboBox.attachSelectionChange(function(E){var i=E.getParameter("selected"),t=E.getParameter("changedItem"),u={},v,w;if(i){v=t.getBindingContext().getProperty();}else{w=this._oMultiInput.getTokens().filter(function(x){return x.getKey()===t.getKey();})[0];if(w){v=w.getBindingContext().getProperty();}}this._getEntityType().key.propertyRef.forEach(function(K){if(v&&v[K.name]){u[K.name]=v[K.name];}});if(i){this._createEntity(u);}else{this._removeEntity(u);}},this);};q.prototype._readNavigationPropertySet=function(){var t=this;return new Promise(function(i,u){var C=t.getBindingContext(),v=t._getModel(),N=t._getNavigationPath();v.read(N,{context:C,success:function(w){i(w);},error:function(E){t.setValueState(o.Error);t.setValueStateText(E.responseText);u(E);}});});};q.prototype._createAndAttachHelperMultiInput=function(){var N=this._getNavigationPath();this._oMultiInput=new a();this._oMultiInput.setBindingContext(this.getBindingContext());this._oMultiInput.setModel(this._getModel());this._oMultiInput.bindAggregation("tokens",{path:N,factory:this._tokensFactory.bind(this)});var i=this._oMultiInput.getBinding("tokens");i.attachChange(function(){var K=this._oMultiInput.getTokens().map(function(t){return t.getKey();});this._oMultiComboBox.setSelectedKeys(K);},this);};q.prototype._getReadTokenList=function(){if(!this.oReadTokenList){this.oReadTokenList=new L();this.addDependent(this.oReadTokenList);}return this.oReadTokenList;};q.prototype._getReadTokenListPopover=function(){if(!this.oReadTokenListPopover){this.oReadTokenListPopover=new P({showArrow:true,placement:p.Auto,showHeader:false,contentMinWidth:"auto",content:[this.oReadTokenList]});this.addDependent(this.oReadTokenListPopover);}return this.oReadTokenListPopover;};q.prototype._handleNMoreIndicatorPress=function(){var t=this.getTokens();if(!t){return;}var u=this._getReadTokenList();var v=this._getReadTokenListPopover();u.removeAllItems();for(var i=0,w=t.length;i<w;i++){var x=t[i],y=new S({title:x.getText()});u.addItem(y);}if(this._oTokenizer._oIndicator&&this._oTokenizer._oIndicator.length>0){v.openBy(this._oTokenizer._oIndicator[0]);}};q.prototype._onResize=function(){if(this._isReadMode()&&this._oTokenizer){this._deregisterResizeHandler();this._oTokenizer.setMaxWidth(this.$().width()+"px");this._oTokenizer._useCollapsedMode(true);this._oTokenizer.scrollToEnd();this._registerResizeHandler();}};q.prototype._initTokenizerCollapseMode=function(){this._oTokenizer._handleNMoreIndicatorPress(this._handleNMoreIndicatorPress.bind(this));this._oTokenizer._useCollapsedMode(true);this._oTokenizer.addEventDelegate({onAfterRendering:this._onResize.bind(this)});};q.prototype.onBeforeRendering=function(){if(d.prototype.onBeforeRendering){d.prototype.onBeforeRendering.apply(this,arguments);}this._deregisterResizeHandler();};q.prototype.onAfterRendering=function(){if(d.prototype.onAfterRendering){d.prototype.onAfterRendering.apply(this,arguments);}this._registerResizeHandler();};q.prototype._registerResizeHandler=function(){if(!this._iResizeHandlerId){this._iResizeHandlerId=R.register(this,this._onResize.bind(this));}};q.prototype._deregisterResizeHandler=function(){if(this._iResizeHandlerId){R.deregister(this._iResizeHandlerId);this._iResizeHandlerId=null;}};q.prototype._createTokenizer=function(){var N=this._getNavigationPath();this._oTokenizer=new c(this.getId()+s,{editable:false,width:"100%"});this._initTokenizerCollapseMode();if(this.getBindingContext()){this._oTokenizer.bindAggregation("tokens",{path:N,factory:this._tokensFactory.bind(this)});}else{this.attachInnerControlsCreated(this._mirrorTokensToDisplayTokenizer,this);}return{control:this._oTokenizer,onCreate:"_onCreate"};};q.prototype._mirrorTokensToDisplayTokenizer=function(){if(this.getMode()==="display"&&typeof this._oMultiInput!=="undefined"){this._oTokenizer.removeAllTokens();this._oMultiInput.getTokens().forEach(function(t){var N=new T({text:t.getText(),key:t.getKey()});this._oTokenizer.addToken(N);},this);}};q.prototype._tokensFactory=function(C,i){var v=i.getProperty(this._getPropertyName());var K=this._formatValue(v);var t=this._getDescriptionFieldName();var u=t?i.getProperty(t):"";var w=this._createToken(K,u,i);return w;};q.prototype._createToken=function(K,i,C){var t=this._getFormattedText(K,i);var u;u=new T();u.setKey(K);u.setText(t);return u;};q.prototype._addToken=function(t){var i={},C,u=t.data("row"),v=t.data("range");i[this._getPropertyName()]=t.getKey();if(u){this._getEntityType().key.propertyRef.forEach(function(K){if(u[K.name]){i[K.name]=u[K.name];}});}if(v){i["range"]=v;}this.setValueState(o.None);C=this._createEntity(i);t.setBindingContext(C);};q.prototype._createEntity=function(i){var t=this._getModel(),A=this._getEntitySetName(),u=t._resolveGroup(A),v=this.getBindingContext().getPath()+"/"+this._getNavigationPath(),w=this.fireBeforeCreate({oData:i,mParameters:u});u.refreshAfterChange=true;if(w){u.properties=i;var C=t.createEntry(v,u);return C;}};q.prototype._removeToken=function(t){var K=this._getEntityKeyProperties(t.getBindingContext());this._removeEntity(K);t.destroy();};q.prototype._removeEntity=function(K){var i=this._getModel(),A=this._getEntitySetName(),t=i._resolveGroup(A),u=this.fireBeforeRemove({mParameters:t});t.refreshAfterChange=true;if(u){var v="/"+i.createKey(A,K);i.remove(v,t);}};q.prototype._getEntityKeyProperties=function(C){var i=this._getModel(),E=i.oMetadata._getEntityTypeByPath(C.getPath()),K={};E.key.propertyRef.forEach(function(t){var u=t.name;K[u]=C.getProperty(u);});return K;};q.prototype.checkClientError=function(){if(this.getMode()==="display"){return false;}return!this._validateMultiInput();};q.prototype.getRangeData=function(){var t=this.getTokens(),i=[];t.forEach(function(u){var v;if(u.data("range")){v=u.data("range");}else{v=this._getDefaultTokenRangeData(u);}i.push(v);},this);return i;};q.prototype.setRangeData=function(v){if(!this.getBindingContext()){var i=Array.isArray(v)?v:[v];if(!this._oMultiInput){var E=this.getEditable(),t=this.getEnabled(),C=this.getContextEditable();this.setEditable(true);this.setEnabled(true);this.setContextEditable(true);this.setEditable(E);this.setEnabled(t);this.setContextEditable(C);}this._oMultiInput.removeAllTokens();i.forEach(function(u){var w=this._getTokenTextFromRangeData(u);var x=new T({text:w,key:w});x.data("range",u);this._oMultiInput.addToken(x);},this);this._mirrorTokensToDisplayTokenizer();}else{j.warning("setRangeData can only be used without property binding");}};q.prototype._getTokenTextFromRangeData=function(i){var t="";switch(i.operation){case m.EQ:t="="+i.value1;break;case m.GT:t=">"+i.value1;break;case m.GE:t=">="+i.value1;break;case m.LT:t="<"+i.value1;break;case m.LE:t="<="+i.value1;break;case m.Contains:t="*"+i.value1+"*";break;case m.StartsWith:t=i.value1+"*";break;case m.EndsWith:t="*"+i.value1;break;case m.BT:t=i.value1+"...";if(i.value2){t+=i.value2;}break;default:t="";}if(i.exclude&&t!==""){t="!("+t+")";}return t;};q.prototype.getFilter=function(){var i=[this._getPropertyName()],t={},u=this.getRangeData(),v;t[this._getPropertyName()]={ranges:u,items:[]};v=h.generateFilters(i,t);return v&&v.length===1&&v[0];};q.prototype._getDefaultTokenRangeData=function(t){var i={exclude:false,operation:m.EQ,value1:this._parseValue(t.getKey()),value2:"",keyField:this._getPropertyName()};return i;};q.prototype._validateToken=function(A){var t=A.text;var v=this._validateValue(t);if(v){var i=new T({key:t,text:t});if(this.getSupportRanges()){var u=this._getDefaultTokenRangeData(i);i.data("range",u);i.setText("="+t);}return i;}};q.prototype._validateMultiInput=function(){if(this._oMultiInput.getValueState()!==o.None){return false;}if(this.getRequired()&&this.getTokens().length===0){this.setValueStateText(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("VALUEHELPVALDLG_FIELDMESSAGE"));this.setValueState(o.Error);return false;}else{this.setValueState(o.None);return true;}};q.prototype._validateValueOnChange=function(v){if(v===""){this.setValueState(o.None);this._validateMultiInput();}else{this._validateValue(v);}};q.prototype._parseValue=function(v){return this._getType().parseValue(v,"string");};q.prototype._formatValue=function(v){return this._getType().formatValue(v,"string");};q.prototype._validateValue=function(v){try{var i=this._parseValue(v);this._getType().validateValue(i);this.setValueState(o.None);return true;}catch(E){this.setValueState(o.Error);this.setValueStateText(E.message);var t={element:this._oMultiInput,property:"value",type:this._getType(),newValue:v,oldValue:null,exception:E,message:E.message};if(E instanceof f){this.fireParseError(t);}else if(E instanceof V){this.fireValidationError(t);}return false;}};q.prototype._getModel=function(){if(this._oFactory){return this._oFactory._oModel;}};q.prototype._getDateFormatSettings=function(){var i=this.data("dateFormatSettings");if(typeof i==="string"){try{i=JSON.parse(i);}catch(t){}}return i;};q.prototype._getNavigationPath=function(){return this._oFactory._oMetaData.navigationPath;};q.prototype._getDescriptionFieldName=function(){var i=this._oFactory._oMetaData.annotations.text;if(i){return i.property.property.name;}};q.prototype._getType=function(){if(!this._oType){var i;if(this._isEdmTimeType()){i=this._getDateFormatSettings();}this._oType=this._oFactory._oTypes.getType(this._oFactory._oMetaData.property,i);}return this._oType;};q.prototype._isEdmTimeType=function(){var t=["Edm.DateTime","Edm.DateTimeOffset","Edm.Time"];return t.indexOf(this._oFactory._oMetaData.property.property.type)>-1;};q.prototype._isTimeType=function(t){var i=["date","datetime","time"];return i.indexOf(t)>-1;};q.prototype._getPropertyName=function(){return this._oFactory._oMetaData.property.property.name;};q.prototype._getEntitySetName=function(){return this._oFactory._oMetaData.entitySet.name;};q.prototype._getEntityType=function(){return this._oFactory._oMetaData.entityType;};q.prototype._getValueListAnnotation=function(){return this._oFactory._oMetaData.annotations.valuelist;};q.prototype._getDisplayBehaviour=function(){var i=this._oFactory._getDisplayBehaviourConfiguration("defaultInputFieldDisplayBehaviour");if(!i||i===n.auto){i=n.descriptionAndId;}return i;};q.prototype._getFormattedText=function(K,i){var t=this._getDisplayBehaviour();return F.getFormattedExpressionFromDisplayBehaviour(t,K,i);};q.prototype._getFilterType=function(i){if(O.isNumeric(i.type)){return"numeric";}else if(i.type==="Edm.DateTime"&&i["sap:display-format"]==="Date"){return"date";}else if(i.type==="Edm.String"){return"string";}else if(i.type==="Edm.Boolean"){return"boolean";}else if(i.type==="Edm.Time"){return"time";}else if(i.type==="Edm.DateTimeOffset"){return"datetime";}return undefined;};q.prototype.setEntitySet=function(){d.prototype.setEntitySet.apply(this,arguments);this.updateBindingContext(false,this._getModel());return this;};q.prototype.bindProperty=function(i,A){d.prototype.bindProperty.apply(this,arguments);if(i==="value"){this.updateBindingContext(false,this._getModel());}return this;};q.prototype._checkComboBox=function(){var C=this._oFactory._oSelector.checkComboBox();return C&&C.combobox;};q.prototype._isReadMode=function(){return!this.getEditable()||!this.getEnabled()||!this.getContextEditable();};function _(){this._onCreate.apply(this,arguments);if(this._aProviders.length>0){this._aProviders[0]._onOK=r;}}q.prototype._init=function(){var t=this;d.prototype._init.apply(this,arguments);if(this._oFactory){this._oFactory._createMultiInput=this._createMultiInput.bind(this);this._oFactory._createMultiComboBox=this._createMultiComboBox.bind(this);this._oFactory._createTokenizer=this._createTokenizer.bind(this);this._oFactory._onMultiInputCreate=_;this._oFactory._oSelector.getCreator=function(){if(t._isReadMode()){return"_createTokenizer";}else if(t._checkComboBox()){return"_createMultiComboBox";}else{return"_createMultiInput";}};}};q.prototype.exit=function(){this._deregisterResizeHandler();d.prototype.exit.apply(this,arguments);};return q;},true);
