/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","./Gizmo"],function(q,c,G){"use strict";var S=G.extend("sap.ui.vk.tools.ScaleToolGizmo",{metadata:{library:"sap.ui.vk.tools"}});S.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._viewport=null;this._tool=null;this._nonUniformScaleEnabled=false;this._sceneGizmo=new THREE.Scene();var l=new THREE.DirectionalLight(0xFFFFFF,0.5);l.position.set(1,3,2);this._sceneGizmo.add(l);this._sceneGizmo.add(new THREE.AmbientLight(0xFFFFFF,0.5));this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._gizmoScale=new THREE.Vector3().setScalar(1);this._coordinateSystem=c.CoordinateSystem.Local;this._nodes=[];this._matViewProj=new THREE.Matrix4();this._gizmoSize=132;var e=144,f=24/e,t=48/e;function g(a,b,j){var m=new THREE.Matrix4().makeBasis(new THREE.Vector3(a.y,a.z,a.x),a,new THREE.Vector3(a.z,a.x,a.y));var k=new THREE.BoxBufferGeometry(f,f,f);k.applyMatrix(m);var n=new THREE.MeshLambertMaterial({color:b,transparent:true});var o=new THREE.Mesh(k,n);o.userData.color=b;if(a){o.position.copy(a);var p=window.devicePixelRatio*0.5/e;var r=new THREE.CylinderBufferGeometry(p,p,1,4);m.setPosition(a.clone().multiplyScalar(-0.5));r.applyMatrix(m);var s=new THREE.Mesh(r,n);s.renderOrder=1;o.add(s);m.setPosition(a);}var u=new THREE.BoxBufferGeometry(t,t,t);u.applyMatrix(m);j.add(new THREE.Mesh(u,n));return o;}function h(a,b,j){var k=new THREE.BufferGeometry();var v=new Float32Array(6);v[a]=v[b+3]=0.7;k.addAttribute("position",new THREE.Float32BufferAttribute(v,3));var m=new Float32Array(6);m[a]=m[b+3]=1;k.addAttribute("color",new THREE.Float32BufferAttribute(m,3));var n=new THREE.Line(k,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:true,linewidth:window.devicePixelRatio}));n.userData.colors=m;var o=new THREE.Geometry();var p=new THREE.Vector3().setComponent(a,0.7);var r=new THREE.Vector3().setComponent(b,0.7);o.vertices.push(new THREE.Vector3(),p,r);o.faces.push(new THREE.Face3(0,1,2));var s=new THREE.Mesh(o,new THREE.MeshBasicMaterial({color:0xFFFF00,opacity:0.5,transparent:true,side:THREE.DoubleSide,visible:false}));s.renderOrder=1;n.add(s);j.add(s.clone());return n;}this._gizmo.add(g(new THREE.Vector3(1,0,0),c.AxisColours.x,this._touchAreas));this._gizmo.add(g(new THREE.Vector3(0,1,0),c.AxisColours.y,this._touchAreas));this._gizmo.add(g(new THREE.Vector3(0,0,1),c.AxisColours.z,this._touchAreas));this._gizmo.add(h(1,2,this._touchAreas));this._gizmo.add(h(2,0,this._touchAreas));this._gizmo.add(h(0,1,this._touchAreas));f-=0.1/e;var i=new THREE.MeshLambertMaterial({color:0xC0C0C0,transparent:true});this._gizmo.add(new THREE.Mesh(new THREE.BoxBufferGeometry(f,f,f),i));this._touchAreas.add(new THREE.Mesh(new THREE.BoxBufferGeometry(t,t,t),new THREE.MeshBasicMaterial()));this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);this._updateGizmoPartVisibility();};S.prototype.hasDomElement=function(){return false;};S.prototype._updateGizmoPartVisibility=function(){var s=this._coordinateSystem===c.CoordinateSystem.Screen;var g=this._gizmo.children,t=this._touchAreas.children;g[2].visible=t[2].visible=!s;g[3].visible=g[4].visible=t[3].visible=t[4].visible=!s&&this._nonUniformScaleEnabled;g[5].visible=t[5].visible=this._nonUniformScaleEnabled;this._axisTitles.children[2].visible=!s;};S.prototype.getCoordinateSystem=function(){return this._coordinateSystem;};S.prototype.setCoordinateSystem=function(a){this._coordinateSystem=a;this._updateGizmoPartVisibility();};S.prototype.getNonUniformScaleEnabled=function(v){return this._nonUniformScaleEnabled;};S.prototype.setNonUniformScaleEnabled=function(v){this._nonUniformScaleEnabled=!!v;this._updateGizmoPartVisibility();};S.prototype.show=function(v,t){this._viewport=v;this._tool=t;this._nodes.length=0;this._updateSelection(v._viewStateManager);};S.prototype.hide=function(){this._viewport=null;this._tool=null;};S.prototype.getGizmoCount=function(){if(this._coordinateSystem===c.CoordinateSystem.Local){return this._nodes.length;}else{return this._nodes.length>0?1:0;}};S.prototype.getTouchObject=function(i){if(this._nodes.length===0){return null;}this._updateGizmoObjectTransformation(this._touchAreas,i);return this._touchAreas;};var d=[1,2,4,6,5,3];S.prototype.highlightHandle=function(a,h){var b=(a===6)||(a>=0&&!this._nonUniformScaleEnabled);var i,o;for(i=0;i<3;i++){o=this._gizmo.children[i];var e=b||(d[a]&(1<<i));var f=e?0xFFFF00:o.userData.color;o.material.color.setHex(f);o.children[0].material.color.setHex(f);o.children[0].material.opacity=o.material.opacity=e||h?1:0.35;var g=this._axisTitles.children[i];g.material.color.setHex(f);g.material.opacity=e||h?1:0.35;}for(i=3;i<6;i++){o=this._gizmo.children[i];var j=o.geometry.attributes.color;j.copyArray(b||i===a?[1,1,0,1,1,0]:o.userData.colors);j.needsUpdate=true;o.material.opacity=h||i===a?1:0.35;o.children[0].material.visible=i===a;}o=this._gizmo.children[6];o.material.color.setHex(b?0xFFFF00:0xC0C0C0);o.material.opacity=b||h?1:0.35;};S.prototype.beginGesture=function(){this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(n){n.scaleOrigin=n.node.scale.clone();n.matOrigin=n.node.matrixWorld.clone();n.matParentInv=new THREE.Matrix4().getInverse(n.node.parent.matrixWorld);});};S.prototype.endGesture=function(){this._tool.fireScaled({x:this._gizmoScale.x,y:this._gizmoScale.y,z:this._gizmoScale.z});this._gizmoScale.setScalar(1);};S.prototype._scale=function(s){this._gizmoScale.copy(s);if(this._coordinateSystem===c.CoordinateSystem.Local){this._nodes.forEach(function(n){n.node.scale.copy(n.scaleOrigin).multiply(s);n.node.matrixWorldNeedsUpdate=true;});this._viewport._updateBoundingBoxesIfNeeded();}else{var m=this._matOrigin.clone().scale(s).multiply(new THREE.Matrix4().getInverse(this._matOrigin));this._nodes.forEach(function(n){if(!n.ignore){var a=n.node;a.matrixWorld.multiplyMatrices(m,n.matOrigin);a.matrix.multiplyMatrices(n.matParentInv,a.matrixWorld);a.matrix.decompose(a.position,new THREE.Quaternion(),a.scale);a.matrixWorldNeedsUpdate=true;}});}this._viewport.setShouldRenderFrame();};S.prototype.scale=function(x,y,z){this.beginGesture();this._scale(new THREE.Vector3(x,y,z));};S.prototype._setScale=function(s){if(this._tool.fireEvent("scaling",{x:s.x,y:s.y,z:s.z},true)){this._scale(s);}};S.prototype.expandBoundingBox=function(b){if(this._viewport){this._expandBoundingBox(b,this._viewport.getCamera().getCameraRef());}};S.prototype.handleSelectionChanged=function(e){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);}};S.prototype._getAnchorPoint=function(){return this._viewport&&this._viewport.getScene()?this._viewport.getScene().getSceneRef().userData.anchorPoint:null;};S.prototype._updateGizmoTransformation=function(g,a){var s=this._updateGizmoObjectTransformation(this._gizmo,g);this._updateAxisTitles(this._axisTitles,this._gizmo,a,this._gizmoSize+30,s);};S.prototype.render=function(){if(this._nodes.length>0){var r=this._viewport.getRenderer(),a=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);r.clearDepth();for(var i=0,l=this.getGizmoCount();i<l;i++){this._updateGizmoTransformation(i,a);r.render(this._sceneGizmo,a);}}};S.prototype.onBeforeRendering=function(){};S.prototype.onAfterRendering=function(){};return S;},true);
